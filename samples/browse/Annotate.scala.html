<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Annotate.scala</title>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* browse -- Scala Source Browser
 * Copyright 2009 Mark Harrah
 */</span>

<span class="keyword">package</span> browse

<span class="keyword">import</span> java.io.{File, Reader, Writer}
<span class="keyword">import</span> scala.collection.jcl.TreeSet

<span class="comment">/** The entry point for annotating an input file.*/</span>
<span class="keyword">private</span> <span class="keyword">object</span> <a title="object browse.Annotate" id="6215">Annotate</a>
{
	<span class="keyword">import</span> FileUtil.{withReader, withWriter}
	<span class="comment">/** Annotates an input source file with highlighting and type information provided by 'tokens' and applied by 'styler'.
	* The result is written to 'target'.*/</span>
	<span class="keyword">def</span> <a title="(java.io.File,java.io.File,scala.collection.jcl.TreeSet[browse.Token],browse.Styler)Unit" id="19411">apply</a>(<a title="java.io.File" id="19412">source</a>: <a title="java.io.File" id="3612">File</a>, <a title="java.io.File" id="19413">target</a>: <a title="java.io.File" id="3612">File</a>, <a title="scala.collection.jcl.TreeSet[browse.Token]" id="19414">tokens</a>: <a title="scala.collection.jcl.TreeSet[browse.Token]" id="10489">TreeSet</a>[Token], <a title="browse.Styler" id="19415">styler</a>: <a href="Styler.scala.html#6193" title="browse.Styler">Styler</a>)
	{
		<a href="FileUtil.scala.html#17545" title="(java.io.File)((java.io.BufferedReader) =&gt; Unit)Unit">withReader</a>(<a href="#19412" title="java.io.File">source</a>) { <a title="java.io.BufferedReader" id="21822">input</a> =&gt;
			<a href="FileUtil.scala.html#17546" title="(java.io.File)((java.io.BufferedWriter) =&gt; Unit)Unit">withWriter</a>(<a href="#19413" title="java.io.File">target</a>) { <a title="java.io.BufferedWriter" id="21836">output</a> =&gt;
				<span title="browse.Annotate" class="keyword">new</span> <a href="#6217" title="browse.Annotate">Annotate</a>(<a href="#21822" title="java.io.BufferedReader">input</a>, <a href="#21836" title="java.io.BufferedWriter">output</a>, <a href="#19414" title="scala.collection.jcl.TreeSet[browse.Token]">tokens</a>, <a href="#19415" title="browse.Styler">styler</a>).<a href="#21846" title="()Unit">annotate</a>()
			}
		}
	}
}
<span class="comment">/** Annotates a source file.  This class is one-time use and should only be used through the Annotate module.
*
*  'input' is the raw source file.
* The annotated file will be written to 'output'
* The information associated with a file is defined by 'tokens'
* 'styler' generates the final annotations for a token 
*
* Note that the 'write' method in this class is specific to HTML and would
* need to be generalized for another format */</span>
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class Annotate extends java.lang.Object with NotNull with ScalaObject" id="6217">Annotate</a>(<span id="21841"><a title="java.io.Reader" id="21850">input</a></span>: <a title="java.io.Reader" id="3498">Reader</a>, <span id="21842"><a title="java.io.Writer" id="21851">output</a></span>: <a title="java.io.Writer" id="3747">Writer</a>, <span id="21843"><a title="scala.collection.jcl.TreeSet[browse.Token]" id="21852">tokens</a></span>: <a title="scala.collection.jcl.TreeSet[browse.Token]" id="10489">TreeSet</a>[Token], <span id="21844"><a title="browse.Styler" id="21853">styler</a></span>: <a href="Styler.scala.html#6193" title="browse.Styler">Styler</a>) <span class="keyword">extends</span> <a title="NotNull" id="181">NotNull</a>
{
	<span class="comment">/** Applies the annotations.*/</span>
	<span class="keyword">def</span> <a title="()Unit" id="21846">annotate</a>()
	{
		<a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<a href="#21844" title="browse.Styler">styler</a>.<a href="Styler.scala.html#19387" title="=&gt; String">head</a>)
		<a href="#21847" title="(Int)Unit">annotate</a>(<span title="Int(0)" class="int">0</span>)
		<a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<a href="#21844" title="browse.Styler">styler</a>.<a href="Styler.scala.html#19389" title="=&gt; String">tail</a>)
	}
	<span class="comment">/** Applies annotations.  index is the current position in the source file. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Int)Unit" id="21847">annotate</a>(<a title="Int" id="22140">index</a>: <a title="Int" id="2346">Int</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#21843" title="scala.collection.jcl.TreeSet[browse.Token]">tokens</a>.<a title="=&gt; Boolean" id="18282">isEmpty</a>) <span class="comment">// no more tokens, copy the remaining characters over</span>
			<a href="#21848" title="(Int)Unit">transfer</a>(java.lang.Integer.<span title="Int(2147483647)">MAX_VALUE</span>)
		<span class="keyword">else</span>
		{
			<span class="comment">//look at the next token</span>
			<span class="keyword">val</span> <a title="browse.Token" id="22155">token</a> = <a href="#21843" title="scala.collection.jcl.TreeSet[browse.Token]">tokens</a>.<a title="=&gt; browse.Token" id="17573">firstKey</a>
			<a href="#21843" title="scala.collection.jcl.TreeSet[browse.Token]">tokens</a>.<a title="(browse.Token)Boolean" id="18304">remove</a>(<a href="#22155" title="browse.Token">token</a>)
			<span title="Unit" class="keyword">if</span>(<a href="#22155" title="browse.Token">token</a>.<a href="Token.scala.html#18317" title="=&gt; Int">start</a> <a title="(Int)Boolean" id="3086">&lt;</a> <a href="#22140" title="Int">index</a>)
			{
				<span id="6038"><a title="(Any)Unit" id="779">println</a></span>(<span title="java.lang.String(&quot;Overlapping span detected at index &quot;)" class="string">&quot;Overlapping span detected at index &quot;</span> <a title="(Any)java.lang.String" id="5736">+</a> <a href="#22140" title="Int">index</a> <a title="(Any)java.lang.String" id="5736">+</a> <span title="java.lang.String(&quot;: &quot;)" class="string">&quot;: &quot;</span> <a title="(Any)java.lang.String" id="5736">+</a> <a href="#22155" title="browse.Token">token</a>)
				<a href="#21847" title="(Int)Unit">annotate</a>(<a href="#22140" title="Int">index</a>)
			}
			<span class="keyword">else</span>
			{
				<span class="comment">// copy over characters not to be annotated </span>
				<a href="#21848" title="(Int)Unit">transfer</a>(<a href="#22155" title="browse.Token">token</a>.<a href="Token.scala.html#18317" title="=&gt; Int">start</a> <a title="(Int)Int" id="3091">-</a> <a href="#22140" title="Int">index</a>)
				<span class="comment">// get the annotations for the token from the styler</span>
				<span class="keyword">val</span> <a title="List[browse.Annotation]" id="22159">styledList</a> = <a href="Styler.scala.html#19388" title="(browse.Token)List[browse.Annotation]">styler</a>(<a href="#22155" title="browse.Token">token</a>)
				<span class="comment">// write all opening tags</span>
				<span class="keyword">for</span>(<span id="11184"><a title="((browse.Annotation) =&gt; Unit)Unit" id="22175">styled</a></span> &lt;- <a href="#22159" title="List[browse.Annotation]">styledList</a>)
					<a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<a href="#22175" title="browse.Annotation">styled</a>.<a href="Styler.scala.html#20558" title="=&gt; String">open</a>)
				<span class="comment">// copy the annotated content</span>
				<a href="#21848" title="(Int)Unit">transfer</a>(<a href="#22155" title="browse.Token">token</a>.<a href="Token.scala.html#18319" title="=&gt; Int">length</a>)
				<span class="comment">// close the tags</span>
				<span class="keyword">for</span>(<span id="11184"><a title="((browse.Annotation) =&gt; Unit)Unit" id="22180">styled</a></span> &lt;- <a href="#22159" title="List[browse.Annotation]">styledList</a>.<a title="=&gt; List[browse.Annotation]" id="11203">reverse</a>)
					<a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<a href="#22180" title="browse.Annotation">styled</a>.<a href="Styler.scala.html#20560" title="=&gt; String">close</a>)
				<span class="comment">// continue</span>
				<a href="#21847" title="(Int)Unit">annotate</a>(<a href="#22155" title="browse.Token">token</a>.<a href="Token.scala.html#18317" title="=&gt; Int">start</a> <a title="(Int)Int" id="3090">+</a> <a href="#22155" title="browse.Token">token</a>.<a href="Token.scala.html#18319" title="=&gt; Int">length</a>)
			}
			
		}
	}
	
	<span class="comment">/** Transfers the given number of characters from the input to the output unless the input does not have enough
	* characters, in which case all remaining characters are transferred.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Int)Unit" id="21848">transfer</a>(<a title="Int" id="22154">chars</a>: <a title="Int" id="2346">Int</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#22154" title="Int">chars</a> <a title="(Int)Boolean" id="3088">&gt;</a> <span title="Int(0)" class="int">0</span>)
		{
			<span class="keyword">val</span> <a title="Int" id="22203">c</a> = <a href="#21841" title="java.io.Reader">input</a>.<a title="()Int" id="22108">read</a>()
			<span title="Unit" class="keyword">if</span>(<a href="#22203" title="Int">c</a> <a title="(Int)Boolean" id="3089">&gt;=</a> <span title="Int(0)" class="int">0</span>)
			{
				<a href="#21849" title="(Char)Unit">write</a>(<a href="#22203" title="Int">c</a>.<a title="Char" id="3446">asInstanceOf</a>[<a title="Char" id="2341">Char</a>])
				<a href="#21848" title="(Int)Unit">transfer</a>(<a href="#22154" title="Int">chars</a> <a title="(Int)Int" id="3091">-</a> <span title="Int(1)" class="int">1</span>)
			}
		}
	}
	<span class="comment">/** Writes the given character to the output, escaping to HTML it if necessary.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Char)Unit" id="21849">write</a>(<a title="Char" id="22287">c</a>: <a title="Char" id="2341">Char</a>)
	{
		<a href="#22287" title="Char">c</a> <span title="Unit" class="keyword">match</span>
		{
			<span title="Unit" class="keyword">case</span> <span title="Char('&gt;')" class="char">'&gt;'</span> =&gt; <a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<span title="java.lang.String(&quot;&amp;gt;&quot;)" class="string">&quot;&amp;gt;&quot;</span>)
			<span title="Unit" class="keyword">case</span> <span title="Char('&amp;')" class="char">'&amp;'</span> =&gt; <a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<span title="java.lang.String(&quot;&amp;amp;&quot;)" class="string">&quot;&amp;amp;&quot;</span>)
			<span title="Unit" class="keyword">case</span> <span title="Char('&lt;')" class="char">'&lt;'</span> =&gt; <a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<span title="java.lang.String(&quot;&amp;lt;&quot;)" class="string">&quot;&amp;lt;&quot;</span>)
			<span title="Unit" class="keyword">case</span> <span title="Char('&quot;')" class="char">'&quot;'</span> =&gt; <a href="#21842" title="java.io.Writer">output</a>.<a title="(java.lang.String)Unit" id="22123">write</a>(<span title="java.lang.String(&quot;&amp;quot;&quot;)" class="string">&quot;&amp;quot;&quot;</span>)
			<span title="Unit" class="keyword">case</span> _ =&gt; <a href="#21842" title="java.io.Writer">output</a>.<a title="(Int)Unit" id="22120">write</a>(<span id="6133"><a href="#22287" title="implicit scala.Predef.char2int : (Char)Int" id="779">c</a></span>)
		}
	}
	
}

        </pre>
    </body>
</html>