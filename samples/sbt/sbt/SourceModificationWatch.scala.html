<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>sbt/SourceModificationWatch.scala</title>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2009  Mikko Peltonen, Mark Harrah
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">object</span> <span class="typed"><span class="type">object sbt.SourceModificationWatch</span><a id="6676">SourceModificationWatch</a></span>
{
	<span class="keyword">def</span> <span class="typed"><span class="type">(sbt.Project,Int)(=&gt; Boolean)(=&gt; Unit)Unit</span><a id="54333">watchUntil</a></span>(<span class="typed"><span class="type">sbt.Project</span><a id="54334">project</a></span>: <span class="typed"><span class="type">sbt.Project</span><a href="Project.scala.html#6494">Project</a></span>, <span class="typed"><span class="type">Int</span><a id="54335">pollDelaySec</a></span>: <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span>)(<span class="typed"><span class="type">=&gt; Boolean</span><a id="54336">terminationCondition</a></span>: =&gt; Boolean)(<span class="typed"><span class="type">=&gt; Unit</span><a id="54337">onSourcesModified</a></span>: =&gt; Unit)
	{
		<span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Iterable[java.io.File]</span><a id="55615">sourceFiles</a></span>: <span class="typed"><span class="type">Iterable[java.io.File]</span><a id="384">Iterable</a></span>[java.io.File] =
			<span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a href="#55616">sourcesFinder</a></span>.<span class="typed"><span class="type">=&gt; scala.collection.Set[sbt.Path]</span><a href="Path.scala.html#9627">get</a></span>.<span class="typed"><span class="type">((sbt.Path) =&gt; Option[sbt.Path])Iterable[Option[sbt.Path]]</span><a id="7355">map</a></span>(<span class="typed"><span class="type">object sbt.Path</span><a href="Path.scala.html#6800">Path</a></span>.<span class="typed"><span class="type">(sbt.Path,sbt.Path)Option[sbt.Path]</span><a href="Path.scala.html#9611">relativize</a></span>(<span class="typed"><span class="type">sbt.Project</span><a href="#54334">project</a></span>.<span class="typed"><span class="type">=&gt; sbt.ProjectInfo</span><a href="Project.scala.html#25088">info</a></span>.<span class="typed"><span class="type">=&gt; sbt.ProjectDirectory</span><a href="ProjectInfo.scala.html#29287">projectPath</a></span>, <span class="typed"><span class="type">sbt.Path</span><a href="#55620">_</a></span>)).<span class="typed"><span class="type">((Option[sbt.Path]) =&gt; Boolean)Iterable[Option[sbt.Path]]</span><a id="7359">filter</a></span>(<span class="typed"><span class="type">Option[sbt.Path]</span><a href="#55624">_</a></span>.<span class="typed"><span class="type">=&gt; Boolean</span><a id="10260">isDefined</a></span>).<span class="typed"><span class="type">((Option[sbt.Path]) =&gt; java.io.File)Iterable[java.io.File]</span><a id="7355">map</a></span>(<span class="typed"><span class="type">Option[sbt.Path]</span><a href="#55627">_</a></span>.<span class="typed"><span class="type">=&gt; sbt.Path</span><a id="10261">get</a></span>.<span class="typed"><span class="type">=&gt; java.io.File</span><a href="Path.scala.html#9638">asFile</a></span>)
	
		<span class="keyword">def</span> <span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a id="55616">sourcesFinder</a></span>: <span class="typed"><span class="type">sbt.PathFinder</span><a href="Path.scala.html#6802">PathFinder</a></span> = <span class="typed"><span class="type">sbt.Project</span><a href="#54334">project</a></span>.<span class="typed"><span class="type">=&gt; List[sbt.Project]</span><a href="Dag.scala.html#25364">topologicalSort</a></span>.<span class="typed"><span class="type">(sbt.PathFinder)((sbt.PathFinder, sbt.Project) =&gt; sbt.PathFinder)sbt.PathFinder</span><a id="6948">foldLeft</a></span>(<span class="typed"><span class="type">object sbt.Path</span><a href="Path.scala.html#6800">Path</a></span>.<span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a href="Path.scala.html#9604">emptyPathFinder</a></span>) {
			(<span class="typed"><span class="type">sbt.PathFinder</span><a id="55635">acc</a></span>, <span class="typed"><span class="type">sbt.Project</span><a id="55636">prj</a></span>) =&gt; <span class="typed"><span class="type">sbt.PathFinder</span><a href="#55635">acc</a></span> <span class="typed"><span class="type">(sbt.PathFinder)sbt.PathFinder</span><a href="Path.scala.html#9619">+++</a></span> (<span class="typed"><span class="type">sbt.Project</span><a href="#55636">prj</a></span> <span class="typed"><span class="type">sbt.PathFinder</span><span class="keyword">match</span></span> {
				<span class="typed"><span class="type">sbt.PathFinder</span><span class="keyword">case</span></span> <span class="typed"><span class="type">sbt.BasicScalaProject</span><a id="55637">prj</a></span>: <span class="typed"><span class="type">sbt.BasicScalaProject</span><a href="DefaultProject.scala.html#6827">BasicScalaProject</a></span> =&gt; <span class="typed"><span class="type">sbt.BasicScalaProject</span><a href="#55637">prj</a></span>.<span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a href="DefaultProject.scala.html#25247">mainSources</a></span> <span class="typed"><span class="type">(sbt.PathFinder)sbt.PathFinder</span><a href="Path.scala.html#9619">+++</a></span> <span class="typed"><span class="type">sbt.BasicScalaProject</span><a href="#55637">prj</a></span>.<span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a href="DefaultProject.scala.html#25248">testSources</a></span>
				<span class="typed"><span class="type">sbt.PathFinder</span><span class="keyword">case</span></span> _ =&gt; <span class="typed"><span class="type">object sbt.Path</span><a href="Path.scala.html#6800">Path</a></span>.<span class="typed"><span class="type">=&gt; sbt.PathFinder</span><a href="Path.scala.html#9604">emptyPathFinder</a></span>
			})
		}
		<span class="keyword">def</span> <span class="typed"><span class="type">(Long,Int)Unit</span><a id="55617">loop</a></span>(<span class="typed"><span class="type">Long</span><a id="55650">lastCallbackCallTime</a></span>: <span class="typed"><span class="type">Long</span><a id="2380">Long</a></span>, <span class="typed"><span class="type">Int</span><a id="55651">previousFileCount</a></span>: <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span>)
		{
			<span class="keyword">val</span> <span class="typed"><span class="type">(Long, Int)</span><span id="9362"><a href="#55826" id="1360">(</a></span></span><span class="typed"><span class="type">Long</span><span id="55826"><span id="55653"><a href="#55652" id="9351">lastModifiedTime</a></span></span></span>, <span class="typed"><span class="type">Int</span><span id="55827"><span id="55654"><a href="#55652" id="9353">fileCount</a></span></span></span>) = <span class="typed"><span class="type">=&gt; Iterable[java.io.File]</span><a href="#55615">sourceFiles</a></span>.<span class="typed"><span class="type">((Long, Int))(((Long, Int), java.io.File) =&gt; (Long, Int))(Long, Int)</span><a id="7372">foldLeft</a></span>(<span class="typed"><span class="type">(Long,Int)(Long, Int)</span><span id="9362"><a id="1360">(</a></span></span><span class="typed"><span class="type">Long(0L)</span><span class="long">0L</span></span>, <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)){(<span class="typed"><span class="type">(Long, Int)</span><a id="55660">acc</a></span>, <span class="typed"><span class="type">java.io.File</span><a id="55661">file</a></span>) =&gt; <span class="typed"><span class="type">(Long,Int)(Long, Int)</span><span id="9362"><a id="1360">(</a></span></span><span class="typed"><span class="type">object Math</span><a id="589">Math</a></span>.<span class="typed"><span class="type">(Long,Long)Long</span><a id="55739">max</a></span>(<span class="typed"><span class="type">(Long, Int)</span><a href="#55660">acc</a></span>.<span class="typed"><span class="type">=&gt; Long</span><a id="9351">_1</a></span>, <span class="typed"><span class="type">java.io.File</span><a href="#55661">file</a></span>.<span class="typed"><span class="type">()Long</span><a id="9672">lastModified</a></span>), <span class="typed"><span class="type">(Long, Int)</span><a href="#55660">acc</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="9353">_2</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3128">+</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>)}
			<span class="keyword">val</span> <span class="typed"><span class="type">Long</span><a id="55655">newCallbackCallTime</a></span> =
				<span class="comment">// check if sources are modified</span>
				<span class="typed"><span class="type">Long</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Long</span><a href="#55653">lastModifiedTime</a></span> <span class="typed"><span class="type">(Long)Boolean</span><a id="3249">&gt;</a></span> <span class="typed"><span class="type">Long</span><a href="#55650">lastCallbackCallTime</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2731">||</a></span> <span class="typed"><span class="type">Int</span><a href="#55651">previousFileCount</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3123">!=</a></span> <span class="typed"><span class="type">Int</span><a href="#55654">fileCount</a></span>)
				{
					<span class="keyword">val</span> <span class="typed"><span class="type">Long</span><a id="55832">now</a></span> = <span class="typed"><span class="type">object java.lang.System</span><a id="1867">System</a></span>.<span class="typed"><span class="type">()Long</span><a id="26413">currentTimeMillis</a></span>
					<span class="typed"><span class="type">=&gt; Unit</span><a href="#54337">onSourcesModified</a></span>
					<span class="typed"><span class="type">Long</span><a href="#55832">now</a></span>
				}
				<span class="keyword">else</span>
					<span class="typed"><span class="type">Long</span><a href="#55650">lastCallbackCallTime</a></span>
			<span class="typed"><span class="type">object java.lang.Thread</span><a id="2065">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="36635">sleep</a></span>(<span class="typed"><span class="type">Int</span><a href="#54335">pollDelaySec</a></span> <span class="typed"><span class="type">implicit scala.Predef.int2long : (Int)Long</span><span id="6176"><span id="802"><a id="3130">*</a></span></span></span> <span class="typed"><span class="type">Int(1000)</span><span class="int">1000</span></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">=&gt; Boolean</span><a id="2728">!</a></span><span class="typed"><span class="type">=&gt; Boolean</span><a href="#54336">terminationCondition</a></span>)
				<span class="typed"><span class="type">(Long,Int)Unit</span><a href="#55617">loop</a></span>(<span class="typed"><span class="type">Long</span><a href="#55655">newCallbackCallTime</a></span>, <span class="typed"><span class="type">Int</span><a href="#55654">fileCount</a></span>)
		}
		<span class="typed"><span class="type">(Long,Int)Unit</span><a href="#55617">loop</a></span>(<span class="typed"><span class="type">Long(0L)</span><span class="long">0L</span></span>, <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
	}
}
        </pre>
    </body>
</html>