<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>sbt/TrapExit.scala</title>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2008 Mark Harrah
 *
 * Partially based on exit trapping in Nailgun by Pete Kirkham,
 * copyright 2004, Martian Software, Inc
 * licensed under Apache 2.0 License.
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">import</span> scala.collection.Set

<span class="comment">/** This provides functionality to catch System.exit calls to prevent the JVM from terminating.
* This is useful for executing user code that may call System.exit, but actually exiting is
* undesirable.  This file handles the call to exit by disposing all top-level windows and interrupting
* all user started threads.  It does not stop the threads and does not call shutdown hooks.  It is
* therefore inappropriate to use this with code that requires shutdown hooks or creates threads that
* do not terminate.  This category of code should only be called by forking the JVM. */</span>
<span class="keyword">object</span> <a title="object sbt.TrapExit" id="6408">TrapExit</a>
{
	<span class="comment">/** Executes the given thunk in a context where System.exit(code) throws
	* a custom SecurityException, which is then caught and the exit code returned
	* in Left.  Otherwise, the result of calling execute is returned. No other
	* exceptions are handled by this method.*/</span>
	<span class="keyword">def</span> <a title="[T](=&gt; T,sbt.Logger)Either[Int,T]" id="43031">apply</a>[<a title="&gt;: Nothing &lt;: Any" id="43033">T</a>](<a title="=&gt; T" id="43043">execute</a>: =&gt; T, <a title="sbt.Logger" id="43044">log</a>: <a href="Logger.scala.html#6667" title="sbt.Logger">Logger</a>): <a title="Either[Int,T]" id="322">Either</a>[Int, T] =
	{
		<span class="keyword">val</span> <a title="java.lang.SecurityManager" id="47551">originalSecurityManager</a> = <a title="object java.lang.System" id="1776">System</a>.<a title="()java.lang.SecurityManager" id="24450">getSecurityManager</a>
		<span class="keyword">val</span> <a title="sbt.TrapExitSecurityManager" id="47552">newSecurityManager</a> = <span title="sbt.TrapExitSecurityManager" class="keyword">new</span> <a href="#6411" title="sbt.TrapExitSecurityManager">TrapExitSecurityManager</a>(<a href="#47551" title="java.lang.SecurityManager">originalSecurityManager</a>)
		<a title="object java.lang.System" id="1776">System</a>.<a title="(java.lang.SecurityManager)Unit" id="24449">setSecurityManager</a>(<a href="#47552" title="sbt.TrapExitSecurityManager">newSecurityManager</a>)
		
		<span class="comment">/** Take a snapshot of the threads that existed before execution in order to determine
		* the threads that were created by 'execute'.*/</span>
		<span class="keyword">val</span> <a title="scala.collection.Set[java.lang.Thread]" id="47553">originalThreads</a> = <a href="#43038" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>
		
		<span class="keyword">val</span> <a title="&lt;refinement&gt; extends Either[Int,T] with Product" id="47554">result</a> =
			<span class="keyword">try</span> { <span id="29414"><a title="(T)Right[Nothing,T]" id="476">Right</a></span>(<a href="#43043" title="=&gt; T">execute</a>) }
			<span class="keyword">catch</span> { <span title="Left[Int,Nothing]" class="keyword">case</span> <a title="java.lang.Throwable" id="47617">t</a>: <a title="Throwable" id="2033">Throwable</a> =&gt; <span id="29944"><a title="(Int)Left[Int,Nothing]" id="1130">Left</a></span>(<a href="#43036" title="(Throwable)Int">exitCode</a>(<a href="#47617" title="java.lang.Throwable">t</a>)) }
		<span class="keyword">val</span> <a title="&lt;refinement&gt; extends Either[Int,T] with Product" id="47555">newResult</a> =
			<a href="#47554" title="&lt;refinement&gt; extends Either[Int,T] with Product">result</a> <span title="&lt;refinement&gt; extends Either[Int,T] with Product" class="keyword">match</span>
			{
				<span title="&lt;refinement&gt; extends Either[Int,T] with Product" class="keyword">case</span> <a id="1">Right</a>(<a title="T" id="47633">r</a>) =&gt;
				{
					<span class="comment">/** In this case, the code completed without calling System.exit.  It possibly started other threads
					* and so we replace the uncaught exception handlers on those threads to handle System.exit.  Then we
					* wait for those threads to die.*/</span>
					<span class="keyword">val</span> <a title="sbt.ExitCode" id="47634">code</a> = <span title="sbt.ExitCode" class="keyword">new</span> <a href="#6410" title="sbt.ExitCode">ExitCode</a>
					<a href="#43040" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#47553" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a title="java.lang.Thread" id="47644">thread</a> =&gt; <a href="#43035" title="(java.lang.Thread,scala.collection.Set[java.lang.Thread],sbt.ExitCode)Unit">replaceHandler</a>(<a href="#47644" title="java.lang.Thread">thread</a>, <a href="#47553" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#47634" title="sbt.ExitCode">code</a>))
					<a href="#43040" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#47553" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a title="java.lang.Thread" id="47649">thread</a> =&gt; <a href="#43034" title="(java.lang.Thread,sbt.Logger)Unit">waitOnThread</a>(<a href="#47649" title="java.lang.Thread">thread</a>, <a href="#43044" title="sbt.Logger">log</a>))
					<a href="#47634" title="sbt.ExitCode">code</a>.<a href="#47640" title="=&gt; Option[Int]">value</a> <span title="&lt;refinement&gt; extends Either[Int,T] with Product" class="keyword">match</span>
					{
						<span title="Left[Int,Nothing]" class="keyword">case</span> <a id="1">Some</a>(<a title="Int" id="47653">exitCode</a>) =&gt; <span id="29944"><a title="(Int)Left[Int,Nothing]" id="1130">Left</a></span>(<a href="#47653" title="Int">exitCode</a>)
						<span title="&lt;refinement&gt; extends Either[Int,T] with Product" class="keyword">case</span> <a title="object None" id="488">None</a> =&gt; <a href="#47554" title="&lt;refinement&gt; extends Either[Int,T] with Product">result</a>
					}
				}
				<span title="&lt;refinement&gt; extends Either[Int,T] with Product" class="keyword">case</span> <a id="1">Left</a>(<a title="Int" id="47656">code</a>) =&gt;
				{
					<span class="comment">/** The other case is that the code directly called System.exit.  In this case, we dispose all
					* top-level windows and interrupt user-started threads.*/</span>
					<a href="#43041" title="(scala.collection.Set[java.lang.Thread])Unit">stopAll</a>(<a href="#47553" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
					<a href="#47554" title="&lt;refinement&gt; extends Either[Int,T] with Product">result</a>
				}
			}
			
		<a title="object java.lang.System" id="1776">System</a>.<a title="(java.lang.SecurityManager)Unit" id="24449">setSecurityManager</a>(<a href="#47551" title="java.lang.SecurityManager">originalSecurityManager</a>)

		<a href="#47555" title="&lt;refinement&gt; extends Either[Int,T] with Product">newResult</a>
	}
	<span class="comment">/** Waits for the given thread to exit. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread,sbt.Logger)Unit" id="43034">waitOnThread</a>(<a title="java.lang.Thread" id="47650">thread</a>: <a title="java.lang.Thread" id="1973">Thread</a>, <a title="sbt.Logger" id="47651">log</a>: <a href="Logger.scala.html#6667" title="sbt.Logger">Logger</a>)
	{
		<a href="#47651" title="sbt.Logger">log</a>.<a href="Logger.scala.html#8351" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;Waiting for thread &quot;)" class="string">&quot;Waiting for thread &quot;</span> <a title="(Any)java.lang.String" id="5683">+</a> <a href="#47650" title="java.lang.Thread">thread</a>.<a title="()java.lang.String" id="35666">getName</a> <a title="(Any)java.lang.String" id="5683">+</a> <span title="java.lang.String(&quot; to exit&quot;)" class="string">&quot; to exit&quot;</span>)
		<a href="#47650" title="java.lang.Thread">thread</a>.<a title="()Unit" id="35673">join</a>
		<a href="#47651" title="sbt.Logger">log</a>.<a href="Logger.scala.html#8351" title="(=&gt; String)Unit">debug</a>(<span title="java.lang.String(&quot;\011Thread &quot;)" class="string">&quot;\tThread &quot;</span> <a title="(Any)java.lang.String" id="5683">+</a> <a href="#47650" title="java.lang.Thread">thread</a>.<a title="()java.lang.String" id="35666">getName</a> <a title="(Any)java.lang.String" id="5683">+</a> <span title="java.lang.String(&quot; exited.&quot;)" class="string">&quot; exited.&quot;</span>)
	}
	<span class="comment">/** Replaces the uncaught exception handler with one that handles the SecurityException thrown by System.exit and
	* otherwise delegates to the original handler*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread,scala.collection.Set[java.lang.Thread],sbt.ExitCode)Unit" id="43035">replaceHandler</a>(<a title="java.lang.Thread" id="47645">thread</a>: <a title="java.lang.Thread" id="1973">Thread</a>, <a title="scala.collection.Set[java.lang.Thread]" id="47646">originalThreads</a>: <a title="scala.collection.Set[java.lang.Thread]" id="7387">Set</a>[Thread], <a title="sbt.ExitCode" id="47647">code</a>: <a href="#6410" title="sbt.ExitCode">ExitCode</a>)
	{
		<a href="#47645" title="java.lang.Thread">thread</a>.<a title="(java.lang.Thread.UncaughtExceptionHandler)Unit" id="35691">setUncaughtExceptionHandler</a>(<span title="sbt.TrapExit.ExitHandler" class="keyword">new</span> <a href="#43042" title="sbt.TrapExit.ExitHandler">ExitHandler</a>(<a href="#47645" title="java.lang.Thread">thread</a>.<a title="()java.lang.Thread.UncaughtExceptionHandler" id="35690">getUncaughtExceptionHandler</a>, <a href="#47646" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a href="#47647" title="sbt.ExitCode">code</a>))
	}
	<span class="comment">/** Returns the exit code of the System.exit that caused the given Exception, or rethrows the exception
	* if its cause was not calling System.exit.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(Throwable)Int" id="43036">exitCode</a>(<a title="Throwable" id="47620">e</a>: <a title="Throwable" id="2033">Throwable</a>): <a title="Int" id="2296">Int</a> =
	{
		<a href="#47620" title="Throwable">e</a> <span title="Int" class="keyword">match</span>
		{
			<span title="Int" class="keyword">case</span> <a title="sbt.TrapExitSecurityException" id="47671">x</a>: <a href="#6412" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a> =&gt; <a href="#47671" title="sbt.TrapExitSecurityException">x</a>.<a href="#47677" title="=&gt; Int">exitCode</a>
			<span title="Int" class="keyword">case</span> _ =&gt; 
			{
				<span class="keyword">val</span> <a title="java.lang.Throwable" id="47693">cause</a> = <a href="#47620" title="Throwable">e</a>.<a title="()java.lang.Throwable" id="9275">getCause</a>
				<span title="Int" class="keyword">if</span>(<a href="#47693" title="java.lang.Throwable">cause</a> <a title="(AnyRef)Boolean" id="3399">==</a> <span title="Null(null)" class="keyword">null</span>)
					<span title="Nothing" class="keyword">throw</span> <a href="#47620" title="Throwable">e</a>
				<span class="keyword">else</span>
					<a href="#43036" title="(Throwable)Int">exitCode</a>(<a href="#47693" title="java.lang.Throwable">cause</a>)
			}
		}
	}
	
	<span class="keyword">import</span> scala.collection.jcl.Conversions.convertSet
	<span class="comment">/** Returns all threads that are not in the 'system' thread group and are not the AWT implementation
	* thread (AWT-XAWT, AWT-Windows, ...)*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; scala.collection.Set[java.lang.Thread]" id="43038">allThreads</a>: <a title="scala.collection.Set[java.lang.Thread]" id="7387">Set</a>[Thread] =
	{
		<span class="keyword">val</span> <a title="&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]" id="47695">threads</a> = <span id="23299"><a title="(java.util.Set[java.lang.Thread])java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]" id="7676">convertSet</a></span>(<a title="object java.lang.Thread" id="1974">Thread</a>.<a title="()java.util.Map[java.lang.Thread,Array[java.lang.StackTraceElement]]" id="35685">getAllStackTraces</a>.<a title="()java.util.Set[java.lang.Thread]" id="21904">keySet</a>)
		<span class="keyword">for</span>(<span id="6839"><span id="6840"><span id="47712"><a title="((java.lang.Thread) =&gt; Unit)Unit" id="47725">thread</a></span></span></span> &lt;- <a href="#47695" title="&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]">threads</a>.<a title="=&gt; List[java.lang.Thread]" id="7279">toList</a> <span class="keyword">if</span> <a href="#43039" title="(java.lang.Thread)Boolean">isSystemThread</a>(<a href="#47712" title="java.lang.Thread">thread</a>))
			<a href="#47695" title="&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]">threads</a> <a title="(java.lang.Thread)Unit" id="23644">-=</a> <a href="#47725" title="java.lang.Thread">thread</a>
		<a href="#47695" title="&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]">threads</a>
	}
	<span class="comment">/** Returns true if the given thread is in the 'system' thread group and is an AWT thread other than
	* AWT-EventQueue or AWT-Shutdown.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.Thread)Boolean" id="43039">isSystemThread</a>(<a title="java.lang.Thread" id="47713">t</a>: <a title="java.lang.Thread" id="1973">Thread</a>) =
	{
		<span class="keyword">val</span> <a title="java.lang.String" id="47715">name</a> = <a href="#47713" title="java.lang.Thread">t</a>.<a title="()java.lang.String" id="35666">getName</a>
		<span title="Boolean" class="keyword">if</span>(<a href="#47715" title="java.lang.String">name</a>.<a title="(java.lang.String)Boolean" id="5722">startsWith</a>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>))
			<a title="=&gt; Boolean" id="2637">!</a>(<a href="#47715" title="java.lang.String">name</a>.<a title="(java.lang.String)Boolean" id="5722">startsWith</a>(<span title="java.lang.String(&quot;AWT-EventQueue&quot;)" class="string">&quot;AWT-EventQueue&quot;</span>) <a title="(Boolean)Boolean" id="2640">||</a> <a href="#47715" title="java.lang.String">name</a>.<a title="(java.lang.String)Boolean" id="5722">startsWith</a>(<span title="java.lang.String(&quot;AWT-Shutdown&quot;)" class="string">&quot;AWT-Shutdown&quot;</span>))
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <a title="java.lang.ThreadGroup" id="47719">group</a> = <a href="#47713" title="java.lang.Thread">t</a>.<a title="()java.lang.ThreadGroup" id="35667">getThreadGroup</a>
			(<a href="#47719" title="java.lang.ThreadGroup">group</a> <a title="(AnyRef)Boolean" id="5674">!=</a> <span title="Null(null)" class="keyword">null</span>) <a title="(Boolean)Boolean" id="2641">&amp;&amp;</a> (<a href="#47719" title="java.lang.ThreadGroup">group</a>.<a title="()java.lang.String" id="45748">getName</a> <a title="(AnyRef)Boolean" id="3399">==</a> <span title="java.lang.String(&quot;system&quot;)" class="string">&quot;system&quot;</span>)
		}
	}
	<span class="comment">/** Calls the provided function for each thread in the system as provided by the 
	* allThreads function except those in ignoreThreads.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit" id="43040">processThreads</a>(<a title="scala.collection.Set[java.lang.Thread]" id="47641">ignoreThreads</a>: <a title="scala.collection.Set[java.lang.Thread]" id="7387">Set</a>[Thread], <a title="(java.lang.Thread) =&gt; Unit" id="47642">process</a>: Thread =&gt; Unit)
	{
		<a href="#43038" title="=&gt; scala.collection.Set[java.lang.Thread]">allThreads</a>.<a title="((java.lang.Thread) =&gt; Boolean)Iterable[java.lang.Thread]" id="7250">filter</a>(<a title="java.lang.Thread" id="47728">thread</a> =&gt; <a title="=&gt; Boolean" id="2637">!</a><a href="#47641" title="scala.collection.Set[java.lang.Thread]">ignoreThreads</a>.<a title="(java.lang.Thread)Boolean" id="21328">contains</a>(<a href="#47728" title="java.lang.Thread">thread</a>)).<a title="((java.lang.Thread) =&gt; Unit)Unit" id="7256">foreach</a>(<a href="#47642" title="(java.lang.Thread) =&gt; Unit">process</a>)
	}
	<span class="comment">/** Handles System.exit by disposing all frames and calling interrupt on all user threads */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(scala.collection.Set[java.lang.Thread])Unit" id="43041">stopAll</a>(<a title="scala.collection.Set[java.lang.Thread]" id="47657">originalThreads</a>: <a title="scala.collection.Set[java.lang.Thread]" id="7387">Set</a>[Thread])
	{
		<span class="keyword">val</span> <a title="Array[java.awt.Frame]" id="47729">allFrames</a> = java.awt.<a title="object java.awt.Frame" id="47932">Frame</a>.<a title="()Array[java.awt.Frame]" id="48610">getFrames</a>
		<span title="Unit" class="keyword">if</span>(<a href="#47729" title="Array[java.awt.Frame]">allFrames</a>.<a title="=&gt; Int" id="6981">length</a> <a title="(Int)Boolean" id="3035">&gt;</a> <span title="Int(0)" class="int">0</span>)
		{
			<a href="#47729" title="Array[java.awt.Frame]">allFrames</a>.<a title="((java.awt.Frame) =&gt; Unit)Unit" id="7256">foreach</a>(<a href="#48730" title="java.awt.Frame">_</a>.<a title="()Unit" id="48826">dispose</a>) <span class="comment">// dispose all top-level windows, which will cause the AWT-EventQueue-* threads to exit</span>
			<a title="object java.lang.Thread" id="1974">Thread</a>.<a title="(Long)Unit" id="35642">sleep</a>(<span title="Long(2000L)" class="int">2000</span>) <span class="comment">// AWT Thread doesn't exit immediately, so wait to interrupt it</span>
		}
		<span class="comment">// interrupt all threads that appear to have been started by the user</span>
		<a href="#43040" title="(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit">processThreads</a>(<a href="#47657" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>, <a title="java.lang.Thread" id="50393">thread</a> =&gt; <span title="Unit" class="keyword">if</span>(<a title="=&gt; Boolean" id="2637">!</a><a href="#50393" title="java.lang.Thread">thread</a>.<a title="()java.lang.String" id="35666">getName</a>.<a title="(java.lang.String)Boolean" id="5722">startsWith</a>(<span title="java.lang.String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span>)) <a href="#50393" title="java.lang.Thread">thread</a>.<a title="()Unit" id="35656">interrupt</a>)
	}
	<span class="comment">/** An uncaught exception handler that delegates to the original uncaught exception handler except when
	* the cause was a call to System.exit (which generated a SecurityException)*/</span>
	<span class="keyword">class</span> <a title="class ExitHandler extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject" id="43042">ExitHandler</a>(<span id="47663"><a title="java.lang.Thread.UncaughtExceptionHandler" id="47668">originalHandler</a></span>: Thread.<a title="java.lang.Thread.UncaughtExceptionHandler" id="35383">UncaughtExceptionHandler</a>, <span id="47664"><a title="scala.collection.Set[java.lang.Thread]" id="47669">originalThreads</a></span>: <a title="scala.collection.Set[java.lang.Thread]" id="7387">Set</a>[Thread], <span id="47665"><a title="sbt.ExitCode" id="47670">codeHolder</a></span>: <a href="#6410" title="sbt.ExitCode">ExitCode</a>) <span class="keyword">extends</span> Thread.<a title="java.lang.Thread.UncaughtExceptionHandler" id="35383">UncaughtExceptionHandler</a>
	{
		<span class="keyword">def</span> <a title="(java.lang.Thread,Throwable)Unit" id="47667">uncaughtException</a>(<a title="java.lang.Thread" id="50399">t</a>: <a title="java.lang.Thread" id="1973">Thread</a>, <a title="Throwable" id="50400">e</a>: <a title="Throwable" id="2033">Throwable</a>)
		{
			<span class="keyword">try</span>
			{
				<a href="#47665" title="sbt.ExitCode">codeHolder</a>.<a href="#47639" title="(Int)Unit">set</a>(<a href="#43036" title="(Throwable)Int">exitCode</a>(<a href="#50400" title="Throwable">e</a>)) <span class="comment">// will rethrow e if it was not because of a call to System.exit</span>
				<a href="#43041" title="(scala.collection.Set[java.lang.Thread])Unit">stopAll</a>(<a href="#47664" title="scala.collection.Set[java.lang.Thread]">originalThreads</a>)
			}
			<span class="keyword">catch</span>
			{
				<span title="Unit" class="keyword">case</span> _ =&gt; <a href="#47663" title="java.lang.Thread.UncaughtExceptionHandler">originalHandler</a>.<a title="(java.lang.Thread,java.lang.Throwable)Unit" id="47659">uncaughtException</a>(<a href="#50399" title="java.lang.Thread">t</a>, <a href="#50400" title="Throwable">e</a>)
			}
		}
	}
}
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class ExitCode extends java.lang.Object with NotNull with ScalaObject" id="6410">ExitCode</a> <span class="keyword">extends</span> <a title="NotNull" id="187">NotNull</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <span id="47638"><span id="47636"><span id="47637"><a title="Option[Int]" id="50403">code</a></span></span></span>: <a title="Option[Int]" id="871">Option</a>[Int] = <a title="object None" id="488">None</a>
	<span class="keyword">def</span> <a title="(Int)Unit" id="47639">set</a>(<a title="Int" id="50401">c</a>: <a title="Int" id="2296">Int</a>)
	{
		<a href="#6410" title="(Unit)Unit" id="5677">synchronized</a>
		{
			<a href="#47636" title="=&gt; Option[Int]">code</a> <span title="Unit" class="keyword">match</span>
			{
				<span title="Unit" class="keyword">case</span> <a id="1">Some</a>(<a title="Int" id="50405">existing</a>) =&gt; <span title="Unit">(</span>)
				<span title="Unit" class="keyword">case</span> <a title="object None" id="488">None</a> =&gt; <a href="#47637" title="(Option[Int])Unit">code</a> = <span id="10256"><a title="(Int)Some[Int]" id="275">Some</a></span>(<a href="#50401" title="Int">c</a>)
			}
		}
	}
	<span class="keyword">def</span> <a title="=&gt; Option[Int]" id="47640">value</a>: <a title="Option[Int]" id="871">Option</a>[Int] = <a href="#6410" title="(Option[Int])Option[Int]" id="5677">synchronized</a> { <a href="#47636" title="=&gt; Option[Int]">code</a> }
}
<span class="comment">///////  These two classes are based on similar classes in Nailgun</span>
<span class="comment">/** A custom SecurityManager to disallow System.exit. */</span>
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class TrapExitSecurityManager extends java.lang.SecurityManager with ScalaObject" id="6411">TrapExitSecurityManager</a>(<span id="47606"><a title="java.lang.SecurityManager" id="47613">delegateManager</a></span>: <a title="java.lang.SecurityManager" id="1784">SecurityManager</a>) <span class="keyword">extends</span> <a title="java.lang.SecurityManager" id="1784">SecurityManager</a>
{
	<span class="keyword">import</span> java.security.Permission
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(Int)Unit" id="47609">checkExit</a>(<a title="Int" id="50410">status</a>: <a title="Int" id="2296">Int</a>)
	{
		<span class="keyword">val</span> <a title="Array[java.lang.StackTraceElement]" id="50411">stack</a> = <a title="object java.lang.Thread" id="1974">Thread</a>.<a title="()java.lang.Thread" id="35640">currentThread</a>.<a title="()Array[java.lang.StackTraceElement]" id="35682">getStackTrace</a>
		<span title="Unit" class="keyword">if</span>(<a href="#50411" title="Array[java.lang.StackTraceElement]">stack</a> <a title="(AnyRef)Boolean" id="3399">==</a> <span title="Null(null)" class="keyword">null</span> <a title="(Boolean)Boolean" id="2640">||</a> <a href="#50411" title="Array[java.lang.StackTraceElement]">stack</a>.<a title="((java.lang.StackTraceElement) =&gt; Boolean)Boolean" id="7258">exists</a>(<a href="#47610" title="(java.lang.StackTraceElement)Boolean">isRealExit</a>))
			<span title="Nothing" class="keyword">throw</span> <span title="sbt.TrapExitSecurityException" class="keyword">new</span> <a href="#6412" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a>(<a href="#50410" title="Int">status</a>)
	}
	<span class="comment">/** This ensures that only actual calls to exit are trapped and not just calls to check if exit is allowed.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="(java.lang.StackTraceElement)Boolean" id="47610">isRealExit</a>(<a title="java.lang.StackTraceElement" id="50413">element</a>: <a title="java.lang.StackTraceElement" id="1745">StackTraceElement</a>): <a title="Boolean" id="2060">Boolean</a> =
		<a href="#50413" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="47702">getClassName</a> <a title="(AnyRef)Boolean" id="3399">==</a> <span title="java.lang.String(&quot;java.lang.Runtime&quot;)" class="string">&quot;java.lang.Runtime&quot;</span> <a title="(Boolean)Boolean" id="2641">&amp;&amp;</a> <a href="#50413" title="java.lang.StackTraceElement">element</a>.<a title="()java.lang.String" id="47703">getMethodName</a> <a title="(AnyRef)Boolean" id="3399">==</a> <span title="java.lang.String(&quot;exit&quot;)" class="string">&quot;exit&quot;</span>
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission)Unit" id="47611">checkPermission</a>(<a title="java.security.Permission" id="50421">perm</a>: <a title="java.security.Permission" id="4804">Permission</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#47606" title="java.lang.SecurityManager">delegateManager</a> <a title="(AnyRef)Boolean" id="5674">!=</a> <span title="Null(null)" class="keyword">null</span>)
			<a href="#47606" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission)Unit" id="47570">checkPermission</a>(<a href="#50421" title="java.security.Permission">perm</a>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="(java.security.Permission,AnyRef)Unit" id="47612">checkPermission</a>(<a title="java.security.Permission" id="50434">perm</a>: <a title="java.security.Permission" id="4804">Permission</a>, <a title="AnyRef" id="50435">context</a>: <a title="AnyRef" id="1907">AnyRef</a>)
	{
		<span title="Unit" class="keyword">if</span>(<a href="#47606" title="java.lang.SecurityManager">delegateManager</a> <a title="(AnyRef)Boolean" id="5674">!=</a> <span title="Null(null)" class="keyword">null</span>)
			<a href="#47606" title="java.lang.SecurityManager">delegateManager</a>.<a title="(java.security.Permission,Any)Unit" id="47571">checkPermission</a>(<a href="#50434" title="java.security.Permission">perm</a>, <a href="#50435" title="AnyRef">context</a>)
	}
}
<span class="comment">/** A custom SecurityException that tries not to be caught.*/</span>
<span class="keyword">private</span> <span class="keyword">class</span> <a title="class TrapExitSecurityException extends java.lang.SecurityException with ScalaObject" id="6412">TrapExitSecurityException</a>(<span class="keyword">val</span> <span id="47678"><span id="47677"><a title="Int" id="50416">exitCode</a></span></span>: <a title="Int" id="2296">Int</a>) <span class="keyword">extends</span> <a title="java.lang.SecurityException" id="1748">SecurityException</a>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <span id="47682"><span id="47680"><span id="47681"><a title="Boolean" id="50445">accessAllowed</a></span></span></span> = <span title="Boolean(false)" class="keyword">false</span>
	<span class="keyword">def</span> <a title="=&gt; Unit" id="47683">allowAccess</a>
	{
		<a href="#47681" title="(Boolean)Unit">accessAllowed</a> = <span title="Boolean(true)" class="keyword">true</span>
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="47684">printStackTrace</a> = <a href="#47690" title="(=&gt; Unit)Unit">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()Unit" id="9278">printStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="47685">toString</a> = <a href="#47690" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="9277">toString</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="47686">getCause</a> = <a href="#47690" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.Throwable" id="9275">getCause</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="47687">getMessage</a> = <a href="#47690" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="9273">getMessage</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.Throwable" id="47688">fillInStackTrace</a> = <a href="#47690" title="(=&gt; java.lang.Throwable)java.lang.Throwable">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.Throwable" id="9281">fillInStackTrace</a>)
	<span class="keyword">override</span> <span class="keyword">def</span> <a title="()java.lang.String" id="47689">getLocalizedMessage</a> = <a href="#47690" title="(=&gt; java.lang.String)java.lang.String">ifAccessAllowed</a>(<span class="keyword">super</span>.<a title="()java.lang.String" id="9274">getLocalizedMessage</a>)
	<span class="keyword">private</span> <span class="keyword">def</span> <a title="[T](=&gt; T)T" id="47690">ifAccessAllowed</a>[<a title="&gt;: Nothing &lt;: Any" id="47692">T</a>](<a title="=&gt; T" id="50455">f</a>: =&gt; T): <a href="#47692" title="T">T</a> =
	{
		<span title="T" class="keyword">if</span>(<a href="#47680" title="=&gt; Boolean">accessAllowed</a>)
			<a href="#50455" title="=&gt; T">f</a>
		<span class="keyword">else</span>
			<span title="Nothing" class="keyword">throw</span> <a href="#6412" title="sbt.TrapExitSecurityException" class="keyword">this</a>
	}
}
        </pre>
    </body>
</html>