<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>sbt/TrapExit.scala</title>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2008 Mark Harrah
 *
 * Partially based on exit trapping in Nailgun by Pete Kirkham,
 * copyright 2004, Martian Software, Inc
 * licensed under Apache 2.0 License.
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">import</span> scala.collection.Set

<span class="comment">/** This provides functionality to catch System.exit calls to prevent the JVM from terminating.
* This is useful for executing user code that may call System.exit, but actually exiting is
* undesirable.  This file handles the call to exit by disposing all top-level windows and interrupting
* all user started threads.  It does not stop the threads and does not call shutdown hooks.  It is
* therefore inappropriate to use this with code that requires shutdown hooks or creates threads that
* do not terminate.  This category of code should only be called by forking the JVM. */</span>
<span class="keyword">object</span> <span class="typed"><span class="type">object sbt.TrapExit</span><a id="6507">TrapExit</a></span>
{
	<span class="comment">/** Executes the given thunk in a context where System.exit(code) throws
	* a custom SecurityException, which is then caught and the exit code returned
	* in Left.  Otherwise, the result of calling execute is returned. No other
	* exceptions are handled by this method.*/</span>
	<span class="keyword">def</span> <span class="typed"><span class="type">[T](=&gt; T,sbt.Logger)Either[Int,T]</span><a id="44033">apply</a></span>[<span class="typed"><span class="type">&gt;: Nothing &lt;: Any</span><a id="44035">T</a></span>](<span class="typed"><span class="type">=&gt; T</span><a id="44045">execute</a></span>: =&gt; T, <span class="typed"><span class="type">sbt.Logger</span><a id="44046">log</a></span>: <span class="typed"><span class="type">sbt.Logger</span><a href="Logger.scala.html#6766">Logger</a></span>): <span class="typed"><span class="type">Either[Int,T]</span><a id="342">Either</a></span>[Int, T] =
	{
		<span class="keyword">val</span> <span class="typed"><span class="type">java.lang.SecurityManager</span><a id="48418">originalSecurityManager</a></span> = <span class="typed"><span class="type">object java.lang.System</span><a id="1867">System</a></span>.<span class="typed"><span class="type">()java.lang.SecurityManager</span><a id="26412">getSecurityManager</a></span>
		<span class="keyword">val</span> <span class="typed"><span class="type">sbt.TrapExitSecurityManager</span><a id="48419">newSecurityManager</a></span> = <span class="typed"><span class="type">sbt.TrapExitSecurityManager</span><span class="keyword">new</span></span> <span class="typed"><span class="type">sbt.TrapExitSecurityManager</span><a href="#6510">TrapExitSecurityManager</a></span>(<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48418">originalSecurityManager</a></span>)
		<span class="typed"><span class="type">object java.lang.System</span><a id="1867">System</a></span>.<span class="typed"><span class="type">(java.lang.SecurityManager)Unit</span><a id="26411">setSecurityManager</a></span>(<span class="typed"><span class="type">sbt.TrapExitSecurityManager</span><a href="#48419">newSecurityManager</a></span>)
		
		<span class="comment">/** Take a snapshot of the threads that existed before execution in order to determine
		* the threads that were created by 'execute'.*/</span>
		<span class="keyword">val</span> <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="48420">originalThreads</a></span> = <span class="typed"><span class="type">=&gt; scala.collection.Set[java.lang.Thread]</span><a href="#44040">allThreads</a></span>
		
		<span class="keyword">val</span> <span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a id="48421">result</a></span> =
			<span class="keyword">try</span> { <span class="typed"><span class="type">(T)Right[Nothing,T]</span><span id="30775"><a id="502">Right</a></span></span>(<span class="typed"><span class="type">=&gt; T</span><a href="#44045">execute</a></span>) }
			<span class="keyword">catch</span> { <span class="typed"><span class="type">Left[Int,Nothing]</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.Throwable</span><a id="48484">t</a></span>: <span class="typed"><span class="type">Throwable</span><a id="2124">Throwable</a></span> =&gt; <span class="typed"><span class="type">(Int)Left[Int,Nothing]</span><span id="31304"><a id="1198">Left</a></span></span>(<span class="typed"><span class="type">(Throwable)Int</span><a href="#44038">exitCode</a></span>(<span class="typed"><span class="type">java.lang.Throwable</span><a href="#48484">t</a></span>)) }
		<span class="keyword">val</span> <span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a id="48422">newResult</a></span> =
			<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a href="#48421">result</a></span> <span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><span class="keyword">match</span></span>
			{
				<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><span class="keyword">case</span></span> <a id="1">Right</a>(<span class="typed"><span class="type">T</span><a id="48500">r</a></span>) =&gt;
				{
					<span class="comment">/** In this case, the code completed without calling System.exit.  It possibly started other threads
					* and so we replace the uncaught exception handlers on those threads to handle System.exit.  Then we
					* wait for those threads to die.*/</span>
					<span class="keyword">val</span> <span class="typed"><span class="type">sbt.ExitCode</span><a id="48501">code</a></span> = <span class="typed"><span class="type">sbt.ExitCode</span><span class="keyword">new</span></span> <span class="typed"><span class="type">sbt.ExitCode</span><a href="#6509">ExitCode</a></span>
					<span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit</span><a href="#44042">processThreads</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48420">originalThreads</a></span>, <span class="typed"><span class="type">java.lang.Thread</span><a id="48511">thread</a></span> =&gt; <span class="typed"><span class="type">(java.lang.Thread,scala.collection.Set[java.lang.Thread],sbt.ExitCode)Unit</span><a href="#44037">replaceHandler</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#48511">thread</a></span>, <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48420">originalThreads</a></span>, <span class="typed"><span class="type">sbt.ExitCode</span><a href="#48501">code</a></span>))
					<span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit</span><a href="#44042">processThreads</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48420">originalThreads</a></span>, <span class="typed"><span class="type">java.lang.Thread</span><a id="48516">thread</a></span> =&gt; <span class="typed"><span class="type">(java.lang.Thread,sbt.Logger)Unit</span><a href="#44036">waitOnThread</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#48516">thread</a></span>, <span class="typed"><span class="type">sbt.Logger</span><a href="#44046">log</a></span>))
					<span class="typed"><span class="type">sbt.ExitCode</span><a href="#48501">code</a></span>.<span class="typed"><span class="type">=&gt; Option[Int]</span><a href="#48507">value</a></span> <span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><span class="keyword">match</span></span>
					{
						<span class="typed"><span class="type">Left[Int,Nothing]</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">Int</span><a id="48520">exitCode</a></span>) =&gt; <span class="typed"><span class="type">(Int)Left[Int,Nothing]</span><span id="31304"><a id="1198">Left</a></span></span>(<span class="typed"><span class="type">Int</span><a href="#48520">exitCode</a></span>)
						<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a id="517">None</a></span> =&gt; <span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a href="#48421">result</a></span>
					}
				}
				<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><span class="keyword">case</span></span> <a id="1">Left</a>(<span class="typed"><span class="type">Int</span><a id="48523">code</a></span>) =&gt;
				{
					<span class="comment">/** The other case is that the code directly called System.exit.  In this case, we dispose all
					* top-level windows and interrupt user-started threads.*/</span>
					<span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread])Unit</span><a href="#44043">stopAll</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48420">originalThreads</a></span>)
					<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a href="#48421">result</a></span>
				}
			}
			
		<span class="typed"><span class="type">object java.lang.System</span><a id="1867">System</a></span>.<span class="typed"><span class="type">(java.lang.SecurityManager)Unit</span><a id="26411">setSecurityManager</a></span>(<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48418">originalSecurityManager</a></span>)

		<span class="typed"><span class="type">&lt;refinement&gt; extends Either[Int,T] with Product</span><a href="#48422">newResult</a></span>
	}
	<span class="comment">/** Waits for the given thread to exit. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.Thread,sbt.Logger)Unit</span><a id="44036">waitOnThread</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a id="48517">thread</a></span>: <span class="typed"><span class="type">java.lang.Thread</span><a id="2064">Thread</a></span>, <span class="typed"><span class="type">sbt.Logger</span><a id="48518">log</a></span>: <span class="typed"><span class="type">sbt.Logger</span><a href="Logger.scala.html#6766">Logger</a></span>)
	{
		<span class="typed"><span class="type">sbt.Logger</span><a href="#48518">log</a></span>.<span class="typed"><span class="type">(=&gt; String)Unit</span><a href="Logger.scala.html#8466">debug</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Waiting for thread &quot;)</span><span class="string">&quot;Waiting for thread &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5774">+</a></span> <span class="typed"><span class="type">java.lang.Thread</span><a href="#48517">thread</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="36659">getName</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5774">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot; to exit&quot;)</span><span class="string">&quot; to exit&quot;</span></span>)
		<span class="typed"><span class="type">java.lang.Thread</span><a href="#48517">thread</a></span>.<span class="typed"><span class="type">()Unit</span><a id="36666">join</a></span>
		<span class="typed"><span class="type">sbt.Logger</span><a href="#48518">log</a></span>.<span class="typed"><span class="type">(=&gt; String)Unit</span><a href="Logger.scala.html#8466">debug</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;\011Thread &quot;)</span><span class="string">&quot;\tThread &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5774">+</a></span> <span class="typed"><span class="type">java.lang.Thread</span><a href="#48517">thread</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="36659">getName</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5774">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot; exited.&quot;)</span><span class="string">&quot; exited.&quot;</span></span>)
	}
	<span class="comment">/** Replaces the uncaught exception handler with one that handles the SecurityException thrown by System.exit and
	* otherwise delegates to the original handler*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.Thread,scala.collection.Set[java.lang.Thread],sbt.ExitCode)Unit</span><a id="44037">replaceHandler</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a id="48512">thread</a></span>: <span class="typed"><span class="type">java.lang.Thread</span><a id="2064">Thread</a></span>, <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="48513">originalThreads</a></span>: <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="7496">Set</a></span>[Thread], <span class="typed"><span class="type">sbt.ExitCode</span><a id="48514">code</a></span>: <span class="typed"><span class="type">sbt.ExitCode</span><a href="#6509">ExitCode</a></span>)
	{
		<span class="typed"><span class="type">java.lang.Thread</span><a href="#48512">thread</a></span>.<span class="typed"><span class="type">(java.lang.Thread.UncaughtExceptionHandler)Unit</span><a id="36684">setUncaughtExceptionHandler</a></span>(<span class="typed"><span class="type">sbt.TrapExit.ExitHandler</span><span class="keyword">new</span></span> <span class="typed"><span class="type">sbt.TrapExit.ExitHandler</span><a href="#44044">ExitHandler</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#48512">thread</a></span>.<span class="typed"><span class="type">()java.lang.Thread.UncaughtExceptionHandler</span><a id="36683">getUncaughtExceptionHandler</a></span>, <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48513">originalThreads</a></span>, <span class="typed"><span class="type">sbt.ExitCode</span><a href="#48514">code</a></span>))
	}
	<span class="comment">/** Returns the exit code of the System.exit that caused the given Exception, or rethrows the exception
	* if its cause was not calling System.exit.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Throwable)Int</span><a id="44038">exitCode</a></span>(<span class="typed"><span class="type">Throwable</span><a id="48487">e</a></span>: <span class="typed"><span class="type">Throwable</span><a id="2124">Throwable</a></span>): <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span> =
	{
		<span class="typed"><span class="type">Throwable</span><a href="#48487">e</a></span> <span class="typed"><span class="type">Int</span><span class="keyword">match</span></span>
		{
			<span class="typed"><span class="type">Int</span><span class="keyword">case</span></span> <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><a id="48538">x</a></span>: <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><a href="#6511">TrapExitSecurityException</a></span> =&gt; <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><a href="#48538">x</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="#48544">exitCode</a></span>
			<span class="typed"><span class="type">Int</span><span class="keyword">case</span></span> _ =&gt; 
			{
				<span class="keyword">val</span> <span class="typed"><span class="type">java.lang.Throwable</span><a id="48560">cause</a></span> = <span class="typed"><span class="type">Throwable</span><a href="#48487">e</a></span>.<span class="typed"><span class="type">()java.lang.Throwable</span><a id="9385">getCause</a></span>
				<span class="typed"><span class="type">Int</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">java.lang.Throwable</span><a href="#48560">cause</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3490">==</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)
					<span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">Throwable</span><a href="#48487">e</a></span>
				<span class="keyword">else</span>
					<span class="typed"><span class="type">(Throwable)Int</span><a href="#44038">exitCode</a></span>(<span class="typed"><span class="type">java.lang.Throwable</span><a href="#48560">cause</a></span>)
			}
		}
	}
	
	<span class="keyword">import</span> scala.collection.jcl.Conversions.convertSet
	<span class="comment">/** Returns all threads that are not in the 'system' thread group and are not the AWT implementation
	* thread (AWT-XAWT, AWT-Windows, ...)*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; scala.collection.Set[java.lang.Thread]</span><a id="44040">allThreads</a></span>: <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="7496">Set</a></span>[Thread] =
	{
		<span class="keyword">val</span> <span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]</span><a id="48562">threads</a></span> = <span class="typed"><span class="type">(java.util.Set[java.lang.Thread])java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]</span><span id="24270"><a id="7785">convertSet</a></span></span>(<span class="typed"><span class="type">object java.lang.Thread</span><a id="2065">Thread</a></span>.<span class="typed"><span class="type">()java.util.Map[java.lang.Thread,Array[java.lang.StackTraceElement]]</span><a id="36678">getAllStackTraces</a></span>.<span class="typed"><span class="type">()java.util.Set[java.lang.Thread]</span><a id="22867">keySet</a></span>)
		<span class="keyword">for</span>(<span class="typed"><span class="type">((java.lang.Thread) =&gt; Unit)Unit</span><span id="6939"><span id="6940"><span id="48579"><a id="48592">thread</a></span></span></span></span> &lt;- <span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]</span><a href="#48562">threads</a></span>.<span class="typed"><span class="type">=&gt; List[java.lang.Thread]</span><a id="7388">toList</a></span> <span class="keyword">if</span> <span class="typed"><span class="type">(java.lang.Thread)Boolean</span><a href="#44041">isSystemThread</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#48579">thread</a></span>))
			<span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]</span><a href="#48562">threads</a></span> <span class="typed"><span class="type">(java.lang.Thread)Unit</span><a id="24615">-=</a></span> <span class="typed"><span class="type">java.lang.Thread</span><a href="#48592">thread</a></span>
		<span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.Object with scala.collection.jcl.SetWrapper[java.lang.Thread]</span><a href="#48562">threads</a></span>
	}
	<span class="comment">/** Returns true if the given thread is in the 'system' thread group and is an AWT thread other than
	* AWT-EventQueue or AWT-Shutdown.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.Thread)Boolean</span><a id="44041">isSystemThread</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a id="48580">t</a></span>: <span class="typed"><span class="type">java.lang.Thread</span><a id="2064">Thread</a></span>) =
	{
		<span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><a id="48582">name</a></span> = <span class="typed"><span class="type">java.lang.Thread</span><a href="#48580">t</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="36659">getName</a></span>
		<span class="typed"><span class="type">Boolean</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">java.lang.String</span><a href="#48582">name</a></span>.<span class="typed"><span class="type">(java.lang.String)Boolean</span><a id="5813">startsWith</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;AWT-&quot;)</span><span class="string">&quot;AWT-&quot;</span></span>))
			<span class="typed"><span class="type">=&gt; Boolean</span><a id="2728">!</a></span>(<span class="typed"><span class="type">java.lang.String</span><a href="#48582">name</a></span>.<span class="typed"><span class="type">(java.lang.String)Boolean</span><a id="5813">startsWith</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;AWT-EventQueue&quot;)</span><span class="string">&quot;AWT-EventQueue&quot;</span></span>) <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2731">||</a></span> <span class="typed"><span class="type">java.lang.String</span><a href="#48582">name</a></span>.<span class="typed"><span class="type">(java.lang.String)Boolean</span><a id="5813">startsWith</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;AWT-Shutdown&quot;)</span><span class="string">&quot;AWT-Shutdown&quot;</span></span>))
		<span class="keyword">else</span>
		{
			<span class="keyword">val</span> <span class="typed"><span class="type">java.lang.ThreadGroup</span><a id="48586">group</a></span> = <span class="typed"><span class="type">java.lang.Thread</span><a href="#48580">t</a></span>.<span class="typed"><span class="type">()java.lang.ThreadGroup</span><a id="36660">getThreadGroup</a></span>
			(<span class="typed"><span class="type">java.lang.ThreadGroup</span><a href="#48586">group</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5765">!=</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>) <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2732">&amp;&amp;</a></span> (<span class="typed"><span class="type">java.lang.ThreadGroup</span><a href="#48586">group</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="46705">getName</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3490">==</a></span> <span class="typed"><span class="type">java.lang.String(&quot;system&quot;)</span><span class="string">&quot;system&quot;</span></span>)
		}
	}
	<span class="comment">/** Calls the provided function for each thread in the system as provided by the 
	* allThreads function except those in ignoreThreads.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit</span><a id="44042">processThreads</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="48508">ignoreThreads</a></span>: <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="7496">Set</a></span>[Thread], <span class="typed"><span class="type">(java.lang.Thread) =&gt; Unit</span><a id="48509">process</a></span>: Thread =&gt; Unit)
	{
		<span class="typed"><span class="type">=&gt; scala.collection.Set[java.lang.Thread]</span><a href="#44040">allThreads</a></span>.<span class="typed"><span class="type">((java.lang.Thread) =&gt; Boolean)Iterable[java.lang.Thread]</span><a id="7359">filter</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a id="48595">thread</a></span> =&gt; <span class="typed"><span class="type">=&gt; Boolean</span><a id="2728">!</a></span><span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48508">ignoreThreads</a></span>.<span class="typed"><span class="type">(java.lang.Thread)Boolean</span><a id="22294">contains</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#48595">thread</a></span>)).<span class="typed"><span class="type">((java.lang.Thread) =&gt; Unit)Unit</span><a id="7365">foreach</a></span>(<span class="typed"><span class="type">(java.lang.Thread) =&gt; Unit</span><a href="#48509">process</a></span>)
	}
	<span class="comment">/** Handles System.exit by disposing all frames and calling interrupt on all user threads */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread])Unit</span><a id="44043">stopAll</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="48524">originalThreads</a></span>: <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="7496">Set</a></span>[Thread])
	{
		<span class="keyword">val</span> <span class="typed"><span class="type">Array[java.awt.Frame]</span><a id="48596">allFrames</a></span> = java.awt.<span class="typed"><span class="type">object java.awt.Frame</span><a id="48799">Frame</a></span>.<span class="typed"><span class="type">()Array[java.awt.Frame]</span><a id="49477">getFrames</a></span>
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Array[java.awt.Frame]</span><a href="#48596">allFrames</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="7081">length</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3126">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
		{
			<span class="typed"><span class="type">Array[java.awt.Frame]</span><a href="#48596">allFrames</a></span>.<span class="typed"><span class="type">((java.awt.Frame) =&gt; Unit)Unit</span><a id="7365">foreach</a></span>(<span class="typed"><span class="type">java.awt.Frame</span><a href="#49597">_</a></span>.<span class="typed"><span class="type">()Unit</span><a id="49693">dispose</a></span>) <span class="comment">// dispose all top-level windows, which will cause the AWT-EventQueue-* threads to exit</span>
			<span class="typed"><span class="type">object java.lang.Thread</span><a id="2065">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="36635">sleep</a></span>(<span class="typed"><span class="type">Long(2000L)</span><span class="int">2000</span></span>) <span class="comment">// AWT Thread doesn't exit immediately, so wait to interrupt it</span>
		}
		<span class="comment">// interrupt all threads that appear to have been started by the user</span>
		<span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread],(java.lang.Thread) =&gt; Unit)Unit</span><a href="#44042">processThreads</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48524">originalThreads</a></span>, <span class="typed"><span class="type">java.lang.Thread</span><a id="51260">thread</a></span> =&gt; <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">=&gt; Boolean</span><a id="2728">!</a></span><span class="typed"><span class="type">java.lang.Thread</span><a href="#51260">thread</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="36659">getName</a></span>.<span class="typed"><span class="type">(java.lang.String)Boolean</span><a id="5813">startsWith</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;AWT-&quot;)</span><span class="string">&quot;AWT-&quot;</span></span>)) <span class="typed"><span class="type">java.lang.Thread</span><a href="#51260">thread</a></span>.<span class="typed"><span class="type">()Unit</span><a id="36649">interrupt</a></span>)
	}
	<span class="comment">/** An uncaught exception handler that delegates to the original uncaught exception handler except when
	* the cause was a call to System.exit (which generated a SecurityException)*/</span>
	<span class="keyword">class</span> <span class="typed"><span class="type">class ExitHandler extends java.lang.Object with java.lang.Thread.UncaughtExceptionHandler with ScalaObject</span><a id="44044">ExitHandler</a></span>(<span class="typed"><span class="type">java.lang.Thread.UncaughtExceptionHandler</span><span id="48530"><a id="48535">originalHandler</a></span></span>: Thread.<span class="typed"><span class="type">java.lang.Thread.UncaughtExceptionHandler</span><a id="36373">UncaughtExceptionHandler</a></span>, <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><span id="48531"><a id="48536">originalThreads</a></span></span>: <span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a id="7496">Set</a></span>[Thread], <span class="typed"><span class="type">sbt.ExitCode</span><span id="48532"><a id="48537">codeHolder</a></span></span>: <span class="typed"><span class="type">sbt.ExitCode</span><a href="#6509">ExitCode</a></span>) <span class="keyword">extends</span> Thread.<span class="typed"><span class="type">java.lang.Thread.UncaughtExceptionHandler</span><a id="36373">UncaughtExceptionHandler</a></span>
	{
		<span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.Thread,Throwable)Unit</span><a id="48534">uncaughtException</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a id="51266">t</a></span>: <span class="typed"><span class="type">java.lang.Thread</span><a id="2064">Thread</a></span>, <span class="typed"><span class="type">Throwable</span><a id="51267">e</a></span>: <span class="typed"><span class="type">Throwable</span><a id="2124">Throwable</a></span>)
		{
			<span class="keyword">try</span>
			{
				<span class="typed"><span class="type">sbt.ExitCode</span><a href="#48532">codeHolder</a></span>.<span class="typed"><span class="type">(Int)Unit</span><a href="#48506">set</a></span>(<span class="typed"><span class="type">(Throwable)Int</span><a href="#44038">exitCode</a></span>(<span class="typed"><span class="type">Throwable</span><a href="#51267">e</a></span>)) <span class="comment">// will rethrow e if it was not because of a call to System.exit</span>
				<span class="typed"><span class="type">(scala.collection.Set[java.lang.Thread])Unit</span><a href="#44043">stopAll</a></span>(<span class="typed"><span class="type">scala.collection.Set[java.lang.Thread]</span><a href="#48531">originalThreads</a></span>)
			}
			<span class="keyword">catch</span>
			{
				<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> _ =&gt; <span class="typed"><span class="type">java.lang.Thread.UncaughtExceptionHandler</span><a href="#48530">originalHandler</a></span>.<span class="typed"><span class="type">(java.lang.Thread,java.lang.Throwable)Unit</span><a id="48526">uncaughtException</a></span>(<span class="typed"><span class="type">java.lang.Thread</span><a href="#51266">t</a></span>, <span class="typed"><span class="type">Throwable</span><a href="#51267">e</a></span>)
			}
		}
	}
}
<span class="keyword">private</span> <span class="keyword">class</span> <span class="typed"><span class="type">class ExitCode extends java.lang.Object with NotNull with ScalaObject</span><a id="6509">ExitCode</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">NotNull</span><a id="186">NotNull</a></span>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">Option[Int]</span><span id="48505"><span id="48503"><span id="48504"><a id="51270">code</a></span></span></span></span>: <span class="typed"><span class="type">Option[Int]</span><a id="915">Option</a></span>[Int] = <span class="typed"><span class="type">object None</span><a id="517">None</a></span>
	<span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="48506">set</a></span>(<span class="typed"><span class="type">Int</span><a id="51268">c</a></span>: <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span>)
	{
		<span class="typed"><span class="type">(Unit)Unit</span><a href="#6509" id="5768">synchronized</a></span>
		{
			<span class="typed"><span class="type">=&gt; Option[Int]</span><a href="#48503">code</a></span> <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span>
			{
				<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">Int</span><a id="51272">existing</a></span>) =&gt; <span class="typed"><span class="type">Unit</span><span >(</span></span>)
				<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a id="517">None</a></span> =&gt; <span class="typed"><span class="type">(Option[Int])Unit</span><a href="#48504">code</a></span> = <span class="typed"><span class="type">(Int)Some[Int]</span><span id="10375"><a id="289">Some</a></span></span>(<span class="typed"><span class="type">Int</span><a href="#51268">c</a></span>)
			}
		}
	}
	<span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Option[Int]</span><a id="48507">value</a></span>: <span class="typed"><span class="type">Option[Int]</span><a id="915">Option</a></span>[Int] = <span class="typed"><span class="type">(Option[Int])Option[Int]</span><a href="#6509" id="5768">synchronized</a></span> { <span class="typed"><span class="type">=&gt; Option[Int]</span><a href="#48503">code</a></span> }
}
<span class="comment">///////  These two classes are based on similar classes in Nailgun</span>
<span class="comment">/** A custom SecurityManager to disallow System.exit. */</span>
<span class="keyword">private</span> <span class="keyword">class</span> <span class="typed"><span class="type">class TrapExitSecurityManager extends java.lang.SecurityManager with ScalaObject</span><a id="6510">TrapExitSecurityManager</a></span>(<span class="typed"><span class="type">java.lang.SecurityManager</span><span id="48473"><a id="48480">delegateManager</a></span></span>: <span class="typed"><span class="type">java.lang.SecurityManager</span><a id="1875">SecurityManager</a></span>) <span class="keyword">extends</span> <span class="typed"><span class="type">java.lang.SecurityManager</span><a id="1875">SecurityManager</a></span>
{
	<span class="keyword">import</span> java.security.Permission
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="48476">checkExit</a></span>(<span class="typed"><span class="type">Int</span><a id="51277">status</a></span>: <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span>)
	{
		<span class="keyword">val</span> <span class="typed"><span class="type">Array[java.lang.StackTraceElement]</span><a id="51278">stack</a></span> = <span class="typed"><span class="type">object java.lang.Thread</span><a id="2065">Thread</a></span>.<span class="typed"><span class="type">()java.lang.Thread</span><a id="36633">currentThread</a></span>.<span class="typed"><span class="type">()Array[java.lang.StackTraceElement]</span><a id="36675">getStackTrace</a></span>
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Array[java.lang.StackTraceElement]</span><a href="#51278">stack</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3490">==</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2731">||</a></span> <span class="typed"><span class="type">Array[java.lang.StackTraceElement]</span><a href="#51278">stack</a></span>.<span class="typed"><span class="type">((java.lang.StackTraceElement) =&gt; Boolean)Boolean</span><a id="7367">exists</a></span>(<span class="typed"><span class="type">(java.lang.StackTraceElement)Boolean</span><a href="#48477">isRealExit</a></span>))
			<span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><span class="keyword">new</span></span> <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><a href="#6511">TrapExitSecurityException</a></span>(<span class="typed"><span class="type">Int</span><a href="#51277">status</a></span>)
	}
	<span class="comment">/** This ensures that only actual calls to exit are trapped and not just calls to check if exit is allowed.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.StackTraceElement)Boolean</span><a id="48477">isRealExit</a></span>(<span class="typed"><span class="type">java.lang.StackTraceElement</span><a id="51280">element</a></span>: <span class="typed"><span class="type">java.lang.StackTraceElement</span><a id="1836">StackTraceElement</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2151">Boolean</a></span> =
		<span class="typed"><span class="type">java.lang.StackTraceElement</span><a href="#51280">element</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="48569">getClassName</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3490">==</a></span> <span class="typed"><span class="type">java.lang.String(&quot;java.lang.Runtime&quot;)</span><span class="string">&quot;java.lang.Runtime&quot;</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2732">&amp;&amp;</a></span> <span class="typed"><span class="type">java.lang.StackTraceElement</span><a href="#51280">element</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="48570">getMethodName</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3490">==</a></span> <span class="typed"><span class="type">java.lang.String(&quot;exit&quot;)</span><span class="string">&quot;exit&quot;</span></span>
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.security.Permission)Unit</span><a id="48478">checkPermission</a></span>(<span class="typed"><span class="type">java.security.Permission</span><a id="51288">perm</a></span>: <span class="typed"><span class="type">java.security.Permission</span><a id="4895">Permission</a></span>)
	{
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48473">delegateManager</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5765">!=</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)
			<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48473">delegateManager</a></span>.<span class="typed"><span class="type">(java.security.Permission)Unit</span><a id="48437">checkPermission</a></span>(<span class="typed"><span class="type">java.security.Permission</span><a href="#51288">perm</a></span>)
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.security.Permission,AnyRef)Unit</span><a id="48479">checkPermission</a></span>(<span class="typed"><span class="type">java.security.Permission</span><a id="51301">perm</a></span>: <span class="typed"><span class="type">java.security.Permission</span><a id="4895">Permission</a></span>, <span class="typed"><span class="type">AnyRef</span><a id="51302">context</a></span>: <span class="typed"><span class="type">AnyRef</span><a id="1998">AnyRef</a></span>)
	{
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48473">delegateManager</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5765">!=</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)
			<span class="typed"><span class="type">java.lang.SecurityManager</span><a href="#48473">delegateManager</a></span>.<span class="typed"><span class="type">(java.security.Permission,Any)Unit</span><a id="48438">checkPermission</a></span>(<span class="typed"><span class="type">java.security.Permission</span><a href="#51301">perm</a></span>, <span class="typed"><span class="type">AnyRef</span><a href="#51302">context</a></span>)
	}
}
<span class="comment">/** A custom SecurityException that tries not to be caught.*/</span>
<span class="keyword">private</span> <span class="keyword">class</span> <span class="typed"><span class="type">class TrapExitSecurityException extends java.lang.SecurityException with ScalaObject</span><a id="6511">TrapExitSecurityException</a></span>(<span class="keyword">val</span> <span class="typed"><span class="type">Int</span><span id="48545"><span id="48544"><a id="51283">exitCode</a></span></span></span>: <span class="typed"><span class="type">Int</span><a id="2375">Int</a></span>) <span class="keyword">extends</span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1839">SecurityException</a></span>
{
	<span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">Boolean</span><span id="48549"><span id="48547"><span id="48548"><a id="51312">accessAllowed</a></span></span></span></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
	<span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="48550">allowAccess</a></span>
	{
		<span class="typed"><span class="type">(Boolean)Unit</span><a href="#48548">accessAllowed</a></span> = <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
	}
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="48551">printStackTrace</a></span> = <span class="typed"><span class="type">(=&gt; Unit)Unit</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()Unit</span><a href="#65977" class="keyword">super</a></span>.<span class="typed"><span class="type">()Unit</span><a id="65977">printStackTrace</a></span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()java.lang.String</span><a id="48552">toString</a></span> = <span class="typed"><span class="type">(=&gt; java.lang.String)java.lang.String</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()java.lang.String</span><a href="#65978" class="keyword">super</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="65978">toString</a></span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()java.lang.Throwable</span><a id="48553">getCause</a></span> = <span class="typed"><span class="type">(=&gt; java.lang.Throwable)java.lang.Throwable</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()java.lang.Throwable</span><a href="#65979" class="keyword">super</a></span>.<span class="typed"><span class="type">()java.lang.Throwable</span><a id="65979">getCause</a></span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()java.lang.String</span><a id="48554">getMessage</a></span> = <span class="typed"><span class="type">(=&gt; java.lang.String)java.lang.String</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()java.lang.String</span><a href="#65980" class="keyword">super</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="65980">getMessage</a></span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()java.lang.Throwable</span><a id="48555">fillInStackTrace</a></span> = <span class="typed"><span class="type">(=&gt; java.lang.Throwable)java.lang.Throwable</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()java.lang.Throwable</span><a href="#65981" class="keyword">super</a></span>.<span class="typed"><span class="type">()java.lang.Throwable</span><a id="65981">fillInStackTrace</a></span>)
	<span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()java.lang.String</span><a id="48556">getLocalizedMessage</a></span> = <span class="typed"><span class="type">(=&gt; java.lang.String)java.lang.String</span><a href="#48557">ifAccessAllowed</a></span>(<span class="typed"><span class="type">()java.lang.String</span><a href="#65982" class="keyword">super</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="65982">getLocalizedMessage</a></span>)
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">[T](=&gt; T)T</span><a id="48557">ifAccessAllowed</a></span>[<span class="typed"><span class="type">&gt;: Nothing &lt;: Any</span><a id="48559">T</a></span>](<span class="typed"><span class="type">=&gt; T</span><a id="51322">f</a></span>: =&gt; T): <span class="typed"><span class="type">T</span><a href="#48559">T</a></span> =
	{
		<span class="typed"><span class="type">T</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">=&gt; Boolean</span><a href="#48547">accessAllowed</a></span>)
			<span class="typed"><span class="type">=&gt; T</span><a href="#51322">f</a></span>
		<span class="keyword">else</span>
			<span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">sbt.TrapExitSecurityException</span><a href="#6511" class="keyword">this</a></span>
	}
}
        </pre>
    </body>
</html>