<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Annotate.scala</title>
        <script type="text/javascript" src="linked.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* sxr -- Scala X-Ray
 * Copyright 2009 Mark Harrah
 */</span>

<span class="keyword">package</span> sxr

<span class="keyword">import</span> java.io.{File, Reader, Writer}
<span class="keyword">import</span> scala.collection.jcl.TreeSet

<span class="comment">/** The entry point for annotating an input file.*/</span>
<span class="keyword">private</span> <span class="keyword">object</span> <span class="typed"><span class="type">object sxr.Annotate</span><a id="6248">Annotate</a></span>
{
	<span class="keyword">import</span> FileUtil.{withReader, withWriter}
	<span class="comment">/** Annotates an input source file with highlighting and type information provided by 'tokens' and applied by 'styler'.
	* The result is written to 'target'.*/</span>
	<span class="keyword">def</span> <span class="typed"><span class="type">(java.io.File,java.io.File,scala.collection.jcl.TreeSet[sxr.Token],sxr.Styler)Unit</span><a id="20168">apply</a></span>(<span class="typed"><span class="type">java.io.File</span><a id="20169">source</a></span>: <span class="typed"><span class="type">java.io.File</span><a id="3644">File</a></span>, <span class="typed"><span class="type">java.io.File</span><a id="20170">target</a></span>: <span class="typed"><span class="type">java.io.File</span><a id="3644">File</a></span>, <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a id="20171">tokens</a></span>: <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a id="11010">TreeSet</a></span>[Token], <span class="typed"><span class="type">sxr.Styler</span><a id="20172">styler</a></span>: <span class="typed"><span class="type">sxr.Styler</span><a href="Styler.scala.html#6226">Styler</a></span>)
	{
		<span class="typed"><span class="type">(java.io.File)((java.io.BufferedReader) =&gt; Unit)Unit</span><a href="FileUtil.scala.html#18287">withReader</a></span>(<span class="typed"><span class="type">java.io.File</span><a href="#20169">source</a></span>) { <span class="typed"><span class="type">java.io.BufferedReader</span><a id="22754">input</a></span> =&gt;
			<span class="typed"><span class="type">(java.io.File)((java.io.BufferedWriter) =&gt; Unit)Unit</span><a href="FileUtil.scala.html#18288">withWriter</a></span>(<span class="typed"><span class="type">java.io.File</span><a href="#20170">target</a></span>) { <span class="typed"><span class="type">java.io.BufferedWriter</span><a id="22756">output</a></span> =&gt;
				<span class="typed"><span class="type">sxr.Annotate</span><span class="keyword">new</span></span> <span class="typed"><span class="type">sxr.Annotate</span><a href="#6250">Annotate</a></span>(<span class="typed"><span class="type">java.io.BufferedReader</span><a href="#22754">input</a></span>, <span class="typed"><span class="type">java.io.BufferedWriter</span><a href="#22756">output</a></span>, <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a href="#20171">tokens</a></span>, <span class="typed"><span class="type">sxr.Styler</span><a href="#20172">styler</a></span>).<span class="typed"><span class="type">()Unit</span><a href="#22766">annotate</a></span>()
			}
		}
	}
}
<span class="comment">/** Annotates a source file.  This class is one-time use and should only be used through the Annotate module.
*
*  'input' is the raw source file.
* The annotated file will be written to 'output'
* The information associated with a file is defined by 'tokens'
* 'styler' generates the final annotations for a token 
*
* Note that the 'write' method in this class is specific to HTML and would
* need to be generalized for another format */</span>
<span class="keyword">private</span> <span class="keyword">class</span> <span class="typed"><span class="type">class Annotate extends java.lang.Object with NotNull with ScalaObject</span><a id="6250">Annotate</a></span>(<span class="typed"><span class="type">java.io.Reader</span><span id="22761"><a id="22770">input</a></span></span>: <span class="typed"><span class="type">java.io.Reader</span><a id="3530">Reader</a></span>, <span class="typed"><span class="type">java.io.Writer</span><span id="22762"><a id="22771">output</a></span></span>: <span class="typed"><span class="type">java.io.Writer</span><a id="3779">Writer</a></span>, <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><span id="22763"><a id="22772">tokens</a></span></span>: <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a id="11010">TreeSet</a></span>[Token], <span class="typed"><span class="type">sxr.Styler</span><span id="22764"><a id="22773">styler</a></span></span>: <span class="typed"><span class="type">sxr.Styler</span><a href="Styler.scala.html#6226">Styler</a></span>) <span class="keyword">extends</span> <span class="typed"><span class="type">NotNull</span><a id="180">NotNull</a></span>
{
	<span class="comment">/** Applies the annotations.*/</span>
	<span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="22766">annotate</a></span>()
	{
		<span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">sxr.Styler</span><a href="#22764">styler</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="Styler.scala.html#20143">head</a></span>)
		<span class="typed"><span class="type">(Int)Unit</span><a href="#22767">annotate</a></span>(<span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
		<span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">sxr.Styler</span><a href="#22764">styler</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="Styler.scala.html#20145">tail</a></span>)
	}
	<span class="comment">/** Applies annotations.  index is the current position in the source file. */</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="22767">annotate</a></span>(<span class="typed"><span class="type">Int</span><a id="23039">index</a></span>: <span class="typed"><span class="type">Int</span><a id="2369">Int</a></span>)
	{
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a href="#22763">tokens</a></span>.<span class="typed"><span class="type">=&gt; Boolean</span><a id="19030">isEmpty</a></span>) <span class="comment">// no more tokens, copy the remaining characters over</span>
			<span class="typed"><span class="type">(Int)Unit</span><a href="#22768">transfer</a></span>(java.lang.Integer.<span class="typed"><span class="type">Int(2147483647)</span><span >MAX_VALUE</span></span>)
		<span class="keyword">else</span>
		{
			<span class="comment">//look at the next token</span>
			<span class="keyword">val</span> <span class="typed"><span class="type">sxr.Token</span><a id="23054">token</a></span> = <span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a href="#22763">tokens</a></span>.<span class="typed"><span class="type">=&gt; sxr.Token</span><a id="18315">firstKey</a></span>
			<span class="typed"><span class="type">scala.collection.jcl.TreeSet[sxr.Token]</span><a href="#22763">tokens</a></span>.<span class="typed"><span class="type">(sxr.Token)Boolean</span><a id="19052">remove</a></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="Token.scala.html#19065">start</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3118">&lt;</a></span> <span class="typed"><span class="type">Int</span><a href="#23039">index</a></span>)
			{
				<span class="typed"><span class="type">(Any)Unit</span><span id="6070"><a id="796">println</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;Overlapping span detected at index &quot;)</span><span class="string">&quot;Overlapping span detected at index &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5768">+</a></span> <span class="typed"><span class="type">Int</span><a href="#23039">index</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5768">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;: &quot;)</span><span class="string">&quot;: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5768">+</a></span> <span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>)
				<span class="typed"><span class="type">(Int)Unit</span><a href="#22767">annotate</a></span>(<span class="typed"><span class="type">Int</span><a href="#23039">index</a></span>)
			}
			<span class="keyword">else</span>
			{
				<span class="comment">// copy over characters not to be annotated </span>
				<span class="typed"><span class="type">(Int)Unit</span><a href="#22768">transfer</a></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="Token.scala.html#19065">start</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3123">-</a></span> <span class="typed"><span class="type">Int</span><a href="#23039">index</a></span>)
				<span class="comment">// get the annotations for the token from the styler</span>
				<span class="keyword">val</span> <span class="typed"><span class="type">List[sxr.Annotation]</span><a id="23058">styledList</a></span> = <span class="typed"><span class="type">(sxr.Token)List[sxr.Annotation]</span><a href="Styler.scala.html#20144">styler</a></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>)
				<span class="comment">// write all opening tags</span>
				<span class="keyword">for</span>(<span class="typed"><span class="type">((sxr.Annotation) =&gt; Unit)Unit</span><span id="11820"><a id="23074">styled</a></span></span> &lt;- <span class="typed"><span class="type">List[sxr.Annotation]</span><a href="#23058">styledList</a></span>)
					<span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">sxr.Annotation</span><a href="#23074">styled</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="Styler.scala.html#21450">open</a></span>)
				<span class="comment">// copy the annotated content</span>
				<span class="typed"><span class="type">(Int)Unit</span><a href="#22768">transfer</a></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="Token.scala.html#19067">length</a></span>)
				<span class="comment">// close the tags</span>
				<span class="keyword">for</span>(<span class="typed"><span class="type">((sxr.Annotation) =&gt; Unit)Unit</span><span id="11820"><a id="23079">styled</a></span></span> &lt;- <span class="typed"><span class="type">List[sxr.Annotation]</span><a href="#23058">styledList</a></span>.<span class="typed"><span class="type">=&gt; List[sxr.Annotation]</span><a id="11839">reverse</a></span>)
					<span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">sxr.Annotation</span><a href="#23079">styled</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="Styler.scala.html#21452">close</a></span>)
				<span class="comment">// continue</span>
				<span class="typed"><span class="type">(Int)Unit</span><a href="#22767">annotate</a></span>(<span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="Token.scala.html#19065">start</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3122">+</a></span> <span class="typed"><span class="type">sxr.Token</span><a href="#23054">token</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="Token.scala.html#19067">length</a></span>)
			}
			
		}
	}
	
	<span class="comment">/** Transfers the given number of characters from the input to the output unless the input does not have enough
	* characters, in which case all remaining characters are transferred.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="22768">transfer</a></span>(<span class="typed"><span class="type">Int</span><a id="23053">chars</a></span>: <span class="typed"><span class="type">Int</span><a id="2369">Int</a></span>)
	{
		<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Int</span><a href="#23053">chars</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3120">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
		{
			<span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="23102">c</a></span> = <span class="typed"><span class="type">java.io.Reader</span><a href="#22761">input</a></span>.<span class="typed"><span class="type">()Int</span><a id="23028">read</a></span>()
			<span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Int</span><a href="#23102">c</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3121">&gt;=</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
			{
				<span class="typed"><span class="type">(Char)Unit</span><a href="#22769">write</a></span>(<span class="typed"><span class="type">Int</span><a href="#23102">c</a></span>.<span class="typed"><span class="type">Char</span><a id="3478">asInstanceOf</a></span>[<span class="typed"><span class="type">Char</span><a id="2364">Char</a></span>])
				<span class="typed"><span class="type">(Int)Unit</span><a href="#22768">transfer</a></span>(<span class="typed"><span class="type">Int</span><a href="#23053">chars</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3123">-</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>)
			}
		}
	}
	<span class="comment">/** Writes the given character to the output, escaping to HTML it if necessary.*/</span>
	<span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Char)Unit</span><a id="22769">write</a></span>(<span class="typed"><span class="type">Char</span><a id="23186">c</a></span>: <span class="typed"><span class="type">Char</span><a id="2364">Char</a></span>)
	{
		<span class="typed"><span class="type">Char</span><a href="#23186">c</a></span> <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span>
		{
			<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('&gt;')</span><span class="char">'&gt;'</span></span> =&gt; <span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;&amp;gt;&quot;)</span><span class="string">&quot;&amp;gt;&quot;</span></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('&amp;')</span><span class="char">'&amp;'</span></span> =&gt; <span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;&amp;amp;&quot;)</span><span class="string">&quot;&amp;amp;&quot;</span></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('&lt;')</span><span class="char">'&lt;'</span></span> =&gt; <span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;&amp;lt;&quot;)</span><span class="string">&quot;&amp;lt;&quot;</span></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('&quot;')</span><span class="char">'&quot;'</span></span> =&gt; <span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="21031">write</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;&amp;quot;&quot;)</span><span class="string">&quot;&amp;quot;&quot;</span></span>)
			<span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> _ =&gt; <span class="typed"><span class="type">java.io.Writer</span><a href="#22762">output</a></span>.<span class="typed"><span class="type">(Int)Unit</span><a id="21028">write</a></span>(<span class="typed"><span class="type">implicit scala.Predef.char2int : (Char)Int</span><span id="6166"><a href="#23186" id="796">c</a></span></span>)
		}
	}
	
}

        </pre>
    </body>
</html>