<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/backend/icode/analysis/DataFlowAnalysis.scala</title>
        <script type="text/javascript" src="../../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */

// $Id: DataFlowAnalysis.scala 18387 2009-07-24 15:28:37Z odersky $

<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> backend.icode.analysis

<span class="keyword">import</span> scala.collection.mutable.{Map, HashMap, Set, HashSet, LinkedHashSet}

/** A generic framework for data flow analysis.
 */
<span class="keyword">trait</span> <a title="trait DataFlowAnalysis[L &lt;: scala.tools.nsc.backend.icode.analysis.CompleteLattice] extends java.lang.Object with ScalaObject" id="15995">DataFlowAnalysis</a>[<a title="&gt;: Nothing &lt;: scala.tools.nsc.backend.icode.analysis.CompleteLattice" id="22843">L</a> &lt;: CompleteLattice] <a title="ScalaObject" id="977">{</a>
  /** A type for program points. */
  <span class="keyword">type</span> <a title="&gt;: Nothing &lt;: scala.tools.nsc.backend.icode.analysis.ProgramPoint[DataFlowAnalysis.this.P]" id="61416">P</a> &lt;: ProgramPoint[P]
  <span class="keyword">val</span>  <a title="=&gt; L" id="61417">lattice</a>: <a href="#22843" title="L">L</a>

  <span class="keyword">val</span> <a title="scala.collection.mutable.Set[DataFlowAnalysis.this.P]" id="61418">worklist</a>: <a title="scala.collection.mutable.Set[DataFlowAnalysis.this.P]" id="25170">Set</a>[P] = <span title="scala.collection.mutable.LinkedHashSet[DataFlowAnalysis.this.P]" class="keyword">new</span> <a title="scala.collection.mutable.LinkedHashSet[DataFlowAnalysis.this.P]" id="25233">LinkedHashSet</a>

  <span class="keyword">val</span> <a title="scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]" id="61420">in</a>:  <span title="scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">Map</span>[P, lattice.Elem] = <span title="scala.collection.mutable.HashMap[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">HashMap</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]" id="61422">out</a>: <span title="scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">Map</span>[P, lattice.Elem] = <span title="scala.collection.mutable.HashMap[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">HashMap</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]" id="61424">visited</a>: <span title="scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]">HashSet</span>[P] = <span title="scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]">HashSet</span>

  /** collect statistics? */
  <span class="keyword">var</span> <a title="Boolean" id="61427">stat</a> = <span title="Boolean(true)" class="keyword">true</span>
  
  /** the number of times we iterated before reaching a fixpoint. */
  <span class="keyword">var</span> <a title="Int" id="61430">iterations</a> = <span title="Int(0)" class="int">0</span>
  
  /* Implement this function to initialize the worklist.  */
  <span class="keyword">def</span> <a title="(f: =&gt; Unit)Unit" id="61432">init</a>(<a title="=&gt; Unit" id="61624">f</a>: =&gt; Unit): <span title="Unit">Unit</span> = {
    <a href="#61430" title="(x$1: Int)Unit">iterations</a> = <span title="Int(0)" class="int">0</span>
    <a href="#61420" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">in</a>.<span title="()Unit">clear</span>; <a href="#61422" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">out</a>.<span title="()Unit">clear</span>; <a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="()Unit">clear</span>; <a href="#61424" title="=&gt; scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]">visited</a>.<span title="()Unit">clear</span>;
    <a href="#61624" title="=&gt; Unit">f</a>
  }
  
  /** Reinitialize, but keep the old solutions. Should be used when reanalyzing the
   *  same method, after some code transformation.
   */
  <span class="keyword">def</span> <a title="(f: =&gt; Unit)Unit" id="61433">reinit</a>(<a title="=&gt; Unit" id="62193">f</a>: =&gt; Unit): <span title="Unit">Unit</span> = {
    <a href="#61430" title="(x$1: Int)Unit">iterations</a> = <span title="Int(0)" class="int">0</span>
    <a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="()Unit">clear</span>; <a href="#61424" title="=&gt; scala.collection.mutable.HashSet[DataFlowAnalysis.this.P]">visited</a>.<span title="()Unit">clear</span>;
    <a href="#62193" title="=&gt; Unit">f</a>
  }

  <span class="keyword">def</span> <a title="=&gt; Unit" id="61434">run</a>: <span title="Unit">Unit</span>

  /** Implements forward dataflow analysis: the transfer function is 
   *  applied when inputs to a Program point change, to obtain the new 
   *  output value.
   *
   *  @param f the transfer function.
   */
  <span class="keyword">def</span> <a title="(f: (DataFlowAnalysis.this.P, DataFlowAnalysis.this.lattice.Elem) =&gt; DataFlowAnalysis.this.lattice.Elem)Unit" id="61435">forwardAnalysis</a>(<a title="(DataFlowAnalysis.this.P, DataFlowAnalysis.this.lattice.Elem) =&gt; DataFlowAnalysis.this.lattice.Elem" id="62463">f</a>: (P, lattice.Elem) =&gt; lattice.Elem): <span title="Unit">Unit</span> = <span class="keyword">try</span> {
    <span title="Unit" class="keyword">while</span> (<span title="=&gt; Boolean">!</span><a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#662894" title="()Unit">{</a>
      <span title="Unit" class="keyword">if</span> (<a href="#61427" title="=&gt; Boolean">stat</a>) <a href="#61430" title="(x$1: Int)Unit">iterations</a> += <span title="Int(1)" class="int">1</span>
      //Console.println(&quot;worklist in: &quot; + worklist);
      <span class="keyword">val</span> <a title="DataFlowAnalysis.this.P" id="662895">point</a> = <a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="=&gt; Iterator[DataFlowAnalysis.this.P]">iterator</span>.<span title="()DataFlowAnalysis.this.P">next</span>; <a href="#61418" title="(elem: DataFlowAnalysis.this.P)DataFlowAnalysis.this.worklist.type">worklist</a> -= <a href="#662895" title="DataFlowAnalysis.this.P">point</a>; <a href="#61424" title="(elem: DataFlowAnalysis.this.P)DataFlowAnalysis.this.visited.type" id="39520">visited</a> += <a href="#662895" title="DataFlowAnalysis.this.P">point</a>;
      //Console.println(&quot;taking out point: &quot; + point + &quot; worklist out: &quot; + worklist);
      <span class="keyword">val</span> <a title="DataFlowAnalysis.this.lattice.Elem" id="662896">output</a> = <a href="#62463" title="(v1: DataFlowAnalysis.this.P,v2: DataFlowAnalysis.this.lattice.Elem)DataFlowAnalysis.this.lattice.Elem">f</a>(<a href="#662895" title="DataFlowAnalysis.this.P">point</a>, <a href="#61420" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">in</a>(<a href="#662895" title="DataFlowAnalysis.this.P">point</a>))

      <span title="Unit" class="keyword">if</span> (<span title="(x$1: Boolean)Boolean">(</span><a href="#61417" title="=&gt; L">lattice</a>.<a href="CompleteLattice.scala.html#60690" title="(x$1: AnyRef)Boolean">bottom</a> == <a href="#61422" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">out</a>(<a href="#662895" title="DataFlowAnalysis.this.P">point</a>)) || <a href="#662896" title="(x$1: AnyRef)Boolean">output</a> != <a href="#61422" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">out</a>(<a href="#662895" title="DataFlowAnalysis.this.P">point</a>)) {
//        Console.println(&quot;Output changed at &quot; + point 
//                        + &quot; from: &quot; + out(point) + &quot; to: &quot; + output 
//                        + &quot; for input: &quot; + in(point) + &quot; and they are different: &quot; + (output != out(point)))
        <a href="#61422" title="(key: DataFlowAnalysis.this.P,value: DataFlowAnalysis.this.lattice.Elem)Unit">out</a>(<a href="#662895" title="DataFlowAnalysis.this.P">point</a>) = <a href="#662896" title="DataFlowAnalysis.this.lattice.Elem">output</a>
        <span class="keyword">val</span> <a title="List[DataFlowAnalysis.this.P]" id="663049">succs</a> = <a href="#662895" title="DataFlowAnalysis.this.P">point</a>.<a href="ProgramPoint.scala.html#61652" title="=&gt; List[DataFlowAnalysis.this.P]">successors</a>
        <a href="#663049" title="(f: (DataFlowAnalysis.this.P) =&gt; Unit)Unit">succs</a> foreach { <a title="DataFlowAnalysis.this.P" id="663070">p</a> =&gt;
          <span title="Any" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="(elem: DataFlowAnalysis.this.P)Boolean">contains</span>(<a href="#663070" title="DataFlowAnalysis.this.P">p</a>))
            <a href="#61418" title="(elem: DataFlowAnalysis.this.P)DataFlowAnalysis.this.worklist.type">worklist</a> += <a href="#663070" title="DataFlowAnalysis.this.P">p</a>;
          <a href="#61420" title="(key: DataFlowAnalysis.this.P,value: DataFlowAnalysis.this.lattice.Elem)Unit">in</a>(<a href="#663070" title="DataFlowAnalysis.this.P">p</a>) = <a href="#61417" title="=&gt; L">lattice</a>.<a href="CompleteLattice.scala.html#60691" title="(xs: List[DataFlowAnalysis.this.lattice.Elem])DataFlowAnalysis.this.lattice.Elem">lub</a>(/*in(p) :: */(<a href="#663070" title="DataFlowAnalysis.this.P">p</a>.<a href="ProgramPoint.scala.html#61651" title="(f: (DataFlowAnalysis.this.P) =&gt; DataFlowAnalysis.this.lattice.Elem)(implicit bf: scala.collection.generic.BuilderFactory[DataFlowAnalysis.this.lattice.Elem,List[DataFlowAnalysis.this.lattice.Elem],List[DataFlowAnalysis.this.P]])List[DataFlowAnalysis.this.lattice.Elem]">predecessors</a> <span title="scala.collection.generic.BuilderFactory[DataFlowAnalysis.this.lattice.Elem,List[DataFlowAnalysis.this.lattice.Elem],List#Coll]">map</span> <a href="#61422" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">out</a>.<a href="#663115" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">apply</a>))
        }
      }
    }
  } <span class="keyword">catch</span> {
    <span title="Nothing" class="keyword">case</span> <a title="NoSuchElementException" id="663154">e</a>: <a title="NoSuchElementException" id="6498">NoSuchElementException</a> =&gt; 
      <span title="object Console">Console</span>.<span title="(x: Any)Unit">println</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;in: &quot;</span> + <a href="#61420" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">in</a>.<span title="(start: String,sep: String,end: String)String">mkString</span>(<span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>))
      <span title="object Console">Console</span>.<span title="(x: Any)Unit">println</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;out: &quot;</span> + <a href="#61422" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">out</a>.<span title="(start: String,sep: String,end: String)String">mkString</span>(<span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>, <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>))
      <a href="#663154" title="NoSuchElementException">e</a>.<a title="()Unit" id="26091">printStackTrace</a>
      <a title="object Predef" id="708">Predef</a>.<a title="(message: String)Nothing" id="7938">error</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;Could not find element &quot;</span> + <a href="#663154" title="NoSuchElementException">e</a>.<a title="()java.lang.String" id="26085">getMessage</a>)
  }

  /** ...
   *
   *  @param f ...
   */
  <span class="keyword">def</span> <a title="(f: (DataFlowAnalysis.this.P, DataFlowAnalysis.this.lattice.Elem) =&gt; DataFlowAnalysis.this.lattice.Elem)Unit" id="61436">backwardAnalysis</a>(<a title="(DataFlowAnalysis.this.P, DataFlowAnalysis.this.lattice.Elem) =&gt; DataFlowAnalysis.this.lattice.Elem" id="556698">f</a>: (P, lattice.Elem) =&gt; lattice.Elem): <span title="Unit">Unit</span> =
    <span title="Unit" class="keyword">while</span> (<span title="=&gt; Boolean">!</span><a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#663194" title="()Unit">{</a>
      <span title="Unit" class="keyword">if</span> (<a href="#61427" title="=&gt; Boolean">stat</a>) <a href="#61430" title="(x$1: Int)Unit">iterations</a> += <span title="Int(1)" class="int">1</span>
      <span class="keyword">val</span> <a title="DataFlowAnalysis.this.P" id="663195">point</a> = <a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="=&gt; Iterator[DataFlowAnalysis.this.P]">iterator</span>.<span title="()DataFlowAnalysis.this.P">next</span>; <a href="#61418" title="(elem: DataFlowAnalysis.this.P)DataFlowAnalysis.this.worklist.type">worklist</a> -= <a href="#663195" title="DataFlowAnalysis.this.P">point</a>

      <a href="#61422" title="(key: DataFlowAnalysis.this.P,value: DataFlowAnalysis.this.lattice.Elem)Unit">out</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>) = <a href="#61417" title="=&gt; L">lattice</a>.<a href="CompleteLattice.scala.html#60691" title="(xs: List[DataFlowAnalysis.this.lattice.Elem])DataFlowAnalysis.this.lattice.Elem">lub</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>.<a href="ProgramPoint.scala.html#61652" title="(f: (DataFlowAnalysis.this.P) =&gt; DataFlowAnalysis.this.lattice.Elem)(implicit bf: scala.collection.generic.BuilderFactory[DataFlowAnalysis.this.lattice.Elem,List[DataFlowAnalysis.this.lattice.Elem],List[DataFlowAnalysis.this.P]])List[DataFlowAnalysis.this.lattice.Elem]">successors</a> <span title="scala.collection.generic.BuilderFactory[DataFlowAnalysis.this.lattice.Elem,List[DataFlowAnalysis.this.lattice.Elem],List#Coll]">map</span> <a href="#61420" title="=&gt; scala.collection.mutable.Map[DataFlowAnalysis.this.P,DataFlowAnalysis.this.lattice.Elem]">in</a>.<a href="#663268" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">apply</a>)
      <span class="keyword">val</span> <a title="DataFlowAnalysis.this.lattice.Elem" id="663196">input</a> = <a href="#556698" title="(v1: DataFlowAnalysis.this.P,v2: DataFlowAnalysis.this.lattice.Elem)DataFlowAnalysis.this.lattice.Elem">f</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>, <a href="#61422" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">out</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>))

      <span title="Unit" class="keyword">if</span> (<span title="(x$1: Boolean)Boolean">(</span><a href="#61417" title="=&gt; L">lattice</a>.<a href="CompleteLattice.scala.html#60690" title="(x$1: AnyRef)Boolean">bottom</a> == <a href="#61420" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">in</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>)) || <a href="#663196" title="(x$1: AnyRef)Boolean">input</a> != <a href="#61420" title="(key: DataFlowAnalysis.this.P)DataFlowAnalysis.this.lattice.Elem">in</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>)) {
        <a href="#61420" title="(key: DataFlowAnalysis.this.P,value: DataFlowAnalysis.this.lattice.Elem)Unit">in</a>(<a href="#663195" title="DataFlowAnalysis.this.P">point</a>) = <a href="#663196" title="DataFlowAnalysis.this.lattice.Elem">input</a>
        <a href="#663195" title="DataFlowAnalysis.this.P">point</a>.<a href="ProgramPoint.scala.html#61651" title="(f: (DataFlowAnalysis.this.P) =&gt; Any)Unit">predecessors</a> foreach { <a title="DataFlowAnalysis.this.P" id="663370">p</a> =&gt;
          <span title="Any" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#61418" title="=&gt; scala.collection.mutable.Set[DataFlowAnalysis.this.P]">worklist</a>.<span title="(elem: DataFlowAnalysis.this.P)Boolean">contains</span>(<a href="#663370" title="DataFlowAnalysis.this.P">p</a>))
            <a href="#61418" title="(elem: DataFlowAnalysis.this.P)DataFlowAnalysis.this.worklist.type">worklist</a> += <a href="#663370" title="DataFlowAnalysis.this.P">p</a>;
        }
      }
    }

}

        </pre>
    </body>
</html>