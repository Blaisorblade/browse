<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/backend/icode/Linearizers.scala</title>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* NSC -- new scala compiler
 * Copyright 2005 LAMP/EPFL
 * @author  Martin Odersky
 */</span>

<span class="comment">// $Id: Linearizers.scala 15286 2008-06-06 19:28:49Z stepancheg $</span>

<span class="keyword">package</span> scala.tools.nsc.backend.icode;

<span class="keyword">import</span> scala.tools.nsc.ast._;
<span class="keyword">import</span> scala.collection.mutable.{Stack, HashSet, BitSet};

<span class="keyword">trait</span> <span class="typed"><span class="type">trait Linearizers extends java.lang.Object with ScalaObject</span><a id="10656">Linearizers</a></span> { self: ICodes =&gt;
  <span class="keyword">import</span> opcodes._;

  <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="typed"><span class="type">class Linearizer extends java.lang.Object with ScalaObject</span><a id="32483">Linearizer</a></span> {
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]</span><a id="33332">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="33334">c</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock];
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod,Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="33333">linearizeAt</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="34176">c</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="34177">start</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock]
  }

  <span class="comment">/** 
   * A simple linearizer which predicts all branches to 
   * take the 'success' branch and tries to schedule those
   * blocks immediately after the test. This is in sync with
   * how 'while' statements are translated (if the test is 
   * 'true', the loop continues).
   */</span>
  <span class="keyword">class</span> <span class="typed"><span class="type">class NormalLinearizer extends Linearizers.this.Linearizer with scala.tools.nsc.backend.WorklistAlgorithm with ScalaObject</span><a id="32484">NormalLinearizer</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">Linearizers.this.Linearizer</span><a href="#32483">Linearizer</a></span> <span class="keyword">with</span> <span class="typed"><span class="type">scala.tools.nsc.backend.WorklistAlgorithm</span><a href="../WorklistAlgorithm.scala.html#8511">WorklistAlgorithm</a></span> {
    <span class="keyword">type</span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108138">Elem</a></span> = <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>;

    <span class="keyword">val</span> <span class="typed"><span class="type">NormalLinearizer.this.WList</span><span id="108140"><a id="108139">worklist</a></span></span>: <span class="typed"><span class="type">NormalLinearizer.this.WList</span><a id="20063">WList</a></span> = <span class="typed"><span class="type">scala.collection.mutable.Stack[NormalLinearizer.this.Elem]</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.collection.mutable.Stack[NormalLinearizer.this.Elem]</span><a id="20063">Stack</a></span>();

    <span class="keyword">var</span> <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><span id="108143"><span id="108141"><span id="108142"><a id="108648">blocks</a></span></span></span></span>: <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]</span><a id="108144">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108650">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="keyword">val</span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108651">b</a></span> = <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108650">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span>;
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108142">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;

      <span class="typed"><span class="type">(=&gt; Unit)Unit</span><a href="../WorklistAlgorithm.scala.html#108155">run</a></span> {
        <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span> <span class="typed"><span class="type">(Iterable[NormalLinearizer.this.Elem])Unit</span><a id="108636">++=</a></span> (<span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108650">m</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.ExceptionHandler]</span><a href="Members.scala.html#32873">exh</a></span> <span class="typed"><span class="type">((Linearizers.this.ExceptionHandler) =&gt; Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="21362">map</a></span> (<span class="typed"><span class="type">Linearizers.this.ExceptionHandler</span><a href="#108663">_</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="ExceptionHandlers.scala.html#51919">startBlock</a></span>));
        <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span>.<span class="typed"><span class="type">(NormalLinearizer.this.Elem*)Unit</span><a id="108638">push</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108651">b</a></span>); 
      }

      <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108141">blocks</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a id="21385">reverse</a></span>;
    }
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod,Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="108145">linearizeAt</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108665">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108666">start</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108142">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>
      <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span>.<span class="typed"><span class="type">()Unit</span><a id="108641">clear</a></span>
      <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a href="#108146">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108666">start</a></span>)
    }

    <span class="comment">/** Linearize another subtree and append it to the existing blocks. */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="108146">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108668">startBlock</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="comment">//blocks = startBlock :: Nil;</span>
      <span class="typed"><span class="type">(=&gt; Unit)Unit</span><a href="../WorklistAlgorithm.scala.html#108155">run</a></span>( { <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span>.<span class="typed"><span class="type">(NormalLinearizer.this.Elem*)Unit</span><a id="108638">push</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108668">startBlock</a></span>); } );
      <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108141">blocks</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a id="21385">reverse</a></span>;
    }

    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="108147">processElement</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108670">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>) = 
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108670">b</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21644">size</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3145">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) {
        <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108670">b</a></span>);
        <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108670">b</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Instruction</span><a href="BasicBlocks.scala.html#33214">lastInstruction</a></span> <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">JUMP</a>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108680">whereto</a></span>) =&gt; 
            <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108680">whereto</a></span>);
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">CJUMP</a>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108682">success</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108683">failure</a></span>, _, _) =&gt;
            <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108682">success</a></span>);
            <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108683">failure</a></span>);
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">CZJUMP</a>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108686">success</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108687">failure</a></span>, _, _) =&gt;
            <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108686">success</a></span>);
            <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108687">failure</a></span>);
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">SWITCH</a>(_, <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="108690">labels</a></span>) =&gt;
            <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108150">add</a></span>(<span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a href="#108690">labels</a></span>);
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">RETURN</a>(_) =&gt; <span class="typed"><span class="type">Unit</span><span >(</span></span>);
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">THROW</a>() =&gt;   <span class="typed"><span class="type">Unit</span><span >(</span></span>);
        }
      }

    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; NormalLinearizer.this.Elem</span><a id="108148">dequeue</a></span>: <span class="typed"><span class="type">NormalLinearizer.this.Elem</span><a href="BasicBlocks.scala.html#32337">Elem</a></span> = <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span>.<span class="typed"><span class="type">()NormalLinearizer.this.Elem</span><a id="108640">pop</a></span>;

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * TODO: use better test than linear search
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="108149">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108675">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>) = 
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108141">blocks</a></span>.<span class="typed"><span class="type">(Any)Boolean</span><a id="21673">contains</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108675">b</a></span>))
        <span class="typed"><span class="type">Unit</span><span >(</span></span>)
      <span class="keyword">else</span> {
        <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108142">blocks</a></span> = <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108675">b</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a href="#108677" id="21335">::</a></span> <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108141">blocks</a></span>;
        <span class="typed"><span class="type">=&gt; NormalLinearizer.this.WList</span><a href="#108139">worklist</a></span> <span class="typed"><span class="type">(NormalLinearizer.this.Elem*)Unit</span><a id="108638">push</a></span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108675">b</a></span>;
      }

    <span class="keyword">def</span> <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a id="108150">add</a></span>(<span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="108674">bs</a></span>: <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock]): <span class="typed"><span class="type">Unit</span><a id="2169">Unit</a></span> = <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a href="#108674">bs</a></span> <span class="typed"><span class="type">((Linearizers.this.BasicBlock) =&gt; Unit)Unit</span><a id="21366">foreach</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108149">add</a></span>;
  }

  <span class="comment">/**
   * Linearize code using a depth first traversal.
   */</span>
  <span class="keyword">class</span> <span class="typed"><span class="type">class DepthFirstLinerizer extends Linearizers.this.Linearizer with ScalaObject</span><a id="32485">DepthFirstLinerizer</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">Linearizers.this.Linearizer</span><a href="#32483">Linearizer</a></span> {
    <span class="keyword">var</span> <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><span id="108128"><span id="108126"><span id="108127"><a id="108698">blocks</a></span></span></span></span>: <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]</span><a id="108129">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108699">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108127">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;

      <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108131">dfs</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108699">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span>);
      <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108699">m</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.ExceptionHandler]</span><a href="Members.scala.html#32873">exh</a></span> <span class="typed"><span class="type">((Linearizers.this.ExceptionHandler) =&gt; Unit)Unit</span><a id="21366">foreach</a></span> (<span class="typed"><span class="type">Linearizers.this.ExceptionHandler</span><a id="108703">b</a></span> =&gt; <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108131">dfs</a></span>(<span class="typed"><span class="type">Linearizers.this.ExceptionHandler</span><a href="#108703">b</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="ExceptionHandlers.scala.html#51919">startBlock</a></span>));

      <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108126">blocks</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a id="21385">reverse</a></span>
    }
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod,Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="108130">linearizeAt</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108705">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108706">start</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108127">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>
      <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108131">dfs</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108706">start</a></span>)
      <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108126">blocks</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a id="21385">reverse</a></span>
    }

    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="108131">dfs</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108700">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">Unit</span><a id="2169">Unit</a></span> = 
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108700">b</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21644">size</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3145">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Boolean</span><a href="#108132">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108700">b</a></span>))
        <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108700">b</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="BasicBlocks.scala.html#33217">successors</a></span> <span class="typed"><span class="type">((Linearizers.this.BasicBlock) =&gt; Unit)Unit</span><a id="21366">foreach</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108131">dfs</a></span>;

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * TODO: use better test than linear search
     * @return Returns true if the block was added.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Boolean</span><a id="108132">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108709">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> = 
      <span class="typed"><span class="type">Boolean</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108126">blocks</a></span>.<span class="typed"><span class="type">(Any)Boolean</span><a id="21673">contains</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108709">b</a></span>))
        <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
      <span class="keyword">else</span> {
        <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108127">blocks</a></span> = <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108709">b</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a href="#108713" id="21335">::</a></span> <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108126">blocks</a></span>;
        <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
      }
  }

  <span class="comment">/**
   * Linearize code in reverse post order. In fact, it does
   * a post order traversal, prepending visited nodes to the list.
   * This way, it is constructed already in reverse post order.
   */</span>
  <span class="keyword">class</span> <span class="typed"><span class="type">class ReversePostOrderLinearizer extends Linearizers.this.Linearizer with ScalaObject</span><a id="32486">ReversePostOrderLinearizer</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">Linearizers.this.Linearizer</span><a href="#32483">Linearizer</a></span> {
    <span class="keyword">var</span> <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><span id="108111"><span id="108109"><span id="108110"><a id="108717">blocks</a></span></span></span></span>: <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;
    <span class="keyword">var</span> <span class="typed"><span class="type">scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><span id="108114"><span id="108112"><span id="108113"><a id="108718">visited</a></span></span></span></span>: <span class="typed"><span class="type">scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a id="19895">HashSet</a></span>[BasicBlock] = <span class="typed"><span class="type">scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a id="19895">HashSet</a></span>;
    <span class="keyword">val</span> <span class="typed"><span class="type">scala.collection.mutable.BitSet</span><span id="108116"><a id="108115">added</a></span></span>: <span class="typed"><span class="type">scala.collection.mutable.BitSet</span><a id="19946">BitSet</a></span> = <span class="typed"><span class="type">()scala.collection.mutable.BitSet</span><a id="32842" class="keyword">new</a></span> <span class="typed"><span class="type">scala.collection.mutable.BitSet</span><a id="19946">BitSet</a></span>
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]</span><a id="108117">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108724">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108110">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>;
      <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a href="#108112">visited</a></span>.<span class="typed"><span class="type">()Unit</span><a id="25501">clear</a></span>;
      <span class="typed"><span class="type">=&gt; scala.collection.mutable.BitSet</span><a href="#108115">added</a></span>.<span class="typed"><span class="type">()Unit</span><a id="32846">clear</a></span>;

      <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108724">m</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.ExceptionHandler]</span><a href="Members.scala.html#32873">exh</a></span> <span class="typed"><span class="type">((Linearizers.this.ExceptionHandler) =&gt; Unit)Unit</span><a id="21366">foreach</a></span> (<span class="typed"><span class="type">Linearizers.this.ExceptionHandler</span><a id="108728">b</a></span> =&gt; <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108119">rpo</a></span>(<span class="typed"><span class="type">Linearizers.this.ExceptionHandler</span><a href="#108728">b</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="ExceptionHandlers.scala.html#51919">startBlock</a></span>));
      <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108119">rpo</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108724">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span>);
      
      <span class="comment">// if the start block has predecessors, it won't be the first one </span>
      <span class="comment">// in the linearization, so we need to enforce it here</span>
      <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108724">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="BasicBlocks.scala.html#33219">predecessors</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5794">eq</a></span> <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>)
        <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108109">blocks</a></span>
      <span class="keyword">else</span>
        <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108724">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a href="#108731" id="21335">::</a></span> (<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108109">blocks</a></span>.<span class="typed"><span class="type">((Linearizers.this.BasicBlock) =&gt; Boolean)List[Linearizers.this.BasicBlock]</span><a id="21368">remove</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108733">_</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3509">==</a></span> <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108724">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.BasicBlock</span><a href="Members.scala.html#33276">startBlock</a></span>))
    }

    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod,Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="108118">linearizeAt</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108737">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108738">start</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108110">blocks</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>
      <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a href="#108112">visited</a></span>.<span class="typed"><span class="type">()Unit</span><a id="25501">clear</a></span>
      <span class="typed"><span class="type">=&gt; scala.collection.mutable.BitSet</span><a href="#108115">added</a></span>.<span class="typed"><span class="type">()Unit</span><a id="32846">clear</a></span>
      
      <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108119">rpo</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108738">start</a></span>)
      <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108109">blocks</a></span>
    }
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="108119">rpo</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108729">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">Unit</span><a id="2169">Unit</a></span> = 
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108729">b</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21644">size</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3145">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">=&gt; Boolean</span><a id="2747">!</a></span>(<span class="typed"><span class="type">=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a href="#108112">visited</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Boolean</span><a id="25498">contains</a></span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108729">b</a></span>)) {
        <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]</span><a href="#108112">visited</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="25499">+=</a></span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108729">b</a></span>;
        <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108729">b</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="BasicBlocks.scala.html#33217">successors</a></span> <span class="typed"><span class="type">((Linearizers.this.BasicBlock) =&gt; Unit)Unit</span><a id="21366">foreach</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108119">rpo</a></span>;
        <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a href="#108120">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108729">b</a></span>);
      }

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * @return Returns true if the block was added.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)Unit</span><a id="108120">add</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108747">b</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>) = 
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; Boolean</span><a id="2747">!</a></span><span class="typed"><span class="type">(Int)Boolean</span><a href="#108115" id="25543">added</a></span>(<span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108747">b</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="BasicBlocks.scala.html#33150">label</a></span>)) {
        <span class="typed"><span class="type">=&gt; scala.collection.mutable.BitSet</span><a href="#108115">added</a></span> <span class="typed"><span class="type">(Int)Unit</span><a id="32844">+=</a></span> <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108747">b</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="BasicBlocks.scala.html#33150">label</a></span>
        <span class="typed"><span class="type">(List[Linearizers.this.BasicBlock])Unit</span><a href="#108110">blocks</a></span> = <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="#108747">b</a></span> <span class="typed"><span class="type">(Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a href="#108753" id="21335">::</a></span> <span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a href="#108109">blocks</a></span>;
      }
  }

  <span class="comment">/** A 'dump' of the blocks in this method, which does not
   *  require any well-formedness of the basic blocks (like
   *  the last instruction being a jump).
   */</span>
  <span class="keyword">class</span> <span class="typed"><span class="type">class DumpLinearizer extends Linearizers.this.Linearizer with ScalaObject</span><a id="32487">DumpLinearizer</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">Linearizers.this.Linearizer</span><a href="#32483">Linearizer</a></span> {
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]</span><a id="108163">linearize</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108757">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] =
      <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="#108757">m</a></span>.<span class="typed"><span class="type">=&gt; Linearizers.this.Code</span><a href="Members.scala.html#32867">code</a></span>.<span class="typed"><span class="type">=&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]</span><a href="Members.scala.html#33274">blocks</a></span>.<span class="typed"><span class="type">=&gt; List[Linearizers.this.BasicBlock]</span><a id="33309">toList</a></span>;
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Linearizers.this.IMethod,Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]</span><a id="108164">linearizeAt</a></span>(<span class="typed"><span class="type">Linearizers.this.IMethod</span><a id="108759">m</a></span>: <span class="typed"><span class="type">Linearizers.this.IMethod</span><a href="Members.scala.html#32332">IMethod</a></span>, <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a id="108760">start</a></span>: <span class="typed"><span class="type">Linearizers.this.BasicBlock</span><a href="BasicBlocks.scala.html#32337">BasicBlock</a></span>): <span class="typed"><span class="type">List[Linearizers.this.BasicBlock]</span><a id="526">List</a></span>[BasicBlock] = {
      <span class="typed"><span class="type">(String)Nothing</span><span id="6000"><a id="821">error</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;not implemented&quot;)</span><span class="string">&quot;not implemented&quot;</span></span>)
    }
  }
  
}

        </pre>
    </body>
</html>