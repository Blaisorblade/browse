<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/backend/icode/TypeStacks.scala</title>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */</span>

<span class="comment">// $Id: TypeStacks.scala 16893 2009-01-13 13:09:22Z cunei $</span>

<span class="keyword">package</span> scala.tools.nsc.backend.icode

<span class="comment">/** This trait ...
 *
 *  @author  Iulian Dragos
 *  @version 1.0
 */</span>
<span class="keyword">trait</span> <span class="typed"><span class="type">trait TypeStacks extends java.lang.Object with ScalaObject</span><a id="11397">TypeStacks</a></span> { self: ICodes =&gt;
  <span class="keyword">import</span> opcodes._
  <span class="keyword">import</span> global.{Symbol, Type, definitions}

  <span class="comment">/* This class simulates the type of the opperand
   * stack of the ICode.
   */</span>
  <span class="keyword">type</span> <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a id="32348">Rep</a></span> = <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a id="526">List</a></span>[TypeKind]

  <span class="keyword">class</span> <span class="typed"><span class="type">class TypeStack extends java.lang.Object with ScalaObject</span><a id="32349">TypeStack</a></span> {
    <span class="keyword">var</span> <span class="typed"><span class="type">TypeStacks.this.Rep</span><span id="37233"><span id="37231"><span id="37232"><a id="155324">types</a></span></span></span></span>: <span class="typed"><span class="type">TypeStacks.this.Rep</span><a id="526">Rep</a></span> = <span class="typed"><span class="type">object Nil</span><a id="335">Nil</a></span>

    <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.Rep)TypeStacks.this.TypeStack</span><a id="37234" class="keyword">this</a></span>(<span class="typed"><span class="type">TypeStacks.this.Rep</span><a id="37251">stack</a></span>: <span class="typed"><span class="type">TypeStacks.this.Rep</span><a id="526">Rep</a></span>) = <span class="typed"><span class="type">Unit</span><span >{</span></span>
      <span class="typed"><span class="type">TypeStack.this.type</span><a href="#32349" class="keyword">this</a></span>()
      <span class="typed"><span class="type">TypeStack.this.type</span><a href="#32349" class="keyword">this</a></span>.<span class="typed"><span class="type">(TypeStacks.this.Rep)Unit</span><a href="#37232">types</a></span> = <span class="typed"><span class="type">TypeStacks.this.Rep</span><a href="#37251">stack</a></span>
    }

    <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.TypeStack)TypeStacks.this.TypeStack</span><a id="37235" class="keyword">this</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="37249">that</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>) = <span class="typed"><span class="type">(TypeStacks.this.Rep)TypeStacks.this.TypeStack</span><a href="#37234" class="keyword">this</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#37249">that</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>)

    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Int</span><a id="37236">length</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21345">length</a></span>

    <span class="comment">/** Push a type on the type stack. UNITs are ignored. */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.TypeKind)Unit</span><a id="37237">push</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="37564">t</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="TypeKinds.scala.html#32353">TypeKind</a></span>) =
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#37564">t</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5793">!=</a></span> <span class="typed"><span class="type">object TypeStacks.this.UNIT</span><a href="TypeKinds.scala.html#32355">UNIT</a></span>)
        <span class="typed"><span class="type">(TypeStacks.this.Rep)Unit</span><a href="#37232">types</a></span> = <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#37564">t</a></span> <span class="typed"><span class="type">(TypeStacks.this.TypeKind)List[TypeStacks.this.TypeKind]</span><a href="#37569" id="21335">::</a></span> <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>

    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a id="37238">head</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="TypeKinds.scala.html#32353">TypeKind</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a id="21332">head</a></span>

    <span class="comment">/** Removes the value on top of the stack, and returns it. It assumes
     *  the stack contains at least one element.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a id="37239">pop</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="TypeKinds.scala.html#32353">TypeKind</a></span> = {
      <span class="keyword">val</span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155336">t</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a id="21332">head</a></span>
      <span class="typed"><span class="type">(TypeStacks.this.Rep)Unit</span><a href="#37232">types</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; List[TypeStacks.this.TypeKind]</span><a id="21334">tail</a></span>
      <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155336">t</a></span>
    }

    <span class="comment">/** Return the topmost two values on the stack. It assumes the stack
     *  is large enough. Topmost element first.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; (TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><a id="37240">pop2</a></span>: <span class="typed"><span class="type">(TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><a id="1378">(</a></span>TypeKind, TypeKind) = <span class="typed"><span class="type">(TypeStacks.this.TypeKind,TypeStacks.this.TypeKind)(TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><span id="23625"><a id="1379">(</a></span></span><span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a href="#37239">pop</a></span>, <span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a href="#37239">pop</a></span>)

    <span class="comment">/** Return the topmost three values on the stack. It assumes the stack
     *  is large enough. Topmost element first.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; (TypeStacks.this.TypeKind, TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><a id="37241">pop3</a></span>: <span class="typed"><span class="type">(TypeStacks.this.TypeKind, TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><a id="448">(</a></span>TypeKind, TypeKind, TypeKind) = <span class="typed"><span class="type">(TypeStacks.this.TypeKind,TypeStacks.this.TypeKind,TypeStacks.this.TypeKind)(TypeStacks.this.TypeKind, TypeStacks.this.TypeKind, TypeStacks.this.TypeKind)</span><span id="23590"><a id="449">(</a></span></span><span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a href="#37239">pop</a></span>, <span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a href="#37239">pop</a></span>, <span class="typed"><span class="type">=&gt; TypeStacks.this.TypeKind</span><a href="#37239">pop</a></span>)

    <span class="comment">/** Drop the first n elements of the stack. */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Int)List[TypeStacks.this.TypeKind]</span><a id="37242">pop</a></span>(<span class="typed"><span class="type">Int</span><a id="37504">n</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a id="526">List</a></span>[TypeKind] = {
      <span class="keyword">val</span> <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a id="155347">prefix</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">(Int)List[TypeStacks.this.TypeKind]</span><a id="21351">take</a></span>(<span class="typed"><span class="type">Int</span><a href="#37504">n</a></span>)
      <span class="typed"><span class="type">(TypeStacks.this.Rep)Unit</span><a href="#37232">types</a></span> = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">(Int)List[TypeStacks.this.TypeKind]</span><a id="21353">drop</a></span>(<span class="typed"><span class="type">Int</span><a href="#37504">n</a></span>)
      <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a href="#155347">prefix</a></span>
    }
    
    <span class="keyword">def</span> <span class="typed"><span class="type">(Int)TypeStacks.this.TypeKind</span><a id="37243">apply</a></span>(<span class="typed"><span class="type">Int</span><a id="61904">n</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="TypeKinds.scala.html#32353">TypeKind</a></span> = <span class="typed"><span class="type">(Int)TypeStacks.this.TypeKind</span><a href="#37231" id="21361">types</a></span>(<span class="typed"><span class="type">Int</span><a href="#61904">n</a></span>)

    <span class="comment">/**
     * A TypeStack aggress with another one if they have the same
     * length and each type kind agrees position-wise. Two 
     * types agree if one is a subtype of the other.
     */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.TypeStack)Boolean</span><a id="37244">agreesWith</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="155354">other</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> =
      (<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21345">length</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155354">other</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21345">length</a></span>) <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span>
      <span class="typed"><span class="type">object List</span><a id="527">List</a></span>.<span class="typed"><span class="type">(List[TypeStacks.this.TypeKind],List[TypeStacks.this.TypeKind])((TypeStacks.this.TypeKind, TypeStacks.this.TypeKind) =&gt; Boolean)Boolean</span><a id="21458">forall2</a></span>(<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155354">other</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>) ((<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155362">t1</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155363">t2</a></span>) =&gt; <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155362">t1</a></span> <span class="typed"><span class="type">(TypeStacks.this.TypeKind)Boolean</span><a href="TypeKinds.scala.html#33485">&lt;:&lt;</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155363">t2</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2750">||</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155363">t2</a></span> <span class="typed"><span class="type">(TypeStacks.this.TypeKind)Boolean</span><a href="TypeKinds.scala.html#33485">&lt;:&lt;</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155362">t1</a></span>)

    <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.TypeStack)TypeStacks.this.TypeStack</span><a id="37245">mergeWith</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="155364">that</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>): <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span> = {
      <span class="keyword">def</span> <span class="typed"><span class="type">(TypeStacks.this.TypeStack,TypeStacks.this.TypeStack)TypeStacks.this.TypeStack</span><a id="155365">merge</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="155366">a</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="155367">b</a></span>: <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>): <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span> = {
        <span class="keyword">val</span> <span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a id="155368">lst</a></span> = <span class="typed"><span class="type">object List</span><a id="527">List</a></span>.<span class="typed"><span class="type">(List[TypeStacks.this.TypeKind],List[TypeStacks.this.TypeKind])((TypeStacks.this.TypeKind, TypeStacks.this.TypeKind) =&gt; TypeStacks.this.TypeKind)List[TypeStacks.this.TypeKind]</span><a id="21449">map2</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155366">a</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155367">b</a></span>.<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>) ((<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155373">k1</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155374">k2</a></span>) =&gt; <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155373">k1</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><span class="keyword">match</span></span> {
          <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><span class="keyword">case</span></span> <a id="1">REFERENCE</a>(<span class="typed"><span class="type">TypeStacks.this.global.Symbol</span><a id="155375">cls1</a></span>) =&gt;
            <span class="keyword">val</span> <span class="typed"><span class="type">TypeStacks.this.global.Symbol</span><a href="#155377">REFERENCE</a></span>(<span class="typed"><span class="type">TypeStacks.this.global.Symbol</span><span id="155376"><a id="155377">cls2</a></span></span>) = <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155374">k2</a></span>
            <span class="typed"><span class="type">(TypeStacks.this.TypeKind,TypeStacks.this.TypeKind)TypeStacks.this.TypeKind</span><a href="TypeKinds.scala.html#32354">lub</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155373">k1</a></span>,<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155374">k2</a></span>)
          <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><span class="keyword">case</span></span> _ =&gt; <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155373">k1</a></span>
        })
        <span class="typed"><span class="type">(TypeStacks.this.Rep)TypeStacks.this.TypeStack</span><a href="#37234" class="keyword">new</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>(<span class="typed"><span class="type">List[TypeStacks.this.TypeKind]</span><a href="#155368">lst</a></span>)
      }

      <span class="typed"><span class="type">(Boolean,=&gt; Any)Unit</span><span id="6004"><a id="821">assert</a></span></span>(<span class="typed"><span class="type">TypeStack.this.type</span><a href="#32349" class="keyword">this</a></span> <span class="typed"><span class="type">(TypeStacks.this.TypeStack)Boolean</span><a href="#37244">agreesWith</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155364">that</a></span>,
             <span class="typed"><span class="type">java.lang.String(&quot;Incompatible type stacks: &quot;)</span><span class="string">&quot;Incompatible type stacks: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349" class="keyword">this</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;, &quot;)</span><span class="string">&quot;, &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155364">that</a></span>)
      <span class="typed"><span class="type">(TypeStacks.this.TypeStack,TypeStacks.this.TypeStack)TypeStacks.this.TypeStack</span><a href="#155365">merge</a></span>(<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349" class="keyword">this</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#155364">that</a></span>)
    }

    <span class="comment">/* This method returns a String representation of the stack */</span>
    <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()String</span><a id="37246">toString</a></span>() = <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>.<span class="typed"><span class="type">(String,String,String)String</span><a id="21818">mkString</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;&lt;&quot;)</span><span class="string">&quot;&lt;&quot;</span></span>, <span class="typed"><span class="type">java.lang.String(&quot;,&quot;)</span><span class="string">&quot;,&quot;</span></span>, <span class="typed"><span class="type">java.lang.String(&quot;&gt;&quot;)</span><span class="string">&quot;&gt;&quot;</span></span>)

    <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">(Any)Boolean</span><a id="37247">equals</a></span>(<span class="typed"><span class="type">Any</span><a id="155394">other</a></span>: <span class="typed"><span class="type">Any</span><a id="51">Any</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> =
      <span class="typed"><span class="type">Any</span><a href="#155394">other</a></span>.<span class="typed"><span class="type">Boolean</span><a id="3501">isInstanceOf</a></span>[<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>] <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span>
      <span class="typed"><span class="type">object List</span><a id="527">List</a></span>.<span class="typed"><span class="type">(List[TypeStacks.this.TypeKind],List[TypeStacks.this.TypeKind])((TypeStacks.this.TypeKind, TypeStacks.this.TypeKind) =&gt; Boolean)Boolean</span><a id="21458">forall2</a></span>(<span class="typed"><span class="type">Any</span><a href="#155394">other</a></span>.<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a id="3503">asInstanceOf</a></span>[<span class="typed"><span class="type">TypeStacks.this.TypeStack</span><a href="#32349">TypeStack</a></span>].<span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>, <span class="typed"><span class="type">=&gt; TypeStacks.this.Rep</span><a href="#37231">types</a></span>)((<span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155398">a</a></span>, <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a id="155399">b</a></span>) =&gt; <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155398">a</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3509">==</a></span> <span class="typed"><span class="type">TypeStacks.this.TypeKind</span><a href="#155399">b</a></span>)
  }

}

        </pre>
    </body>
</html>