<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/transform/LazyVals.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> transform;

<span class="keyword">import</span> scala.tools.nsc._
<span class="keyword">import</span> scala.collection.mutable.HashMap

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class LazyVals extends scala.tools.nsc.SubComponent with scala.tools.nsc.transform.Transform with scala.tools.nsc.ast.TreeDSL with ScalaObject" id="13945">LazyVals</a> <span title="ScalaObject" class="keyword">extends</span> <a href="Transform.scala.html#14164" title="scala.tools.nsc.transform.Transform">Transform</a> <span class="keyword">with</span> ast.<a href="../ast/TreeDSL.scala.html#11964" title="scala.tools.nsc.ast.TreeDSL">TreeDSL</a> {
  // inherits abstract value `global' and class `Phase' from Transform

  <span class="keyword">import</span> global._                  // the global environment
  <span class="keyword">import</span> definitions._             // standard classes and methods
  <span class="keyword">import</span> typer.{typed, atOwner}    // methods to type trees
  <span class="keyword">import</span> CODE._

  <span class="keyword">val</span> <a title="String" id="580976">phaseName</a>: <a title="String" id="1626">String</a> = <span title="java.lang.String(&quot;lazyvals&quot;)" class="string">&quot;lazyvals&quot;</span>

  <span class="keyword">def</span> <a title="(unit: LazyVals.this.global.CompilationUnit)LazyVals.this.global.Transformer" id="580978">newTransformer</a>(<a title="LazyVals.this.global.CompilationUnit" id="704121">unit</a>: <a href="../CompilationUnits.scala.html#39428" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>): <a href="../ast/Trees.scala.html#26932" title="LazyVals.this.global.Transformer">Transformer</a> =
    <span title="LazyVals.this.LazyValues" class="keyword">new</span> <a href="#580981" title="LazyVals.this.LazyValues">LazyValues</a>(<a href="#704121" title="LazyVals.this.global.CompilationUnit">unit</a>)

  /** Create a new phase which applies transformer */
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(prev: scala.tools.nsc.Phase)LazyVals.this.StdPhase" id="580979">newPhase</a>(<a title="scala.tools.nsc.Phase" id="704143">prev</a>: scala.tools.nsc.<a href="../Phase.scala.html#8931" title="scala.tools.nsc.Phase">Phase</a>): <a href="../SubComponent.scala.html#39872" title="LazyVals.this.StdPhase">StdPhase</a> = <span title="LazyVals.this.Phase" class="keyword">new</span> <a href="#580980" title="LazyVals.this.Phase">Phase</a>(<a href="#704143" title="scala.tools.nsc.Phase">prev</a>)

  /** The phase defined by this transform */
  <span class="keyword">class</span> <a title="class Phase extends LazyVals.this.StdPhase with ScalaObject" id="580980">Phase</a><span title="ScalaObject">(</span><a title="scala.tools.nsc.Phase" id="704149">prev</a>: scala.tools.nsc.<a href="../Phase.scala.html#8931" title="scala.tools.nsc.Phase">Phase</a>) <span class="keyword">extends</span> <a href="../SubComponent.scala.html#39872" title="LazyVals.this.StdPhase">StdPhase</a>(<a href="#704149" title="scala.tools.nsc.Phase">prev</a>) {
    <span class="keyword">def</span> <a title="(unit: LazyVals.this.global.CompilationUnit)Unit" id="704148">apply</a>(<a title="LazyVals.this.global.CompilationUnit" id="704156">unit</a>: global.<a href="../CompilationUnits.scala.html#39428" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>): <a title="Unit" id="1971">Unit</a> = <a href="#580978" title="(unit: LazyVals.this.global.CompilationUnit)LazyVals.this.global.Transformer">newTransformer</a><a href="../ast/Trees.scala.html#45715" title="(unit: LazyVals.this.global.CompilationUnit)Unit">(</a><a href="#704156" title="LazyVals.this.global.CompilationUnit">unit</a>) transformUnit <a href="#704156" title="LazyVals.this.global.CompilationUnit">unit</a>
  }

  /**
   * Transform local lazy accessors to check for the initialized bit.
   */
  <span class="keyword">class</span> <a title="class LazyValues extends LazyVals.this.global.Transformer with ScalaObject" id="580981">LazyValues</a><span title="ScalaObject">(</span><a title="LazyVals.this.global.CompilationUnit" id="704140">unit</a>: <a href="../CompilationUnits.scala.html#39428" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>) <span class="keyword">extends</span> <a href="../ast/Trees.scala.html#26932" title="LazyVals.this.global.Transformer">Transformer</a> {    
    /** map from method symbols to the number of lazy values it defines. */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]" id="704127">lazyVals</a> = <a href="#704167" title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]{ ... }" class="keyword">new</a> <a title="anonymous class $anon extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]" id="704167">HashMap</a>[Symbol, Int] {
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol)Int" id="704169">default</a>(<a title="LazyVals.this.global.Symbol" id="704173">meth</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>) = <span title="Int(0)" class="int">0</span>
    }
    
    <span class="keyword">import</span> symtab.Flags._
    <span class="keyword">import</span> lazyVals._

    /** Perform the following transformations:
     *  - for a lazy accessor inside a method, make it check the initialization bitmap
     *  - for all methods, add enough int vars to allow one flag per lazy local value
     *  - blocks in template bodies behave almost like methods. A single bitmaps section is
     *      added in the first block, for all lazy values defined in such blocks.
     *  - remove ACCESSOR flags: accessors in traits are not statically implemented,  
     *    but moved to the host class. local lazy values should be statically implemented.
     */
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="704131">transform</a>(<a title="LazyVals.this.global.Tree" id="704215">tree</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a> = {
      <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="704218">sym</a> = <a href="#704215" title="LazyVals.this.global.Tree">tree</a>.<a href="../ast/Trees.scala.html#29553" title="=&gt; LazyVals.this.global.Symbol">symbol</a>
      <a href="#704215" title="LazyVals.this.global.Tree">tree</a> <span title="LazyVals.this.global.Tree" class="keyword">match</span> {
        <span title="LazyVals.this.global.DefDef" class="keyword">case</span> DefDef(<a title="LazyVals.this.global.Modifiers" id="704227">mods</a>, <a title="LazyVals.this.global.Name" id="704228">name</a>, <a title="List[LazyVals.this.global.TypeDef]" id="704229">tparams</a>, <a title="List[List[LazyVals.this.global.ValDef]]" id="704230">vparams</a>, <a title="LazyVals.this.global.Tree" id="704231">tpt</a>, <a title="LazyVals.this.global.Tree" id="704232">rhs</a>) =&gt;
          <span class="keyword">val</span> <a title="LazyVals.this.global.Tree" id="704235">res</a> = <span title="LazyVals.this.global.Tree" class="keyword">if</span> (<span title="(x$1: Boolean)Boolean">!</span><a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27142" title="=&gt; LazyVals.this.global.Symbol">owner</a>.<a href="../symtab/Symbols.scala.html#27056" title="=&gt; Boolean">isClass</a> &amp;&amp; <a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27155" title="(mask: Long)Boolean">hasFlag</a>(<span title="Long(2147483648L)">LAZY</span>)) {
            <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="704240">enclosingDummyOrMethod</a> = 
              <span title="LazyVals.this.global.Symbol" class="keyword">if</span> (<a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27191" title="(x$1: AnyRef)Boolean">enclMethod</a> == <a href="../symtab/Symbols.scala.html#26293" title="object LazyVals.this.global.NoSymbol">NoSymbol</a>) <a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27142" title="=&gt; LazyVals.this.global.Symbol">owner</a> <span class="keyword">else</span> <a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27191" title="=&gt; LazyVals.this.global.Symbol">enclMethod</a>
            <span class="keyword">val</span> <a title="Int" id="704241">idx</a> = <a href="#704127" title="(key: LazyVals.this.global.Symbol)Int">lazyVals</a>(<a href="#704240" title="LazyVals.this.global.Symbol">enclosingDummyOrMethod</a>)
            <span class="keyword">val</span> <a title="LazyVals.this.global.Tree" id="704242">rhs1</a> = <a href="#704133" title="(meth: LazyVals.this.global.Symbol,tree: LazyVals.this.global.Tree,offset: Int)LazyVals.this.global.Tree">mkLazyDef</a>(<a href="#704240" title="LazyVals.this.global.Symbol">enclosingDummyOrMethod</a>, <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45705" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#704232" title="LazyVals.this.global.Tree">rhs</a>), <a href="#704241" title="Int">idx</a>)
            <a href="#704127" title="(key: LazyVals.this.global.Symbol,value: Int)Unit">lazyVals</a>(<a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27142" title="=&gt; LazyVals.this.global.Symbol">owner</a>) = <a href="#704241" title="(x$1: Int)Int" id="2985">idx</a> + <span title="Int(1)" class="int">1</span>
            <a href="#704218" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27153" title="(mask: Long)sym.type">resetFlag</a>(LAZY <span title="Long(2281701376L)">|</span> ACCESSOR) 
            <a href="#704242" title="LazyVals.this.global.Tree">rhs1</a>
          } <span class="keyword">else</span>
            <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45705" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#704232" title="LazyVals.this.global.Tree">rhs</a>)
          <a href="../ast/Trees.scala.html#45697" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48798" title="(tree: LazyVals.this.global.Tree,mods: LazyVals.this.global.Modifiers,name: LazyVals.this.global.Name,tparams: List[LazyVals.this.global.TypeDef],vparamss: List[List[LazyVals.this.global.ValDef]],tpt: LazyVals.this.global.Tree,rhs: LazyVals.this.global.Tree)LazyVals.this.global.DefDef">DefDef</a>(<a href="#704215" title="LazyVals.this.global.Tree">tree</a>, <a href="#704227" title="LazyVals.this.global.Modifiers">mods</a>, <a href="#704228" title="LazyVals.this.global.Name">name</a>, <a href="#704229" title="List[LazyVals.this.global.TypeDef]">tparams</a>, <a href="#704230" title="List[List[LazyVals.this.global.ValDef]]">vparams</a>, <a href="#704231" title="LazyVals.this.global.Tree">tpt</a>, 
                          <a href="../typechecker/Typers.scala.html#42872" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#704132" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#704218" title="LazyVals.this.global.Symbol">sym</a>, <a href="#704235" title="LazyVals.this.global.Tree">res</a>)))

        <span title="LazyVals.this.global.Template" class="keyword">case</span> Template(<a title="List[LazyVals.this.global.Tree]" id="704359">parents</a>, <a title="LazyVals.this.global.ValDef" id="704360">self</a>, <a title="List[LazyVals.this.global.Tree]" id="704361">body</a>) =&gt;
          <span class="keyword">val</span> <a title="List[LazyVals.this.global.Tree]" id="704364">body1</a> = <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45706" title="(trees: List[LazyVals.this.global.Tree])List[LazyVals.this.global.Tree]">transformTrees</a>(<a href="#704361" title="List[LazyVals.this.global.Tree]">body</a>)
          <span class="keyword">var</span> <a title="Boolean" id="704365">added</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">val</span> <a title="List[LazyVals.this.global.analyzer.global.Tree]" id="704366">stats</a> = 
            <span class="keyword">for</span> (<a title="LazyVals.this.global.Tree" id="704379">stat</a> &lt;- <a href="#704364" title="(f: (LazyVals.this.global.Tree) =&gt; LazyVals.this.global.analyzer.global.Tree)(implicit bf: scala.collection.generic.BuilderFactory[LazyVals.this.global.analyzer.global.Tree,List[LazyVals.this.global.analyzer.global.Tree],List[LazyVals.this.global.Tree]])List[LazyVals.this.global.analyzer.global.Tree]">body1</a>) <span class="keyword">yield</span> <a href="#704379" title="LazyVals.this.global.Tree">stat</a> <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">match</span> {
              <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">case</span> Block(_, _) <span class="keyword">if</span> <span title="=&gt; Boolean">!</span><a href="#704365" title="Boolean">added</a> =&gt; 
                <a href="#704365" title="Boolean">added</a> = <span title="Boolean(true)" class="keyword">true</span>
                <a href="../typechecker/Typers.scala.html#42872" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#704132" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#704218" title="LazyVals.this.global.Symbol">sym</a>, <a href="#704379" title="LazyVals.this.global.Tree">stat</a>))
              <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">case</span> ValDef(<a title="LazyVals.this.global.Modifiers" id="704403">mods</a>, <a title="LazyVals.this.global.Name" id="704404">name</a>, <a title="LazyVals.this.global.Tree" id="704405">tpt</a>, <a title="LazyVals.this.global.Tree" id="704406">rhs</a>) =&gt;
                <a href="../typechecker/Typers.scala.html#42872" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="../ast/Trees.scala.html#45697" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48797" title="(tree: LazyVals.this.global.Tree,mods: LazyVals.this.global.Modifiers,name: LazyVals.this.global.Name,tpt: LazyVals.this.global.Tree,rhs: LazyVals.this.global.Tree)LazyVals.this.global.ValDef">ValDef</a>(<a href="#704379" title="LazyVals.this.global.Tree">stat</a>, <a href="#704403" title="LazyVals.this.global.Modifiers">mods</a>, <a href="#704404" title="LazyVals.this.global.Name">name</a>, <a href="#704405" title="LazyVals.this.global.Tree">tpt</a>, <a href="#704132" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#704379" title="LazyVals.this.global.Tree">stat</a>.<a href="../ast/Trees.scala.html#29553" title="=&gt; LazyVals.this.global.Symbol">symbol</a>, <a href="#704406" title="LazyVals.this.global.Tree">rhs</a>)))
              <span title="LazyVals.this.global.Tree" class="keyword">case</span> _ =&gt; 
                <a href="#704379" title="LazyVals.this.global.Tree">stat</a>
            }
          <a href="../ast/Trees.scala.html#45697" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48803" title="(tree: LazyVals.this.global.Tree,parents: List[LazyVals.this.global.Tree],self: LazyVals.this.global.ValDef,body: List[LazyVals.this.global.Tree])LazyVals.this.global.Template">Template</a>(<a href="#704215" title="LazyVals.this.global.Tree">tree</a>, <a href="#704359" title="List[LazyVals.this.global.Tree]">parents</a>, <a href="#704360" title="LazyVals.this.global.ValDef">self</a>, <a href="#704366" title="List[LazyVals.this.global.analyzer.global.Tree]">stats</a>)
          
        <span title="LazyVals.this.global.Tree" class="keyword">case</span> _ =&gt; <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45705" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#704215" title="LazyVals.this.global.Tree">tree</a>)
      }
    }

    /** Add the bitmap definitions to the rhs of a method definition.
     *  If the rhs has been tail-call transformed, insert the bitmap
     *  definitions inside the top-level label definition, so that each
     *  iteration has the lazy values un-initialized. Otherwise add them
     *  at the very beginning of the method.
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="704132">addBitmapDefs</a>(<a title="LazyVals.this.global.Symbol" id="704345">methSym</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="704346">rhs</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a> = {
      <span class="keyword">def</span> <a title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block" id="704519">prependStats</a>(<a title="List[LazyVals.this.global.Tree]" id="704521">stats</a>: <a title="List[LazyVals.this.global.Tree]" id="7414">List</a>[Tree], <a title="LazyVals.this.global.Tree" id="704522">tree</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26812" title="LazyVals.this.global.Block">Block</a> = <a href="#704522" title="LazyVals.this.global.Tree">tree</a> <span title="LazyVals.this.global.Block" class="keyword">match</span> {
        <span title="LazyVals.this.global.Block" class="keyword">case</span> Block(<a title="List[LazyVals.this.global.Tree]" id="704525">stats1</a>, <a title="LazyVals.this.global.Tree" id="704526">res</a>) =&gt; <a href="../ast/Trees.scala.html#49279" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#704521" title="List[LazyVals.this.global.Tree]">stats</a> <a href="#704547" title="List[LazyVals.this.global.Tree]">:::</a> <a href="#704525" title="(prefix: List[LazyVals.this.global.Tree])List[LazyVals.this.global.Tree]" id="24420">stats1</a>, <a href="#704526" title="LazyVals.this.global.Tree">res</a>)
        <span title="LazyVals.this.global.Block" class="keyword">case</span> _ =&gt; <a href="../ast/Trees.scala.html#49279" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#704521" title="List[LazyVals.this.global.Tree]">stats</a>, <a href="#704522" title="LazyVals.this.global.Tree">tree</a>)
      }

      <span class="keyword">val</span> <a title="List[LazyVals.this.global.ValDef]" id="704520">bmps</a> = <a href="#704137" title="(key: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]">bitmaps</a><span title="(f: (LazyVals.this.global.Symbol) =&gt; LazyVals.this.global.ValDef)(implicit bf: scala.collection.generic.BuilderFactory[LazyVals.this.global.ValDef,List[LazyVals.this.global.ValDef],List[LazyVals.this.global.Symbol]])List[LazyVals.this.global.ValDef]">(</span><a href="#704345" title="LazyVals.this.global.Symbol">methSym</a>) <a title="scala.collection.generic.BuilderFactory[LazyVals.this.global.ValDef,List[LazyVals.this.global.ValDef],List#Coll]" id="24472">map</a> (<a href="../ast/Trees.scala.html#26781" title="(sym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.ValDef">ValDef</a>(<a href="#704596" title="LazyVals.this.global.Symbol">_</a>, <a href="../ast/TreeDSL.scala.html#42729" title="=&gt; LazyVals.this.global.Literal">ZERO</a>))
      <span title="LazyVals.this.global.Tree" class="keyword">if</span> (<a href="#704520" title="List[LazyVals.this.global.ValDef]">bmps</a>.<a title="=&gt; Boolean" id="25593">isEmpty</a>) <a href="#704346" title="LazyVals.this.global.Tree">rhs</a> <span class="keyword">else</span> <a href="#704346" title="LazyVals.this.global.Tree">rhs</a> <span title="LazyVals.this.global.Tree" class="keyword">match</span> {
        <span title="LazyVals.this.global.Block" class="keyword">case</span> Block(<a title="List[LazyVals.this.global.Tree]" id="704714">assign</a>, <a title="LazyVals.this.global.LabelDef" id="704715">l</a> @ LabelDef(<a title="LazyVals.this.global.Name" id="704721">name</a>, <a title="List[LazyVals.this.global.Ident]" id="704722">params</a>, <a title="LazyVals.this.global.Tree" id="704723">rhs1</a>))
          <span class="keyword">if</span> (<a href="#704721" title="LazyVals.this.global.Name">name</a>.<a href="../symtab/Names.scala.html#28391" title="()String">toString</a>.<a title="(x$1: Any)Boolean" id="7016">equals</a><span title="(x$1: Boolean)Boolean">(</span><a title="(x$1: Any)java.lang.String" id="6622" class="string">&quot;_&quot;</a> + <a href="#704345" title="LazyVals.this.global.Symbol">methSym</a>.<a href="../symtab/Symbols.scala.html#27147" title="=&gt; LazyVals.this.global.Name">name</a>)
              &amp;&amp; <span title="object List">List</span>.<a title="(xs: List[LazyVals.this.global.Ident],ys: List[LazyVals.this.global.Type])(f: (LazyVals.this.global.Ident, LazyVals.this.global.Type) =&gt; Boolean)Boolean" id="24550">forall2</a>(<a href="#704722" title="List[LazyVals.this.global.Ident]">params</a>.<a title="=&gt; List[LazyVals.this.global.Ident]" id="25477">tail</a>, <a href="#704345" title="LazyVals.this.global.Symbol">methSym</a>.<a href="../symtab/Symbols.scala.html#27162" title="=&gt; LazyVals.this.global.Type">tpe</a>.<a href="../symtab/Types.scala.html#30386" title="=&gt; List[LazyVals.this.global.Type]">paramTypes</a>) { (<a title="LazyVals.this.global.Ident" id="704748">ident</a>, <a title="LazyVals.this.global.Type" id="704749">tpe</a>) =&gt; <a href="#704748" title="LazyVals.this.global.Ident">ident</a>.<a href="../ast/Trees.scala.html#29549" title="(x$1: AnyRef)Boolean">tpe</a> == <a href="#704749" title="LazyVals.this.global.Type">tpe</a> }) =&gt;
            <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="704761">sym</a> = <a href="#704715" title="LazyVals.this.global.LabelDef">l</a>.<a href="../ast/Trees.scala.html#48738" title="=&gt; LazyVals.this.global.Symbol">symbol</a>
            <a href="../ast/Trees.scala.html#49279" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#704714" title="List[LazyVals.this.global.Tree]">assign</a>, <a href="../ast/Trees.scala.html#45697" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48800" title="(tree: LazyVals.this.global.Tree,name: LazyVals.this.global.Name,params: List[LazyVals.this.global.Ident],rhs: LazyVals.this.global.Tree)LazyVals.this.global.LabelDef">LabelDef</a>(<a href="#704715" title="LazyVals.this.global.LabelDef">l</a>, <a href="#704721" title="LazyVals.this.global.Name">name</a>, <a href="#704722" title="List[LazyVals.this.global.Ident]">params</a>, <a href="../typechecker/Typers.scala.html#42872" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#704519" title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block">prependStats</a>(<a href="#704520" title="List[LazyVals.this.global.ValDef]">bmps</a>, <a href="#704723" title="LazyVals.this.global.Tree">rhs1</a>))))

        <span title="LazyVals.this.global.Block" class="keyword">case</span> _ =&gt; <a href="#704519" title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block">prependStats</a>(<a href="#704520" title="List[LazyVals.this.global.ValDef]">bmps</a>, <a href="#704346" title="LazyVals.this.global.Tree">rhs</a>)
      }
    }
    
    /** return a 'lazified' version of rhs. Rhs should conform to the
     *  following schema:
     *  {
     *    l$ = &lt;rhs&gt; 
     *    l$
     *  } or
     *  &lt;rhs&gt; when the lazy value has type Unit (for which there is no field
     *  to cache it's value.
     * 
     *  The result will be a tree of the form
     *  {
     *    if ((bitmap$n &amp; MASK) == 0) {
     *       l$ = &lt;rhs&gt;
     *       bitmap$n = bimap$n | MASK
     *    }
     *    l$
     *  }
     *  where bitmap$n is an int value acting as a bitmap of initialized values. It is
     *  the 'n' is (offset / 32), the MASK is (1 &lt;&lt; (offset % 32)). If the value has type
     *  unit, no field is used to chache the value, so the resulting code is:
     *  {
     *    if ((bitmap$n &amp; MASK) == 0) {
     *       &lt;rhs&gt;;
     *       bitmap$n = bimap$n | MASK
     *    }
     *    ()
     *  }
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol,tree: LazyVals.this.global.Tree,offset: Int)LazyVals.this.global.Tree" id="704133">mkLazyDef</a>(<a title="LazyVals.this.global.Symbol" id="704264">meth</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="704265">tree</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>, <a title="Int" id="704266">offset</a>: <span title="Int">Int</span>): <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a> = {      
      <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="704803">bitmapSym</a>           = <a href="#704139" title="(meth: LazyVals.this.global.Symbol,offset: Int)LazyVals.this.global.Symbol">getBitmapFor</a>(<a href="#704264" title="LazyVals.this.global.Symbol">meth</a>, <a href="#704266" title="Int">offset</a>)
      <span class="keyword">val</span> <a title="LazyVals.this.global.Literal" id="704804">mask</a>                = <a href="../ast/TreeDSL.scala.html#49582" title="(x: Any)LazyVals.this.global.Literal">LIT</a>(<a title="(x$1: Int)Int" id="2874" class="int">1</a> &lt;&lt; (<a href="#704266" title="(x$1: Int)Int" id="2993">offset</a> % <span title="Int(32)">FLAGS_PER_WORD</span>))
      <span class="keyword">def</span> <a title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block" id="704805">mkBlock</a>(<a title="LazyVals.this.global.Tree" id="704832">stmt</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>) = <a href="../ast/TreeDSL.scala.html#42758" title="(xs: LazyVals.this.global.Tree*)LazyVals.this.global.Block">BLOCK</a>(<a href="#704832" title="LazyVals.this.global.Tree">stmt</a>, <a href="#704134" title="(bmp: LazyVals.this.global.Symbol,mask: LazyVals.this.global.Tree)LazyVals.this.global.Tree">mkSetFlag</a>(<a href="#704803" title="LazyVals.this.global.Symbol">bitmapSym</a>, <a href="#704804" title="LazyVals.this.global.Literal">mask</a>), <a href="../ast/TreeDSL.scala.html#42731" title="=&gt; LazyVals.this.global.Literal">UNIT</a>)

      <span class="keyword">val</span> <a href="#36621" title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)">(</a><a href="#704806" title="LazyVals.this.global.Block" id="36621">block</a>, <a href="#704806" title="LazyVals.this.global.Tree" id="36623">res</a>) = <a href="#704265" title="LazyVals.this.global.Tree">tree</a> <span title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)" class="keyword">match</span> {
        <span title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)" class="keyword">case</span> Block(<a href="#704844" title="(x: List[LazyVals.this.global.Tree])Some[List[LazyVals.this.global.Tree]]" id="24568">List</a>(<a title="LazyVals.this.global.Tree" id="704853">assignment</a>), <a title="LazyVals.this.global.Tree" id="704855">res</a>) =&gt; <span title="(_1: LazyVals.this.global.Block,_2: LazyVals.this.global.Tree)(LazyVals.this.global.Block, LazyVals.this.global.Tree)">(</span><a href="#704805" title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block">mkBlock</a>(<a href="#704853" title="LazyVals.this.global.Tree">assignment</a>),  <a href="#704855" title="LazyVals.this.global.Tree">res</a>)
        <span title="(LazyVals.this.global.Block, LazyVals.this.global.Literal)" class="keyword">case</span> <a title="LazyVals.this.global.Tree" id="704868">rhs</a>                          =&gt; <span title="(_1: LazyVals.this.global.Block,_2: LazyVals.this.global.Literal)(LazyVals.this.global.Block, LazyVals.this.global.Literal)">(</span><a href="#704805" title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block">mkBlock</a>(<a href="#704868" title="LazyVals.this.global.Tree">rhs</a>),         <a href="../ast/TreeDSL.scala.html#42731" title="=&gt; LazyVals.this.global.Literal">UNIT</a>)          
      }
      <a title="(assertion: Boolean)Unit" id="708">assert</a>(<a href="#36623" title="(x$1: AnyRef)Boolean" id="6609">res</a> <a title="(x$1: Boolean)Boolean" id="2231">!=</a> <a href="../ast/TreeDSL.scala.html#42731" title="=&gt; LazyVals.this.global.Literal">UNIT</a> || <a href="#704264" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#27162" title="=&gt; LazyVals.this.global.Type">tpe</a>.<a href="../symtab/Types.scala.html#30382" title="=&gt; LazyVals.this.global.Type">finalResultType</a>.<a href="../symtab/Types.scala.html#30366" title="(x$1: AnyRef)Boolean">typeSymbol</a> == <a href="../symtab/Definitions.scala.html#28463" title="=&gt; LazyVals.this.global.Symbol">UnitClass</a>)
      
      <a href="../ast/Trees.scala.html#26943" title="(pos: scala.tools.nsc.util.Position)(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">atPos</a>(<a href="#704265" title="LazyVals.this.global.Tree">tree</a>.<a href="../ast/Trees.scala.html#29547" title="=&gt; scala.tools.nsc.util.Position">pos</a>)(<a href="../typechecker/Typers.scala.html#42872" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a> {
        <span class="keyword">def</span> <a title="=&gt; LazyVals.this.global.If" id="704931">body</a> = { <a href="../ast/TreeDSL.scala.html#42756" title="(tree: LazyVals.this.global.Tree)LazyVals.this.CODE.IfStart">IF</a> <a href="../ast/TreeDSL.scala.html#50041" title="(x: LazyVals.this.global.Tree)LazyVals.this.CODE.IfStart">(</a><a href="../ast/TreeDSL.scala.html#45309" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="../ast/Trees.scala.html#26895" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45308" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="#704803" title="LazyVals.this.global.Symbol">bitmapSym</a>) <a href="../ast/TreeDSL.scala.html#42770" title="implicit scala.tools.nsc.ast.TreeDSL.CODE.mkTreeMethods : (target: LazyVals.this.global.Tree)LazyVals.this.CODE.TreeMethods">INT_&amp;</a> <a href="#704804" title="LazyVals.this.global.Literal">mask</a>) INT_== <a href="../ast/TreeDSL.scala.html#42729" title="=&gt; LazyVals.this.global.Literal">ZERO</a>) THEN <a href="#36621" title="LazyVals.this.global.Block">block</a> <a href="../ast/TreeDSL.scala.html#50043" title="=&gt; LazyVals.this.global.If">ENDIF</a> }
        <a href="../ast/TreeDSL.scala.html#42758" title="(xs: LazyVals.this.global.Tree*)LazyVals.this.global.Block">BLOCK</a>(<a href="#704931" title="=&gt; LazyVals.this.global.If">body</a>, <a href="#36623" title="LazyVals.this.global.Tree">res</a>)
      })
    }
     
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bmp: LazyVals.this.global.Symbol,mask: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="704134">mkSetFlag</a>(<a title="LazyVals.this.global.Symbol" id="704834">bmp</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="704835">mask</a>: <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26752" title="LazyVals.this.global.Tree">Tree</a> =
      <a href="../ast/Trees.scala.html#26895" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45318" title="(rhs: LazyVals.this.global.Tree)LazyVals.this.global.Assign">(</a><a href="#704834" title="LazyVals.this.global.Symbol">bmp</a>) === (<a href="../ast/Trees.scala.html#26895" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45307" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="#704834" title="LazyVals.this.global.Symbol">bmp</a>) INT_| <a href="#704835" title="LazyVals.this.global.Tree">mask</a>)
    
    <span class="keyword">final</span> <span class="keyword">val</span> <a title="Int(32)" id="704135">FLAGS_PER_WORD</a> = <span title="Int(32)" class="int">32</span>
    <span class="keyword">val</span> <a title="&lt;refinement&gt; extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]" id="704137">bitmaps</a> = <a href="#704188" title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]{ ... }" class="keyword">new</a> <a title="anonymous class $anon extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]" id="704188">HashMap</a>[Symbol, List[Symbol]] {
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol)object Nil" id="704190">default</a>(<a title="LazyVals.this.global.Symbol" id="704194">meth</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>) = <a title="object Nil" id="7700">Nil</a>
    }
    
    /** Return the symbol corresponding of the right bitmap int inside meth,
     *  given offset.
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol,offset: Int)LazyVals.this.global.Symbol" id="704139">getBitmapFor</a>(<a title="LazyVals.this.global.Symbol" id="704809">meth</a>: <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="Int" id="704810">offset</a>: <span title="Int">Int</span>): <a href="../symtab/Symbols.scala.html#26286" title="LazyVals.this.global.Symbol">Symbol</a> = {
      <span class="keyword">val</span> <a title="Int" id="705067">n</a> = <a href="#704810" title="(x$1: Int)Int" id="2991">offset</a> / <span title="Int(32)">FLAGS_PER_WORD</span>
      <span class="keyword">val</span> <a title="List[LazyVals.this.global.Symbol]" id="705068">bmps</a> = <a href="#704137" title="(key: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]">bitmaps</a>(<a href="#704809" title="LazyVals.this.global.Symbol">meth</a>)
      <span title="LazyVals.this.global.Symbol" class="keyword">if</span> (<a href="#705068" title="List[LazyVals.this.global.Symbol]">bmps</a>.<a title="(x$1: Int)Boolean" id="29114">length</a> &gt; <a href="#705067" title="Int">n</a>) 
        <a href="#705068" title="(n: Int)LazyVals.this.global.Symbol" id="29115">bmps</a>(<a href="#705067" title="Int">n</a>)
      <span class="keyword">else</span> {
        <span class="keyword">val</span> <a title="LazyVals.this.global.TermSymbol" id="705101">sym</a> = <a href="#704809" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#27023" title="(pos: scala.tools.nsc.util.Position,name: LazyVals.this.global.Name)LazyVals.this.global.TermSymbol">newVariable</a>(<a href="#704809" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#27006" title="=&gt; scala.tools.nsc.util.Position">pos</a>, <a href="../symtab/StdNames.scala.html#26690" title="object LazyVals.this.global.nme">nme</a>.<a href="../symtab/StdNames.scala.html#29864" title="(n: Int)LazyVals.this.global.Name">bitmapName</a>(<a href="#705067" title="Int">n</a>)).<a href="../symtab/Symbols.scala.html#27164" title="(info: LazyVals.this.global.Type)LazyVals.this.global.TermSymbol">setInfo</a>(<a href="../symtab/Definitions.scala.html#28471" title="=&gt; LazyVals.this.global.Symbol">IntClass</a>.<a href="../symtab/Symbols.scala.html#27162" title="=&gt; LazyVals.this.global.Type">tpe</a>)
        <a href="#704137" title="(key: LazyVals.this.global.Symbol,value: List[LazyVals.this.global.Symbol])Unit">bitmaps</a>(<a href="#704809" title="LazyVals.this.global.Symbol">meth</a>) = (<a href="#705101" title="LazyVals.this.global.TermSymbol">sym</a> <a href="#705119" title="LazyVals.this.global.TermSymbol">::</a> <a href="#705068" title="(x: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]" id="24417">bmps</a>).<a title="=&gt; List[LazyVals.this.global.Symbol]" id="24460">reverse</a>
        <a href="#705101" title="LazyVals.this.global.TermSymbol">sym</a>
      }
    }
  }
}

        </pre>
    </body>
</html>