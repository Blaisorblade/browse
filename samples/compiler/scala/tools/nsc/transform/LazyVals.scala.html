<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/transform/LazyVals.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> transform;

<span class="keyword">import</span> scala.tools.nsc._
<span class="keyword">import</span> scala.collection.mutable.HashMap

<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class LazyVals extends scala.tools.nsc.SubComponent with scala.tools.nsc.transform.Transform with scala.tools.nsc.ast.TreeDSL with ScalaObject" id="13870">LazyVals</a> <span title="ScalaObject" class="keyword">extends</span> <a href="Transform.scala.html#14089" title="scala.tools.nsc.transform.Transform">Transform</a> <span class="keyword">with</span> ast.<a href="../ast/TreeDSL.scala.html#11895" title="scala.tools.nsc.ast.TreeDSL">TreeDSL</a> {
  // inherits abstract value `global' and class `Phase' from Transform

  <span class="keyword">import</span> global._                  // the global environment
  <span class="keyword">import</span> definitions._             // standard classes and methods
  <span class="keyword">import</span> typer.{typed, atOwner}    // methods to type trees
  <span class="keyword">import</span> CODE._

  <span class="keyword">val</span> <a title="String" id="579411">phaseName</a>: <a title="String" id="1605">String</a> = <span title="java.lang.String(&quot;lazyvals&quot;)" class="string">&quot;lazyvals&quot;</span>

  <span class="keyword">def</span> <a title="(unit: LazyVals.this.global.CompilationUnit)LazyVals.this.global.Transformer" id="579413">newTransformer</a>(<a title="LazyVals.this.global.CompilationUnit" id="702360">unit</a>: <a href="../CompilationUnits.scala.html#39196" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>): <a href="../ast/Trees.scala.html#26773" title="LazyVals.this.global.Transformer">Transformer</a> =
    <span title="LazyVals.this.LazyValues" class="keyword">new</span> <a href="#579416" title="LazyVals.this.LazyValues">LazyValues</a>(<a href="#702360" title="LazyVals.this.global.CompilationUnit">unit</a>)

  /** Create a new phase which applies transformer */
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(prev: scala.tools.nsc.Phase)LazyVals.this.StdPhase" id="579414">newPhase</a>(<a title="scala.tools.nsc.Phase" id="702382">prev</a>: scala.tools.nsc.<a href="../Phase.scala.html#8862" title="scala.tools.nsc.Phase">Phase</a>): <a href="../SubComponent.scala.html#39640" title="LazyVals.this.StdPhase">StdPhase</a> = <span title="LazyVals.this.Phase" class="keyword">new</span> <a href="#579415" title="LazyVals.this.Phase">Phase</a>(<a href="#702382" title="scala.tools.nsc.Phase">prev</a>)

  /** The phase defined by this transform */
  <span class="keyword">class</span> <a title="class Phase extends LazyVals.this.StdPhase with ScalaObject" id="579415">Phase</a><span title="ScalaObject">(</span><a title="scala.tools.nsc.Phase" id="702388">prev</a>: scala.tools.nsc.<a href="../Phase.scala.html#8862" title="scala.tools.nsc.Phase">Phase</a>) <span class="keyword">extends</span> <a href="../SubComponent.scala.html#39640" title="LazyVals.this.StdPhase">StdPhase</a>(<a href="#702388" title="scala.tools.nsc.Phase">prev</a>) {
    <span class="keyword">def</span> <a title="(unit: LazyVals.this.global.CompilationUnit)Unit" id="702387">apply</a>(<a title="LazyVals.this.global.CompilationUnit" id="702395">unit</a>: global.<a href="../CompilationUnits.scala.html#39196" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>): <a title="Unit" id="1950">Unit</a> = <a href="#579413" title="(unit: LazyVals.this.global.CompilationUnit)LazyVals.this.global.Transformer">newTransformer</a><a href="../ast/Trees.scala.html#45483" title="(unit: LazyVals.this.global.CompilationUnit)Unit">(</a><a href="#702395" title="LazyVals.this.global.CompilationUnit">unit</a>) transformUnit <a href="#702395" title="LazyVals.this.global.CompilationUnit">unit</a>
  }

  /**
   * Transform local lazy accessors to check for the initialized bit.
   */
  <span class="keyword">class</span> <a title="class LazyValues extends LazyVals.this.global.Transformer with ScalaObject" id="579416">LazyValues</a><span title="ScalaObject">(</span><a title="LazyVals.this.global.CompilationUnit" id="702379">unit</a>: <a href="../CompilationUnits.scala.html#39196" title="LazyVals.this.global.CompilationUnit">CompilationUnit</a>) <span class="keyword">extends</span> <a href="../ast/Trees.scala.html#26773" title="LazyVals.this.global.Transformer">Transformer</a> {    
    /** map from method symbols to the number of lazy values it defines. */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]" id="702366">lazyVals</a> = <a href="#702406" title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]{ ... }" class="keyword">new</a> <a title="anonymous class $anon extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,Int]" id="702406">HashMap</a>[Symbol, Int] {
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol)Int" id="702408">default</a>(<a title="LazyVals.this.global.Symbol" id="702412">meth</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>) = <span title="Int(0)" class="int">0</span>
    }
    
    <span class="keyword">import</span> symtab.Flags._
    <span class="keyword">import</span> lazyVals._

    /** Perform the following transformations:
     *  - for a lazy accessor inside a method, make it check the initialization bitmap
     *  - for all methods, add enough int vars to allow one flag per lazy local value
     *  - blocks in template bodies behave almost like methods. A single bitmaps section is
     *      added in the first block, for all lazy values defined in such blocks.
     *  - remove ACCESSOR flags: accessors in traits are not statically implemented,  
     *    but moved to the host class. local lazy values should be statically implemented.
     */
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="702370">transform</a>(<a title="LazyVals.this.global.Tree" id="702454">tree</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a> = {
      <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="702457">sym</a> = <a href="#702454" title="LazyVals.this.global.Tree">tree</a>.<a href="../ast/Trees.scala.html#29367" title="=&gt; LazyVals.this.global.Symbol">symbol</a>
      <a href="#702454" title="LazyVals.this.global.Tree">tree</a> <span title="LazyVals.this.global.Tree" class="keyword">match</span> {
        <span title="LazyVals.this.global.DefDef" class="keyword">case</span> DefDef(<a title="LazyVals.this.global.Modifiers" id="702466">mods</a>, <a title="LazyVals.this.global.Name" id="702467">name</a>, <a title="List[LazyVals.this.global.TypeDef]" id="702468">tparams</a>, <a title="List[List[LazyVals.this.global.ValDef]]" id="702469">vparams</a>, <a title="LazyVals.this.global.Tree" id="702470">tpt</a>, <a title="LazyVals.this.global.Tree" id="702471">rhs</a>) =&gt;
          <span class="keyword">val</span> <a title="LazyVals.this.global.Tree" id="702474">res</a> = <span title="LazyVals.this.global.Tree" class="keyword">if</span> (<span title="(x$1: Boolean)Boolean">!</span><a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26983" title="=&gt; LazyVals.this.global.Symbol">owner</a>.<a href="../symtab/Symbols.scala.html#26897" title="=&gt; Boolean">isClass</a> &amp;&amp; <a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26996" title="(mask: Long)Boolean">hasFlag</a>(<span title="Long(2147483648L)">LAZY</span>)) {
            <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="702479">enclosingDummyOrMethod</a> = 
              <span title="LazyVals.this.global.Symbol" class="keyword">if</span> (<a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27032" title="(x$1: AnyRef)Boolean">enclMethod</a> == <a href="../symtab/Symbols.scala.html#26134" title="object LazyVals.this.global.NoSymbol">NoSymbol</a>) <a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26983" title="=&gt; LazyVals.this.global.Symbol">owner</a> <span class="keyword">else</span> <a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27032" title="=&gt; LazyVals.this.global.Symbol">enclMethod</a>
            <span class="keyword">val</span> <a title="Int" id="702480">idx</a> = <a href="#702366" title="(key: LazyVals.this.global.Symbol)Int">lazyVals</a>(<a href="#702479" title="LazyVals.this.global.Symbol">enclosingDummyOrMethod</a>)
            <span class="keyword">val</span> <a title="LazyVals.this.global.Tree" id="702481">rhs1</a> = <a href="#702372" title="(meth: LazyVals.this.global.Symbol,tree: LazyVals.this.global.Tree,offset: Int)LazyVals.this.global.Tree">mkLazyDef</a>(<a href="#702479" title="LazyVals.this.global.Symbol">enclosingDummyOrMethod</a>, <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45473" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#702471" title="LazyVals.this.global.Tree">rhs</a>), <a href="#702480" title="Int">idx</a>)
            <a href="#702366" title="(key: LazyVals.this.global.Symbol,value: Int)Unit">lazyVals</a>(<a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26983" title="=&gt; LazyVals.this.global.Symbol">owner</a>) = <a href="#702480" title="(x$1: Int)Int" id="2964">idx</a> + <span title="Int(1)" class="int">1</span>
            <a href="#702457" title="LazyVals.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26994" title="(mask: Long)sym.type">resetFlag</a>(LAZY <span title="Long(2281701376L)">|</span> ACCESSOR) 
            <a href="#702481" title="LazyVals.this.global.Tree">rhs1</a>
          } <span class="keyword">else</span>
            <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45473" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#702471" title="LazyVals.this.global.Tree">rhs</a>)
          <a href="../ast/Trees.scala.html#45465" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48545" title="(tree: LazyVals.this.global.Tree,mods: LazyVals.this.global.Modifiers,name: LazyVals.this.global.Name,tparams: List[LazyVals.this.global.TypeDef],vparamss: List[List[LazyVals.this.global.ValDef]],tpt: LazyVals.this.global.Tree,rhs: LazyVals.this.global.Tree)LazyVals.this.global.DefDef">DefDef</a>(<a href="#702454" title="LazyVals.this.global.Tree">tree</a>, <a href="#702466" title="LazyVals.this.global.Modifiers">mods</a>, <a href="#702467" title="LazyVals.this.global.Name">name</a>, <a href="#702468" title="List[LazyVals.this.global.TypeDef]">tparams</a>, <a href="#702469" title="List[List[LazyVals.this.global.ValDef]]">vparams</a>, <a href="#702470" title="LazyVals.this.global.Tree">tpt</a>, 
                          <a href="../typechecker/Typers.scala.html#42640" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#702371" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#702457" title="LazyVals.this.global.Symbol">sym</a>, <a href="#702474" title="LazyVals.this.global.Tree">res</a>)))

        <span title="LazyVals.this.global.Template" class="keyword">case</span> Template(<a title="List[LazyVals.this.global.Tree]" id="702598">parents</a>, <a title="LazyVals.this.global.ValDef" id="702599">self</a>, <a title="List[LazyVals.this.global.Tree]" id="702600">body</a>) =&gt;
          <span class="keyword">val</span> <a title="List[LazyVals.this.global.Tree]" id="702603">body1</a> = <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45474" title="(trees: List[LazyVals.this.global.Tree])List[LazyVals.this.global.Tree]">transformTrees</a>(<a href="#702600" title="List[LazyVals.this.global.Tree]">body</a>)
          <span class="keyword">var</span> <a title="Boolean" id="702604">added</a> = <span title="Boolean(false)" class="keyword">false</span>
          <span class="keyword">val</span> <a title="List[LazyVals.this.global.analyzer.global.Tree]" id="702605">stats</a> = 
            <span class="keyword">for</span> (<a title="LazyVals.this.global.Tree" id="702618">stat</a> &lt;- <a href="#702603" title="(f: (LazyVals.this.global.Tree) =&gt; LazyVals.this.global.analyzer.global.Tree)(implicit bf: scala.collection.generic.BuilderFactory[LazyVals.this.global.analyzer.global.Tree,List[LazyVals.this.global.analyzer.global.Tree],List[LazyVals.this.global.Tree]])List[LazyVals.this.global.analyzer.global.Tree]">body1</a>) <span class="keyword">yield</span> <a href="#702618" title="LazyVals.this.global.Tree">stat</a> <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">match</span> {
              <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">case</span> Block(_, _) <span class="keyword">if</span> <span title="=&gt; Boolean">!</span><a href="#702604" title="Boolean">added</a> =&gt; 
                <a href="#702604" title="Boolean">added</a> = <span title="Boolean(true)" class="keyword">true</span>
                <a href="../typechecker/Typers.scala.html#42640" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#702371" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#702457" title="LazyVals.this.global.Symbol">sym</a>, <a href="#702618" title="LazyVals.this.global.Tree">stat</a>))
              <span title="LazyVals.this.global.analyzer.global.Tree" class="keyword">case</span> ValDef(<a title="LazyVals.this.global.Modifiers" id="702642">mods</a>, <a title="LazyVals.this.global.Name" id="702643">name</a>, <a title="LazyVals.this.global.Tree" id="702644">tpt</a>, <a title="LazyVals.this.global.Tree" id="702645">rhs</a>) =&gt;
                <a href="../typechecker/Typers.scala.html#42640" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="../ast/Trees.scala.html#45465" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48544" title="(tree: LazyVals.this.global.Tree,mods: LazyVals.this.global.Modifiers,name: LazyVals.this.global.Name,tpt: LazyVals.this.global.Tree,rhs: LazyVals.this.global.Tree)LazyVals.this.global.ValDef">ValDef</a>(<a href="#702618" title="LazyVals.this.global.Tree">stat</a>, <a href="#702642" title="LazyVals.this.global.Modifiers">mods</a>, <a href="#702643" title="LazyVals.this.global.Name">name</a>, <a href="#702644" title="LazyVals.this.global.Tree">tpt</a>, <a href="#702371" title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree">addBitmapDefs</a>(<a href="#702618" title="LazyVals.this.global.Tree">stat</a>.<a href="../ast/Trees.scala.html#29367" title="=&gt; LazyVals.this.global.Symbol">symbol</a>, <a href="#702645" title="LazyVals.this.global.Tree">rhs</a>)))
              <span title="LazyVals.this.global.Tree" class="keyword">case</span> _ =&gt; 
                <a href="#702618" title="LazyVals.this.global.Tree">stat</a>
            }
          <a href="../ast/Trees.scala.html#45465" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48550" title="(tree: LazyVals.this.global.Tree,parents: List[LazyVals.this.global.Tree],self: LazyVals.this.global.ValDef,body: List[LazyVals.this.global.Tree])LazyVals.this.global.Template">Template</a>(<a href="#702454" title="LazyVals.this.global.Tree">tree</a>, <a href="#702598" title="List[LazyVals.this.global.Tree]">parents</a>, <a href="#702599" title="LazyVals.this.global.ValDef">self</a>, <a href="#702605" title="List[LazyVals.this.global.analyzer.global.Tree]">stats</a>)
          
        <span title="LazyVals.this.global.Tree" class="keyword">case</span> _ =&gt; <span class="keyword">super</span>.<a href="../ast/Trees.scala.html#45473" title="(tree: LazyVals.this.global.Tree)LazyVals.this.global.Tree">transform</a>(<a href="#702454" title="LazyVals.this.global.Tree">tree</a>)
      }
    }

    /** Add the bitmap definitions to the rhs of a method definition.
     *  If the rhs has been tail-call transformed, insert the bitmap
     *  definitions inside the top-level label definition, so that each
     *  iteration has the lazy values un-initialized. Otherwise add them
     *  at the very beginning of the method.
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(methSym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="702371">addBitmapDefs</a>(<a title="LazyVals.this.global.Symbol" id="702584">methSym</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="702585">rhs</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a> = {
      <span class="keyword">def</span> <a title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block" id="702755">prependStats</a>(<a title="List[LazyVals.this.global.Tree]" id="702757">stats</a>: <a title="List[LazyVals.this.global.Tree]" id="7345">List</a>[Tree], <a title="LazyVals.this.global.Tree" id="702758">tree</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26653" title="LazyVals.this.global.Block">Block</a> = <a href="#702758" title="LazyVals.this.global.Tree">tree</a> <span title="LazyVals.this.global.Block" class="keyword">match</span> {
        <span title="LazyVals.this.global.Block" class="keyword">case</span> Block(<a title="List[LazyVals.this.global.Tree]" id="702761">stats1</a>, <a title="LazyVals.this.global.Tree" id="702762">res</a>) =&gt; <a href="../ast/Trees.scala.html#49026" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#702757" title="List[LazyVals.this.global.Tree]">stats</a> <a href="#702783" title="List[LazyVals.this.global.Tree]">:::</a> <a href="#702761" title="(prefix: List[LazyVals.this.global.Tree])List[LazyVals.this.global.Tree]" id="24261">stats1</a>, <a href="#702762" title="LazyVals.this.global.Tree">res</a>)
        <span title="LazyVals.this.global.Block" class="keyword">case</span> _ =&gt; <a href="../ast/Trees.scala.html#49026" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#702757" title="List[LazyVals.this.global.Tree]">stats</a>, <a href="#702758" title="LazyVals.this.global.Tree">tree</a>)
      }

      <span class="keyword">val</span> <a title="List[LazyVals.this.global.ValDef]" id="702756">bmps</a> = <a href="#702376" title="(key: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]">bitmaps</a><span title="(f: (LazyVals.this.global.Symbol) =&gt; LazyVals.this.global.ValDef)(implicit bf: scala.collection.generic.BuilderFactory[LazyVals.this.global.ValDef,List[LazyVals.this.global.ValDef],List[LazyVals.this.global.Symbol]])List[LazyVals.this.global.ValDef]">(</span><a href="#702584" title="LazyVals.this.global.Symbol">methSym</a>) <a title="scala.collection.generic.BuilderFactory[LazyVals.this.global.ValDef,List[LazyVals.this.global.ValDef],List#Coll]" id="24313">map</a> (<a href="../ast/Trees.scala.html#26622" title="(sym: LazyVals.this.global.Symbol,rhs: LazyVals.this.global.Tree)LazyVals.this.global.ValDef">ValDef</a>(<a href="#702832" title="LazyVals.this.global.Symbol">_</a>, <a href="../ast/TreeDSL.scala.html#42497" title="=&gt; LazyVals.this.global.Literal">ZERO</a>))
      <span title="LazyVals.this.global.Tree" class="keyword">if</span> (<a href="#702756" title="List[LazyVals.this.global.ValDef]">bmps</a>.<a title="=&gt; Boolean" id="25434">isEmpty</a>) <a href="#702585" title="LazyVals.this.global.Tree">rhs</a> <span class="keyword">else</span> <a href="#702585" title="LazyVals.this.global.Tree">rhs</a> <span title="LazyVals.this.global.Tree" class="keyword">match</span> {
        <span title="LazyVals.this.global.Block" class="keyword">case</span> Block(<a title="List[LazyVals.this.global.Tree]" id="702947">assign</a>, <a title="LazyVals.this.global.LabelDef" id="702948">l</a> @ LabelDef(<a title="LazyVals.this.global.Name" id="702954">name</a>, <a title="List[LazyVals.this.global.Ident]" id="702955">params</a>, <a title="LazyVals.this.global.Tree" id="702956">rhs1</a>))
          <span class="keyword">if</span> (<a href="#702954" title="LazyVals.this.global.Name">name</a>.<a href="../symtab/Names.scala.html#28205" title="()String">toString</a>.<a title="(x$1: Any)Boolean" id="6947">equals</a><span title="(x$1: Boolean)Boolean">(</span><a title="(x$1: Any)java.lang.String" id="6553" class="string">&quot;_&quot;</a> + <a href="#702584" title="LazyVals.this.global.Symbol">methSym</a>.<a href="../symtab/Symbols.scala.html#26988" title="=&gt; LazyVals.this.global.Name">name</a>)
              &amp;&amp; <span title="object List">List</span>.<a title="(xs: List[LazyVals.this.global.Ident],ys: List[LazyVals.this.global.Type])(f: (LazyVals.this.global.Ident, LazyVals.this.global.Type) =&gt; Boolean)Boolean" id="24391">forall2</a>(<a href="#702955" title="List[LazyVals.this.global.Ident]">params</a>.<a title="=&gt; List[LazyVals.this.global.Ident]" id="25318">tail</a>, <a href="#702584" title="LazyVals.this.global.Symbol">methSym</a>.<a href="../symtab/Symbols.scala.html#27003" title="=&gt; LazyVals.this.global.Type">tpe</a>.<a href="../symtab/Types.scala.html#30200" title="=&gt; List[LazyVals.this.global.Type]">paramTypes</a>) { (<a title="LazyVals.this.global.Ident" id="702981">ident</a>, <a title="LazyVals.this.global.Type" id="702982">tpe</a>) =&gt; <a href="#702981" title="LazyVals.this.global.Ident">ident</a>.<a href="../ast/Trees.scala.html#29363" title="(x$1: AnyRef)Boolean">tpe</a> == <a href="#702982" title="LazyVals.this.global.Type">tpe</a> }) =&gt;
            <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="702994">sym</a> = <a href="#702948" title="LazyVals.this.global.LabelDef">l</a>.<a href="../ast/Trees.scala.html#48485" title="=&gt; LazyVals.this.global.Symbol">symbol</a>
            <a href="../ast/Trees.scala.html#49026" title="(stats: List[LazyVals.this.global.Tree],expr: LazyVals.this.global.Tree)LazyVals.this.global.Block">Block</a>(<a href="#702947" title="List[LazyVals.this.global.Tree]">assign</a>, <a href="../ast/Trees.scala.html#45465" title="=&gt; LazyVals.this.global.TreeCopier">treeCopy</a>.<a href="../ast/Trees.scala.html#48547" title="(tree: LazyVals.this.global.Tree,name: LazyVals.this.global.Name,params: List[LazyVals.this.global.Ident],rhs: LazyVals.this.global.Tree)LazyVals.this.global.LabelDef">LabelDef</a>(<a href="#702948" title="LazyVals.this.global.LabelDef">l</a>, <a href="#702954" title="LazyVals.this.global.Name">name</a>, <a href="#702955" title="List[LazyVals.this.global.Ident]">params</a>, <a href="../typechecker/Typers.scala.html#42640" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a>(<a href="#702755" title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block">prependStats</a>(<a href="#702756" title="List[LazyVals.this.global.ValDef]">bmps</a>, <a href="#702956" title="LazyVals.this.global.Tree">rhs1</a>))))

        <span title="LazyVals.this.global.Block" class="keyword">case</span> _ =&gt; <a href="#702755" title="(stats: List[LazyVals.this.global.Tree],tree: LazyVals.this.global.Tree)LazyVals.this.global.Block">prependStats</a>(<a href="#702756" title="List[LazyVals.this.global.ValDef]">bmps</a>, <a href="#702585" title="LazyVals.this.global.Tree">rhs</a>)
      }
    }
    
    /** return a 'lazified' version of rhs. Rhs should conform to the
     *  following schema:
     *  {
     *    l$ = &lt;rhs&gt; 
     *    l$
     *  } or
     *  &lt;rhs&gt; when the lazy value has type Unit (for which there is no field
     *  to cache it's value.
     * 
     *  The result will be a tree of the form
     *  {
     *    if ((bitmap$n &amp; MASK) == 0) {
     *       l$ = &lt;rhs&gt;
     *       bitmap$n = bimap$n | MASK
     *    }
     *    l$
     *  }
     *  where bitmap$n is an int value acting as a bitmap of initialized values. It is
     *  the 'n' is (offset / 32), the MASK is (1 &lt;&lt; (offset % 32)). If the value has type
     *  unit, no field is used to chache the value, so the resulting code is:
     *  {
     *    if ((bitmap$n &amp; MASK) == 0) {
     *       &lt;rhs&gt;;
     *       bitmap$n = bimap$n | MASK
     *    }
     *    ()
     *  }
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol,tree: LazyVals.this.global.Tree,offset: Int)LazyVals.this.global.Tree" id="702372">mkLazyDef</a>(<a title="LazyVals.this.global.Symbol" id="702503">meth</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="702504">tree</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>, <a title="Int" id="702505">offset</a>: <span title="Int">Int</span>): <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a> = {      
      <span class="keyword">val</span> <a title="LazyVals.this.global.Symbol" id="703036">bitmapSym</a>           = <a href="#702378" title="(meth: LazyVals.this.global.Symbol,offset: Int)LazyVals.this.global.Symbol">getBitmapFor</a>(<a href="#702503" title="LazyVals.this.global.Symbol">meth</a>, <a href="#702505" title="Int">offset</a>)
      <span class="keyword">val</span> <a title="LazyVals.this.global.Literal" id="703037">mask</a>                = <a href="../ast/TreeDSL.scala.html#49329" title="(x: Any)LazyVals.this.global.Literal">LIT</a>(<a title="(x$1: Int)Int" id="2853" class="int">1</a> &lt;&lt; (<a href="#702505" title="(x$1: Int)Int" id="2972">offset</a> % <span title="Int(32)">FLAGS_PER_WORD</span>))
      <span class="keyword">def</span> <a title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block" id="703038">mkBlock</a>(<a title="LazyVals.this.global.Tree" id="703065">stmt</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>) = <a href="../ast/TreeDSL.scala.html#42526" title="(xs: LazyVals.this.global.Tree*)LazyVals.this.global.Block">BLOCK</a>(<a href="#703065" title="LazyVals.this.global.Tree">stmt</a>, <a href="#702373" title="(bmp: LazyVals.this.global.Symbol,mask: LazyVals.this.global.Tree)LazyVals.this.global.Tree">mkSetFlag</a>(<a href="#703036" title="LazyVals.this.global.Symbol">bitmapSym</a>, <a href="#703037" title="LazyVals.this.global.Literal">mask</a>), <a href="../ast/TreeDSL.scala.html#42499" title="=&gt; LazyVals.this.global.Literal">UNIT</a>)

      <span class="keyword">val</span> <a href="#36432" title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)">(</a><a href="#703039" title="LazyVals.this.global.Block" id="36432">block</a>, <a href="#703039" title="LazyVals.this.global.Tree" id="36434">res</a>) = <a href="#702504" title="LazyVals.this.global.Tree">tree</a> <span title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)" class="keyword">match</span> {
        <span title="(LazyVals.this.global.Block, LazyVals.this.global.Tree)" class="keyword">case</span> Block(<a href="#703077" title="(x: List[LazyVals.this.global.Tree])Some[List[LazyVals.this.global.Tree]]" id="24409">List</a>(<a title="LazyVals.this.global.Tree" id="703086">assignment</a>), <a title="LazyVals.this.global.Tree" id="703088">res</a>) =&gt; <span title="(_1: LazyVals.this.global.Block,_2: LazyVals.this.global.Tree)(LazyVals.this.global.Block, LazyVals.this.global.Tree)">(</span><a href="#703038" title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block">mkBlock</a>(<a href="#703086" title="LazyVals.this.global.Tree">assignment</a>),  <a href="#703088" title="LazyVals.this.global.Tree">res</a>)
        <span title="(LazyVals.this.global.Block, LazyVals.this.global.Literal)" class="keyword">case</span> <a title="LazyVals.this.global.Tree" id="703101">rhs</a>                          =&gt; <span title="(_1: LazyVals.this.global.Block,_2: LazyVals.this.global.Literal)(LazyVals.this.global.Block, LazyVals.this.global.Literal)">(</span><a href="#703038" title="(stmt: LazyVals.this.global.Tree)LazyVals.this.global.Block">mkBlock</a>(<a href="#703101" title="LazyVals.this.global.Tree">rhs</a>),         <a href="../ast/TreeDSL.scala.html#42499" title="=&gt; LazyVals.this.global.Literal">UNIT</a>)          
      }
      <a title="(assertion: Boolean)Unit" id="693">assert</a>(<a href="#36434" title="(x$1: AnyRef)Boolean" id="6540">res</a> <a title="(x$1: Boolean)Boolean" id="2210">!=</a> <a href="../ast/TreeDSL.scala.html#42499" title="=&gt; LazyVals.this.global.Literal">UNIT</a> || <a href="#702503" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#27003" title="=&gt; LazyVals.this.global.Type">tpe</a>.<a href="../symtab/Types.scala.html#30196" title="=&gt; LazyVals.this.global.Type">finalResultType</a>.<a href="../symtab/Types.scala.html#30180" title="(x$1: AnyRef)Boolean">typeSymbol</a> == <a href="../symtab/Definitions.scala.html#28277" title="=&gt; LazyVals.this.global.Symbol">UnitClass</a>)
      
      <a href="../ast/Trees.scala.html#26784" title="(pos: scala.tools.nsc.util.Position)(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">atPos</a>(<a href="#702504" title="LazyVals.this.global.Tree">tree</a>.<a href="../ast/Trees.scala.html#29361" title="=&gt; scala.tools.nsc.util.Position">pos</a>)(<a href="../typechecker/Typers.scala.html#42640" title="(tree: LazyVals.this.global.analyzer.global.Tree)LazyVals.this.global.analyzer.global.Tree">typed</a> {
        <span class="keyword">def</span> <a title="=&gt; LazyVals.this.global.If" id="703164">body</a> = { <a href="../ast/TreeDSL.scala.html#42524" title="(tree: LazyVals.this.global.Tree)LazyVals.this.CODE.IfStart">IF</a> <a href="../ast/TreeDSL.scala.html#49788" title="(x: LazyVals.this.global.Tree)LazyVals.this.CODE.IfStart">(</a><a href="../ast/TreeDSL.scala.html#45077" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="../ast/Trees.scala.html#26736" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45076" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="#703036" title="LazyVals.this.global.Symbol">bitmapSym</a>) <a href="../ast/TreeDSL.scala.html#42538" title="implicit scala.tools.nsc.ast.TreeDSL.CODE.mkTreeMethods : (target: LazyVals.this.global.Tree)LazyVals.this.CODE.TreeMethods">INT_&amp;</a> <a href="#703037" title="LazyVals.this.global.Literal">mask</a>) INT_== <a href="../ast/TreeDSL.scala.html#42497" title="=&gt; LazyVals.this.global.Literal">ZERO</a>) THEN <a href="#36432" title="LazyVals.this.global.Block">block</a> <a href="../ast/TreeDSL.scala.html#49790" title="=&gt; LazyVals.this.global.If">ENDIF</a> }
        <a href="../ast/TreeDSL.scala.html#42526" title="(xs: LazyVals.this.global.Tree*)LazyVals.this.global.Block">BLOCK</a>(<a href="#703164" title="=&gt; LazyVals.this.global.If">body</a>, <a href="#36434" title="LazyVals.this.global.Tree">res</a>)
      })
    }
     
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bmp: LazyVals.this.global.Symbol,mask: LazyVals.this.global.Tree)LazyVals.this.global.Tree" id="702373">mkSetFlag</a>(<a title="LazyVals.this.global.Symbol" id="703067">bmp</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="LazyVals.this.global.Tree" id="703068">mask</a>: <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a>): <a href="../ast/Trees.scala.html#26593" title="LazyVals.this.global.Tree">Tree</a> =
      <a href="../ast/Trees.scala.html#26736" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45086" title="(rhs: LazyVals.this.global.Tree)LazyVals.this.global.Assign">(</a><a href="#703067" title="LazyVals.this.global.Symbol">bmp</a>) === (<a href="../ast/Trees.scala.html#26736" title="(sym: LazyVals.this.global.Symbol)LazyVals.this.global.Ident">Ident</a><a href="../ast/TreeDSL.scala.html#45075" title="(other: LazyVals.this.global.Tree)LazyVals.this.global.Apply">(</a><a href="#703067" title="LazyVals.this.global.Symbol">bmp</a>) INT_| <a href="#703068" title="LazyVals.this.global.Tree">mask</a>)
    
    <span class="keyword">final</span> <span class="keyword">val</span> <a title="Int(32)" id="702374">FLAGS_PER_WORD</a> = <span title="Int(32)" class="int">32</span>
    <span class="keyword">val</span> <a title="&lt;refinement&gt; extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]" id="702376">bitmaps</a> = <a href="#702427" title="scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]{ ... }" class="keyword">new</a> <a title="anonymous class $anon extends scala.collection.mutable.HashMap[LazyVals.this.global.Symbol,List[LazyVals.this.global.Symbol]]" id="702427">HashMap</a>[Symbol, List[Symbol]] {
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol)object Nil" id="702429">default</a>(<a title="LazyVals.this.global.Symbol" id="702433">meth</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>) = <a title="object Nil" id="7634">Nil</a>
    }
    
    /** Return the symbol corresponding of the right bitmap int inside meth,
     *  given offset.
     */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(meth: LazyVals.this.global.Symbol,offset: Int)LazyVals.this.global.Symbol" id="702378">getBitmapFor</a>(<a title="LazyVals.this.global.Symbol" id="703042">meth</a>: <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a>, <a title="Int" id="703043">offset</a>: <span title="Int">Int</span>): <a href="../symtab/Symbols.scala.html#26127" title="LazyVals.this.global.Symbol">Symbol</a> = {
      <span class="keyword">val</span> <a title="Int" id="703300">n</a> = <a href="#703043" title="(x$1: Int)Int" id="2970">offset</a> / <span title="Int(32)">FLAGS_PER_WORD</span>
      <span class="keyword">val</span> <a title="List[LazyVals.this.global.Symbol]" id="703301">bmps</a> = <a href="#702376" title="(key: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]">bitmaps</a>(<a href="#703042" title="LazyVals.this.global.Symbol">meth</a>)
      <span title="LazyVals.this.global.Symbol" class="keyword">if</span> (<a href="#703301" title="List[LazyVals.this.global.Symbol]">bmps</a>.<a title="(x$1: Int)Boolean" id="28928">length</a> &gt; <a href="#703300" title="Int">n</a>) 
        <a href="#703301" title="(n: Int)LazyVals.this.global.Symbol" id="28929">bmps</a>(<a href="#703300" title="Int">n</a>)
      <span class="keyword">else</span> {
        <span class="keyword">val</span> <a title="LazyVals.this.global.TermSymbol" id="703334">sym</a> = <a href="#703042" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#26864" title="(pos: scala.tools.nsc.util.Position,name: LazyVals.this.global.Name)LazyVals.this.global.TermSymbol">newVariable</a>(<a href="#703042" title="LazyVals.this.global.Symbol">meth</a>.<a href="../symtab/Symbols.scala.html#26847" title="=&gt; scala.tools.nsc.util.Position">pos</a>, <a href="../symtab/StdNames.scala.html#26531" title="object LazyVals.this.global.nme">nme</a>.<a href="../symtab/StdNames.scala.html#29678" title="(n: Int)LazyVals.this.global.Name">bitmapName</a>(<a href="#703300" title="Int">n</a>)).<a href="../symtab/Symbols.scala.html#27005" title="(info: LazyVals.this.global.Type)LazyVals.this.global.TermSymbol">setInfo</a>(<a href="../symtab/Definitions.scala.html#28285" title="=&gt; LazyVals.this.global.Symbol">IntClass</a>.<a href="../symtab/Symbols.scala.html#27003" title="=&gt; LazyVals.this.global.Type">tpe</a>)
        <a href="#702376" title="(key: LazyVals.this.global.Symbol,value: List[LazyVals.this.global.Symbol])Unit">bitmaps</a>(<a href="#703042" title="LazyVals.this.global.Symbol">meth</a>) = (<a href="#703334" title="LazyVals.this.global.TermSymbol">sym</a> <a href="#703352" title="LazyVals.this.global.TermSymbol">::</a> <a href="#703301" title="(x: LazyVals.this.global.Symbol)List[LazyVals.this.global.Symbol]" id="24258">bmps</a>).<a title="=&gt; List[LazyVals.this.global.Symbol]" id="24301">reverse</a>
        <a href="#703334" title="LazyVals.this.global.TermSymbol">sym</a>
      }
    }
  }
}

        </pre>
    </body>
</html>