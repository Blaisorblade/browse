<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/CompileSocket.scala</title>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */</span>
<span class="comment">// $Id: CompileSocket.scala 17274 2009-03-10 11:39:04Z michelou $</span>

<span class="keyword">package</span> scala.tools.nsc

<span class="keyword">import</span> java.lang.{Thread, System, Runtime}
<span class="keyword">import</span> java.lang.NumberFormatException
<span class="keyword">import</span> java.io.{File, IOException, PrintWriter, FileOutputStream}
<span class="keyword">import</span> java.io.{BufferedReader, FileReader}
<span class="keyword">import</span> java.util.regex.Pattern
<span class="keyword">import</span> java.net._

<span class="comment">/** This class manages sockets for the fsc offline compiler.  */</span>
<span class="keyword">class</span> <span class="typed"><span class="type">class CompileSocket extends java.lang.Object with ScalaObject</span><a id="6852">CompileSocket</a></span> {
  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; scala.tools.nsc.StandardCompileClient</span><a id="67443">compileClient</a></span>: <span class="typed"><span class="type">scala.tools.nsc.StandardCompileClient</span><a href="CompileClient.scala.html#6474">StandardCompileClient</a></span> = <span class="typed"><span class="type">object scala.tools.nsc.CompileClient</span><a href="CompileClient.scala.html#6361">CompileClient</a></span> <span class="comment">//todo: lazy val</span>

  <span class="comment">/** The prefix of the port identification file, which is followed
   *  by the port number.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; java.lang.String</span><a id="67444">dirName</a></span> = <span class="typed"><span class="type">java.lang.String(&quot;scalac-compile-server-port&quot;)</span><span class="string">&quot;scalac-compile-server-port&quot;</span></span> <span class="comment">//todo: lazy val</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; java.lang.String</span><a id="67445">cmdName</a></span> = <span class="typed"><span class="type">object scala.tools.nsc.Properties</span><a href="Properties.scala.html#7366">Properties</a></span>.<span class="typed"><span class="type">=&gt; java.lang.String</span><a href="Properties.scala.html#46666">cmdName</a></span> <span class="comment">//todo: lazy val</span>

  <span class="comment">/** The vm part of the command to start a new scala compile server */</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><span id="67447"><a id="67446">vmCommand</a></span></span> =
    <span class="typed"><span class="type">object scala.tools.nsc.Properties</span><a href="Properties.scala.html#7366">Properties</a></span>.<span class="typed"><span class="type">=&gt; String</span><a id="46651">scalaHome</a></span> <span class="typed"><span class="type">java.lang.String</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">java.lang.String</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span> =&gt;
        <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67445">cmdName</a></span>
      <span class="typed"><span class="type">java.lang.String</span><span class="keyword">case</span></span> <span class="typed"><span class="type">String</span><a id="67480">dirname</a></span> =&gt;
        <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><a id="67481">trial</a></span> = <span class="typed"><span class="type">(java.io.File,java.lang.String)java.io.File</span><a id="40682" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">(java.lang.String,java.lang.String)java.io.File</span><a id="40681" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">String</span><a href="#67480">dirname</a></span>, <span class="typed"><span class="type">java.lang.String(&quot;bin&quot;)</span><span class="string">&quot;bin&quot;</span></span>), <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67445">cmdName</a></span>)
        <span class="typed"><span class="type">java.lang.String</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">java.io.File</span><a href="#67481">trial</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40695">canRead</a></span>)
          <span class="typed"><span class="type">java.io.File</span><a href="#67481">trial</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="40687">getPath</a></span>
        <span class="keyword">else</span>
          <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67445">cmdName</a></span>
    }

  <span class="comment">/** The class name of the scala compile server */</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><span id="67449"><a id="67448">serverClass</a></span></span> = <span class="typed"><span class="type">java.lang.String(&quot;scala.tools.nsc.CompileServer&quot;)</span><span class="string">&quot;scala.tools.nsc.CompileServer&quot;</span></span>
    
  <span class="comment">/** A regular expression for checking compiler output for errors */</span>
  <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><span id="67451"><a id="67450">errorRegex</a></span></span> = <span class="typed"><span class="type">java.lang.String(&quot;.*(errors? found|don't know|bad option).*&quot;)</span><span class="string">&quot;.*(errors? found|don't know|bad option).*&quot;</span></span>
    
  <span class="comment">/** A Pattern object for checking compiler output for errors */</span>
  <span class="keyword">val</span> <span class="typed"><span class="type">java.util.regex.Pattern</span><span id="67453"><a id="67452">errorPattern</a></span></span> = <span class="typed"><span class="type">object java.util.regex.Pattern</span><a id="22978">Pattern</a></span>.<span class="typed"><span class="type">(java.lang.String)java.util.regex.Pattern</span><a id="67776">compile</a></span>(<span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67450">errorRegex</a></span>)

  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">(String)Unit</span><a id="67454">error</a></span>(<span class="typed"><span class="type">String</span><a id="67864">msg</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>) = <span class="typed"><span class="type">object java.lang.System</span><a id="1886">System</a></span>.<span class="typed"><span class="type">java.io.PrintStream</span><a id="47437">err</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="27111">println</a></span>(<span class="typed"><span class="type">String</span><a href="#67864">msg</a></span>)
    
  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">(String)Nothing</span><a id="67455">fatal</a></span>(<span class="typed"><span class="type">String</span><a id="67862">msg</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>) = {
    <span class="typed"><span class="type">(String)Unit</span><a href="#67454">error</a></span>(<span class="typed"><span class="type">String</span><a href="#67862">msg</a></span>)
    <span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">(java.lang.String)java.lang.Exception</span><a id="29864" class="keyword">new</a></span> <span class="typed"><span class="type">java.lang.Exception</span><span id="5974"><a id="821">Exception</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;fsc failure&quot;)</span><span class="string">&quot;fsc failure&quot;</span></span>)
  }

  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">(String)Unit</span><a id="67456">info</a></span>(<span class="typed"><span class="type">String</span><a id="67839">msg</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>) =
    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; scala.tools.nsc.StandardCompileClient</span><a href="#67443">compileClient</a></span>.<span class="typed"><span class="type">=&gt; Boolean</span><a href="CompileClient.scala.html#67846">verbose</a></span>) <span class="typed"><span class="type">object java.lang.System</span><a id="1886">System</a></span>.<span class="typed"><span class="type">java.io.PrintStream</span><a id="47436">out</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="27111">println</a></span>(<span class="typed"><span class="type">String</span><a href="#67839">msg</a></span>)

  <span class="comment">/** A temporary directory to use */</span>
  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><span id="67458"><a id="67457">tmpDir</a></span></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">List[(java.lang.String, List[java.lang.String])]</span><a id="67790">totry</a></span> = <span class="typed"><span class="type">((java.lang.String, List[java.lang.String])*)List[(java.lang.String, List[java.lang.String])]</span><span id="21328"><a id="527">List</a></span></span>(
        <span class="typed"><span class="type">(java.lang.String,List[java.lang.String])(java.lang.String, List[java.lang.String])</span><span id="23625"><a id="1379">(</a></span></span><span class="typed"><span class="type">java.lang.String(&quot;scala.home&quot;)</span><span class="string">&quot;scala.home&quot;</span></span>, <span class="typed"><span class="type">(java.lang.String*)List[java.lang.String]</span><span id="21328"><a id="527">List</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;var&quot;)</span><span class="string">&quot;var&quot;</span></span>, <span class="typed"><span class="type">java.lang.String(&quot;scala-devel&quot;)</span><span class="string">&quot;scala-devel&quot;</span></span>)),
        <span class="typed"><span class="type">(java.lang.String,List[java.lang.String])(java.lang.String, List[java.lang.String])</span><span id="23625"><a id="1379">(</a></span></span><span class="typed"><span class="type">java.lang.String(&quot;java.io.tmpdir&quot;)</span><span class="string">&quot;java.io.tmpdir&quot;</span></span>, <span class="typed"><span class="type">(java.lang.String*)List[java.lang.String]</span><span id="21328"><a id="527">List</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;scala-devel&quot;)</span><span class="string">&quot;scala-devel&quot;</span></span>)),
        <span class="typed"><span class="type">(java.lang.String,List[java.lang.String])(java.lang.String, List[java.lang.String])</span><span id="23625"><a id="1379">(</a></span></span><span class="typed"><span class="type">java.lang.String(&quot;user.home&quot;)</span><span class="string">&quot;user.home&quot;</span></span>, <span class="typed"><span class="type">(java.lang.String*)List[java.lang.String]</span><span id="21328"><a id="527">List</a></span></span>(<span class="typed"><span class="type">java.lang.String(&quot;tmp&quot;)</span><span class="string">&quot;tmp&quot;</span></span>)))

    <span class="comment">/** Expand a property-extensions pair into a complete File object */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">((String, List[String]))Option[java.io.File]</span><a id="67791">expand</a></span>(<span class="typed"><span class="type">(String, List[String])</span><a id="67804">trial</a></span>: <span class="typed"><span class="type">(String, List[String])</span><a id="1378">(</a></span>String, List[String])): <span class="typed"><span class="type">Option[java.io.File]</span><a id="934">Option</a></span>[File] = {
      <span class="keyword">val</span> <span class="typed"><span class="type">(String, List[String])</span><span id="23625"><a href="#67810" id="1379">(</a></span></span><span class="typed"><span class="type">String</span><span id="67810"><span id="67806"><a href="#67805" id="23614">topdirProp</a></span></span></span>, <span class="typed"><span class="type">List[String]</span><span id="67811"><span id="67807"><a href="#67805" id="23616">extensions</a></span></span></span>) = <span class="typed"><span class="type">(String, List[String])</span><a href="#67804">trial</a></span>
      <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><a id="67808">topdir</a></span> = <span class="typed"><span class="type">object java.lang.System</span><a id="1886">System</a></span>.<span class="typed"><span class="type">(java.lang.String)java.lang.String</span><a id="47450">getProperty</a></span>(<span class="typed"><span class="type">String</span><a href="#67806">topdirProp</a></span>)
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">java.lang.String</span><a href="#67808">topdir</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5794">eq</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)
        <span class="typed"><span class="type">Nothing</span><span class="keyword">return</span></span> <span class="typed"><span class="type">object None</span><a id="536">None</a></span>

      <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><a id="67809">fulldir</a></span> =
        <span class="typed"><span class="type">List[String]</span><a href="#67807">extensions</a></span>.<span class="typed"><span class="type">(java.io.File)((java.io.File, String) =&gt; java.io.File)java.io.File</span><a id="21375">foldLeft</a></span>[<span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>](<span class="typed"><span class="type">java.io.File</span><span class="keyword">new</span></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">java.lang.String</span><a href="#67808">topdir</a></span>))(
            (<span class="typed"><span class="type">java.io.File</span><a id="67818">dir</a></span>,<span class="typed"><span class="type">String</span><a id="67819">ext</a></span>) =&gt; <span class="typed"><span class="type">(java.io.File,java.lang.String)java.io.File</span><a id="40682" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">java.io.File</span><a href="#67818">dir</a></span>, <span class="typed"><span class="type">String</span><a href="#67819">ext</a></span>))

      <span class="typed"><span class="type">(java.io.File)Some[java.io.File]</span><span id="29737"><a id="308">Some</a></span></span>(<span class="typed"><span class="type">java.io.File</span><a href="#67809">fulldir</a></span>)
    }

    <span class="comment">/** Try to create directory f, and then see if it can
     *  be written into. */</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(java.io.File)Boolean</span><a id="67792">isDirWritable</a></span>(<span class="typed"><span class="type">java.io.File</span><a id="67835">f</a></span>: <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> = {
      <span class="typed"><span class="type">java.io.File</span><a href="#67835">f</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40712">mkdirs</a></span>()
      <span class="typed"><span class="type">java.io.File</span><a href="#67835">f</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40698">isDirectory</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">java.io.File</span><a href="#67835">f</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40696">canWrite</a></span>
    }
    
    <span class="keyword">def</span> <span class="typed"><span class="type">()java.io.File</span><a id="67793">findTmpDir</a></span>(): <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span> = {    
      <span class="keyword">for</span> (<span class="typed"><span class="type">(((java.lang.String, List[java.lang.String])) =&gt; Unit)Unit</span><span id="21366"><a id="67837">trial</a></span></span> &lt;- <span class="typed"><span class="type">List[(java.lang.String, List[java.lang.String])]</span><a href="#67790">totry</a></span>) <span class="typed"><span class="type">((String, List[String]))Option[java.io.File]</span><a href="#67791">expand</a></span>(<span class="typed"><span class="type">(java.lang.String, List[java.lang.String])</span><a href="#67837">trial</a></span>) <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
        <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">java.io.File</span><a id="67838">dir</a></span>) <span class="keyword">if</span> <span class="typed"><span class="type">(java.io.File)Boolean</span><a href="#67792">isDirWritable</a></span>(<span class="typed"><span class="type">java.io.File</span><a href="#67838">dir</a></span>) =&gt;
          <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[Temp directory: &quot;)</span><span class="string">&quot;[Temp directory: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.io.File</span><a href="#67838">dir</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;]&quot;)</span><span class="string">&quot;]&quot;</span></span>)
          <span class="typed"><span class="type">Nothing</span><span class="keyword">return</span></span> <span class="typed"><span class="type">java.io.File</span><a href="#67838">dir</a></span>
        <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> _ =&gt;
      }
      <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Could not find a directory for temporary files&quot;)</span><span class="string">&quot;Could not find a directory for temporary files&quot;</span></span>)
    }
    
    <span class="typed"><span class="type">()java.io.File</span><a href="#67793">findTmpDir</a></span>()
  }
  
  <span class="comment">/* A directory holding port identification files */</span>
  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><span id="67460"><a id="67459">portsDir</a></span></span> =  <span class="typed"><span class="type">(java.io.File,java.lang.String)java.io.File</span><a id="40682" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#67457">tmpDir</a></span>, <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67444">dirName</a></span>)
  <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#67459">portsDir</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40712">mkdirs</a></span>

  <span class="comment">/** Maximum number of polls for an available port */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><span id="67462"><a id="67461">MaxAttempts</a></span></span> = <span class="typed"><span class="type">Int(100)</span><span class="int">100</span></span>

  <span class="comment">/** Time (in ms) to sleep between two polls */</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><span id="67464"><a id="67463">sleepTime</a></span></span> = <span class="typed"><span class="type">Int(20)</span><span class="int">20</span></span>

  <span class="comment">/** The command which starts the compile server, given vm arguments.
    *
    *  @param vmArgs  the argument string to be passed to the java or scala command
    *                 the string must be either empty or start with a ' '.
    */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(String)String</span><a id="67465">serverCommand</a></span>(<span class="typed"><span class="type">String</span><a id="67887">vmArgs</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>): <span class="typed"><span class="type">String</span><a id="1861">String</a></span> =
    <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67446">vmCommand</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">String</span><a href="#67887">vmArgs</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot; &quot;)</span><span class="string">&quot; &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">=&gt; java.lang.String</span><a href="#67448">serverClass</a></span>

  <span class="comment">/** Start a new server; returns true iff it succeeds */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(String)Unit</span><a id="67466">startNewServer</a></span>(<span class="typed"><span class="type">String</span><a id="67888">vmArgs</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>) {
    <span class="keyword">val</span> <span class="typed"><span class="type">String</span><a id="67889">cmd</a></span> = <span class="typed"><span class="type">(String)String</span><a href="#67465">serverCommand</a></span>(<span class="typed"><span class="type">String</span><a href="#67888">vmArgs</a></span>)
    <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[Executed command: &quot;)</span><span class="string">&quot;[Executed command: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">String</span><a href="#67889">cmd</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;]&quot;)</span><span class="string">&quot;]&quot;</span></span>)
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">object java.lang.Runtime</span><a id="1751">Runtime</a></span>.<span class="typed"><span class="type">()java.lang.Runtime</span><a id="67890">getRuntime</a></span>().<span class="typed"><span class="type">(java.lang.String)java.lang.Process</span><a id="67896">exec</a></span>(<span class="typed"><span class="type">String</span><a href="#67889">cmd</a></span>)
<span class="comment">//      val exitVal = proc.waitFor()</span>
<span class="comment">//      info(&quot;[Exit value: &quot; + exitVal + &quot;]&quot;)</span>
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="67928">ex</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3519">IOException</a></span> =&gt;
        <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="string">&quot;Cannot start compilation daemon.&quot;</span> <span class="typed"><span class="type">java.lang.String(&quot;Cannot start compilation daemon.\012tried command: &quot;)</span><span >+</span></span>
              <span class="string">&quot;\ntried command: &quot;</span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">String</span><a href="#67889">cmd</a></span>)
    }
  }

  <span class="comment">/** The port identification file */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(Int)java.io.File</span><a id="67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a id="67929">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>) = <span class="typed"><span class="type">(java.io.File,java.lang.String)java.io.File</span><a id="40682" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3669">File</a></span>(<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#67459">portsDir</a></span>, <span class="typed"><span class="type">Int</span><a href="#67929">port</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="3500">toString</a></span>())

  <span class="comment">/** Poll for a server port number; return -1 if none exists yet */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Int</span><a id="67468">pollPort</a></span>(): <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">Array[java.io.File]</span><a id="67945">hits</a></span> = <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#67459">portsDir</a></span>.<span class="typed"><span class="type">()Array[java.io.File]</span><a id="40708">listFiles</a></span>()
    <span class="typed"><span class="type">Int</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Array[java.io.File]</span><a href="#67945">hits</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21508">length</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) -<span class="typed"><span class="type">Int(-1)</span><span class="int">1</span></span>
    <span class="keyword">else</span>
      <span class="keyword">try</span> {
        <span class="keyword">for</span> (<span class="typed"><span class="type">((Int) =&gt; Unit)Unit</span><span id="40475"><a id="67959">i</a></span></span> &lt;- <span class="typed"><span class="type">implicit scala.Predef.intWrapper : (Int)scala.runtime.RichInt</span><span id="6133"><a id="821" class="int">1</a></span></span> <span class="typed"><span class="type">(Int)Range</span><a id="26778">until</a></span> <span class="typed"><span class="type">Array[java.io.File]</span><a href="#67945">hits</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21508">length</a></span>) <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67945" id="21509">hits</a></span>(<span class="typed"><span class="type">Int</span><a href="#67959">i</a></span>).<span class="typed"><span class="type">()Boolean</span><a id="40704">delete</a></span>()
        <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67945" id="21509">hits</a></span>(<span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>).<span class="typed"><span class="type">implicit scala.Predef.stringWrapper : (String)scala.runtime.RichString</span><span id="6140"><span id="821"><a id="40684">getName</a></span></span></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="23114">toInt</a></span>
      } <span class="keyword">catch</span> {
        <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.NumberFormatException</span><a id="67970">ex</a></span>: <span class="typed"><span class="type">java.lang.NumberFormatException</span><a id="2104">NumberFormatException</a></span> =&gt;
          <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.NumberFormatException</span><a href="#67970">ex</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="23650">toString</a></span>() <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
                <span class="typed"><span class="type">java.lang.String(&quot;\012bad file in temp directory: &quot;)</span><span class="string">&quot;\nbad file in temp directory: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
                <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67945" id="21509">hits</a></span>(<span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>).<span class="typed"><span class="type">()java.lang.String</span><a id="40689">getAbsolutePath</a></span>() <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
                <span class="typed"><span class="type">java.lang.String(&quot;\012please remove the file and try again&quot;)</span><span class="string">&quot;\nplease remove the file and try again&quot;</span></span>)
      }
  }

  <span class="comment">/** Get the port number to which a scala compile server is connected;
   *  If no server is running yet, then create one.
   */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(String)Int</span><a id="67469">getPort</a></span>(<span class="typed"><span class="type">String</span><a id="67974">vmArgs</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>): <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = {
    <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><a id="67975">attempts</a></span> = <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>
    <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><a id="67976">port</a></span> = <span class="typed"><span class="type">()Int</span><a href="#67468">pollPort</a></span>()

    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#67976">port</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
      <span class="typed"><span class="type">(String)Unit</span><a href="#67466">startNewServer</a></span>(<span class="typed"><span class="type">String</span><a href="#67974">vmArgs</a></span>)
    <span class="typed"><span class="type">Unit</span><a href="#67977" class="keyword">while</a></span> (<span class="typed"><span class="type">Int</span><a href="#67976">port</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Int</span><a href="#67975">attempts</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#67461">MaxAttempts</a></span>) {
      <span class="typed"><span class="type">Int</span><a href="#67975">attempts</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+=</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>
      <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="29017">sleep</a></span>(<span class="typed"><span class="type">implicit scala.Predef.int2long : (Int)Long</span><span id="6212"><a href="#67463" id="821">sleepTime</a></span></span>)
      <span class="typed"><span class="type">Int</span><a href="#67976">port</a></span> = <span class="typed"><span class="type">()Int</span><a href="#67468">pollPort</a></span>()
    }
    <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[Port number: &quot;)</span><span class="string">&quot;[Port number: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">Int</span><a href="#67976">port</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;]&quot;)</span><span class="string">&quot;]&quot;</span></span>)
    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#67976">port</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
      <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Could not connect to compilation daemon.&quot;)</span><span class="string">&quot;Could not connect to compilation daemon.&quot;</span></span>)
    <span class="typed"><span class="type">Int</span><a href="#67976">port</a></span>
  }

  <span class="comment">/** Set the port number to which a scala compile server is connected */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="67470">setPort</a></span>(<span class="typed"><span class="type">Int</span><a id="68005">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>) {
    <span class="keyword">try</span> {
      <span class="keyword">val</span> <span class="typed"><span class="type">java.io.PrintWriter</span><a id="68006">f</a></span> = <span class="typed"><span class="type">(java.io.OutputStream)java.io.PrintWriter</span><a id="28679" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.PrintWriter</span><a id="3759">PrintWriter</a></span>(<span class="typed"><span class="type">(java.io.File)java.io.FileOutputStream</span><a id="48703" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.FileOutputStream</span><a id="3798">FileOutputStream</a></span>(<span class="typed"><span class="type">(Int)java.io.File</span><a href="#67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a href="#68005">port</a></span>)))
      <span class="typed"><span class="type">java.io.PrintWriter</span><a href="#68006">f</a></span>.<span class="typed"><span class="type">(java.lang.String)Unit</span><a id="28711">println</a></span>(<span class="typed"><span class="type">java.security.SecureRandom</span><span class="keyword">new</span></span> java.security.<span class="typed"><span class="type">java.security.SecureRandom</span><a id="4869">SecureRandom</a></span>().<span class="typed"><span class="type">()Int</span><a id="68036">nextInt</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="3500">toString</a></span>)
      <span class="typed"><span class="type">java.io.PrintWriter</span><a href="#68006">f</a></span>.<span class="typed"><span class="type">()Unit</span><a id="28686">close</a></span>()
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Exception</span><a id="68057">ex</a></span>: <span class="comment">/*FileNotFound+Security*/</span><span class="typed"><span class="type">Exception</span><a id="2131">Exception</a></span> =&gt;
        <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Cannot create file: &quot;)</span><span class="string">&quot;Cannot create file: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
              <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a href="#68005">port</a></span>).<span class="typed"><span class="type">()java.lang.String</span><a id="40689">getAbsolutePath</a></span>())
    }
  }

  <span class="comment">/** Delete the port number to which a scala compile server was connected */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="67471">deletePort</a></span>(<span class="typed"><span class="type">Int</span><a id="68058">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>) { <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a href="#68058">port</a></span>).<span class="typed"><span class="type">()Boolean</span><a id="40704">delete</a></span>() }

  <span class="comment">/** Get a socket connected to a daemon.  If create is true, then
    * create a new daemon if necessary.  Returns null if the connection
    * cannot be established.
    */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(String,Boolean)java.net.Socket</span><a id="67472">getOrCreateSocket</a></span>(<span class="typed"><span class="type">String</span><a id="68059">vmArgs</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>, <span class="typed"><span class="type">Boolean</span><a id="68060">create</a></span>: <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span>): <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="68061">nAttempts</a></span> = <span class="typed"><span class="type">Int(49)</span><span class="int">49</span></span>  <span class="comment">// try for about 5 seconds</span>
    <span class="keyword">def</span> <span class="typed"><span class="type">(Int)java.net.Socket</span><a id="68062">getsock</a></span>(<span class="typed"><span class="type">Int</span><a id="68063">attempts</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span> =
      <span class="typed"><span class="type">java.net.Socket</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#68063">attempts</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) {
        <span class="typed"><span class="type">(String)Unit</span><a href="#67454">error</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Unable to establish connection to compilation daemon&quot;)</span><span class="string">&quot;Unable to establish connection to compilation daemon&quot;</span></span>)
        <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>
      } <span class="keyword">else</span> {
        <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="68065">port</a></span> = <span class="typed"><span class="type">Int</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Boolean</span><a href="#68060">create</a></span>) <span class="typed"><span class="type">(String)Int</span><a href="#67469">getPort</a></span>(<span class="typed"><span class="type">String</span><a href="#68059">vmArgs</a></span>) <span class="keyword">else</span> <span class="typed"><span class="type">()Int</span><a href="#67468">pollPort</a></span>()
        <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span>(<span class="typed"><span class="type">Int</span><a href="#68065">port</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) <span class="typed"><span class="type">Nothing</span><span class="keyword">return</span></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>
        <span class="keyword">val</span> <span class="typed"><span class="type">java.net.InetAddress</span><a id="68066">hostAdr</a></span> = <span class="typed"><span class="type">object java.net.InetAddress</span><a id="4647">InetAddress</a></span>.<span class="typed"><span class="type">()java.net.InetAddress</span><a id="47327">getLocalHost</a></span>()
        <span class="keyword">try</span> {
          <span class="keyword">val</span> <span class="typed"><span class="type">java.net.Socket</span><a id="68068">result</a></span> = <span class="typed"><span class="type">(java.net.InetAddress,Int)java.net.Socket</span><a id="47485" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span>(<span class="typed"><span class="type">java.net.InetAddress</span><a href="#68066">hostAdr</a></span>, <span class="typed"><span class="type">Int</span><a href="#68065">port</a></span>)
          <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[Connected to compilation daemon at port &quot;)</span><span class="string">&quot;[Connected to compilation daemon at port &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">Int</span><a href="#68065">port</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;]&quot;)</span><span class="string">&quot;]&quot;</span></span>)
          <span class="typed"><span class="type">java.net.Socket</span><a href="#68068">result</a></span>
        } <span class="keyword">catch</span> {
          <span class="typed"><span class="type">java.net.Socket</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Exception</span><a id="68078">e</a></span>: <span class="comment">/*IO+Security*/</span><span class="typed"><span class="type">Exception</span><a id="2131">Exception</a></span> =&gt;
            <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">Exception</span><a href="#68078">e</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="23650">toString</a></span>)
            <span class="typed"><span class="type">(String)Unit</span><a href="#67456">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[Connecting to compilation daemon at port &quot;)</span><span class="string">&quot;[Connecting to compilation daemon at port &quot;</span></span>  <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
                 <span class="typed"><span class="type">Int</span><a href="#68065">port</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot; failed; re-trying...]&quot;)</span><span class="string">&quot; failed; re-trying...]&quot;</span></span>)
            
            <span class="typed"><span class="type">AnyVal with NotNull</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#68063">attempts</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3151">%</a></span> <span class="typed"><span class="type">Int(2)</span><span class="int">2</span></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) 
              <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a href="#68065">port</a></span>).<span class="typed"><span class="type">()Boolean</span><a id="40704">delete</a></span> <span class="comment">// 50% chance to stop trying on this port</span>
              
            <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="29017">sleep</a></span>(<span class="typed"><span class="type">Long(100L)</span><span class="int">100</span></span>) <span class="comment">// delay before retrying</span>
            
            <span class="typed"><span class="type">(Int)java.net.Socket</span><a href="#68062">getsock</a></span>(<span class="typed"><span class="type">Int</span><a href="#68063">attempts</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>)
        }
      }
    <span class="typed"><span class="type">(Int)java.net.Socket</span><a href="#68062">getsock</a></span>(<span class="typed"><span class="type">Int</span><a href="#68061">nAttempts</a></span>)
  }
  
  <span class="comment">/** Same as getOrCreateSocket(vmArgs, true). */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(String)java.net.Socket</span><a id="67473">getOrCreateSocket</a></span>(<span class="typed"><span class="type">String</span><a id="68103">vmArgs</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>): <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span> =
    <span class="typed"><span class="type">(String,Boolean)java.net.Socket</span><a href="#67472">getOrCreateSocket</a></span>(<span class="typed"><span class="type">String</span><a href="#68103">vmArgs</a></span>, <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>)

  <span class="keyword">def</span> <span class="typed"><span class="type">(String)java.net.Socket</span><a id="67474">getSocket</a></span>(<span class="typed"><span class="type">String</span><a id="68109">serverAdr</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>): <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="68110">cpos</a></span> = <span class="typed"><span class="type">String</span><a href="#68109">serverAdr</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="5844">indexOf</a></span> <span class="typed"><span class="type">Int(58)</span><span class="char">':'</span></span>
    <span class="typed"><span class="type">java.net.Socket</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#68110">cpos</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
      <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Malformed server address: &quot;)</span><span class="string">&quot;Malformed server address: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">String</span><a href="#68109">serverAdr</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;; exiting&quot;)</span><span class="string">&quot;; exiting&quot;</span></span>)
    <span class="keyword">else</span> {
      <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><a id="68118">hostName</a></span> = <span class="typed"><span class="type">String</span><a href="#68109">serverAdr</a></span>.<span class="typed"><span class="type">(Int,Int)java.lang.String</span><a id="5855">substring</a></span>(<span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>, <span class="typed"><span class="type">Int</span><a href="#68110">cpos</a></span>)
      <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="68119">port</a></span> = <span class="keyword">try</span> {
        <span class="typed"><span class="type">String</span><a href="#68109">serverAdr</a></span>.<span class="typed"><span class="type">implicit scala.Predef.stringWrapper : (String)scala.runtime.RichString</span><span id="6140"><span id="821"><a id="5854">substring</a></span></span></span>(<span class="typed"><span class="type">Int</span><a href="#68110">cpos</a></span><span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span><span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>).<span class="typed"><span class="type">=&gt; Int</span><a id="23114">toInt</a></span>
      } <span class="keyword">catch</span> {
        <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.Throwable</span><a id="68150">ex</a></span>: <span class="typed"><span class="type">Throwable</span><a id="2143">Throwable</a></span> =&gt;
          <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Malformed server address: &quot;)</span><span class="string">&quot;Malformed server address: &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">String</span><a href="#68109">serverAdr</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;; exiting&quot;)</span><span class="string">&quot;; exiting&quot;</span></span>)
      }
      <span class="typed"><span class="type">(String,Int)java.net.Socket</span><a href="#67475">getSocket</a></span>(<span class="typed"><span class="type">java.lang.String</span><a href="#68118">hostName</a></span>, <span class="typed"><span class="type">Int</span><a href="#68119">port</a></span>)
    }
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(String,Int)java.net.Socket</span><a id="67475">getSocket</a></span>(<span class="typed"><span class="type">String</span><a id="68152">hostName</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>, <span class="typed"><span class="type">Int</span><a id="68153">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span> =
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">(java.lang.String,Int)java.net.Socket</span><a id="47484" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.Socket</span><a id="4403">Socket</a></span>(<span class="typed"><span class="type">String</span><a href="#68152">hostName</a></span>, <span class="typed"><span class="type">Int</span><a href="#68153">port</a></span>)
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Exception</span><a id="68167">e</a></span>: <span class="comment">/*IO+Security*/</span><span class="typed"><span class="type">Exception</span><a id="2131">Exception</a></span> =&gt;
        <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Unable to establish connection to server &quot;)</span><span class="string">&quot;Unable to establish connection to server &quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span>
              <span class="typed"><span class="type">String</span><a href="#68152">hostName</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;:&quot;)</span><span class="string">&quot;:&quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">Int</span><a href="#68153">port</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;; exiting&quot;)</span><span class="string">&quot;; exiting&quot;</span></span>)
    }

  <span class="keyword">def</span> <span class="typed"><span class="type">(Int)String</span><a id="67476">getPassword</a></span>(<span class="typed"><span class="type">Int</span><a id="68168">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">String</span><a id="1861">String</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><a id="68169">ff</a></span> = <span class="typed"><span class="type">(Int)java.io.File</span><a href="#67467">portFile</a></span>(<span class="typed"><span class="type">Int</span><a href="#68168">port</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">java.io.BufferedReader</span><a id="68170">f</a></span> = <span class="typed"><span class="type">(java.io.Reader)java.io.BufferedReader</span><a id="46775" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.BufferedReader</span><a id="3549">BufferedReader</a></span>(<span class="typed"><span class="type">(java.io.File)java.io.FileReader</span><a id="68176" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.FileReader</span><a id="3828">FileReader</a></span>(<span class="typed"><span class="type">java.io.File</span><a href="#68169">ff</a></span>))
    <span class="comment">// allow some time for the server to start up</span>
    <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><a id="68171">retry</a></span> = <span class="typed"><span class="type">Int(50)</span><span class="int">50</span></span>
    <span class="typed"><span class="type">Unit</span><a href="#68173" class="keyword">while</a></span> (<span class="typed"><span class="type">java.io.File</span><a href="#68169">ff</a></span>.<span class="typed"><span class="type">()Long</span><a id="40702">length</a></span>() <span class="typed"><span class="type">(Int)Boolean</span><a id="3250">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Int</span><a href="#68171">retry</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3145">&gt;</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) {
      <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="29017">sleep</a></span>(<span class="typed"><span class="type">Long(100L)</span><span class="int">100</span></span>)
      <span class="typed"><span class="type">Int</span><a href="#68171">retry</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-=</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>
    }
    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">java.io.File</span><a href="#68169">ff</a></span>.<span class="typed"><span class="type">()Long</span><a id="40702">length</a></span>() <span class="typed"><span class="type">(Int)Boolean</span><a id="3250">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) {
      <span class="typed"><span class="type">java.io.File</span><a href="#68169">ff</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="40704">delete</a></span>()
      <span class="typed"><span class="type">(String)Nothing</span><a href="#67455">fatal</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Unable to establish connection to server.&quot;)</span><span class="string">&quot;Unable to establish connection to server.&quot;</span></span>)
    }
    <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.String</span><a id="68172">result</a></span> = <span class="typed"><span class="type">java.io.BufferedReader</span><a href="#68170">f</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="46779">readLine</a></span>()
    <span class="typed"><span class="type">java.io.BufferedReader</span><a href="#68170">f</a></span>.<span class="typed"><span class="type">()Unit</span><a id="46785">close</a></span>()
    <span class="typed"><span class="type">java.lang.String</span><a href="#68172">result</a></span>
  }
}


<span class="keyword">object</span> <span class="typed"><span class="type">object scala.tools.nsc.CompileSocket</span><a id="6853">CompileSocket</a></span> <span class="keyword">extends</span> <span class="typed"><span class="type">scala.tools.nsc.CompileSocket</span><a href="#6852">CompileSocket</a></span>

        </pre>
    </body>
</html>