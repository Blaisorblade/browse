<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/CompileSocket.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */
// $Id: CompileSocket.scala 18626 2009-09-01 16:05:38Z extempore $

<span class="keyword">package</span> scala.tools.nsc

<span class="keyword">import</span> java.io.{ IOException, FileNotFoundException, PrintWriter, FileOutputStream }
<span class="keyword">import</span> java.io.{ BufferedReader, FileReader }
<span class="keyword">import</span> java.util.regex.Pattern
<span class="keyword">import</span> java.net._
<span class="keyword">import</span> java.security.SecureRandom

<span class="keyword">import</span> scala.io.{ File, Path }
<span class="keyword">import</span> scala.util.control.Exception.catching

// class CompileChannel { }

/** This class manages sockets for the fsc offline compiler.  */
<span class="keyword">class</span> <a title="class CompileSocket extends java.lang.Object with ScalaObject" id="8907">CompileSocket</a> <span title="ScalaObject">{</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; scala.tools.nsc.StandardCompileClient" id="132466">compileClient</a>: <a href="CompileClient.scala.html#8511" title="scala.tools.nsc.StandardCompileClient">StandardCompileClient</a> = <a href="CompileClient.scala.html#8383" title="object scala.tools.nsc.CompileClient">CompileClient</a> //todo: lazy val

  /** The prefix of the port identification file, which is followed
   *  by the port number.
   */
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; java.lang.String" id="132467">dirName</a> = <span title="java.lang.String(&quot;scalac-compile-server-port&quot;)" class="string">&quot;scalac-compile-server-port&quot;</span> //todo: lazy val

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; java.lang.String" id="132468">cmdName</a> = <a href="Properties.scala.html#9493" title="object scala.tools.nsc.Properties">Properties</a>.<a href="Properties.scala.html#38505" title="=&gt; java.lang.String">cmdName</a> //todo: lazy val

  /** The vm part of the command to start a new scala compile server */
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.lang.String" id="132469">vmCommand</a> = <a href="Properties.scala.html#9493" title="object scala.tools.nsc.Properties">Properties</a>.<a title="=&gt; String" id="38489">scalaHome</a> <span title="java.lang.String" class="keyword">match</span> {
    <span title="java.lang.String" class="keyword">case</span> <span title="Null(null)" class="keyword">null</span>     =&gt; <a href="#132468" title="=&gt; java.lang.String">cmdName</a>
    <span title="String" class="keyword">case</span> <a title="String" id="606074">dirname</a>  =&gt;
      <span class="keyword">val</span> <a title="scala.io.Path" id="606075">trial</a> = <span title="object scala.io.File">File</span><a title="(child: scala.io.Path)scala.io.Path" id="606092">(</a><a href="#606074" title="scala.io.Path" id="606087">dirname</a>) <span title="(child: scala.io.Path)scala.io.Path">/</span> <span title="implicit scala.io.Path.string2path : (s: String)scala.io.Path" class="string">&quot;bin&quot;</span> / <a href="#132468" title="implicit scala.io.Path.string2path : (s: String)scala.io.Path">cmdName</a>
      <span title="String" class="keyword">if</span> (<a href="#606075" title="scala.io.Path">trial</a>.<a title="=&gt; Boolean" id="112302">canRead</a>) <a href="#606075" title="scala.io.Path">trial</a>.<span title="=&gt; String">path</span>
      <span class="keyword">else</span> <a href="#132468" title="=&gt; java.lang.String">cmdName</a>
  }

  /** The class name of the scala compile server */
  <span class="keyword">protected</span> <span class="keyword">val</span> <a title="java.lang.String" id="132471">serverClass</a> = <span title="java.lang.String(&quot;scala.tools.nsc.CompileServer&quot;)" class="string">&quot;scala.tools.nsc.CompileServer&quot;</span>
    
  /** A regular expression for checking compiler output for errors */
  <span class="keyword">val</span> <a title="java.lang.String" id="132473">errorRegex</a> = <span title="java.lang.String(&quot;.*(errors? found|don't know|bad option).*&quot;)" class="string">&quot;.*(errors? found|don't know|bad option).*&quot;</span>
    
  /** A Pattern object for checking compiler output for errors */
  <span class="keyword">val</span> <a title="java.util.regex.Pattern" id="132475">errorPattern</a> = <a title="(x$1: java.lang.String)java.util.regex.Pattern" id="30801">Pattern</a> compile <a href="#132473" title="=&gt; java.lang.String">errorRegex</a>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(msg: String)Unit" id="132477">error</a>(<a title="String" id="606241">msg</a>: <span title="String">String</span>) = <span title="object java.lang.System">System</span>.<a title="java.io.PrintStream" id="65177">err</a>.<span title="(x$1: java.lang.String)Unit">println</span>(<a href="#606241" title="String">msg</a>)
    
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(msg: String)Nothing" id="132478">fatal</a>(<a title="String" id="606238">msg</a>: <span title="String">String</span>) = {
    <a href="#132477" title="(msg: String)Unit">error</a>(<a href="#606238" title="String">msg</a>)
    <span title="Nothing" class="keyword">throw</span> <a title="(x$1: java.lang.String)java.lang.Exception" id="29441" class="keyword">new</a> <a title="java.lang.Exception" id="7889">Exception</a>(<span title="java.lang.String(&quot;fsc failure&quot;)" class="string">&quot;fsc failure&quot;</span>)
  }

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(msg: String)Unit" id="132479">info</a>(<a title="String" id="606221">msg</a>: <span title="String">String</span>) =
    <span title="Unit" class="keyword">if</span> (<a href="#132466" title="=&gt; scala.tools.nsc.StandardCompileClient">compileClient</a>.<a href="CompileClient.scala.html#60576" title="=&gt; Boolean">verbose</a>) <span title="object java.lang.System">System</span>.<a title="java.io.PrintStream" id="65176">out</a>.<span title="(x$1: java.lang.String)Unit">println</span>(<a href="#606221" title="String">msg</a>)

  /** A temporary directory to use */
  <span class="keyword">val</span> <a title="scala.io.Directory" id="132480">tmpDir</a> = {
    <span class="keyword">val</span> <a title="String" id="606145">udir</a>  = <a title="(x: String)Option[String]" id="795">Option</a><a title="(default: =&gt; String)String" id="35236">(</a><a href="Properties.scala.html#9493" title="object scala.tools.nsc.Properties">Properties</a>.<a title="=&gt; String" id="38487">userName</a>) getOrElse <span title="java.lang.String(&quot;shared&quot;)" class="string">&quot;shared&quot;</span>
    <span class="keyword">val</span> <a title="scala.io.Directory" id="606146">f</a>     = (<a title="(path: String)scala.io.Path" id="112341">Path</a><span title="(child: scala.io.Path)scala.io.Path">(</span><a href="Properties.scala.html#9493" title="object scala.tools.nsc.Properties">Properties</a>.<a title="=&gt; String" id="38485">tmpDir</a>) <span title="(child: scala.io.Path)scala.io.Path">/</span> <span title="implicit scala.io.Path.string2path : (s: String)scala.io.Path" class="string">&quot;scala-devel&quot;</span> <a title="scala.io.Path" id="606213">/</a> <a href="#606145" title="implicit scala.io.Path.string2path : (s: String)scala.io.Path">udir</a>).<a href="#606213" title="Boolean" id="606216">createDirectory</a>()
    
    <span title="scala.io.Directory" class="keyword">if</span> (<a href="#606146" title="scala.io.Directory">f</a>.<a title="(x$1: Boolean)Boolean" id="112307">isDirectory</a> &amp;&amp; <a href="#606146" title="scala.io.Directory">f</a>.<a title="=&gt; Boolean" id="112303">canWrite</a>) {
      <a href="#132479" title="(msg: String)Unit">info</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[Temp directory: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#606146" title="scala.io.Directory">f</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)
      <a href="#606146" title="scala.io.Directory">f</a>
    }
    <span class="keyword">else</span> <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="java.lang.String(&quot;Could not find a directory for temporary files&quot;)" class="string">&quot;Could not find a directory for temporary files&quot;</span>)
  }
  
  /* A directory holding port identification files */
  <span class="keyword">val</span> <a title="scala.io.Directory" id="132482">portsDir</a> = (<a href="#132480" title="(child: scala.io.Path)scala.io.Path">tmpDir</a> <a title="scala.io.Path" id="606283">/</a> <a href="#132467" title="implicit scala.io.Path.string2path : (s: String)scala.io.Path">dirName</a>).<a href="#606283" title="Boolean" id="606286">createDirectory</a>()

  /** Maximum number of polls for an available port */
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="132484">MaxAttempts</a> = <span title="Int(100)" class="int">100</span>

  /** Time (in ms) to sleep between two polls */
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="Int" id="132486">sleepTime</a> = <span title="Int(20)" class="int">20</span>

  /** The command which starts the compile server, given vm arguments.
    *
    *  @param vmArgs  the argument string to be passed to the java or scala command
    *                 the string must be either empty or start with a ' '.
    */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(vmArgs: String)String" id="132488">serverCommand</a>(<a title="String" id="606291">vmArgs</a>: <span title="String">String</span>): <span title="String">String</span> =
    <a href="#132469" title="(x$1: Any)java.lang.String">vmCommand</a> <span title="(x$1: Any)java.lang.String">+</span> <a href="#606291" title="String">vmArgs</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span> + <a href="#132471" title="=&gt; java.lang.String">serverClass</a>

  /** Start a new server; returns true iff it succeeds */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(vmArgs: String)Unit" id="132489">startNewServer</a>(<a title="String" id="606299">vmArgs</a>: <span title="String">String</span>) {
    <span class="keyword">val</span> <a title="String" id="606301">cmd</a> = <a href="#132488" title="(vmArgs: String)String">serverCommand</a>(<a href="#606299" title="String">vmArgs</a>)
    <a href="#132479" title="(msg: String)Unit">info</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[Executed command: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#606301" title="String">cmd</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)
    <span class="keyword">try</span> {
      <a title="object java.lang.Runtime" id="1519">Runtime</a>.<a title="()java.lang.Runtime" id="130971">getRuntime</a>().<a title="(x$1: java.lang.String)java.lang.Process" id="130982">exec</a><span title="Unit">(</span><a href="#606301" title="String">cmd</a>)
//      val exitVal = proc.waitFor()
//      info(&quot;[Exit value: &quot; + exitVal + &quot;]&quot;)
    } <span class="keyword">catch</span> {
      <span title="Nothing" class="keyword">case</span> <a title="java.io.IOException" id="606325">ex</a>: <span title="java.io.IOException">IOException</span> =&gt;
        <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span class="string">&quot;Cannot start compilation daemon.&quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
              <span class="string">&quot;\ntried command: &quot;</span> + <a href="#606301" title="String">cmd</a>)
    }
  }

  /** The port identification file */
  <span class="keyword">def</span> <a title="(port: Int)scala.io.File" id="132490">portFile</a>(<a title="Int" id="606332">port</a>: <span title="Int">Int</span>) = <a href="#132482" title="(child: scala.io.File)scala.io.File" id="112292">portsDir</a> / <span title="object scala.io.File">File</span><a title="scala.io.Codec" id="606353">(</a><a href="#606332" title="Int">port</a>.<a title="scala.io.Path" id="606348">toString</a>)

  /** Poll for a server port number; return -1 if none exists yet */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Int" id="132491">pollPort</a>(): <span title="Int">Int</span> =
    <a href="#132482" title="=&gt; scala.io.Directory">portsDir</a>.<a title="=&gt; Iterator[scala.io.Path]" id="131507">list</a>.<a title="=&gt; List[scala.io.Path]" id="32462">toList</a> <span title="Int" class="keyword">match</span> {
      <span title="Int(-1)" class="keyword">case</span> <a title="object Nil" id="7700">Nil</a>      =&gt; <span title="Int(-1)">-</span><span class="int">1</span>
      <span title="Int" class="keyword">case</span> <a title="scala.io.Path" id="606363">p</a> :: <a title="List[scala.io.Path]" id="606364">xs</a>  =&gt;
        <a href="#606364" title="(p: (scala.io.Path) =&gt; Boolean)Boolean" id="29121">xs</a> forall (<a href="#606371" title="scala.io.Path">_</a>.<span title="()Boolean">delete</span>())
        <a href="#606363" title="scala.io.Path">p</a>.<a title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString" id="112294">name</a>.<span title="=&gt; Int">toInt</span>
    }

  /** Get the port number to which a scala compile server is connected;
   *  If no server is running yet, then create one.
   */
  <span class="keyword">def</span> <a title="(vmArgs: String)Int" id="132492">getPort</a>(<a title="String" id="606393">vmArgs</a>: <span title="String">String</span>): <span title="Int">Int</span> = {
    <span class="keyword">var</span> <a title="Int" id="606395">attempts</a> = <span title="Int(0)" class="int">0</span>
    <span class="keyword">var</span> <a title="Int" id="606396">port</a> = <a href="#132491" title="()Int">pollPort</a>()

    <span title="Unit" class="keyword">if</span> (<a href="#606396" title="(x$1: Int)Boolean">port</a> &lt; <span title="Int(0)" class="int">0</span>)
      <a href="#132489" title="(vmArgs: String)Unit">startNewServer</a>(<a href="#606393" title="String">vmArgs</a>)
      
    <span title="Unit" class="keyword">while</span> (<a href="#606396" title="(x$1: Int)Boolean">port</a> <span title="(x$1: Boolean)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> &amp;&amp; <a href="#606395" title="(x$1: Int)Boolean">attempts</a> &lt; <a href="#132484" title="=&gt; Int">MaxAttempts</a>) <a href="#606397" title="()Unit">{</a>
      <a href="#606395" title="Int">attempts</a> += <span title="Int(1)" class="int">1</span>
      <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span>(<a href="#132486" title="implicit scala.Predef.int2long : (x: Int)Long" id="8206">sleepTime</a>)
      <a href="#606396" title="Int">port</a> = <a href="#132491" title="()Int">pollPort</a>()
    }
    <a href="#132479" title="(msg: String)Unit">info</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[Port number: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#606396" title="Int">port</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)
    <span title="Unit" class="keyword">if</span> (<a href="#606396" title="(x$1: Int)Boolean">port</a> &lt; <span title="Int(0)" class="int">0</span>)
      <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="java.lang.String(&quot;Could not connect to compilation daemon.&quot;)" class="string">&quot;Could not connect to compilation daemon.&quot;</span>)
    <a href="#606396" title="Int">port</a>
  }

  /** Set the port number to which a scala compile server is connected */
  <span class="keyword">def</span> <a title="(port: Int)Unit" id="132493">setPort</a>(<a title="Int" id="606484">port</a>: <span title="Int">Int</span>) {
    <span class="keyword">val</span> <a title="scala.io.File" id="606486">file</a>    = <a href="#132490" title="(port: Int)scala.io.File">portFile</a>(<a href="#606484" title="Int">port</a>)
    <span class="keyword">val</span> <a title="java.lang.String" id="606487">secret</a>  = <span title="java.security.SecureRandom" class="keyword">new</span> <a title="java.security.SecureRandom" id="5555">SecureRandom</a>().<a title="()Int" id="606531">nextInt</a>.<span title="()java.lang.String">toString</span>
    
    <span class="keyword">try</span> <a href="#606486" title="(xs: Traversable[String],append: Boolean,codec: scala.io.Codec)Unit" id="131283">file</a> writeAll <a title="(xs: java.lang.String*)List[java.lang.String]" id="7415">List</a>(<a href="#606487" title="java.lang.String">secret</a>) <span class="keyword">catch</span> { 
      <span title="Nothing" class="keyword">case</span> <a title="java.lang.Throwable" id="606565">e</a> @ (_: <a title="java.io.FileNotFoundException" id="3720">FileNotFoundException</a> | _: <span title="java.lang.SecurityException">SecurityException</span>) =&gt;
        <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString" class="string">&quot;Cannot create file: %s&quot;</span>.<span title="(args: Any*)String">format</span>(<a href="#606486" title="scala.io.File">file</a>.<span title="=&gt; String">path</span>))
    }
  }

  /** Delete the port number to which a scala compile server was connected */
  <span class="keyword">def</span> <a title="(port: Int)Boolean" id="132494">deletePort</a>(<a title="Int" id="606589">port</a>: <span title="Int">Int</span>) = <a href="#132490" title="(port: Int)scala.io.File">portFile</a>(<a href="#606589" title="Int">port</a>).<span title="()Boolean">delete</span>()

  /** Get a socket connected to a daemon.  If create is true, then
    * create a new daemon if necessary.  Returns null if the connection
    * cannot be established.
    */
  <span class="keyword">def</span> <a title="(vmArgs: String,create: Boolean)java.net.Socket" id="132495">getOrCreateSocket</a>(<a title="String" id="132501">vmArgs</a>: <span title="String">String</span>, <a title="Boolean" id="132606">create</a>: <a title="Boolean" id="1972">Boolean</a> = <span title="Boolean(true)" class="keyword">true</span>): <span title="java.net.Socket">Socket</span> = {
    <span class="keyword">val</span> <a title="Int" id="606596">nAttempts</a> = <span title="Int(49)" class="int">49</span>  // try for about 5 seconds
    <span class="keyword">def</span> <a title="(attempts: Int)java.net.Socket" id="606597">getsock</a>(<a title="Int" id="606598">attempts</a>: <span title="Int">Int</span>): <span title="java.net.Socket">Socket</span> =
      <span title="java.net.Socket" class="keyword">if</span> (<a href="#606598" title="(x$1: Int)Boolean">attempts</a> == <span title="Int(0)" class="int">0</span>) {
        <a href="#132477" title="(msg: String)Unit">error</a>(<span title="java.lang.String(&quot;Unable to establish connection to compilation daemon&quot;)" class="string">&quot;Unable to establish connection to compilation daemon&quot;</span>)
        <span title="Null(null)" class="keyword">null</span>
      } <span class="keyword">else</span> {
        <span class="keyword">val</span> <a title="Int" id="606607">port</a> = <span title="Int" class="keyword">if</span>(<a href="#132606" title="Boolean">create</a>) <a href="#132492" title="(vmArgs: String)Int">getPort</a>(<a href="#132501" title="String">vmArgs</a>) <span class="keyword">else</span> <a href="#132491" title="()Int">pollPort</a>()
        <span title="Unit" class="keyword">if</span>(<a href="#606607" title="(x$1: Int)Boolean">port</a> &lt; <span title="Int(0)" class="int">0</span>) <span title="Nothing" class="keyword">return</span> <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">val</span> <a title="java.net.InetAddress" id="606608">hostAdr</a> = <a title="object java.net.InetAddress" id="5320">InetAddress</a>.<a title="()java.net.InetAddress" id="287645">getLocalHost</a>()
        <span class="keyword">try</span> {
          <span class="keyword">val</span> <a title="java.net.Socket" id="606621">result</a> = <a title="(x$1: java.net.InetAddress,x$2: Int)java.net.Socket" id="132514" class="keyword">new</a> <span title="java.net.Socket">Socket</span>(<a href="#606608" title="java.net.InetAddress">hostAdr</a>, <a href="#606607" title="Int">port</a>)
          <a href="#132479" title="(msg: String)Unit">info</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[Connected to compilation daemon at port &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#606607" title="Int">port</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)
          <a href="#606621" title="java.net.Socket">result</a>
        } <span class="keyword">catch</span> {
          <span title="java.net.Socket" class="keyword">case</span> <a title="Exception" id="606638">e</a>: /*IO+Security*/<a title="Exception" id="1896">Exception</a> =&gt;
            <a href="#132479" title="(msg: String)Unit">info</a>(<a href="#606638" title="Exception">e</a>.<a title="()java.lang.String" id="26090">toString</a>)
            <a href="#132479" title="(msg: String)Unit">info</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[Connecting to compilation daemon at port &quot;</span>  <span title="(x$1: Any)java.lang.String">+</span>
                 <a href="#606607" title="Int">port</a> + <span title="java.lang.String(&quot; failed; re-trying...]&quot;)" class="string">&quot; failed; re-trying...]&quot;</span>)
            
            <span title="AnyVal with NotNull" class="keyword">if</span> (<a href="#606598" title="(x$1: Int)Int" id="2993">attempts</a> <span title="(x$1: Int)Boolean">%</span> <span title="Int(2)" class="int">2</span> == <span title="Int(0)" class="int">0</span>) 
              <a href="#132490" title="(port: Int)scala.io.File">portFile</a>(<a href="#606607" title="Int">port</a>).<span title="()Boolean">delete</span> // 50% chance to stop trying on this port
              
            <span title="object java.lang.Thread">Thread</span>.<span title="(x$1: Long)Unit">sleep</span>(<span title="Long(100L)" class="int">100</span>) // delay before retrying
            
            <a href="#606597" title="(attempts: Int)java.net.Socket">getsock</a>(<a href="#606598" title="(x$1: Int)Int" id="2987">attempts</a> - <span title="Int(1)" class="int">1</span>)
        }
      }
    <a href="#606597" title="(attempts: Int)java.net.Socket">getsock</a>(<a href="#606596" title="Int">nAttempts</a>)
  }

  // XXX way past time for this to be central
  <span class="keyword">def</span> <a title="(x: String)Option[Int]" id="132496">parseInt</a>(<a title="String" id="606698">x</a>: <span title="String">String</span>): <a title="Option[Int]" id="794">Option</a>[Int] =
    <span class="keyword">try</span>   { <a title="(x: Int)Some[Int]" id="267">Some</a>(<a href="#606698" title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString">x</a>.<span title="=&gt; Int">toInt</span>) }
    <span class="keyword">catch</span> { <span title="None.type" class="keyword">case</span> _: <a title="NumberFormatException" id="1869">NumberFormatException</a> =&gt; <a title="object None" id="477">None</a> }
  
  <span class="keyword">def</span> <a title="(serverAdr: String)java.net.Socket" id="132497">getSocket</a>(<a title="String" id="606718">serverAdr</a>: <span title="String">String</span>): <span title="java.net.Socket">Socket</span> = {
    <span class="keyword">def</span> <a title="=&gt; Nothing" id="606720">fail</a> = <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="(args: Any*)String" class="string">&quot;Malformed server address: %s; exiting&quot;</span> format <a href="#606718" title="String">serverAdr</a>)
    (<a href="#606718" title="(x$1: Int)Int" id="7047">serverAdr</a> indexOf <span title="Int(58)" class="char">':'</span>) <span title="java.net.Socket" class="keyword">match</span> {
      <span title="Nothing" class="keyword">case</span> <span title="Int(-1)">-</span><span class="int">1</span>   =&gt; <a href="#606720" title="=&gt; Nothing">fail</a>
      <span title="java.net.Socket" class="keyword">case</span> <a title="Int" id="606758">cpos</a> =&gt;
        <span class="keyword">val</span> <a title="String" id="606759">hostName</a>: <span title="String">String</span> = <a href="#606718" title="(n: Int)scala.runtime.RichString" id="25943">serverAdr</a> <span title="implicit scala.Predef.richString2String : (x: scala.runtime.RichString)String">take</span> <a href="#606758" title="Int">cpos</a>
        <a href="#132496" title="(x: String)Option[Int]">parseInt</a>(<a href="#606718" title="(n: Int)scala.runtime.RichString" id="25945">serverAdr</a> <span title="implicit scala.Predef.richString2String : (x: scala.runtime.RichString)String">drop</span> (<a href="#606758" title="(x$1: Int)Int">cpos</a> + <span title="Int(1)" class="int">1</span>)) <span title="java.net.Socket" class="keyword">match</span> {
          <span title="java.net.Socket" class="keyword">case</span> Some(<a title="Int" id="606833">port</a>) =&gt; <a href="#132498" title="(hostName: String,port: Int)java.net.Socket">getSocket</a>(<a href="#606759" title="String">hostName</a>, <a href="#606833" title="Int">port</a>)
          <span title="Nothing" class="keyword">case</span> _          =&gt; <a href="#606720" title="=&gt; Nothing">fail</a>
        }
    }
  }

  <span class="keyword">def</span> <a title="(hostName: String,port: Int)java.net.Socket" id="132498">getSocket</a>(<a title="String" id="606839">hostName</a>: <span title="String">String</span>, <a title="Int" id="606840">port</a>: <span title="Int">Int</span>): <span title="java.net.Socket">Socket</span> =
    <span class="keyword">try</span> <a title="(x$1: java.lang.String,x$2: Int)java.net.Socket" id="132511" class="keyword">new</a> <span title="java.net.Socket">Socket</span>(<a href="#606839" title="String">hostName</a>, <a href="#606840" title="Int">port</a>) <span class="keyword">catch</span> {
      <span title="Nothing" class="keyword">case</span> <a title="java.lang.Throwable" id="606858">e</a> @ (_: <span title="java.io.IOException">IOException</span> | _: <span title="java.lang.SecurityException">SecurityException</span>) =&gt;
        <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString" class="string">&quot;Unable to establish connection to server %s:%d; exiting&quot;</span>.<span title="(args: Any*)String">format</span>(<a href="#606839" title="String">hostName</a>, <a href="#606840" title="Int">port</a>))
    }

  <span class="keyword">def</span> <a title="(port: Int)String" id="132499">getPassword</a>(<a title="Int" id="132736">port</a>: <span title="Int">Int</span>): <span title="String">String</span> = {
    <span class="keyword">val</span> <a title="scala.io.File" id="606882">ff</a>  = <a href="#132490" title="(port: Int)scala.io.File">portFile</a>(<a href="#132736" title="Int">port</a>)
    <span class="keyword">val</span> <a title="java.io.BufferedReader" id="606883">f</a>   = <a href="#606882" title="scala.io.File">ff</a>.<a title="(codec: scala.io.Codec)java.io.BufferedReader" id="131334">bufferedReader</a>()

    // allow some time for the server to start up
    <span class="keyword">def</span> <a title="=&gt; Long" id="606884">check</a> = {
      <span title="(x$1: Long)Unit">Thread</span> sleep <span title="Long(100L)" class="int">100</span>
      <a href="#606882" title="scala.io.File">ff</a>.<a title="=&gt; Long" id="131261">length</a>
    }
    <span title="Unit" class="keyword">if</span> (<a title="(elem: =&gt; Long)Iterator[Long]" id="375">Iterator</a> <a title="(n: Int)Iterator[Long]" id="32309">continually</a> <a href="#606884" title="=&gt; Long">check</a> <a title="(p: (Long) =&gt; Boolean)Option[Long]" id="32368">take</a> <span title="Int(50)" class="int">50</span> find (<a href="#606903" title="(x$1: Int)Boolean" id="3189">_</a> &gt; <span title="Int(0)" class="int">0</span>) <a title="=&gt; Boolean" id="35230">isEmpty</a>) {
      <a href="#606882" title="scala.io.File">ff</a>.<span title="()Boolean">delete</span>()
      <a href="#132478" title="(msg: String)Nothing">fatal</a>(<span title="java.lang.String(&quot;Unable to establish connection to server.&quot;)" class="string">&quot;Unable to establish connection to server.&quot;</span>)
    }
    <span class="keyword">val</span> <a title="java.lang.String" id="606885">result</a> = <a href="#606883" title="java.io.BufferedReader">f</a>.<a title="()java.lang.String" id="39081">readLine</a>()
    <a href="#606883" title="java.io.BufferedReader">f</a>.<a title="()Unit" id="39089">close</a>()
    <a href="#606885" title="java.lang.String">result</a>
  }
}


<span class="keyword">object</span> <a title="object scala.tools.nsc.CompileSocket" id="8908">CompileSocket</a> <span title="ScalaObject" class="keyword">extends</span> <a href="#8907" title="scala.tools.nsc.CompileSocket">CompileSocket</a>

        </pre>
    </body>
</html>