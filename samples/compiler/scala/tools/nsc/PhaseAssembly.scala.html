<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/PhaseAssembly.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new Scala compiler
 * Copyright 2007-2009 LAMP/EPFL
 * @author Anders Bach Nielsen
 * @version 1.0
 */
// $Id: PhaseAssembly.scala 18548 2009-08-22 21:27:49Z extempore $

<span class="keyword">package</span> scala.tools.nsc

<span class="keyword">import</span> scala.collection.mutable.{HashSet, HashMap}
<span class="keyword">import</span> java.io.{BufferedWriter, FileWriter}

/** 
 * PhaseAssembly
 * Trait made to seperate the constraint solving of the phase order from
 * the rest of the compiler. See SIP 00002
 *   
 */
<span class="keyword">trait</span> <a title="trait PhaseAssembly extends java.lang.Object with ScalaObject" id="8928">PhaseAssembly</a> <span title="ScalaObject">{</span> self: Global =&gt;
  
  /**
   * Aux datastructure for solving the constraint system
   * The depency graph container with helper methods for node and edge creation
   */
  <span class="keyword">class</span> <a title="class DependencyGraph extends java.lang.Object with ScalaObject" id="39446">DependencyGraph</a> <span title="ScalaObject">{</span>

    /**
     * Simple edge with to and from refs
     */
    <span class="keyword">class</span> <a title="class Edge extends java.lang.Object with ScalaObject" id="716842">Edge</a><span title="ScalaObject">(</span><span class="keyword">var</span> <a title="DependencyGraph.this.Node" id="716903">frm</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>, <span class="keyword">var</span> <a title="DependencyGraph.this.Node" id="716904">to</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>, <span class="keyword">var</span> <a title="Boolean" id="716905">hard</a>: <a title="Boolean" id="1972">Boolean</a>) 
    
    /**
     * Simple node with name and object ref for the phase object,
     * also sets of in and out going dependencies
     */
    <span class="keyword">class</span> <a title="class Node extends java.lang.Object with ScalaObject" id="716843">Node</a><span title="ScalaObject">(</span><a title="String" id="716918">name</a>: <span title="String">String</span>) {
      <span class="keyword">val</span> <a title="String" id="716883">phasename</a> = <a href="#716918" title="String">name</a>
      <span class="keyword">var</span> <a title="Option[List[scala.tools.nsc.SubComponent]]" id="716886">phaseobj</a>: <a title="Option[List[scala.tools.nsc.SubComponent]]" id="794">Option</a>[List[SubComponent]] = <span title="object None">None</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" id="716888">after</a> = <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">HashSet</span>[Edge]()
      <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" id="716891">before</a> = <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">HashSet</span>[Edge]()
      <span class="keyword">var</span> <a title="Boolean" id="716894">visited</a> = <span title="Boolean(false)" class="keyword">false</span>
      <span class="keyword">var</span> <a title="Int" id="716897">level</a> = <span title="Int(0)" class="int">0</span>

      <span class="keyword">def</span> <a title="()String" id="716899">allPhaseNames</a>(): <span title="String">String</span> = <a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a> <span title="String" class="keyword">match</span> {
	<span title="String" class="keyword">case</span> <span title="object None">None</span> =&gt; <a href="#716883" title="=&gt; String">phasename</a>
	<span title="String" class="keyword">case</span> Some(<a title="List[scala.tools.nsc.SubComponent]" id="716923">lst</a>) =&gt; <a href="#716923" title="List[scala.tools.nsc.SubComponent]">lst</a>.<a title="(f: (scala.tools.nsc.SubComponent) =&gt; String)(implicit bf: scala.collection.generic.BuilderFactory[String,List[String],List[scala.tools.nsc.SubComponent]])List[String]" id="25402">map</a><span title="scala.collection.generic.BuilderFactory[String,List[String],List#Coll]">(</span><a href="#716934" title="scala.tools.nsc.SubComponent">_</a>.<a href="SubComponent.scala.html#39854" title="=&gt; String">phaseName</a>).<a title="(f: (String, String) =&gt; String)String" id="29137">reduceLeft</a>(<a href="#717035" title="(x$1: Any)java.lang.String">_</a><span title="(x$1: Any)java.lang.String">+</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span>+<a href="#717036" title="String">_</a>)
      }
    }

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]" id="716844">nodes</a> = <span title="scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]" class="keyword">new</span> <a title="scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]" id="25113">HashMap</a>[String,Node]()
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" id="716846">edges</a> = <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">HashSet</span>[Edge]()

    /* Given a phase object, get the node for this phase object. If the
     * node object does not exist, then create it.
     */
    <span class="keyword">def</span> <a title="(phs: scala.tools.nsc.SubComponent)DependencyGraph.this.Node" id="716848">getNodeByPhase</a>(<a title="scala.tools.nsc.SubComponent" id="717043">phs</a>: <a href="SubComponent.scala.html#8328" title="scala.tools.nsc.SubComponent">SubComponent</a>): <a href="#716843" title="DependencyGraph.this.Node">Node</a> = {
      <span class="keyword">var</span> <a title="DependencyGraph.this.Node" id="717045">node</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a> = <a href="#716849" title="(name: String)DependencyGraph.this.Node">getNodeByPhase</a>(<a href="#717043" title="scala.tools.nsc.SubComponent">phs</a>.<a href="SubComponent.scala.html#39854" title="=&gt; String">phaseName</a>)
      <a href="#717045" title="DependencyGraph.this.Node">node</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a> <span title="Unit" class="keyword">match</span> {
	<span title="Unit" class="keyword">case</span> <span title="object None">None</span> =&gt;
	  <a href="#717045" title="DependencyGraph.this.Node">node</a>.<a href="#716886" title="(x$1: Option[List[scala.tools.nsc.SubComponent]])Unit">phaseobj</a> = <span title="(x: List[scala.tools.nsc.SubComponent])Some[List[scala.tools.nsc.SubComponent]]">Some</span>(<a title="[A](xs: A*)List[A]" id="24478">List</a><span title="(xs: scala.tools.nsc.SubComponent*)List[scala.tools.nsc.SubComponent]">[</span><a href="SubComponent.scala.html#8328" title="scala.tools.nsc.SubComponent">SubComponent</a>](<a href="#717043" title="scala.tools.nsc.SubComponent">phs</a>))
	<span title="Unit" class="keyword">case</span> _ =&gt;
      }
      <a href="#717045" title="DependencyGraph.this.Node">node</a>
    }

    /* Given the name of a phase object, get the node for that name. If the
     * node object does not exits, then create it.
     */
    <span class="keyword">def</span> <a title="(name: String)DependencyGraph.this.Node" id="716849">getNodeByPhase</a>(<a title="String" id="717049">name</a>: <span title="String">String</span>): <a href="#716843" title="DependencyGraph.this.Node">Node</a> = {
      <a href="#716844" title="=&gt; scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]">nodes</a>.<a title="(key: String)Option[DependencyGraph.this.Node]" id="44613">get</a>(<a href="#717049" title="String">name</a>).<a title="(default: =&gt; DependencyGraph.this.Node)DependencyGraph.this.Node" id="35236">getOrElse</a> {
        <span class="keyword">val</span> <a title="DependencyGraph.this.Node" id="717078">node</a> = <span title="DependencyGraph.this.Node" class="keyword">new</span> <a href="#716843" title="DependencyGraph.this.Node">Node</a>(<a href="#717049" title="String">name</a>)
        <a href="#716844" title="(kv: (String, DependencyGraph.this.Node))DependencyGraph.this.nodes.type" id="44623">nodes</a> += (<a href="#717049" title="(y: DependencyGraph.this.Node)(String, DependencyGraph.this.Node)" id="708">name</a> -&gt; <a href="#717078" title="DependencyGraph.this.Node">node</a>)
        <a href="#717078" title="DependencyGraph.this.Node">node</a>
      }
    }
    
    /* Connect the frm and to nodes with an edge and make it soft.
     * Also add the edge object to the set of edges, and to the dependency
     * list of the nodes
     */
    <span class="keyword">def</span> <a title="(frm: DependencyGraph.this.Node,to: DependencyGraph.this.Node)Unit" id="716850">softConnectNodes</a>(<a title="DependencyGraph.this.Node" id="717137">frm</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>, <a title="DependencyGraph.this.Node" id="717138">to</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>) {
      <span class="keyword">var</span> <a title="DependencyGraph.this.Edge" id="717140">e</a> = <span title="DependencyGraph.this.Edge" class="keyword">new</span> <a href="#716842" title="DependencyGraph.this.Edge">Edge</a>(<a href="#717137" title="DependencyGraph.this.Node">frm</a>, <a href="#717138" title="DependencyGraph.this.Node">to</a>, <span title="Boolean(false)" class="keyword">false</span>)
      <a href="#39446" title="DependencyGraph.this.type" class="keyword">this</a>.<a href="#716846" title="(elem: DependencyGraph.this.Edge)DependencyGraph.this.edges.type">edges</a> += <a href="#717140" title="DependencyGraph.this.Edge">e</a>
      
      <a href="#717137" title="DependencyGraph.this.Node">frm</a>.<a href="#716888" title="(elem: DependencyGraph.this.Edge)frm.after.type">after</a> += <a href="#717140" title="DependencyGraph.this.Edge">e</a>
      <a href="#717138" title="DependencyGraph.this.Node">to</a>.<a href="#716891" title="(elem: DependencyGraph.this.Edge)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a> <span title="Unit">+=</span> <a href="#717140" title="DependencyGraph.this.Edge">e</a>
    }
    
    /* Connect the frm and to nodes with an edge and make it hard.
     * Also add the edge object to the set of edges, and to the dependency
     * list of the nodes
     */
    <span class="keyword">def</span> <a title="(frm: DependencyGraph.this.Node,to: DependencyGraph.this.Node)Unit" id="716851">hardConnectNodes</a>(<a title="DependencyGraph.this.Node" id="717243">frm</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>, <a title="DependencyGraph.this.Node" id="717244">to</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>) {
      <span class="keyword">var</span> <a title="DependencyGraph.this.Edge" id="717246">e</a> = <span title="DependencyGraph.this.Edge" class="keyword">new</span> <a href="#716842" title="DependencyGraph.this.Edge">Edge</a>(<a href="#717243" title="DependencyGraph.this.Node">frm</a>, <a href="#717244" title="DependencyGraph.this.Node">to</a>, <span title="Boolean(true)" class="keyword">true</span>)
      <a href="#39446" title="DependencyGraph.this.type" class="keyword">this</a>.<a href="#716846" title="(elem: DependencyGraph.this.Edge)DependencyGraph.this.edges.type">edges</a> += <a href="#717246" title="DependencyGraph.this.Edge">e</a>
      
      <a href="#717243" title="DependencyGraph.this.Node">frm</a>.<a href="#716888" title="(elem: DependencyGraph.this.Edge)frm.after.type">after</a> += <a href="#717246" title="DependencyGraph.this.Edge">e</a>
      <a href="#717244" title="DependencyGraph.this.Node">to</a>.<a href="#716891" title="(elem: DependencyGraph.this.Edge)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a> <span title="Unit">+=</span> <a href="#717246" title="DependencyGraph.this.Edge">e</a>
    }

    /* Given the entire graph, collect the phase objects at each level, where the phase
     * names are sorted alphabetical at each level, into the compiler phase list
     */
    <span class="keyword">def</span> <a title="()List[scala.tools.nsc.SubComponent]" id="716852">compilerPhaseList</a>(): <span title="List[scala.tools.nsc.SubComponent]">List</span>[SubComponent] = {
      <span class="keyword">var</span> <a title="List[scala.tools.nsc.SubComponent]" id="717350">chain</a>: <span title="List[scala.tools.nsc.SubComponent]">List</span>[SubComponent] = <span title="object Nil">Nil</span>

      <span class="keyword">var</span> <a title="Int" id="717351">lvl</a> = <span title="Int(1)" class="int">1</span>
      <span class="keyword">var</span> <a title="List[DependencyGraph.this.Node]" id="717352">nds</a> = <a href="#716844" title="=&gt; scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]">nodes</a>.<span title="=&gt; Iterator[DependencyGraph.this.Node]">valuesIterator</span>.<span title="(p: (DependencyGraph.this.Node) =&gt; Boolean)Iterator[DependencyGraph.this.Node]">filter</span>(<a href="#717356" title="DependencyGraph.this.Node">_</a>.<a href="#716897" title="(x$1: Int)Boolean">level</a> == <a href="#717351" title="Int">lvl</a>).<span title="=&gt; List[DependencyGraph.this.Node]">toList</span>
      <span title="Unit" class="keyword">while</span>(<a href="#717352" title="List[DependencyGraph.this.Node]">nds</a>.<span title="(x$1: Int)Boolean">size</span> &gt; <span title="Int(0)" class="int">0</span>) <a href="#717353" title="()Unit">{</a>
	<a href="#717352" title="List[DependencyGraph.this.Node]">nds</a> = <a href="#717352" title="List[DependencyGraph.this.Node]">nds</a>.<span title="(lt: (DependencyGraph.this.Node, DependencyGraph.this.Node) =&gt; Boolean)List[DependencyGraph.this.Node]">sort</span>((<a title="DependencyGraph.this.Node" id="717375">n1</a>,<a title="DependencyGraph.this.Node" id="717376">n2</a>) =&gt; <span title="(x$1: Int)Boolean">(</span><a href="#717375" title="DependencyGraph.this.Node">n1</a>.<a href="#716883" title="(x$1: java.lang.String)Int">phasename</a> compareTo <a href="#717376" title="DependencyGraph.this.Node">n2</a>.<a href="#716883" title="=&gt; String">phasename</a>) &lt; <span title="Int(0)" class="int">0</span>)
	<span class="keyword">for</span> (<a title="DependencyGraph.this.Node" id="717405">n</a> &lt;- <a href="#717352" title="(f: (DependencyGraph.this.Node) =&gt; Unit)Unit">nds</a>) {
	  <a href="#717350" title="List[scala.tools.nsc.SubComponent]">chain</a> = <a href="#717350" title="List[scala.tools.nsc.SubComponent]">chain</a> <a href="#717406" title="List[scala.tools.nsc.SubComponent]">:::</a> <a href="#717405" title="DependencyGraph.this.Node">n</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a>.<a title="(prefix: List[scala.tools.nsc.SubComponent])List[scala.tools.nsc.SubComponent]" id="24420">get</a>
	}      
	<a href="#717351" title="Int">lvl</a> += <span title="Int(1)" class="int">1</span>
	<a href="#717352" title="List[DependencyGraph.this.Node]">nds</a> = <a href="#716844" title="=&gt; scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]">nodes</a>.<span title="=&gt; Iterator[DependencyGraph.this.Node]">valuesIterator</span>.<span title="(p: (DependencyGraph.this.Node) =&gt; Boolean)Iterator[DependencyGraph.this.Node]">filter</span>(<a href="#717461" title="DependencyGraph.this.Node">_</a>.<a href="#716897" title="(x$1: Int)Boolean">level</a> == <a href="#717351" title="Int">lvl</a>).<span title="=&gt; List[DependencyGraph.this.Node]">toList</span>
      }
      <a href="#717350" title="List[scala.tools.nsc.SubComponent]">chain</a>
    }

    /* Test if there are cycles in the graph, assign levels to the nodes
     * and collapse hard links into nodes
     */
    <span class="keyword">def</span> <a title="(node: DependencyGraph.this.Node,lvl: Int)Unit" id="716853">collapseHardLinksAndLevels</a>(<a title="DependencyGraph.this.Node" id="717473">node</a>: <a href="#716843" title="DependencyGraph.this.Node">Node</a>, <a title="Int" id="717474">lvl</a>: <a title="Int" id="2198">Int</a>) {
      <span title="Unit" class="keyword">if</span> (<a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716894" title="=&gt; Boolean">visited</a>) {
	<span title="Nothing" class="keyword">throw</span> <span title="scala.tools.nsc.FatalError" class="keyword">new</span> <a href="FatalError.scala.html#8289" title="scala.tools.nsc.FatalError">FatalError</a>(
          <span title="(x$1: Any)java.lang.String" class="string">&quot;Cycle in compiler phase dependencies detected, phase &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
          <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716883" title="=&gt; String">phasename</a> + <span title="java.lang.String(&quot; reacted twice!&quot;)" class="string">&quot; reacted twice!&quot;</span>)
      }

      <span title="Unit" class="keyword">if</span> (<a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716897" title="(x$1: Int)Boolean">level</a> &lt; <a href="#717474" title="Int">lvl</a>) <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716897" title="(x$1: Int)Unit">level</a> = <a href="#717474" title="Int">lvl</a>
      
      <span class="keyword">var</span> <a title="List[DependencyGraph.this.Edge]" id="717476">hls</a> = <span title="(that: Traversable[DependencyGraph.this.Edge])(implicit bf: scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List[Nothing]])List[DependencyGraph.this.Edge]">Nil</span> <span title="scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List#Coll]">++</span> <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a href="#717558" title="DependencyGraph.this.Edge">_</a>.<a href="#716905" title="=&gt; Boolean">hard</a>)
      <span title="Unit" class="keyword">while</span> (<a href="#717476" title="List[DependencyGraph.this.Edge]">hls</a>.<span title="(x$1: Int)Boolean">size</span> &gt; <span title="Int(0)" class="int">0</span>) <a href="#717477" title="()Unit">{</a>
	<span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="717697">hl</a> &lt;- <a href="#717476" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">hls</a>) {
	  <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716886" title="(x$1: Option[List[scala.tools.nsc.SubComponent]])Unit">phaseobj</a> = <span title="(x: List[scala.tools.nsc.SubComponent])Some[List[scala.tools.nsc.SubComponent]]">Some</span>(<a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a>.<span title="(that: Traversable[scala.tools.nsc.SubComponent])(implicit bf: scala.collection.generic.BuilderFactory[scala.tools.nsc.SubComponent,List[scala.tools.nsc.SubComponent],List[scala.tools.nsc.SubComponent]])List[scala.tools.nsc.SubComponent]">get</span> <span title="scala.collection.generic.BuilderFactory[scala.tools.nsc.SubComponent,List[scala.tools.nsc.SubComponent],List#Coll]">++</span> <a href="#717697" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a>.<span title="=&gt; List[scala.tools.nsc.SubComponent]">get</span>)
	  <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="(x$1: scala.collection.mutable.HashSet[DependencyGraph.this.Edge])Unit">before</a> = <a href="#717697" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>
	  <a href="#716844" title="(key: String)DependencyGraph.this.nodes.type">nodes</a> -= <a href="#717697" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a>
	  <a href="#716846" title="(elem: DependencyGraph.this.Edge)DependencyGraph.this.edges.type">edges</a> -= <a href="#717697" title="DependencyGraph.this.Edge">hl</a>
	  <span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="717911">edge</a> &lt;- <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">before</a>) <a href="#717911" title="DependencyGraph.this.Edge">edge</a>.<a href="#716904" title="(x$1: DependencyGraph.this.Node)Unit">to</a> = <a href="#717473" title="DependencyGraph.this.Node">node</a>
	}
	<a href="#717476" title="List[DependencyGraph.this.Edge]">hls</a> = <span title="(that: Traversable[DependencyGraph.this.Edge])(implicit bf: scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List[Nothing]])List[DependencyGraph.this.Edge]">Nil</span> <span title="scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List#Coll]">++</span> <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a href="#717986" title="DependencyGraph.this.Edge">_</a>.<a href="#716905" title="=&gt; Boolean">hard</a>)
      }
      <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716894" title="(x$1: Boolean)Unit">visited</a> = <span title="Boolean(true)" class="keyword">true</span>
      
      <span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718066">edge</a> &lt;- <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">before</a>) {
	<a href="#716853" title="(node: DependencyGraph.this.Node,lvl: Int)Unit">collapseHardLinksAndLevels</a>( <a href="#718066" title="DependencyGraph.this.Edge">edge</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>, <a href="#717474" title="(x$1: Int)Int">lvl</a> + <span title="Int(1)" class="int">1</span>)
      }

      <a href="#717473" title="DependencyGraph.this.Node">node</a>.<a href="#716894" title="(x$1: Boolean)Unit">visited</a> = <span title="Boolean(false)" class="keyword">false</span>
    }

    /* Find all edges in the given graph that are hard links. For each hard link we
     * need to check that its the only dependency. If not, then we will promote the
     * other dependencies down
     */
    <span class="keyword">def</span> <a title="()Unit" id="716854">validateAndEnforceHardlinks</a>() {
      <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" id="718097">hardlinks</a> = <a href="#716846" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">edges</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a href="#718101" title="DependencyGraph.this.Edge">_</a>.<a href="#716905" title="=&gt; Boolean">hard</a>)
      <span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718121">hl</a> &lt;- <a href="#718097" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">hardlinks</a>) {
	<span title="Unit" class="keyword">if</span> (<a href="#718121" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716888" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">after</a>.<a title="(x$1: Int)Boolean" id="39517">size</a> &gt; <span title="Int(1)" class="int">1</span>) {
	  <span title="Nothing" class="keyword">throw</span> <span title="scala.tools.nsc.FatalError" class="keyword">new</span> <a href="FatalError.scala.html#8289" title="scala.tools.nsc.FatalError">FatalError</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;phase &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718121" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; want to run right after &quot;)" class="string">&quot; want to run right after &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718121" title="DependencyGraph.this.Edge">hl</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;, but some phase has declared to run before &quot;)" class="string">&quot;, but some phase has declared to run before &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718121" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a> + <span title="java.lang.String(&quot;. Re-run with -Xgenerate-phase-graph &lt;filename&gt; to better see the problem.&quot;)" class="string">&quot;. Re-run with -Xgenerate-phase-graph &lt;filename&gt; to better see the problem.&quot;</span>)
	}
      }

      <span class="keyword">var</span> <a title="Boolean" id="718098">rerun</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span title="Unit" class="keyword">while</span> (<a href="#718098" title="Boolean">rerun</a>) <a href="#718146" title="()Unit">{</a>
	<a href="#718098" title="Boolean">rerun</a> = <span title="Boolean(false)" class="keyword">false</span>
	<a href="#718097" title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">hardlinks</a> = <a href="#716846" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">edges</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a href="#718149" title="DependencyGraph.this.Edge">_</a>.<a href="#716905" title="=&gt; Boolean">hard</a>)
	<span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718169">hl</a> &lt;- <a href="#718097" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">hardlinks</a>) {
	  <span class="keyword">var</span> <a title="List[DependencyGraph.this.Edge]" id="718170">sanity</a> = <span title="(that: Traversable[DependencyGraph.this.Edge])(implicit bf: scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List[Nothing]])List[DependencyGraph.this.Edge]">Nil</span> <span title="scala.collection.generic.BuilderFactory[DependencyGraph.this.Edge,List[DependencyGraph.this.Edge],List#Coll]">++</span> <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a href="#718237" title="DependencyGraph.this.Edge">_</a>.<a href="#716905" title="=&gt; Boolean">hard</a>)
	  <span title="Unit" class="keyword">if</span> (<a href="#718170" title="List[DependencyGraph.this.Edge]">sanity</a>.<span title="(x$1: Int)Boolean">length</span> == <span title="Int(0)" class="int">0</span>) {
	    <span title="Nothing" class="keyword">throw</span> <span title="scala.tools.nsc.FatalError" class="keyword">new</span> <a href="FatalError.scala.html#8289" title="scala.tools.nsc.FatalError">FatalError</a>(<span title="java.lang.String(&quot;There is no runs right after dependency, where there should be one! This is not supposed to happen!&quot;)" class="string">&quot;There is no runs right after dependency, where there should be one! This is not supposed to happen!&quot;</span>)
	  } <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> (<a href="#718170" title="List[DependencyGraph.this.Edge]">sanity</a>.<span title="(x$1: Int)Boolean">length</span> &gt; <span title="Int(1)" class="int">1</span>) {
	    <span class="keyword">var</span> <a title="java.lang.String" id="718369">msg</a> = <span title="(x$1: Any)java.lang.String" class="string">&quot;Multiple phases want to run right after the phase &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718170" title="List[DependencyGraph.this.Edge]">sanity</a>.<span title="=&gt; DependencyGraph.this.Edge">head</span>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716883" title="=&gt; String">phasename</a> + <span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span>
	    <a href="#718369" title="java.lang.String">msg</a> += <span title="java.lang.String(&quot;Phases: &quot;)" class="string">&quot;Phases: &quot;</span>
	    <a href="#718170" title="List[DependencyGraph.this.Edge]">sanity</a> = <a href="#718170" title="List[DependencyGraph.this.Edge]">sanity</a>.<span title="(lt: (DependencyGraph.this.Edge, DependencyGraph.this.Edge) =&gt; Boolean)List[DependencyGraph.this.Edge]">sort</span>((<a title="DependencyGraph.this.Edge" id="718391">e1</a>,<a title="DependencyGraph.this.Edge" id="718392">e2</a>) =&gt; <span title="(x$1: Int)Boolean">(</span><a href="#718391" title="DependencyGraph.this.Edge">e1</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="(x$1: java.lang.String)Int">phasename</a> compareTo <a href="#718392" title="DependencyGraph.this.Edge">e2</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a>) &lt; <span title="Int(0)" class="int">0</span>)
	    <span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718422">edge</a> &lt;- <a href="#718170" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">sanity</a>) {
	      <a href="#718369" title="java.lang.String">msg</a> += <a href="#718422" title="DependencyGraph.this.Edge">edge</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="(x$1: Any)java.lang.String">phasename</a> + <span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span>
	    }
	    <a href="#718369" title="java.lang.String">msg</a> += <span title="java.lang.String(&quot;\012Re-run with -Xgenerate-phase-graph &lt;filename&gt; to better see the problem.&quot;)" class="string">&quot;\nRe-run with -Xgenerate-phase-graph &lt;filename&gt; to better see the problem.&quot;</span>
	    <span title="Nothing" class="keyword">throw</span> <span title="scala.tools.nsc.FatalError" class="keyword">new</span> <a href="FatalError.scala.html#8289" title="scala.tools.nsc.FatalError">FatalError</a>(<a href="#718369" title="java.lang.String">msg</a>)
	    
	  } <span class="keyword">else</span> {
	    
	    <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[DependencyGraph.this.Edge]" id="718458">promote</a> = <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>.<span title="(p: (DependencyGraph.this.Edge) =&gt; Boolean)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">filter</span>(<a title="DependencyGraph.this.Edge" id="718461">e</a> =&gt; (<span title="=&gt; Boolean">!</span><a href="#718461" title="DependencyGraph.this.Edge">e</a>.<a href="#716905" title="=&gt; Boolean">hard</a>))
	    <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716891" title="=&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a>.<a title="()Unit" id="39528">clear</a>
	    <a href="#718170" title="(f: (DependencyGraph.this.Edge) =&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge])Unit">sanity</a> foreach (<a title="DependencyGraph.this.Edge" id="718484">edge</a> =&gt; <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716891" title="(elem: DependencyGraph.this.Edge)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a> += <a href="#718484" title="DependencyGraph.this.Edge">edge</a>)
	    <span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718543">edge</a> &lt;- <a href="#718458" title="(f: (DependencyGraph.this.Edge) =&gt; scala.collection.mutable.HashSet[DependencyGraph.this.Edge])Unit">promote</a>) {
	      <a href="#718098" title="Boolean">rerun</a> = <span title="Boolean(true)" class="keyword">true</span>
	      <a href="Global.scala.html#39298" title="(msg: String)Unit">informProgress</a>(
                <span title="(x$1: Any)java.lang.String" class="string">&quot;promote the dependency of &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718543" title="DependencyGraph.this.Edge">edge</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span>
                <span title="java.lang.String(&quot;: &quot;)" class="string">&quot;: &quot;</span>  <span title="(x$1: Any)java.lang.String">+</span> <a href="#718543" title="DependencyGraph.this.Edge">edge</a>.<a href="#716904" title="=&gt; DependencyGraph.this.Node">to</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; =&gt; &quot;)" class="string">&quot; =&gt; &quot;</span> + <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716883" title="=&gt; String">phasename</a>)
	      <a href="#718543" title="DependencyGraph.this.Edge">edge</a>.<a href="#716904" title="(x$1: DependencyGraph.this.Node)Unit">to</a> = <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>
	      <a href="#718169" title="DependencyGraph.this.Edge">hl</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716891" title="(elem: DependencyGraph.this.Edge)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">before</a> += <a href="#718543" title="DependencyGraph.this.Edge">edge</a>
	    }
	  }
	}
      }
    }

    /** Remove all nodes in the given graph, that have no phase object
     *  Make sure to clean up all edges when removing the node object
     *  &lt;code&gt;Inform&lt;/code&gt; with warnings, if an external phase has a
     *  dependency on something that is dropped.
     */
    <span class="keyword">def</span> <a title="()Unit" id="716855">removeDanglingNodes</a>() {
      <span class="keyword">var</span> <a title="Iterator[DependencyGraph.this.Node]" id="718605">dnodes</a> = <a href="#716844" title="=&gt; scala.collection.mutable.HashMap[String,DependencyGraph.this.Node]">nodes</a>.<span title="(p: (DependencyGraph.this.Node) =&gt; Boolean)Iterator[DependencyGraph.this.Node]">valuesIterator</span> filter (<a href="#718608" title="DependencyGraph.this.Node">_</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a>.<a title="=&gt; Boolean" id="35230">isEmpty</a>)
      <span class="keyword">for</span> (<a title="DependencyGraph.this.Node" id="718615">node</a> &lt;- <a href="#718605" title="(f: (DependencyGraph.this.Node) =&gt; Unit)Unit" id="32359">dnodes</a>) {
	<span class="keyword">val</span> <a title="java.lang.String" id="718616">msg</a> = <span title="(x$1: Any)java.lang.String" class="string">&quot;dropping dependency on node with no phase object: &quot;</span>+<a href="#718615" title="DependencyGraph.this.Node">node</a>.<a href="#716883" title="=&gt; String">phasename</a>
        <a href="Global.scala.html#39298" title="(msg: String)Unit">informProgress</a>(<a href="#718616" title="java.lang.String">msg</a>)
	<a href="#716844" title="(key: String)DependencyGraph.this.nodes.type">nodes</a> -= <a href="#718615" title="DependencyGraph.this.Node">node</a>.<a href="#716883" title="=&gt; String">phasename</a>
	<span class="keyword">for</span> (<a title="DependencyGraph.this.Edge" id="718663">edge</a> &lt;- <a href="#718615" title="DependencyGraph.this.Node">node</a>.<a href="#716891" title="(f: (DependencyGraph.this.Edge) =&gt; Unit)Unit">before</a>) {
	  <a href="#716846" title="(elem: DependencyGraph.this.Edge)DependencyGraph.this.edges.type">edges</a> -= <a href="#718663" title="DependencyGraph.this.Edge">edge</a>
	  <a href="#718663" title="DependencyGraph.this.Edge">edge</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716888" title="(elem: DependencyGraph.this.Edge)scala.collection.mutable.HashSet[DependencyGraph.this.Edge]">after</a> -= <a href="#718663" title="DependencyGraph.this.Edge">edge</a>
	  <a href="#718663" title="DependencyGraph.this.Edge">edge</a>.<a href="#716903" title="=&gt; DependencyGraph.this.Node">frm</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a> <span title="Unit" class="keyword">match</span> {
	    <span title="Unit" class="keyword">case</span> Some(<a title="List[scala.tools.nsc.SubComponent]" id="718722">lsc</a>) =&gt; <span title="Unit" class="keyword">if</span> (<span title="=&gt; Boolean">!</span> <a href="#718722" title="List[scala.tools.nsc.SubComponent]">lsc</a>.<span title="=&gt; scala.tools.nsc.SubComponent">head</span>.<a href="SubComponent.scala.html#39859" title="=&gt; Boolean">internal</a>) <a href="Global.scala.html#39293" title="(msg: String)Unit">warning</a>(<a href="#718616" title="java.lang.String">msg</a>)
	    <span title="Unit" class="keyword">case</span> _ =&gt; 
	  }
	}
      }
    }
    
  }

  /* Method called from computePhaseDescriptors in class Global
   */
  <span class="keyword">def</span> <a title="()List[scala.tools.nsc.SubComponent]" id="39447">buildCompilerFromPhasesSet</a>(): <span title="List[scala.tools.nsc.SubComponent]">List</span>[SubComponent] = {

    // Add all phases in the set to the graph  
    <span class="keyword">val</span> <a title="PhaseAssembly.this.DependencyGraph" id="718733">graph</a> = <a href="#39448" title="(phsSet: scala.collection.mutable.HashSet[scala.tools.nsc.SubComponent])PhaseAssembly.this.DependencyGraph">phasesSetToDepGraph</a>(<a href="Global.scala.html#39398" title="=&gt; scala.collection.mutable.HashSet[scala.tools.nsc.SubComponent]">phasesSet</a>)

    // Output the phase dependency graph at this stage
    <span title="Unit" class="keyword">if</span> (<a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: AnyRef)Boolean">value</a> != <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>)
      <a href="#39449" title="(graph: PhaseAssembly.this.DependencyGraph,filename: String)Unit">graphToDotFile</a>(<a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>, <a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: Any)java.lang.String">value</a> + <span title="java.lang.String(&quot;1.dot&quot;)" class="string">&quot;1.dot&quot;</span>)

    // Remove nodes without phaseobj
    <a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716855" title="()Unit">removeDanglingNodes</a>() 

    // Output the phase dependency graph at this stage
    <span title="Unit" class="keyword">if</span> (<a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: AnyRef)Boolean">value</a> != <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>)
      <a href="#39449" title="(graph: PhaseAssembly.this.DependencyGraph,filename: String)Unit">graphToDotFile</a>(<a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>, <a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: Any)java.lang.String">value</a> + <span title="java.lang.String(&quot;2.dot&quot;)" class="string">&quot;2.dot&quot;</span>)

    // Validate and Enforce hardlinks / runsRightAfter and promote nodes down the tree    
    <a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716854" title="()Unit">validateAndEnforceHardlinks</a>()

    // Output the phase dependency graph at this stage
    <span title="Unit" class="keyword">if</span> (<a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: AnyRef)Boolean">value</a> != <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>)
      <a href="#39449" title="(graph: PhaseAssembly.this.DependencyGraph,filename: String)Unit">graphToDotFile</a>(<a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>, <a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: Any)java.lang.String">value</a> + <span title="java.lang.String(&quot;3.dot&quot;)" class="string">&quot;3.dot&quot;</span>)

    // test for cycles, assign levels and collapse hard links into nodes
    <a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716853" title="(node: graph.Node,lvl: Int)Unit">collapseHardLinksAndLevels</a>(<a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716849" title="(name: String)graph.Node">getNodeByPhase</a>(<span title="java.lang.String(&quot;parser&quot;)" class="string">&quot;parser&quot;</span>), <span title="Int(1)" class="int">1</span>)

    // Output the phase dependency graph at this stage
    <span title="Unit" class="keyword">if</span> (<a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: AnyRef)Boolean">value</a> != <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>)
      <a href="#39449" title="(graph: PhaseAssembly.this.DependencyGraph,filename: String)Unit">graphToDotFile</a>(<a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>, <a href="Global.scala.html#39250" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="Settings.scala.html#37287" title="=&gt; scala.tools.nsc.Settings.StringSetting">genPhaseGraph</a>.<a href="Settings.scala.html#37988" title="(x$1: Any)java.lang.String">value</a> + <span title="java.lang.String(&quot;4.dot&quot;)" class="string">&quot;4.dot&quot;</span>)
    
    // assemble the compiler
    <a href="#718733" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716852" title="()List[scala.tools.nsc.SubComponent]">compilerPhaseList</a>()
  }

  /** Given the phases set, will build a dependency graph from the phases set
   *  Using the aux. method of the DependencyGraph to create nodes and egdes.
   */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(phsSet: scala.collection.mutable.HashSet[scala.tools.nsc.SubComponent])PhaseAssembly.this.DependencyGraph" id="39448">phasesSetToDepGraph</a>(<a title="scala.collection.mutable.HashSet[scala.tools.nsc.SubComponent]" id="718734">phsSet</a>: <span title="scala.collection.mutable.HashSet[scala.tools.nsc.SubComponent]">HashSet</span>[SubComponent]): <a href="#39446" title="PhaseAssembly.this.DependencyGraph">DependencyGraph</a> = {
    <span class="keyword">val</span> <a title="PhaseAssembly.this.DependencyGraph" id="718817">graph</a> = <span title="PhaseAssembly.this.DependencyGraph" class="keyword">new</span> <a href="#39446" title="PhaseAssembly.this.DependencyGraph">DependencyGraph</a>()

    <span class="keyword">for</span> (<a title="scala.tools.nsc.SubComponent" id="718836">phs</a> &lt;- <a href="#718734" title="(f: (scala.tools.nsc.SubComponent) =&gt; Unit)Unit">phsSet</a>) {
      
      <span class="keyword">var</span> <a title="graph.Node" id="718837">fromnode</a> = <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716848" title="(phs: scala.tools.nsc.SubComponent)graph.Node">getNodeByPhase</a>(<a href="#718836" title="scala.tools.nsc.SubComponent">phs</a>)
      
      <a href="#718836" title="scala.tools.nsc.SubComponent">phs</a>.<a href="SubComponent.scala.html#39858" title="=&gt; Option[String]">runsRightAfter</a> <span title="Unit" class="keyword">match</span> {
	<span title="Unit" class="keyword">case</span> <span title="object None">None</span> =&gt;
	  <span class="keyword">for</span> (<a title="String" id="718860">phsname</a> &lt;- <a href="#718836" title="scala.tools.nsc.SubComponent">phs</a>.<a href="SubComponent.scala.html#39855" title="(f: (String) =&gt; Unit)Unit">runsAfter</a>) {
	    <span title="Unit" class="keyword">if</span> (<a href="#718860" title="(x$1: AnyRef)Boolean">phsname</a> != <span title="java.lang.String(&quot;terminal&quot;)" class="string">&quot;terminal&quot;</span>) {
	      <span class="keyword">val</span> <a title="graph.Node" id="718867">tonode</a> = <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716849" title="(name: String)graph.Node">getNodeByPhase</a>(<a href="#718860" title="String">phsname</a>)
	      <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716850" title="(frm: graph.Node,to: graph.Node)Unit">softConnectNodes</a>(<a href="#718837" title="graph.Node">fromnode</a>, <a href="#718867" title="graph.Node">tonode</a>)
	    } <span class="keyword">else</span> {
	      <a href="Global.scala.html#39292" title="(msg: String)Unit">error</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[phase assembly, after dependency on terminal phase not allowed: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718837" title="graph.Node">fromnode</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; =&gt; &quot;)" class="string">&quot; =&gt; &quot;</span><span title="(x$1: Any)java.lang.String">+</span> <a href="#718860" title="String">phsname</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)	    
	    }
	  }
	  <span class="keyword">for</span> (<a title="String" id="718907">phsname</a> &lt;- <a href="#718836" title="scala.tools.nsc.SubComponent">phs</a>.<a href="SubComponent.scala.html#39856" title="(f: (String) =&gt; Unit)Unit">runsBefore</a>) {
	    <span title="Unit" class="keyword">if</span> (<a href="#718907" title="(x$1: AnyRef)Boolean">phsname</a> != <span title="java.lang.String(&quot;parser&quot;)" class="string">&quot;parser&quot;</span>) {
	      <span class="keyword">val</span> <a title="graph.Node" id="718914">tonode</a> = <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716849" title="(name: String)graph.Node">getNodeByPhase</a>(<a href="#718907" title="String">phsname</a>)
	      <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716850" title="(frm: graph.Node,to: graph.Node)Unit">softConnectNodes</a>(<a href="#718914" title="graph.Node">tonode</a>, <a href="#718837" title="graph.Node">fromnode</a>)
	    } <span class="keyword">else</span> {
	      <a href="Global.scala.html#39292" title="(msg: String)Unit">error</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[phase assembly, before dependency on parser phase not allowed: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718907" title="String">phsname</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; =&gt; &quot;)" class="string">&quot; =&gt; &quot;</span><span title="(x$1: Any)java.lang.String">+</span> <a href="#718837" title="graph.Node">fromnode</a>.<a href="#716883" title="=&gt; String">phasename</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)	    
	    }
	  }
	<span title="Unit" class="keyword">case</span> Some(<a title="String" id="718939">phsname</a>) =&gt;
	  <span title="Unit" class="keyword">if</span> (<a href="#718939" title="(x$1: AnyRef)Boolean">phsname</a> != <span title="java.lang.String(&quot;terminal&quot;)" class="string">&quot;terminal&quot;</span>) {
	    <span class="keyword">val</span> <a title="graph.Node" id="718948">tonode</a> = <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716849" title="(name: String)graph.Node">getNodeByPhase</a>(<a href="#718939" title="String">phsname</a>)
            <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716851" title="(frm: graph.Node,to: graph.Node)Unit">hardConnectNodes</a>(<a href="#718837" title="graph.Node">fromnode</a>, <a href="#718948" title="graph.Node">tonode</a>)
	  } <span class="keyword">else</span> {
	    <a href="Global.scala.html#39292" title="(msg: String)Unit">error</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;[phase assembly, right after dependency on terminal phase not allowed: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#718837" title="graph.Node">fromnode</a>.<a href="#716883" title="=&gt; String">phasename</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; =&gt; &quot;)" class="string">&quot; =&gt; &quot;</span><span title="(x$1: Any)java.lang.String">+</span> <a href="#718939" title="String">phsname</a> + <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span>)
	  }
      }
    }
    <a href="#718817" title="PhaseAssembly.this.DependencyGraph">graph</a>
  }

  /* This is a helper method, that given a dependency graph will generate a graphviz dot
   * file showing its structure.
   * Plug-in supplied phases are marked as green nodes and hard links are marked as blue edges.
   */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(graph: PhaseAssembly.this.DependencyGraph,filename: String)Unit" id="39449">graphToDotFile</a>(<a title="PhaseAssembly.this.DependencyGraph" id="718747">graph</a>: <a href="#39446" title="PhaseAssembly.this.DependencyGraph">DependencyGraph</a>, <a title="String" id="718748">filename</a>: <span title="String">String</span>) {
    <span class="keyword">var</span> <a title="StringBuilder" id="718972">sbuf</a> = <a title="()StringBuilder" id="57658" class="keyword">new</a> <a title="StringBuilder" id="375">StringBuilder</a>
    <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[graph.Node]" id="718973">extnodes</a> = <span title="scala.collection.mutable.HashSet[graph.Node]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[graph.Node]">HashSet</span>[graph.Node]()
    <span class="keyword">var</span> <a title="scala.collection.mutable.HashSet[graph.Node]" id="718974">fatnodes</a> = <span title="scala.collection.mutable.HashSet[graph.Node]" class="keyword">new</span> <span title="scala.collection.mutable.HashSet[graph.Node]">HashSet</span>[graph.Node]()
    <a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="java.lang.String(&quot;digraph G {\012&quot;)" class="string">&quot;digraph G {\n&quot;</span>)
    <span class="keyword">for</span> (<a title="graph.Edge" id="719014">edge</a> &lt;- <a href="#718747" title="PhaseAssembly.this.DependencyGraph">graph</a>.<a href="#716846" title="(f: (graph.Edge) =&gt; StringBuilder)Unit">edges</a>) {
      <a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;\&quot;&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a>.<a href="#716899" title="()String">allPhaseNames</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;(&quot;)" class="string">&quot;(&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a>.<a href="#716897" title="=&gt; Int">level</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;&quot;-&gt;&quot;&quot;)" class="string">&quot;\&quot;-&gt;\&quot;&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719014" title="graph.Edge">edge</a>.<a href="#716904" title="=&gt; graph.Node">to</a>.<a href="#716899" title="()String">allPhaseNames</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;(&quot;)" class="string">&quot;(&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719014" title="graph.Edge">edge</a>.<a href="#716904" title="=&gt; graph.Node">to</a>.<a href="#716897" title="=&gt; Int">level</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span> + <span title="java.lang.String(&quot;&quot;&quot;)" class="string">&quot;\&quot;&quot;</span>)
      <span title="Any" class="keyword">if</span> (<span title="=&gt; Boolean">!</span> <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a>.<span title="=&gt; List[scala.tools.nsc.SubComponent]">get</span>.<span title="=&gt; scala.tools.nsc.SubComponent">head</span>.<a href="SubComponent.scala.html#39859" title="=&gt; Boolean">internal</a>) {
       	<a href="#718973" title="(elem: graph.Node)scala.collection.mutable.HashSet[graph.Node]">extnodes</a> += <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a>
      }
      <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a> <span title="Any" class="keyword">match</span> { <span title="Null(null)" class="keyword">case</span> <span title="object None">None</span> =&gt; <span title="Null(null)" class="keyword">null</span> <span title="Any" class="keyword">case</span> Some(<a title="List[scala.tools.nsc.SubComponent]" id="719099">ln</a>) =&gt; <span title="Any" class="keyword">if</span>(<a href="#719099" title="List[scala.tools.nsc.SubComponent]">ln</a>.<span title="(x$1: Int)Boolean">size</span> &gt; <span title="Int(1)" class="int">1</span>) <a href="#718974" title="(elem: graph.Node)scala.collection.mutable.HashSet[graph.Node]">fatnodes</a> += <a href="#719014" title="graph.Edge">edge</a>.<a href="#716903" title="=&gt; graph.Node">frm</a> }
      <a href="#719014" title="graph.Edge">edge</a>.<a href="#716904" title="=&gt; graph.Node">to</a>.<a href="#716886" title="=&gt; Option[List[scala.tools.nsc.SubComponent]]">phaseobj</a> <span title="Any" class="keyword">match</span> { <span title="Null(null)" class="keyword">case</span> <span title="object None">None</span> =&gt; <span title="Null(null)" class="keyword">null</span> <span title="Any" class="keyword">case</span> Some(<a title="List[scala.tools.nsc.SubComponent]" id="719153">ln</a>) =&gt; <span title="Any" class="keyword">if</span>(<a href="#719153" title="List[scala.tools.nsc.SubComponent]">ln</a>.<span title="(x$1: Int)Boolean">size</span> &gt; <span title="Int(1)" class="int">1</span>) <a href="#718974" title="(elem: graph.Node)scala.collection.mutable.HashSet[graph.Node]">fatnodes</a> += <a href="#719014" title="graph.Edge">edge</a>.<a href="#716904" title="=&gt; graph.Node">to</a> }
      <span title="StringBuilder" class="keyword">if</span> (<a href="#719014" title="graph.Edge">edge</a>.<a href="#716905" title="=&gt; Boolean">hard</a>) {
	<a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="java.lang.String(&quot; [color=&quot;#0000ff&quot;]\012&quot;)" class="string">&quot; [color=\&quot;#0000ff\&quot;]\n&quot;</span>)
      } <span class="keyword">else</span> {
	<a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="java.lang.String(&quot; [color=&quot;#000000&quot;]\012&quot;)" class="string">&quot; [color=\&quot;#000000\&quot;]\n&quot;</span>)
      }
    }
    <span class="keyword">for</span> (<a title="graph.Node" id="719238">node</a> &lt;- <a href="#718973" title="(f: (graph.Node) =&gt; StringBuilder)Unit">extnodes</a>) {
      <a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;\&quot;&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719238" title="graph.Node">node</a>.<a href="#716899" title="()String">allPhaseNames</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;(&quot;)" class="string">&quot;(&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719238" title="graph.Node">node</a>.<a href="#716897" title="=&gt; Int">level</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span> + <span title="java.lang.String(&quot;&quot; [color=&quot;#00ff00&quot;]\012&quot;)" class="string">&quot;\&quot; [color=\&quot;#00ff00\&quot;]\n&quot;</span>)
    }
    <span class="keyword">for</span> (<a title="graph.Node" id="719277">node</a> &lt;- <a href="#718974" title="(f: (graph.Node) =&gt; StringBuilder)Unit">fatnodes</a>) {
      <a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;\&quot;&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719277" title="graph.Node">node</a>.<a href="#716899" title="()String">allPhaseNames</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;(&quot;)" class="string">&quot;(&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#719277" title="graph.Node">node</a>.<a href="#716897" title="=&gt; Int">level</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span> + <span title="java.lang.String(&quot;&quot; [color=&quot;#0000ff&quot;]\012&quot;)" class="string">&quot;\&quot; [color=\&quot;#0000ff\&quot;]\n&quot;</span>)
    }
    <a href="#718972" title="StringBuilder">sbuf</a>.<span title="(s: String)StringBuilder">append</span>(<span title="java.lang.String(&quot;}\012&quot;)" class="string">&quot;}\n&quot;</span>)
    <span class="keyword">var</span> <a title="java.io.BufferedWriter" id="718975">out</a> = <span title="java.io.BufferedWriter" class="keyword">new</span> <a title="java.io.BufferedWriter" id="3978">BufferedWriter</a>(<span title="java.io.FileWriter" class="keyword">new</span> <a title="java.io.FileWriter" id="3774">FileWriter</a>(<a href="#718748" title="String">filename</a>))
    <a href="#718975" title="java.io.BufferedWriter">out</a>.<a title="(x$1: java.lang.String)Unit" id="41489">write</a>(<a href="#718972" title="StringBuilder">sbuf</a>.<a title="()String" id="57807">toString</a>)
    <a href="#718975" title="java.io.BufferedWriter">out</a>.<a title="()Unit" id="707030">flush</a>()
    <a href="#718975" title="java.io.BufferedWriter">out</a>.<a title="()Unit" id="707031">close</a>()
  }

}

        </pre>
    </body>
</html>