<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/util/NewCharArrayReader.scala</title>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */</span>
<span class="comment">// $Id: NewCharArrayReader.scala 16893 2009-01-13 13:09:22Z cunei $</span>

<span class="keyword">package</span> scala.tools.nsc.util

<span class="keyword">import</span> scala.tools.nsc.util.SourceFile.{LF, FF, CR, SU}

<span class="keyword">class</span> <span class="typed"><span class="type">class NewCharArrayReader extends java.lang.Object with Iterator[Char] with ScalaObject</span><a id="8474">NewCharArrayReader</a></span>(<span class="keyword">val</span> <span class="typed"><span class="type">RandomAccessSeq[Char]</span><span id="39008"><span id="39007"><a id="40550">buf</a></span></span></span>: <span class="typed"><span class="type">RandomAccessSeq[Char]</span><a id="667">RandomAccessSeq</a></span>[Char], <span class="comment">// should not change </span>
                       <span class="typed"><span class="type">Boolean</span><span id="39009"><a id="40551">decodeUni</a></span></span>: <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span>, <span class="typed"><span class="type">(Int, String) =&gt; Unit</span><span id="39010"><a id="40552">error</a></span></span>: (Int,String) =&gt; Unit) <span class="keyword">extends</span> <span class="typed"><span class="type">Iterator[Char]</span><a id="1339">Iterator</a></span>[Char] {
  <span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><span id="39014"><span id="39012"><span id="39013"><a id="113418">idx</a></span></span></span></span> : <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>
  <span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">Boolean</span><span id="39017"><span id="39015"><span id="39016"><a id="113419">isUnicode0</a></span></span></span></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Boolean</span><a id="39018">isUnicode</a></span> = <span class="typed"><span class="type">=&gt; Boolean</span><a href="#39015">isUnicode0</a></span>
  
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><span id="39020"><a id="39019">bufLength</a></span></span> = <span class="typed"><span class="type">=&gt; RandomAccessSeq[Char]</span><a href="#39007">buf</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a id="21642">length</a></span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(Int)Unit</span><a id="39021">seek</a></span>(<span class="typed"><span class="type">Int</span><a id="39030">offset</a></span> : <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>) = {
    <span class="typed"><span class="type">(Boolean)Unit</span><span id="6003"><a id="821">assert</a></span></span>(<span class="typed"><span class="type">Int</span><a href="#39030">offset</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3144">&lt;=</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39019">bufLength</a></span>)
    <span class="typed"><span class="type">(Int)Unit</span><a href="#39013">idx</a></span> = <span class="typed"><span class="type">Int</span><a href="#39030">offset</a></span>
  }
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Int</span><a id="39022">offset</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.Object with Iterator[(Int, Char)]</span><a id="39023">withOffset</a></span> = <span class="typed"><span class="type">template $anon extends java.lang.Object with Iterator[(Int, Char)]</span><a id="113422" class="keyword">new</a></span> <span class="typed"><span class="type">Iterator[(Int, Char)]</span><a id="1339">Iterator</a></span>[(Int,Char)] {
    <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Boolean</span><a id="113424">hasNext</a></span> = <span class="typed"><span class="type">NewCharArrayReader.this.type</span><a href="#8474">NewCharArrayReader</a></span>.<span class="keyword">this</span>.<span class="typed"><span class="type">=&gt; Boolean</span><a href="#39024">hasNext</a></span>
    <span class="keyword">def</span> <span class="typed"><span class="type">()(Int, Char)</span><a id="113425">next</a></span> = <span class="typed"><span class="type">(Int,Char)(Int, Char)</span><span id="23625"><a id="1379">(</a></span></span><span class="typed"><span class="type">=&gt; Int</span><a href="#39022">offset</a></span>, <span class="typed"><span class="type">NewCharArrayReader.this.type</span><a href="#8474">NewCharArrayReader</a></span>.<span class="keyword">this</span>.<span class="typed"><span class="type">()Char</span><a href="#39025">next</a></span>)
  }
  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Boolean</span><a id="39024">hasNext</a></span> = { <span class="comment">// could be padded</span>
    <span class="typed"><span class="type">Boolean</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39019">bufLength</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>) <span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>) <span class="typed"><span class="type">(Char)Boolean</span><a id="3019">!=</a></span> <span class="typed"><span class="type">Char('\032')</span><span >SU</span></span>
    <span class="keyword">else</span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39019">bufLength</a></span>
  }
  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Char</span><a id="39025">next</a></span> : <span class="typed"><span class="type">Char</span><a id="2389">Char</a></span> = {
    <span class="typed"><span class="type">(Boolean)Unit</span><a href="#39016">isUnicode0</a></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; Boolean</span><a id="2747">!</a></span><span class="typed"><span class="type">=&gt; Boolean</span><a href="#39024">hasNext</a></span>) <span class="typed"><span class="type">Nothing</span><span class="keyword">return</span></span> <span class="typed"><span class="type">Char('\032')</span><span >SU</span></span>
    <span class="keyword">var</span> <span class="typed"><span class="type">Char</span><a id="113441">ch</a></span> = <span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>)
    <span class="typed"><span class="type">(Int)Unit</span><a href="#39013">idx</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>
    <span class="typed"><span class="type">Char</span><a href="#113441">ch</a></span> <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
    <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('\015')</span><span >CR</span></span> <span class="keyword">if</span> <span class="typed"><span class="type">=&gt; RandomAccessSeq[Char]</span><a href="#39007">buf</a></span>.<span class="typed"><span class="type">(Int,Any)Boolean</span><a id="21594">safeIs</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>, <span class="typed"><span class="type">Char('\012')</span><span >LF</span></span>) =&gt; 
      <span class="typed"><span class="type">(Int)Unit</span><a href="#39013">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+=</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>; <span class="typed"><span class="type">Char</span><a href="#113441">ch</a></span> = <span class="typed"><span class="type">Char('\012')</span><span >LF</span></span>
    <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('\012')</span><span >LF</span></span> | <span class="typed"><span class="type">Char('\014')</span><span >FF</span></span> =&gt; 
    <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Char('\')</span><span class="char">'\\'</span></span> =&gt; 
      <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Boolean</span><a id="113501">evenSlashPrefix</a></span>: <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> = {
        <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><a id="113503">p</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(2)</span><span class="int">2</span></span>
        <span class="typed"><span class="type">Unit</span><a href="#113504" class="keyword">while</a></span> (<span class="typed"><span class="type">Int</span><a href="#113503">p</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3146">&gt;=</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">Int</span><a href="#113503">p</a></span>) <span class="typed"><span class="type">(Char)Boolean</span><a id="3018">==</a></span> <span class="typed"><span class="type">Char('\')</span><span class="char">'\\'</span></span>) <span class="typed"><span class="type">Int</span><a href="#113503">p</a></span> = <span class="typed"><span class="type">Int</span><a href="#113503">p</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>;
        (<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int</span><a href="#113503">p</a></span>) <span class="typed"><span class="type">(Int)Int</span><a id="3151">%</a></span> <span class="typed"><span class="type">Int(2)</span><span class="int">2</span></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>
      }
      <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Int</span><a id="113502">udigit</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = {
        <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="113527">d</a></span> = <span class="typed"><span class="type">(Char,Int)Int</span><a href="#39026">digit2int</a></span>(<span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>), <span class="typed"><span class="type">Int(16)</span><span class="int">16</span></span>)
        <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Int</span><a href="#113527">d</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3146">&gt;=</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>) { <span class="typed"><span class="type">(Int)Unit</span><a href="#39013">idx</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span> }
        <span class="keyword">else</span> <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">(Int, String) =&gt; Unit</span><a href="#39010">error</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="5793">!=</a></span> <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>) <span class="typed"><span class="type">(Int,String)Unit</span><a href="#39010" id="29833">error</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>, <span class="typed"><span class="type">java.lang.String(&quot;error in unicode escape&quot;)</span><span class="string">&quot;error in unicode escape&quot;</span></span>);
        <span class="typed"><span class="type">Int</span><a href="#113527">d</a></span>
      }
      <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39019">bufLength</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>) <span class="typed"><span class="type">(Char)Boolean</span><a id="3018">==</a></span> <span class="typed"><span class="type">Char('u')</span><span class="char">'u'</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Boolean</span><a href="#39009">decodeUni</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">=&gt; Boolean</span><a href="#113501">evenSlashPrefix</a></span>) {
        <span class="typed"><span class="type">Unit</span><a href="#113554" class="keyword">do</a></span> {
          <span class="typed"><span class="type">(Int)Unit</span><a href="#39013">idx</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(1)</span><span class="int">1</span></span>; <span class="comment">// nextcol = nextcol + 1;</span>
        } <span class="keyword">while</span> (<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3143">&lt;</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#39019">bufLength</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">(Int)Char</span><a href="#39007" id="21757">buf</a></span>(<span class="typed"><span class="type">=&gt; Int</span><a href="#39012">idx</a></span>) <span class="typed"><span class="type">(Char)Boolean</span><a id="3018">==</a></span> <span class="typed"><span class="type">Char('u')</span><span class="char">'u'</span></span>);
        <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><a id="113553">code</a></span> = <span class="typed"><span class="type">=&gt; Int</span><a href="#113502">udigit</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3090">&lt;&lt;</a></span> <span class="typed"><span class="type">Int(12)</span><span class="int">12</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3152">|</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#113502">udigit</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3090">&lt;&lt;</a></span> <span class="typed"><span class="type">Int(8)</span><span class="int">8</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3152">|</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#113502">udigit</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3090">&lt;&lt;</a></span> <span class="typed"><span class="type">Int(4)</span><span class="int">4</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3152">|</a></span> <span class="typed"><span class="type">=&gt; Int</span><a href="#113502">udigit</a></span>
        <span class="typed"><span class="type">(Boolean)Unit</span><a href="#39016">isUnicode0</a></span> = <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
        <span class="typed"><span class="type">Char</span><a href="#113441">ch</a></span> = <span class="typed"><span class="type">Int</span><a href="#113553">code</a></span>.<span class="typed"><span class="type">Char</span><a id="3503">asInstanceOf</a></span>[<span class="typed"><span class="type">Char</span><a id="2389">Char</a></span>]
      }
    <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> _ =&gt; 
    }
    <span class="typed"><span class="type">Char</span><a href="#113441">ch</a></span>
  }
  <span class="keyword">def</span> <span class="typed"><span class="type">(Char,Int)Int</span><a id="39026">digit2int</a></span>(<span class="typed"><span class="type">Char</span><a id="113528">ch</a></span>: <span class="typed"><span class="type">Char</span><a id="2389">Char</a></span>, <span class="typed"><span class="type">Int</span><a id="113529">base</a></span>: <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span>): <span class="typed"><span class="type">Int</span><a id="2394">Int</a></span> = {
    <span class="typed"><span class="type">Int</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Char('0')</span><span class="char">'0'</span></span> <span class="typed"><span class="type">(Char)Boolean</span><a id="3021">&lt;=</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Char)Boolean</span><a id="3021">&lt;=</a></span> <span class="typed"><span class="type">Char('9')</span><span class="char">'9'</span></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3034">&lt;</a></span> <span class="typed"><span class="type">Char('0')</span><span class="char">'0'</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3038">+</a></span> <span class="typed"><span class="type">Int</span><a href="#113529">base</a></span>)
      <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Char)Int</span><a id="3025">-</a></span> <span class="typed"><span class="type">Char('0')</span><span class="char">'0'</span></span>
    <span class="keyword">else</span> <span class="typed"><span class="type">Int</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Char('A')</span><span class="char">'A'</span></span> <span class="typed"><span class="type">(Char)Boolean</span><a id="3021">&lt;=</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3034">&lt;</a></span> <span class="typed"><span class="type">Char('A')</span><span class="char">'A'</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3038">+</a></span> <span class="typed"><span class="type">Int</span><a href="#113529">base</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(10)</span><span class="int">10</span></span>)
      <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Char)Int</span><a id="3025">-</a></span> <span class="typed"><span class="type">Char('A')</span><span class="char">'A'</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(10)</span><span class="int">10</span></span>
    <span class="keyword">else</span> <span class="typed"><span class="type">Int</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">Char('a')</span><span class="char">'a'</span></span> <span class="typed"><span class="type">(Char)Boolean</span><a id="3021">&lt;=</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Boolean)Boolean</span><a id="2751">&amp;&amp;</a></span> <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3034">&lt;</a></span> <span class="typed"><span class="type">Char('a')</span><span class="char">'a'</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3038">+</a></span> <span class="typed"><span class="type">Int</span><a href="#113529">base</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3148">-</a></span> <span class="typed"><span class="type">Int(10)</span><span class="int">10</span></span>)
      <span class="typed"><span class="type">Char</span><a href="#113528">ch</a></span> <span class="typed"><span class="type">(Char)Int</span><a id="3025">-</a></span> <span class="typed"><span class="type">Char('a')</span><span class="char">'a'</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3147">+</a></span> <span class="typed"><span class="type">Int(10)</span><span class="int">10</span></span>
    <span class="keyword">else</span>
      -<span class="typed"><span class="type">Int(-1)</span><span class="int">1</span></span>
  }
}

        </pre>
    </body>
</html>