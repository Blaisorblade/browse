<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/util/SourceFile.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */

// $Id: SourceFile.scala 18406 2009-07-30 07:41:22Z odersky $

<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> util
<span class="keyword">import</span> scala.tools.nsc.io.{AbstractFile, VirtualFile}
<span class="keyword">import</span> scala.collection.mutable.ArrayBuffer
<span class="keyword">import</span> annotation.tailrec

<span class="keyword">object</span> <a title="object scala.tools.nsc.util.SourceFile" id="14789">SourceFile</a> <span title="ScalaObject">{</span>
  // Be very careful touching these.
  // Apparently trivial changes to the way you write these constants 
  // will cause Scanners.scala to go from a nice efficient switch to 
  // a ghastly nested if statement which will bring the type checker
  // to its knees. See ticket #1456
  <span class="keyword">final</span> <span class="keyword">val</span> <a title="Char('\012')" id="65731">LF</a> = <span title="Char('\012')" class="char">'\u000A'</span>
  <span class="keyword">final</span> <span class="keyword">val</span> <a title="Char('\014')" id="65733">FF</a> = <span title="Char('\014')" class="char">'\u000C'</span>
  <span class="keyword">final</span> <span class="keyword">val</span> <a title="Char('\015')" id="65735">CR</a> = <span title="Char('\015')" class="char">'\u000D'</span>
  <span class="keyword">final</span> <span class="keyword">val</span> <a title="Char('\032')" id="65737">SU</a> = <span title="Char('\032')" class="char">'\u001A'</span>

  <span class="keyword">def</span> <a title="(c: Int)Boolean" id="65739">isLineBreakChar</a>(<a title="Int" id="333676">c</a>: <span title="Int">Int</span>) = <a href="#333676" title="Int">c</a> <span title="Boolean" class="keyword">match</span> {
    <span title="Boolean(true)" class="keyword">case</span> <a href="#65731" title="=&gt; Char('\012')">LF</a>|<a href="#65733" title="=&gt; Char('\014')">FF</a>|<a href="#65735" title="=&gt; Char('\015')">CR</a>|<a href="#65737" title="=&gt; Char('\032')">SU</a>  =&gt; <span title="Boolean(true)" class="keyword">true</span>
    <span title="Boolean(false)" class="keyword">case</span> _            =&gt; <span title="Boolean(false)" class="keyword">false</span>
  }
}
/** abstract base class of a source file used in the compiler */
<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class SourceFile extends java.lang.Object with ScalaObject" id="14788">SourceFile</a> <span title="ScalaObject">{</span>
  <span class="keyword">import</span> SourceFile._
  <span class="keyword">def</span> <a title="=&gt; Array[Char]" id="68478">content</a> : <span title="Array[Char]">Array</span>[Char]         // normalized, must end in SU
  <span class="keyword">def</span> <a title="=&gt; scala.tools.nsc.io.AbstractFile" id="68479">file</a>    : <a href="../io/AbstractFile.scala.html#20689" title="scala.tools.nsc.io.AbstractFile">AbstractFile</a>
  <span class="keyword">def</span> <a title="(idx: Int)Boolean" id="68480">isLineBreak</a>(<a title="Int" id="333682">idx</a> : <span title="Int">Int</span>) : <span title="Boolean">Boolean</span>
  <span class="keyword">def</span> <a title="=&gt; Int" id="68481">length</a> : <span title="Int">Int</span>
  <span class="keyword">def</span> <a title="(offset: Int)scala.tools.nsc.util.Position" id="68482">position</a>(<a title="Int" id="311629">offset</a>: <span title="Int">Int</span>) : <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a> = {
    <span title="(assertion: Boolean)Unit">assert</span>(<a href="#311629" title="(x$1: Int)Boolean">offset</a> &lt; <a href="#68481" title="=&gt; Int">length</a>)
    <span title="scala.tools.nsc.util.OffsetPosition" class="keyword">new</span> <a href="Position.scala.html#14638" title="scala.tools.nsc.util.OffsetPosition">OffsetPosition</a>(<a href="#14788" title="scala.tools.nsc.util.SourceFile" class="keyword">this</a>, <a href="#311629" title="Int">offset</a>)
  }
  <span class="keyword">def</span> <a title="(line: Int,column: Int)scala.tools.nsc.util.Position" id="68483">position</a>(<a title="Int" id="311626">line</a>: <span title="Int">Int</span>, <a title="Int" id="311627">column</a>: <span title="Int">Int</span>) : <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a> = <span title="scala.tools.nsc.util.OffsetPosition" class="keyword">new</span> <a href="Position.scala.html#14638" title="scala.tools.nsc.util.OffsetPosition">OffsetPosition</a>(<a href="#14788" title="scala.tools.nsc.util.SourceFile" class="keyword">this</a>, <a href="#68485" title="(index: Int)Int">lineToOffset</a><span title="(x$1: Int)Int">(</span><a href="#311626" title="Int">line</a>) + <a href="#311627" title="Int">column</a>)
  <span class="keyword">def</span> <a title="(offset: Int)Int" id="68484">offsetToLine</a>(<a title="Int" id="333727">offset</a>: <span title="Int">Int</span>): <span title="Int">Int</span> 
  <span class="keyword">def</span> <a title="(index: Int)Int" id="68485">lineToOffset</a>(<a title="Int" id="333696">index</a> : <span title="Int">Int</span>): <span title="Int">Int</span>
  /** Map a position to a position in the underlying source file.
   *  For regular source files, simply return the argument.
   */
  <span class="keyword">def</span> <a title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position" id="68486">positionInUltimateSource</a>(<a title="scala.tools.nsc.util.Position" id="172831">position</a>: <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a>) = <a href="#172831" title="scala.tools.nsc.util.Position">position</a>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()String" id="68487">toString</a>(): <span title="String">String</span> = <a href="#68479" title="=&gt; scala.tools.nsc.io.AbstractFile">file</a>.<a href="../io/AbstractFile.scala.html#51636" title="=&gt; String">name</a> /* + &quot;:&quot; + content.length */
  <span class="keyword">def</span> <a title="(offset: Int)java.lang.String" id="68488">dbg</a>(<a title="Int" id="333729">offset</a>: <span title="Int">Int</span>) = (<span title="scala.tools.nsc.util.OffsetPosition" class="keyword">new</span> <a href="Position.scala.html#14638" title="scala.tools.nsc.util.OffsetPosition">OffsetPosition</a>(<a href="#14788" title="scala.tools.nsc.util.SourceFile" class="keyword">this</a>, <a href="#333729" title="Int">offset</a>)).<a href="Position.scala.html#68434" title="=&gt; java.lang.String">dbgString</a>
  <span class="keyword">def</span> <a title="=&gt; String" id="68489">path</a> = <a href="#68479" title="=&gt; scala.tools.nsc.io.AbstractFile">file</a>.<a href="../io/AbstractFile.scala.html#51637" title="=&gt; String">path</a>

  <span class="keyword">def</span> <a title="(offset: Int,text: String)Boolean" id="68490">beginsWith</a>(<a title="Int" id="333761">offset</a>: <span title="Int">Int</span>, <a title="String" id="333762">text</a>: <span title="String">String</span>): <span title="Boolean">Boolean</span> =
    <a title="(that: Sequence[Char])Boolean" id="25748">(</a><a href="#68478" title="(n: Int)Array[Char]">content</a> drop <a href="#333761" title="Int">offset</a>) startsWith <a href="#333762" title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString" id="8170">text</a>

  <span class="keyword">def</span> <a title="(index: Int)String" id="68491">lineToString</a>(<a title="Int" id="333790">index</a>: <span title="Int">Int</span>): <span title="String">String</span> =
    <a href="#68478" title="(n: Int)Array[Char]">content</a> <span title="(p: (Char) =&gt; Boolean)Array[Char]">drop</span> <a href="#68485" title="(index: Int)Int">lineToOffset</a>(<a href="#333790" title="Int">index</a>) takeWhile (<a title="Char" id="333802">c</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#65739" title="(c: Int)Boolean">isLineBreakChar</a>(<a href="#333802" title="implicit scala.Predef.char2int : (x: Char)Int">c</a>)) <a title="=&gt; String" id="25525">mkString</a>
    
  @tailrec
  <span class="keyword">final</span> <span class="keyword">def</span> <a title="(offset: Int)Int" id="68492">skipWhitespace</a>(<a title="Int" id="333815">offset</a>: <span title="Int">Int</span>): <span title="Int">Int</span> =  
    <span title="Int" class="keyword">if</span> (<a href="#68478" title="(i: Int)Char">content</a><a title="implicit scala.Predef.charWrapper : (c: Char)scala.runtime.RichChar" id="8160">(</a><a href="#333815" title="Int">offset</a>).<a title="=&gt; Boolean" id="43561">isWhitespace</a>) <a href="#68492" title="(offset: Int)Int">skipWhitespace</a>(<a href="#333815" title="(x$1: Int)Int">offset</a> + <span title="Int(1)" class="int">1</span>) <span class="keyword">else</span> <a href="#333815" title="Int">offset</a>
  
  <span class="keyword">def</span> <a title="(pos: scala.tools.nsc.util.Position,compiler: scala.tools.nsc.Global)Option[String]" id="68493">identifier</a>(<a title="scala.tools.nsc.util.Position" id="333863">pos</a>: <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a>, <a title="scala.tools.nsc.Global" id="333864">compiler</a>: <a href="../Global.scala.html#8529" title="scala.tools.nsc.Global">Global</a>): <a title="Option[String]" id="794">Option</a>[String] = <a title="object None" id="477">None</a>  
}

/** a file whose contents do not change over time */
<span class="keyword">class</span> <a title="class BatchSourceFile extends scala.tools.nsc.util.SourceFile with ScalaObject" id="14734">BatchSourceFile</a><span title="ScalaObject">(</span><span class="keyword">val</span> <a title="scala.tools.nsc.io.AbstractFile" id="121561">file</a> : <a href="../io/AbstractFile.scala.html#20689" title="scala.tools.nsc.io.AbstractFile">AbstractFile</a>, <span class="keyword">val</span> <a title="Array[Char]" id="121562">content</a>: <span title="Array[Char]">Array</span>[Char]) <span class="keyword">extends</span> <a href="#14788" title="scala.tools.nsc.util.SourceFile">SourceFile</a> {
  <span class="keyword">import</span> SourceFile._
  
  <span class="keyword">def</span> <a title="(_file: scala.tools.nsc.io.AbstractFile)scala.tools.nsc.util.BatchSourceFile" id="121514" class="keyword">this</a>(<a title="scala.tools.nsc.io.AbstractFile" id="121538">_file</a>: <a href="../io/AbstractFile.scala.html#20689" title="scala.tools.nsc.io.AbstractFile">AbstractFile</a>)                 = <a href="#14734" title="BatchSourceFile.this.type" class="keyword">this</a>(<a href="#121538" title="scala.tools.nsc.io.AbstractFile">_file</a>, <a href="#121538" title="scala.tools.nsc.io.AbstractFile">_file</a>.<a href="../io/AbstractFile.scala.html#51650" title="=&gt; Array[Char]">toCharArray</a>)
  <span class="keyword">def</span> <a title="(sourceName: String,cs: Seq[Char])scala.tools.nsc.util.BatchSourceFile" id="121515" class="keyword">this</a>(<a title="String" id="121536">sourceName</a>: <span title="String">String</span>, <a title="Seq[Char]" id="121537">cs</a>: <span title="Seq[Char]">Seq</span>[Char])   = <a href="#14734" title="BatchSourceFile.this.type" class="keyword">this</a>(<a href="../io/VirtualFile.scala.html#111124" title="(name: String)scala.tools.nsc.io.VirtualFile" class="keyword">new</a> <a href="../io/VirtualFile.scala.html#20728" title="scala.tools.nsc.io.VirtualFile">VirtualFile</a>(<a href="#121536" title="String">sourceName</a>), <a href="#121537" title="Seq[Char]">cs</a>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Char])Array[Char]">toArray</span>)
  <span class="keyword">def</span> <a title="(file: scala.tools.nsc.io.AbstractFile,cs: Seq[Char])scala.tools.nsc.util.BatchSourceFile" id="121516" class="keyword">this</a>(<a title="scala.tools.nsc.io.AbstractFile" id="121534">file</a>: <a href="../io/AbstractFile.scala.html#20689" title="scala.tools.nsc.io.AbstractFile">AbstractFile</a>, <a title="Seq[Char]" id="121535">cs</a>: <span title="Seq[Char]">Seq</span>[Char])   = <a href="#14734" title="BatchSourceFile.this.type" class="keyword">this</a>(<a href="#121534" title="scala.tools.nsc.io.AbstractFile">file</a>, <a href="#121535" title="Seq[Char]">cs</a>.<span title="(implicit evidence$1: scala.reflect.ClassManifest[Char])Array[Char]">toArray</span>)
    
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(that: Any)Boolean" id="121517">equals</a>(<a title="Any" id="333951">that</a> : <a title="Any" id="49">Any</a>) = <a href="#333951" title="Any">that</a> <span title="Boolean" class="keyword">match</span> {
    <span title="Boolean" class="keyword">case</span> <a title="scala.tools.nsc.util.BatchSourceFile" id="333954">that</a> : <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a> =&gt; <a href="#121561" title="(x$1: AnyRef)Boolean">file</a> == <a href="#333954" title="scala.tools.nsc.util.BatchSourceFile">that</a>.<a href="#121561" title="=&gt; scala.tools.nsc.io.AbstractFile">file</a>
    <span title="Boolean(false)" class="keyword">case</span> _ =&gt; <span title="Boolean(false)" class="keyword">false</span>
  }
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Int" id="121518">hashCode</a> = <a href="#121561" title="=&gt; scala.tools.nsc.io.AbstractFile">file</a>.<a title="()Int" id="6593">hashCode</a>
  <span class="keyword">val</span> <a title="Int" id="121519">length</a> = <a href="#121562" title="=&gt; Array[Char]">content</a>.<span title="=&gt; Int">length</span>

  // in SourceFileFragments, these are overridden to compensate during offset calculation
  // Invariant: length + start = underlyingLength
  <span class="keyword">def</span> <a title="=&gt; Int" id="121521">underlyingLength</a> = <a href="#121519" title="=&gt; Int">length</a>
  <span class="keyword">def</span> <a title="=&gt; Int" id="121522">start</a> = <span title="Int(0)" class="int">0</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(pos: scala.tools.nsc.util.Position,compiler: scala.tools.nsc.Global)Option[String]" id="121523">identifier</a>(<a title="scala.tools.nsc.util.Position" id="333972">pos</a>: <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a>, <a title="scala.tools.nsc.Global" id="333973">compiler</a>: <a href="../Global.scala.html#8529" title="scala.tools.nsc.Global">Global</a>) = 
    <span title="Option[String]" class="keyword">if</span> (<a href="#333972" title="scala.tools.nsc.util.Position">pos</a>.<a href="Position.scala.html#30465" title="(x$1: Boolean)Boolean">isDefined</a> <span title="(x$1: Boolean)Boolean">&amp;&amp;</span> <a href="#333972" title="scala.tools.nsc.util.Position">pos</a>.<a href="Position.scala.html#30464" title="(x$1: AnyRef)Boolean">source</a> == <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile" class="keyword">this</a> &amp;&amp; <a href="#333972" title="scala.tools.nsc.util.Position">pos</a>.<a href="Position.scala.html#30472" title="(x$1: Int)Boolean" id="2975">point</a> != <span title="Int(-1)">-</span><span class="int">1</span>) {
      <span class="keyword">def</span> <a title="(c: Char)Boolean" id="333994">isOK</a>(<a title="Char" id="333995">c</a>: <a title="Char" id="2184">Char</a>) = {
        <span class="keyword">import</span> compiler.syntaxAnalyzer.{ isOperatorPart, isIdentifierPart }
        <a href="../ast/parser/Scanners.scala.html#39911" title="(c: Char)Boolean">isIdentifierPart</a><span title="(x$1: Boolean)Boolean">(</span><a href="#333995" title="Char">c</a>) || <a href="../ast/parser/Scanners.scala.html#39913" title="(c: Char)Boolean">isOperatorPart</a>(<a href="#333995" title="Char">c</a>)
      }
      <a title="(x: java.lang.String)Some[java.lang.String]" id="267">Some</a>(<a title="(x$1: Array[Char])java.lang.String" id="6630" class="keyword">new</a> <a title="java.lang.String" id="7886">String</a>(<a href="#121562" title="(n: Int)Array[Char]">content</a> <span title="(p: (Char) =&gt; Boolean)Array[Char]">drop</span> <a href="#333972" title="scala.tools.nsc.util.Position">pos</a>.<a href="Position.scala.html#30472" title="=&gt; Int">point</a> takeWhile <a href="#333994" title="(c: Char)Boolean">isOK</a>))
    } <span class="keyword">else</span> {
      <span class="keyword">super</span>.<a href="#68493" title="(pos: scala.tools.nsc.util.Position,compiler: scala.tools.nsc.Global)Option[String]">identifier</a>(<a href="#333972" title="scala.tools.nsc.util.Position">pos</a>, <a href="#333973" title="scala.tools.nsc.Global">compiler</a>)
    }
  
  <span class="keyword">def</span> <a title="(idx: Int)Boolean" id="121524">isLineBreak</a>(<a title="Int" id="334062">idx</a>: <span title="Int">Int</span>) =
    <span title="Boolean" class="keyword">if</span> (<a href="#334062" title="(x$1: Int)Boolean">idx</a> &gt;= <a href="#121519" title="=&gt; Int">length</a>) <span title="Boolean(false)" class="keyword">false</span> <span class="keyword">else</span> <a href="#121562" title="(i: Int)Char">content</a>(<a href="#334062" title="Int">idx</a>) <span title="Boolean" class="keyword">match</span> {
      // don't identify the CR in CR LF as a line break, since LF will do.
      <span title="Boolean" class="keyword">case</span> <span title="Char('\015')">CR</span> =&gt; <span title="(x$1: Boolean)Boolean">(</span><a href="#334062" title="(x$1: Int)Int">idx</a> <a title="(x$1: Int)Boolean" id="2973">+</a> <span title="Int(1)" class="int">1</span> == <a href="#121519" title="=&gt; Int">length</a>) || (<a href="#121562" title="(i: Int)Char">content</a><a title="(x$1: Char)Boolean" id="2739">(</a><a href="#334062" title="(x$1: Int)Int">idx</a> + <span title="Int(1)" class="int">1</span>) != <span title="Char('\012')">LF</span>)
      <span title="Boolean" class="keyword">case</span> <a title="Char" id="334136">x</a>  =&gt; <a href="#65739" title="(c: Int)Boolean">isLineBreakChar</a>(<a href="#334136" title="implicit scala.Predef.char2int : (x: Char)Int">x</a>)
    }
    
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Array[Int]" id="121526">lineIndices</a>: <span title="Array[Int]">Array</span>[Int] = {
    <span class="keyword">val</span> <a title="scala.collection.mutable.ArrayBuffer[Int]" id="334145">buf</a> = <a title="()scala.collection.mutable.ArrayBuffer[Int]" id="108940" class="keyword">new</a> <a title="scala.collection.mutable.ArrayBuffer[Int]" id="25155">ArrayBuffer</a>[Int]
    <a href="#334145" title="(elem: Int)buf.type">buf</a> += <span title="Int(0)" class="int">0</span>
    <span class="keyword">for</span> (<a title="Int" id="334219">i</a> &lt;- <a title="(end: Int)Range" id="8158" class="int">0</a> <a title="(f: (Int) =&gt; Any)Unit" id="56527">until</a> <a href="#121562" title="=&gt; Array[Char]">content</a>.<span title="=&gt; Int">length</span>) <span title="Any" class="keyword">if</span> (<a href="#121524" title="(idx: Int)Boolean">isLineBreak</a>(<a href="#334219" title="Int">i</a>)) <a href="#334145" title="(elem: Int)buf.type">buf</a> += <a href="#334219" title="(x$1: Int)Int">i</a> + <span title="Int(1)" class="int">1</span>
    <a href="#334145" title="(elem: Int)buf.type">buf</a> += <a href="#121562" title="=&gt; Array[Char]">content</a>.<span title="=&gt; Int">length</span> // sentinel, so that findLine below works smoother
    <a href="#334145" title="scala.collection.mutable.ArrayBuffer[Int]">buf</a>.<a title="(implicit evidence$1: scala.reflect.ClassManifest[Int])Array[Int]" id="58950">toArray</a>
  }

  <span class="keyword">def</span> <a title="(index: Int)Int" id="121527">lineToOffset</a>(<a title="Int" id="334327">index</a> : <span title="Int">Int</span>): <span title="Int">Int</span> = <a href="#121525" title="(i: Int)Int">lineIndices</a>(<a href="#334327" title="Int">index</a>)

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Int" id="121529">lastLine</a> = <span title="Int(0)" class="int">0</span>

  /** Convert offset to line in this source file
   *  Lines are numbered from 0
   */
  <span class="keyword">def</span> <a title="(offset: Int)Int" id="121531">offsetToLine</a>(<a title="Int" id="334338">offset</a>: <span title="Int">Int</span>): <span title="Int">Int</span> = {
    <span class="keyword">val</span> <a title="Array[Int]" id="334340">lines</a> = <a href="#121525" title="=&gt; Array[Int]">lineIndices</a>
    <span class="keyword">def</span> <a title="(lo: Int,hi: Int,mid: Int)Int" id="334341">findLine</a>(<a title="Int" id="334342">lo</a>: <span title="Int">Int</span>, <a title="Int" id="334343">hi</a>: <span title="Int">Int</span>, <a title="Int" id="334344">mid</a>: <span title="Int">Int</span>): <span title="Int">Int</span> =
      <span title="Int" class="keyword">if</span> (<a href="#334338" title="(x$1: Int)Boolean">offset</a> &lt; <a href="#334340" title="(i: Int)Int">lines</a>(<a href="#334344" title="Int">mid</a>)) <a href="#334341" title="(lo: Int,hi: Int,mid: Int)Int">findLine</a>(<a href="#334342" title="Int">lo</a>, <a href="#334344" title="(x$1: Int)Int">mid</a> - <span title="Int(1)" class="int">1</span>, <span title="(x$1: Int)Int">(</span><a href="#334342" title="(x$1: Int)Int">lo</a> <span title="(x$1: Int)Int">+</span> <a href="#334344" title="Int">mid</a> - <span title="Int(1)" class="int">1</span>) / <span title="Int(2)" class="int">2</span>)
      <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#334338" title="(x$1: Int)Boolean">offset</a> &gt;= <a href="#334340" title="(i: Int)Int">lines</a>(<a href="#334344" title="(x$1: Int)Int">mid</a> + <span title="Int(1)" class="int">1</span>)) <a href="#334341" title="(lo: Int,hi: Int,mid: Int)Int">findLine</a>(<a href="#334344" title="(x$1: Int)Int">mid</a> + <span title="Int(1)" class="int">1</span>, <a href="#334343" title="Int">hi</a>, <span title="(x$1: Int)Int">(</span><a href="#334344" title="(x$1: Int)Int">mid</a> <span title="(x$1: Int)Int">+</span> <span title="Int(1)" class="int">1</span> + <a href="#334343" title="Int">hi</a>) / <span title="Int(2)" class="int">2</span>)
      <span class="keyword">else</span> <a href="#334344" title="Int">mid</a>
    <a href="#121529" title="(x$1: Int)Unit">lastLine</a> = <a href="#334341" title="(lo: Int,hi: Int,mid: Int)Int">findLine</a>(<span title="Int(0)" class="int">0</span>, <a href="#334340" title="Array[Int]">lines</a>.<span title="=&gt; Int">length</span>, <a href="#121529" title="=&gt; Int">lastLine</a>)
    <a href="#121529" title="=&gt; Int">lastLine</a>
  }

/**    
  
  // An array which maps line numbers (counting from 0) to char offset into content
  private lazy val lineIndices: Array[Int] = {
    
    val xs = content.indices filter isLineBreak map (_ + 1) toArray
    val arr = new Array[Int](xs.length + 1)
    arr(0) = 0
    System.arraycopy(xs, 0, arr, 1, xs.length)

    arr
  }
  // A reverse map which also hunts down the right answer on non-exact lookups
  private class SparseReverser() {
    val revMap = Map(lineIndices.zipWithIndex: _*)
    
    def apply(x: Int): Int = revMap.get(x) match {
      case Some(res)  =&gt; res
      case _          =&gt;
        var candidate = x - 1
        while (!revMap.contains(candidate))
          candidate -= 1

        revMap(candidate)
    }
  }
  private lazy val lineIndicesRev = new SparseReverser()
  
  def lineToOffset(index : Int): Int = lineIndices(index)
  def offsetToLine(offset: Int): Int = lineIndicesRev(offset)

  */
}

/** A source file composed of multiple other source files.
 *
 *  @version 1.0
 */
<span class="keyword">class</span> <a title="class CompoundSourceFile extends scala.tools.nsc.util.BatchSourceFile with ScalaObject" id="14563">CompoundSourceFile</a><a href="#121515" title="ScalaObject">(</a>
    <a title="String" id="132151">name</a>: <span title="String">String</span>,
    <a title="List[scala.tools.nsc.util.BatchSourceFile]" id="132152">components</a>: <a title="List[scala.tools.nsc.util.BatchSourceFile]" id="7414">List</a>[BatchSourceFile],
    <a title="Array[Char]" id="132153">contents</a>: <span title="Array[Char]">Array</span>[Char])
<span class="keyword">extends</span> <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a>(<a href="#132151" title="String">name</a>, <a href="#132153" title="Array[Char]">contents</a>)
{
  /** The usual constructor.  Specify a name for the compound file and
   *  a list of component sources.
   */
  <span class="keyword">def</span> <a title="(name: String,components: scala.tools.nsc.util.BatchSourceFile*)scala.tools.nsc.util.CompoundSourceFile" id="132143" class="keyword">this</a>(<a title="String" id="132149">name</a>: <span title="String">String</span>, <a title="scala.tools.nsc.util.BatchSourceFile*" id="132150">components</a>: <span title="scala.tools.nsc.util.BatchSourceFile*">BatchSourceFile</span>*) = <span title="Unit">{</span>
    <a href="#14563" title="CompoundSourceFile.this.type" class="keyword">this</a>(
      <a href="#132149" title="String">name</a>,
      <a href="#132150" title="scala.tools.nsc.util.BatchSourceFile*">components</a>.<span title="=&gt; List[scala.tools.nsc.util.BatchSourceFile]">toList</span>,
      <a title="object Array" id="906">Array</a>.<a title="(xss: Traversable[Char]*)(implicit evidence$8: scala.reflect.ClassManifest[Char])Array[Char]" id="24815">concat</a><span title="=&gt; &lt;refinement&gt; extends java.lang.Object with scala.reflect.Manifest[Char]">(</span><a href="#132150" title="scala.tools.nsc.util.BatchSourceFile*">components</a>.<span title="=&gt; List[scala.tools.nsc.util.BatchSourceFile]">toList</span>.<a title="(f: (scala.tools.nsc.util.BatchSourceFile) =&gt; Array[Char])(implicit bf: scala.collection.generic.BuilderFactory[Array[Char],List[Array[Char]],List[scala.tools.nsc.util.BatchSourceFile]])List[Array[Char]]" id="25402">map</a><a title="scala.collection.generic.BuilderFactory[Array[Char],List[Array[Char]],List#Coll]" id="7415">(</a><a title="scala.tools.nsc.util.BatchSourceFile" id="334540">comp</a> =&gt; 
        <a href="#14564" title="object scala.tools.nsc.util.CompoundSourceFile">CompoundSourceFile</a>.<a href="#334542" title="(chars: Array[Char])Array[Char]">stripSU</a>(<a href="#334540" title="scala.tools.nsc.util.BatchSourceFile">comp</a>.<a href="#121562" title="=&gt; Array[Char]">content</a>).<span title="(implicit evidence$1: scala.reflect.ClassManifest[Char])Array[Char]">toArray</span>):_*))
  }

  /** Create an instance with the specified components and a generic name. */
  <span class="keyword">def</span> <a title="(components: scala.tools.nsc.util.BatchSourceFile*)scala.tools.nsc.util.CompoundSourceFile" id="132144" class="keyword">this</a>(<a title="scala.tools.nsc.util.BatchSourceFile*" id="132148">components</a>: <span title="scala.tools.nsc.util.BatchSourceFile*">BatchSourceFile</span>*) =
    <a href="#132143" title="(name: String,components: scala.tools.nsc.util.BatchSourceFile*)scala.tools.nsc.util.CompoundSourceFile" class="keyword">this</a>(<span title="java.lang.String(&quot;(virtual file)&quot;)" class="string">&quot;(virtual file)&quot;</span>, <a href="#132148" title="scala.tools.nsc.util.BatchSourceFile*">components</a>.<span title="=&gt; List[scala.tools.nsc.util.BatchSourceFile]">toList</span>:_*)

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position" id="132145">positionInUltimateSource</a>(<a title="scala.tools.nsc.util.Position" id="334708">position</a>: <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a>) = {
    <span title="scala.tools.nsc.util.Position" class="keyword">if</span> (<a href="#334708" title="scala.tools.nsc.util.Position">position</a>.<a href="Position.scala.html#30476" title="=&gt; Option[Int]">offset</a>.<span title="=&gt; Boolean">isEmpty</span>) <span class="keyword">super</span>.<a href="#68486" title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position">positionInUltimateSource</a>(<a href="#334708" title="scala.tools.nsc.util.Position">position</a>)
    <span class="keyword">else</span> {
      <span title="(x: Any)Unit">println</span>(<span title="java.lang.String(&quot;!!!&quot;)" class="string">&quot;!!!&quot;</span>)
      <span class="keyword">var</span> <a title="Int" id="334714">off</a> = <a href="#334708" title="scala.tools.nsc.util.Position">position</a>.<a href="Position.scala.html#30476" title="=&gt; Option[Int]">offset</a>.<span title="=&gt; Int">get</span>
      <span class="keyword">var</span> <a title="List[scala.tools.nsc.util.BatchSourceFile]" id="334715">compsLeft</a> = <a href="#132152" title="List[scala.tools.nsc.util.BatchSourceFile]">components</a>
      // the search here has to be against the length of the files underlying the
      // components, not their advertised length (which in the case of a fragment is
      // less than the underlying length.) Otherwise we can and will overshoot the
      // correct component and return a garbage position.
      <span title="Unit" class="keyword">while</span> (<a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; scala.tools.nsc.util.BatchSourceFile">head</span>.<a href="#121521" title="(x$1: Int)Int">underlyingLength</a><span title="(x$1: Int)Boolean">-</span><span title="Int(1)" class="int">1</span> <span title="(x$1: Boolean)Boolean">&lt;=</span> <a href="#334714" title="Int">off</a> &amp;&amp; <span title="=&gt; Boolean">!</span><a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; List[scala.tools.nsc.util.BatchSourceFile]">tail</span>.<a title="=&gt; Boolean" id="25593">isEmpty</a>) <a href="#334717" title="()Unit">{</a>
        <span title="(x: Any)Unit">println</span>(<span title="(x$1: Any)java.lang.String" class="string">&quot;discarding &quot;</span>+<a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; scala.tools.nsc.util.BatchSourceFile">head</span>)
        <a href="#334714" title="Int">off</a> = <a href="#334714" title="(x$1: Int)Int">off</a> <span title="(x$1: Int)Int">-</span> <a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; scala.tools.nsc.util.BatchSourceFile">head</span>.<a href="#121521" title="=&gt; Int">underlyingLength</a> + <span title="Int(1)" class="int">1</span>
        <a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a> = <a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; List[scala.tools.nsc.util.BatchSourceFile]">tail</span>
      }
      // now that we've identified the correct component, we have to adjust the
      // position we report since it is expected relative to the fragment, not the
      // underlying file.  Thus, off - comp.start.
      <span class="keyword">val</span> <a title="scala.tools.nsc.util.BatchSourceFile" id="334716">comp</a> = <a href="#334715" title="List[scala.tools.nsc.util.BatchSourceFile]">compsLeft</a>.<span title="=&gt; scala.tools.nsc.util.BatchSourceFile">head</span>
      <a href="#334716" title="scala.tools.nsc.util.BatchSourceFile">comp</a>.<a href="#68486" title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position">positionInUltimateSource</a>(<span title="scala.tools.nsc.util.OffsetPosition" class="keyword">new</span> <a href="Position.scala.html#14638" title="scala.tools.nsc.util.OffsetPosition">OffsetPosition</a>(<a href="#14563" title="scala.tools.nsc.util.CompoundSourceFile" class="keyword">this</a>, <a href="#334714" title="(x$1: Int)Int">off</a> - <a href="#334716" title="scala.tools.nsc.util.BatchSourceFile">comp</a>.<a href="#121522" title="=&gt; Int">start</a>))
    }
  }
}

<span class="keyword">object</span> <a title="object scala.tools.nsc.util.CompoundSourceFile" id="14564">CompoundSourceFile</a> <span title="ScalaObject">{</span>
  <span class="keyword">private</span>[util] <span class="keyword">def</span> <a title="(chars: Array[Char])Array[Char]" id="334542">stripSU</a>(<a title="Array[Char]" id="334543">chars</a>: <span title="Array[Char]">Array</span>[Char]) =
    <span title="Array[Char]" class="keyword">if</span> (<a href="#334543" title="Array[Char]">chars</a>.<a title="(x$1: Int)Boolean" id="2981">length</a> <span title="(x$1: Boolean)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> &amp;&amp; <a href="#334543" title="Array[Char]">chars</a>.<a title="(x$1: Char)Boolean" id="25941">last</a> == SourceFile.<span title="Char('\032')">SU</span>)
      <a href="#334543" title="Array[Char]">chars</a>.<span title="(from: Int,until: Int)Array[Char]">slice</span>(<span title="Int(0)" class="int">0</span>, <a href="#334543" title="Array[Char]">chars</a>.<span title="(x$1: Int)Int">length</span>-<span title="Int(1)" class="int">1</span>)
    <span class="keyword">else</span>
      <a href="#334543" title="Array[Char]">chars</a>
}


/** One portion of an underlying file.  The fragment includes
  * the indices from the specified start (inclusively) to stop
  * (not inclusively).
  */
<span class="keyword">class</span> <a title="class SourceFileFragment extends scala.tools.nsc.util.BatchSourceFile with ScalaObject" id="14713">SourceFileFragment</a> <a href="#121515" title="ScalaObject" class="keyword">private</a> (
    <a title="String" id="334819">name</a>: <span title="String">String</span>,
    <a title="scala.tools.nsc.util.BatchSourceFile" id="334820">underlyingFile</a>: <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a>,
    <span class="keyword">override</span> <span class="keyword">val</span> <a title="Int" id="334821">start</a>: <span title="Int">Int</span>,
    <a title="Int" id="334822">stop</a>: <span title="Int">Int</span>,
    <a title="Array[Char]" id="334823">contents</a>: <span title="Array[Char]">Array</span>[Char])
<span class="keyword">extends</span> <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a>(<a href="#334819" title="String">name</a>, <a href="#334823" title="Array[Char]">contents</a>) {
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Int" id="132103">underlyingLength</a> = <a href="#334820" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>.<a href="#121519" title="=&gt; Int">length</a>
  <span class="keyword">def</span> <a title="(name: String,underlyingFile: scala.tools.nsc.util.BatchSourceFile,start: Int,stop: Int)scala.tools.nsc.util.SourceFileFragment" id="132104" class="keyword">this</a>(<a title="String" id="132112">name</a>: <span title="String">String</span>, <a title="scala.tools.nsc.util.BatchSourceFile" id="132113">underlyingFile</a>: <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a>, <a title="Int" id="132114">start</a>: <span title="Int">Int</span>, <a title="Int" id="132115">stop</a>: <span title="Int">Int</span>) =
    <a href="#14713" title="SourceFileFragment.this.type" class="keyword">this</a>(
      <a href="#132112" title="String">name</a>,
      <a href="#132113" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>,
      <a href="#132114" title="Int">start</a>,
      <a href="#132115" title="Int">stop</a>,
      { <span title="(assertion: Boolean)Unit">assert</span>(<a href="#132114" title="(x$1: Int)Boolean">start</a> &gt;= <span title="Int(0)" class="int">0</span>)
        <span title="(assertion: Boolean)Unit">assert</span>(<a href="#132114" title="(x$1: Int)Boolean">start</a> &lt;= <a href="#132115" title="Int">stop</a>)
        <span title="(assertion: Boolean)Unit">assert</span>(<a href="#132114" title="(x$1: Int)Boolean">start</a> &lt;= <a href="#132113" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>.<a href="#121519" title="=&gt; Int">length</a>)
        <span title="(assertion: Boolean)Unit">assert</span>(<a href="#132115" title="(x$1: Int)Boolean">stop</a> &lt;= <a href="#132113" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>.<a href="#121519" title="=&gt; Int">length</a>)
        <a href="#132113" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>.<a href="#121562" title="=&gt; Array[Char]">content</a>.<span title="(from: Int,until: Int)Array[Char]">slice</span>(<a href="#132114" title="Int">start</a>, <a href="#132115" title="Int">stop</a>).<span title="(implicit evidence$1: scala.reflect.ClassManifest[Char])Array[Char]">toArray</span> })

  <span class="keyword">def</span> <a title="(underlyingFile: scala.tools.nsc.util.BatchSourceFile,start: Int,stop: Int)scala.tools.nsc.util.SourceFileFragment" id="132105" class="keyword">this</a>(<a title="scala.tools.nsc.util.BatchSourceFile" id="132109">underlyingFile</a>: <a href="#14734" title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</a>, <a title="Int" id="132110">start</a>: <span title="Int">Int</span>, <a title="Int" id="132111">stop</a>: <span title="Int">Int</span>) =
    <a href="#132104" title="(name: String,underlyingFile: scala.tools.nsc.util.BatchSourceFile,start: Int,stop: Int)scala.tools.nsc.util.SourceFileFragment" class="keyword">this</a>(
      <span title="(x$1: Any)java.lang.String" class="string">&quot;(fragment of &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#132109" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>.<a href="#121561" title="=&gt; scala.tools.nsc.io.AbstractFile">file</a>.<a href="../io/AbstractFile.scala.html#51636" title="=&gt; String">name</a> + <span title="java.lang.String(&quot;)&quot;)" class="string">&quot;)&quot;</span>,
      <a href="#132109" title="scala.tools.nsc.util.BatchSourceFile">underlyingFile</a>,
      <a href="#132110" title="Int">start</a>,
      <a href="#132111" title="Int">stop</a>)

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position" id="132106">positionInUltimateSource</a>(<a title="scala.tools.nsc.util.Position" id="334916">position</a>: <a href="Position.scala.html#14785" title="scala.tools.nsc.util.Position">Position</a>) = {
    <span title="scala.tools.nsc.util.Position" class="keyword">if</span> (<a href="#334916" title="scala.tools.nsc.util.Position">position</a>.<a href="Position.scala.html#30476" title="=&gt; Option[Int]">offset</a>.<span title="=&gt; Boolean">isEmpty</span>)
      <span class="keyword">super</span>.<a href="#68486" title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position">positionInUltimateSource</a>(<a href="#334916" title="scala.tools.nsc.util.Position">position</a>)
    <span class="keyword">else</span> {
      <span class="keyword">super</span>.<a href="#68486" title="(position: scala.tools.nsc.util.Position)scala.tools.nsc.util.Position">positionInUltimateSource</a>(
      <span title="scala.tools.nsc.util.OffsetPosition" class="keyword">new</span> <a href="Position.scala.html#14638" title="scala.tools.nsc.util.OffsetPosition">OffsetPosition</a>(<a href="#14713" title="scala.tools.nsc.util.SourceFileFragment" class="keyword">this</a>, <a href="#334916" title="scala.tools.nsc.util.Position">position</a>.<a href="Position.scala.html#30476" title="=&gt; Option[Int]">offset</a>.<span title="=&gt; Int">get</span>))
    }
  }
}

        </pre>
    </body>
</html>