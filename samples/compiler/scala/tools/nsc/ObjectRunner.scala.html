<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/ObjectRunner.scala</title>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/* NSC -- new Scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Lex Spoon
 */</span>

<span class="comment">// $Id: ObjectRunner.scala 16893 2009-01-13 13:09:22Z cunei $</span>

<span class="keyword">package</span> scala.tools.nsc

<span class="keyword">import</span> java.lang.{Class, ClassNotFoundException, NoSuchMethodException}
<span class="keyword">import</span> java.lang.reflect.{Method, Modifier}
<span class="keyword">import</span> java.net.{URL, URLClassLoader}

<span class="comment">/** An object that runs another object specified by name.
 *
 *  @author  Lex Spoon
 *  @version 1.1, 2007/7/13
 */</span>
<span class="keyword">object</span> <span class="typed"><span class="type">object scala.tools.nsc.ObjectRunner</span><a id="6826">ObjectRunner</a></span> {
  <span class="comment">/** Create a class loader for the specified class path */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(List[java.net.URL])java.net.URLClassLoader</span><a id="58141">makeClassLoader</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a id="128412">classpath</a></span>: <span class="typed"><span class="type">List[java.net.URL]</span><a id="526">List</a></span>[URL]) =
    <span class="typed"><span class="type">java.net.URLClassLoader</span><span class="keyword">new</span></span> <span class="typed"><span class="type">java.net.URLClassLoader</span><a id="4412">URLClassLoader</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a href="#128412">classpath</a></span>.<span class="typed"><span class="type">Array[java.net.URL]</span><a id="21675">toArray</a></span>, <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)

  <span class="comment">/** Look up a class with a given class path. */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">(java.lang.ClassLoader,String)Option[java.lang.Class[_]]</span><a id="58142">findClass</a></span>(<span class="typed"><span class="type">java.lang.ClassLoader</span><a id="128434">loader</a></span>: <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="1726">ClassLoader</a></span>, <span class="typed"><span class="type">String</span><a id="128435">objectName</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>)
  : <span class="typed"><span class="type">Option[java.lang.Class[_]]</span><a id="934">Option</a></span>[Class[T] <span class="keyword">forSome</span> { <span class="keyword">type</span> T }] = 
  {
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">(java.lang.Class[?0])Some[java.lang.Class[?0]]</span><span id="29737"><a id="308">Some</a></span></span>(<span class="typed"><span class="type">object java.lang.Class</span><a id="1673">Class</a></span>.<span class="typed"><span class="type">(java.lang.String,Boolean,java.lang.ClassLoader)java.lang.Class[_]</span><a id="3936">forName</a></span>(<span class="typed"><span class="type">String</span><a href="#128435">objectName</a></span>, <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>, <span class="typed"><span class="type">java.lang.ClassLoader</span><a href="#128434">loader</a></span>))
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">None.type</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="128451">e</a></span>: <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1858">SecurityException</a></span> =&gt;
        <span class="typed"><span class="type">object Console</span><a id="440">Console</a></span>.<span class="typed"><span class="type">(Any)Unit</span><a id="27062">println</a></span>(<span class="typed"><span class="type">java.lang.SecurityException</span><a href="#128451">e</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="23646">getMessage</a></span>)
        <span class="typed"><span class="type">object None</span><a id="536">None</a></span>
      <span class="typed"><span class="type">None.type</span><span class="keyword">case</span></span> _: <span class="typed"><span class="type">java.lang.ClassNotFoundException</span><a id="1729">ClassNotFoundException</a></span> =&gt;
        <span class="typed"><span class="type">object None</span><a id="536">None</a></span>
    }
  }
  
  <span class="comment">/** Check whether a class with the specified name
   *  exists on the specified class path. */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(List[java.net.URL],String)Boolean</span><a id="58143">classExists</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a id="58148">classpath</a></span>: <span class="typed"><span class="type">List[java.net.URL]</span><a id="526">List</a></span>[URL], <span class="typed"><span class="type">String</span><a id="58149">objectName</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2170">Boolean</a></span> =
    <span class="typed"><span class="type">=&gt; Boolean</span><a id="2747">!</a></span><span class="typed"><span class="type">(java.lang.ClassLoader,String)Option[java.lang.Class[_]]</span><a href="#58142">findClass</a></span>(<span class="typed"><span class="type">(List[java.net.URL])java.net.URLClassLoader</span><a href="#58141">makeClassLoader</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a href="#58148">classpath</a></span>), <span class="typed"><span class="type">String</span><a href="#58149">objectName</a></span>).<span class="typed"><span class="type">=&gt; Boolean</span><a id="25406">isEmpty</a></span>

  <span class="comment">/** Set the Java context class loader while executing an action */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">[T](java.lang.ClassLoader)(=&gt; T)T</span><a id="58144">withContextClassLoader</a></span>[<span class="typed"><span class="type">&gt;: Nothing &lt;: Any</span><a id="58146">T</a></span>](<span class="typed"><span class="type">java.lang.ClassLoader</span><a id="128453">loader</a></span>: <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="1726">ClassLoader</a></span>)(<span class="typed"><span class="type">=&gt; T</span><a id="128454">action</a></span>: =&gt;T): <span class="typed"><span class="type">T</span><a href="#58146">T</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="128455">oldLoader</a></span> = <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">()java.lang.Thread</span><a id="29015">currentThread</a></span>.<span class="typed"><span class="type">()java.lang.ClassLoader</span><a id="29054">getContextClassLoader</a></span>
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">()java.lang.Thread</span><a id="29015">currentThread</a></span>.<span class="typed"><span class="type">(java.lang.ClassLoader)Unit</span><a id="29055">setContextClassLoader</a></span>(<span class="typed"><span class="type">java.lang.ClassLoader</span><a href="#128453">loader</a></span>)
      <span class="typed"><span class="type">=&gt; T</span><a href="#128454">action</a></span>
    } <span class="keyword">finally</span> {
      <span class="typed"><span class="type">object java.lang.Thread</span><a id="2084">Thread</a></span>.<span class="typed"><span class="type">()java.lang.Thread</span><a id="29015">currentThread</a></span>.<span class="typed"><span class="type">(java.lang.ClassLoader)Unit</span><a id="29055">setContextClassLoader</a></span>(<span class="typed"><span class="type">java.lang.ClassLoader</span><a href="#128455">oldLoader</a></span>)
    }
  }

  
  <span class="comment">/** Run a given object, specified by name, using a
   *  specified classpath and argument list.
   *
   *  @throws ClassNotFoundException   
   *  @throws NoSuchMethodError         
   *  @throws InvocationTargetException 
   */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(List[java.net.URL],String,Seq[String])Unit</span><a id="58147">run</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a id="58150">classpath</a></span>: <span class="typed"><span class="type">List[java.net.URL]</span><a id="526">List</a></span>[URL], <span class="typed"><span class="type">String</span><a id="58151">objectName</a></span>: <span class="typed"><span class="type">String</span><a id="1861">String</a></span>, <span class="typed"><span class="type">Seq[String]</span><a id="58152">arguments</a></span>: <span class="typed"><span class="type">Seq[String]</span><a id="763">Seq</a></span>[String]) {
    <span class="keyword">val</span> <span class="typed"><span class="type">java.net.URLClassLoader</span><a id="128456">loader</a></span> = <span class="typed"><span class="type">(List[java.net.URL])java.net.URLClassLoader</span><a href="#58141">makeClassLoader</a></span>(<span class="typed"><span class="type">List[java.net.URL]</span><a href="#58150">classpath</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.Class[?]</span><a id="128457">clsToRun</a></span> = <span class="typed"><span class="type">(java.lang.ClassLoader,String)Option[java.lang.Class[_]]</span><a href="#58142">findClass</a></span>(<span class="typed"><span class="type">java.net.URLClassLoader</span><a href="#128456">loader</a></span>, <span class="typed"><span class="type">String</span><a href="#58151">objectName</a></span>) <span class="typed"><span class="type">java.lang.Class[?]</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">java.lang.Class[?]</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">java.lang.Class[?]</span><a id="128459">cls</a></span>) =&gt; <span class="typed"><span class="type">java.lang.Class[?]</span><a href="#128459">cls</a></span>
      <span class="typed"><span class="type">Nothing</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a id="536">None</a></span> =&gt; <span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">(java.lang.String)java.lang.ClassNotFoundException</span><a id="58155" class="keyword">new</a></span> <span class="typed"><span class="type">java.lang.ClassNotFoundException</span><a id="1729">ClassNotFoundException</a></span>(<span class="typed"><span class="type">String</span><a href="#58151">objectName</a></span>)
    }

    <span class="keyword">val</span> <span class="typed"><span class="type">java.lang.reflect.Method</span><a id="128458">method</a></span> = <span class="typed"><span class="type">java.lang.Class[?]</span><a href="#128457">clsToRun</a></span>.<span class="typed"><span class="type">(java.lang.String,java.lang.Class[_]*)java.lang.reflect.Method</span><a id="4342">getMethod</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;main&quot;)</span><span class="string">&quot;main&quot;</span></span>, <span class="typed"><span class="type">java.lang.Class[Array[String]]</span><span >classOf</span></span>[Array[String]])
    <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> ((<span class="typed"><span class="type">java.lang.reflect.Method</span><a href="#128458">method</a></span>.<span class="typed"><span class="type">()Int</span><a id="128473">getModifiers</a></span> <span class="typed"><span class="type">(Int)Int</span><a id="3153">&amp;</a></span> Modifier.<span class="typed"><span class="type">Int(8)</span><span >STATIC</span></span>) <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">==</a></span> <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
      <span class="typed"><span class="type">Nothing</span><span class="keyword">throw</span></span> <span class="typed"><span class="type">(java.lang.String)java.lang.NoSuchMethodException</span><a id="58162" class="keyword">new</a></span> <span class="typed"><span class="type">java.lang.NoSuchMethodException</span><a id="2089">NoSuchMethodException</a></span>(<span class="typed"><span class="type">String</span><a href="#58151">objectName</a></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5802">+</a></span> <span class="typed"><span class="type">java.lang.String(&quot;.main is not static&quot;)</span><span class="string">&quot;.main is not static&quot;</span></span>)

    <span class="typed"><span class="type">(java.lang.ClassLoader)(=&gt; java.lang.Object)java.lang.Object</span><a href="#58144">withContextClassLoader</a></span>(<span class="typed"><span class="type">java.net.URLClassLoader</span><a href="#128456">loader</a></span>) {
      <span class="typed"><span class="type">java.lang.reflect.Method</span><a href="#128458">method</a></span>.<span class="typed"><span class="type">(Any,java.lang.Object*)java.lang.Object</span><a id="128492">invoke</a></span>(<span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>, <span class="typed"><span class="type">(Array[String]*)List[Array[String]]</span><span id="21328"><a id="527">List</a></span></span>(<span class="typed"><span class="type">Seq[String]</span><a href="#58152">arguments</a></span>.<span class="typed"><span class="type">Array[String]</span><a id="21675">toArray</a></span>).<span class="typed"><span class="type">Array[Array[String]]</span><a id="21675">toArray</a></span>: _*)
    }
  }
}

        </pre>
    </body>
</html>