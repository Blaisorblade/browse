<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/typechecker/Variances.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */
// $Id: Variances.scala 18387 2009-07-24 15:28:37Z odersky $

<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> typechecker

<span class="keyword">import</span> symtab.Flags._

/** Variances form a lattice, 0 &lt;= COVARIANT &lt;= Variances, 0 &lt;= CONTRAVARIANT &lt;= VARIANCES
 */
<span class="keyword">trait</span> <a title="trait Variances extends java.lang.Object with ScalaObject" id="18282">Variances</a> <a title="ScalaObject" id="959">{</a>

  <span class="keyword">val</span> <a title="=&gt; scala.tools.nsc.Global" id="40010">global</a>: <a href="../Global.scala.html#8460" title="scala.tools.nsc.Global">Global</a>
  <span class="keyword">import</span> global._

  /** Convert variance to string */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(variance: Int)String" id="40012">varianceString</a>(<a title="Int" id="717619">variance</a>: <span title="Int">Int</span>): <a title="String" id="1605">String</a> =
    <span title="String" class="keyword">if</span> (<a href="#717619" title="(x$1: Int)Boolean">variance</a> == <span title="Int(65536)">COVARIANT</span>) <span title="java.lang.String(&quot;covariant&quot;)" class="string">&quot;covariant&quot;</span>
    <span class="keyword">else</span> <span title="String" class="keyword">if</span> (<a href="#717619" title="(x$1: Int)Boolean">variance</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <span title="java.lang.String(&quot;contravariant&quot;)" class="string">&quot;contravariant&quot;</span>
    <span class="keyword">else</span> <span title="java.lang.String(&quot;invariant&quot;)" class="string">&quot;invariant&quot;</span>
  
  /** Flip between covariant and contravariant */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v: Int)Int" id="40013">flip</a>(<a title="Int" id="717633">v</a>: <span title="Int">Int</span>): <span title="Int">Int</span> = {
    <span title="Int" class="keyword">if</span> (<a href="#717633" title="(x$1: Int)Boolean">v</a> == <span title="Int(65536)">COVARIANT</span>) <span title="Int(131072)">CONTRAVARIANT</span>
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#717633" title="(x$1: Int)Boolean">v</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <span title="Int(65536)">COVARIANT</span>
    <span class="keyword">else</span> <a href="#717633" title="Int">v</a>
  }

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v1: Int,v2: Int)Int" id="40014">compose</a>(<a title="Int" id="717647">v1</a>: <span title="Int">Int</span>, <a title="Int" id="717648">v2</a>: <span title="Int">Int</span>) =
    <span title="Int" class="keyword">if</span> (<a href="#717647" title="(x$1: Int)Boolean">v1</a> == <span title="Int(0)" class="int">0</span>) <span title="Int(0)" class="int">0</span>
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#717647" title="(x$1: Int)Boolean">v1</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <a href="#40013" title="(v: Int)Int">flip</a>(<a href="#717648" title="Int">v2</a>)
    <span class="keyword">else</span> <a href="#717648" title="Int">v2</a>;

  /** Map everything below VARIANCES to 0 */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v: Int)Int" id="40015">cut</a>(<a title="Int" id="717665">v</a>: <span title="Int">Int</span>): <span title="Int">Int</span> =
    <span title="Int" class="keyword">if</span> (<a href="#717665" title="(x$1: Int)Boolean">v</a> == <span title="Int(196608)">VARIANCES</span>) <a href="#717665" title="Int">v</a> <span class="keyword">else</span> <span title="Int(0)" class="int">0</span>

  /** Compute variance of type parameter `tparam' in types of all symbols `sym'. */
  <span class="keyword">def</span> <a title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int" id="40016">varianceInSyms</a>(<a title="List[Variances.this.global.Symbol]" id="717673">syms</a>: <span title="List[Variances.this.global.Symbol]">List</span>[Symbol])(<a title="Variances.this.global.Symbol" id="717674">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> =
    (<span title="Int(196608)">VARIANCES</span> <a href="#717676" title="Int">/:</a> <a href="#717673" title="(z: Int)(op: (Int, Variances.this.global.Symbol) =&gt; Int)Int">syms</a>) ((<a title="Int" id="717688">v</a>, <a title="Variances.this.global.Symbol" id="717689">sym</a>) =&gt; <a href="#717688" title="(x$1: Int)Int">v</a> &amp; <a href="#40017" title="(sym: Variances.this.global.Symbol)(tparam: Variances.this.global.Symbol)Int">varianceInSym</a>(<a href="#717689" title="Variances.this.global.Symbol">sym</a>)(<a href="#717674" title="Variances.this.global.Symbol">tparam</a>))

  /** Compute variance of type parameter `tparam' in type of symbol `sym'. */
  <span class="keyword">def</span> <a title="(sym: Variances.this.global.Symbol)(tparam: Variances.this.global.Symbol)Int" id="40017">varianceInSym</a>(<a title="Variances.this.global.Symbol" id="717701">sym</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>)(<a title="Variances.this.global.Symbol" id="717702">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = 
    <span title="Int" class="keyword">if</span> (<a href="#717701" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#26899" title="=&gt; Boolean">isAliasType</a>) <a href="#40015" title="(v: Int)Int">cut</a>(<a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717701" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27004" title="=&gt; Variances.this.global.Type">info</a>)(<a href="#717702" title="Variances.this.global.Symbol">tparam</a>)) 
    <span class="keyword">else</span> <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717701" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27004" title="=&gt; Variances.this.global.Type">info</a>)(<a href="#717702" title="Variances.this.global.Symbol">tparam</a>)

  /** Compute variance of type parameter `tparam' in all types `tps'. */
  <span class="keyword">def</span> <a title="(tps: List[Variances.this.global.Type])(tparam: Variances.this.global.Symbol)Int" id="40018">varianceInTypes</a>(<a title="List[Variances.this.global.Type]" id="717725">tps</a>: <span title="List[Variances.this.global.Type]">List</span>[Type])(<a title="Variances.this.global.Symbol" id="717726">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> =
    (<span title="Int(196608)">VARIANCES</span> <a href="#717728" title="Int">/:</a> <a href="#717725" title="(z: Int)(op: (Int, Variances.this.global.Type) =&gt; Int)Int">tps</a>) ((<a title="Int" id="717740">v</a>, <a title="Variances.this.global.Type" id="717741">tp</a>) =&gt; <a href="#717740" title="(x$1: Int)Int">v</a> &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717741" title="Variances.this.global.Type">tp</a>)(<a href="#717726" title="Variances.this.global.Symbol">tparam</a>))

  /** Compute variance of type parameter `tparam' in all type arguments
   *  &lt;code&gt;tps&lt;/code&gt; which correspond to formal type parameters `tparams1'.
   */
  <span class="keyword">def</span> <a title="(tps: List[Variances.this.global.Type],tparams1: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int" id="40019">varianceInArgs</a>(<a title="List[Variances.this.global.Type]" id="717758">tps</a>: <span title="List[Variances.this.global.Type]">List</span>[Type], <a title="List[Variances.this.global.Symbol]" id="717759">tparams1</a>: <span title="List[Variances.this.global.Symbol]">List</span>[Symbol])(<a title="Variances.this.global.Symbol" id="717760">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    <span class="keyword">var</span> <a title="Int" id="717762">v</a>: <span title="Int">Int</span> = <span title="Int(196608)">VARIANCES</span>;
    <span class="keyword">for</span> ((<a title="Variances.this.global.Type" id="717889">tp</a>, <a title="Variances.this.global.Symbol" id="717890">tparam1</a>) &lt;- <a href="#717758" title="(that: Iterable[Variances.this.global.Symbol])(implicit bf: scala.collection.generic.BuilderFactory[(Variances.this.global.Type, Variances.this.global.Symbol),List[(Variances.this.global.Type, Variances.this.global.Symbol)],List[Variances.this.global.Type]])List[(Variances.this.global.Type, Variances.this.global.Symbol)]" id="25448">tps</a> <a href="#717856" title="(f: ((Variances.this.global.Type, Variances.this.global.Symbol)) =&gt; Unit)Unit" id="7346">zip</a> <a href="#717759" title="List[Variances.this.global.Symbol]">tparams1</a>) {
      <span class="keyword">val</span> <a title="Int" id="717893">v1</a> = <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717889" title="Variances.this.global.Type">tp</a>)(<a href="#717760" title="Variances.this.global.Symbol">tparam</a>)
      <a href="#717762" title="Int">v</a> = <a href="#717762" title="(x$1: Int)Int">v</a> &amp; (<span title="Int" class="keyword">if</span> (<a href="#717890" title="Variances.this.global.Symbol">tparam1</a>.<a href="../symtab/Symbols.scala.html#26980" title="=&gt; Boolean">isCovariant</a>) <a href="#717893" title="Int">v1</a>
	       <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#717890" title="Variances.this.global.Symbol">tparam1</a>.<a href="../symtab/Symbols.scala.html#26981" title="=&gt; Boolean">isContravariant</a>) <a href="#40013" title="(v: Int)Int">flip</a>(<a href="#717893" title="Int">v1</a>)
	       <span class="keyword">else</span> <a href="#40015" title="(v: Int)Int">cut</a>(<a href="#717893" title="Int">v1</a>))
    }
    <a href="#717762" title="Int">v</a>
  }

  /** Compute variance of type parameter `tparam' in all type annotations `annots'. */
  <span class="keyword">def</span> <a title="(annots: List[Variances.this.global.AnnotationInfo])(tparam: Variances.this.global.Symbol)Int" id="40020">varianceInAttribs</a>(<a title="List[Variances.this.global.AnnotationInfo]" id="717915">annots</a>: <span title="List[Variances.this.global.AnnotationInfo]">List</span>[AnnotationInfo])(<a title="Variances.this.global.Symbol" id="717916">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    (<span title="Int(196608)">VARIANCES</span> <a href="#717918" title="Int">/:</a> <a href="#717915" title="(z: Int)(op: (Int, Variances.this.global.AnnotationInfo) =&gt; Int)Int">annots</a>) ((<a title="Int" id="717930">v</a>, <a title="Variances.this.global.AnnotationInfo" id="717931">annot</a>) =&gt; <a href="#717930" title="(x$1: Int)Int">v</a> &amp; <a href="#40021" title="(annot: Variances.this.global.AnnotationInfo)(tparam: Variances.this.global.Symbol)Int">varianceInAttrib</a>(<a href="#717931" title="Variances.this.global.AnnotationInfo">annot</a>)(<a href="#717916" title="Variances.this.global.Symbol">tparam</a>))
  }

  /** Compute variance of type parameter `tparam' in type annotation `annot'. */
  <span class="keyword">def</span> <a title="(annot: Variances.this.global.AnnotationInfo)(tparam: Variances.this.global.Symbol)Int" id="40021">varianceInAttrib</a>(<a title="Variances.this.global.AnnotationInfo" id="717940">annot</a>: <a href="../symtab/AnnotationInfos.scala.html#26553" title="Variances.this.global.AnnotationInfo">AnnotationInfo</a>)(<a title="Variances.this.global.Symbol" id="717941">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717940" title="Variances.this.global.AnnotationInfo">annot</a>.<a href="../symtab/AnnotationInfos.scala.html#44738" title="=&gt; Variances.this.global.Type">atp</a>)(<a href="#717941" title="Variances.this.global.Symbol">tparam</a>)
  }

  /** Compute variance of type parameter &lt;code&gt;tparam&lt;/code&gt; in type &lt;code&gt;tp&lt;/code&gt;. */
  <span class="keyword">def</span> <a title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int" id="40022">varianceInType</a>(<a title="Variances.this.global.Type" id="717712">tp</a>: <a href="../symtab/Types.scala.html#26205" title="Variances.this.global.Type">Type</a>)(<a title="Variances.this.global.Symbol" id="717713">tparam</a>: <a href="../symtab/Symbols.scala.html#26127" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = <a href="#717712" title="Variances.this.global.Type">tp</a> <span title="Int" class="keyword">match</span> {
    <span title="Int(196608)" class="keyword">case</span> <a href="../symtab/Types.scala.html#26217" title="object Variances.this.global.ErrorType">ErrorType</a> | <a href="../symtab/Types.scala.html#26219" title="object Variances.this.global.WildcardType">WildcardType</a> | <a href="../symtab/Types.scala.html#26224" title="object Variances.this.global.NoType">NoType</a> | <a href="../symtab/Types.scala.html#26226" title="object Variances.this.global.NoPrefix">NoPrefix</a> | ThisType(_) | ConstantType(_) =&gt;
      <span title="Int(196608)">VARIANCES</span>
    <span title="Int" class="keyword">case</span> SingleType(<a title="Variances.this.global.Type" id="717963">pre</a>, <a title="Variances.this.global.Symbol" id="717964">sym</a>) =&gt;
      <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717963" title="Variances.this.global.Type">pre</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> TypeRef(<a title="Variances.this.global.Type" id="717974">pre</a>, <a title="Variances.this.global.Symbol" id="717975">sym</a>, <a title="List[Variances.this.global.Type]" id="717976">args</a>) =&gt;
      <span title="Int" class="keyword">if</span> (<a href="#717975" title="(x$1: AnyRef)Boolean" id="3626">sym</a> == <a href="#717713" title="Variances.this.global.Symbol">tparam</a>) <span title="Int(65536)">COVARIANT</span>
      <span class="keyword">else</span> <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#717974" title="Variances.this.global.Type">pre</a>)<span title="(x$1: Int)Int">(</span><a href="#717713" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40019" title="(tps: List[Variances.this.global.Type],tparams1: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInArgs</a>(<a href="#717976" title="List[Variances.this.global.Type]">args</a>, <a href="#717975" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27016" title="=&gt; List[Variances.this.global.Symbol]">typeParams</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> TypeBounds(<a title="Variances.this.global.Type" id="718005">lo</a>, <a title="Variances.this.global.Type" id="718006">hi</a>) =&gt;
      <a href="#40013" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718005" title="Variances.this.global.Type">lo</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718006" title="Variances.this.global.Type">hi</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> RefinedType(<a title="List[Variances.this.global.Type]" id="718031">parents</a>, <a title="Variances.this.global.Scope" id="718032">defs</a>) =&gt;
      <a href="#40018" title="(tps: List[Variances.this.global.Type])(tparam: Variances.this.global.Symbol)Int">varianceInTypes</a>(<a href="#718031" title="List[Variances.this.global.Type]">parents</a>)<span title="(x$1: Int)Int">(</span><a href="#717713" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40016" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#718032" title="Variances.this.global.Scope">defs</a>.<a href="../symtab/Scopes.scala.html#27144" title="=&gt; List[Variances.this.global.Symbol]">toList</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> MethodType(<a title="List[Variances.this.global.Symbol]" id="718055">params</a>, <a title="Variances.this.global.Type" id="718056">restpe</a>) =&gt;
      <a href="#40013" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40016" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#718055" title="List[Variances.this.global.Symbol]">params</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718056" title="Variances.this.global.Type">restpe</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> PolyType(<a title="List[Variances.this.global.Symbol]" id="718081">tparams</a>, <a title="Variances.this.global.Type" id="718082">restpe</a>) =&gt;
      <a href="#40013" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40016" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#718081" title="List[Variances.this.global.Symbol]">tparams</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718082" title="Variances.this.global.Type">restpe</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> ExistentialType(<a title="List[Variances.this.global.Symbol]" id="718107">tparams</a>, <a title="Variances.this.global.Type" id="718108">restpe</a>) =&gt;
      <a href="#40016" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#718107" title="List[Variances.this.global.Symbol]">tparams</a>)<span title="(x$1: Int)Int">(</span><a href="#717713" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718108" title="Variances.this.global.Type">restpe</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> AnnotatedType(<a title="List[Variances.this.global.AnnotationInfo]" id="718132">annots</a>, <a title="Variances.this.global.Type" id="718133">tp</a>, _) =&gt;
      <a href="#40020" title="(annots: List[Variances.this.global.AnnotationInfo])(tparam: Variances.this.global.Symbol)Int">varianceInAttribs</a>(<a href="#718132" title="List[Variances.this.global.AnnotationInfo]">annots</a>)<span title="(x$1: Int)Int">(</span><a href="#717713" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40022" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#718133" title="Variances.this.global.Type">tp</a>)(<a href="#717713" title="Variances.this.global.Symbol">tparam</a>)
  }
}

        </pre>
    </body>
</html>