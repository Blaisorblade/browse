<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/nsc/typechecker/Variances.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/* NSC -- new scala compiler
 * Copyright 2005-2009 LAMP/EPFL
 * @author  Martin Odersky
 */
// $Id: Variances.scala 18387 2009-07-24 15:28:37Z odersky $

<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> typechecker

<span class="keyword">import</span> symtab.Flags._

/** Variances form a lattice, 0 &lt;= COVARIANT &lt;= Variances, 0 &lt;= CONTRAVARIANT &lt;= VARIANCES
 */
<span class="keyword">trait</span> <a title="trait Variances extends java.lang.Object with ScalaObject" id="18411">Variances</a> <a title="ScalaObject" id="977">{</a>

  <span class="keyword">val</span> <a title="=&gt; scala.tools.nsc.Global" id="40242">global</a>: <a href="../Global.scala.html#8529" title="scala.tools.nsc.Global">Global</a>
  <span class="keyword">import</span> global._

  /** Convert variance to string */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(variance: Int)String" id="40244">varianceString</a>(<a title="Int" id="719335">variance</a>: <span title="Int">Int</span>): <a title="String" id="1626">String</a> =
    <span title="String" class="keyword">if</span> (<a href="#719335" title="(x$1: Int)Boolean">variance</a> == <span title="Int(65536)">COVARIANT</span>) <span title="java.lang.String(&quot;covariant&quot;)" class="string">&quot;covariant&quot;</span>
    <span class="keyword">else</span> <span title="String" class="keyword">if</span> (<a href="#719335" title="(x$1: Int)Boolean">variance</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <span title="java.lang.String(&quot;contravariant&quot;)" class="string">&quot;contravariant&quot;</span>
    <span class="keyword">else</span> <span title="java.lang.String(&quot;invariant&quot;)" class="string">&quot;invariant&quot;</span>
  
  /** Flip between covariant and contravariant */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v: Int)Int" id="40245">flip</a>(<a title="Int" id="719349">v</a>: <span title="Int">Int</span>): <span title="Int">Int</span> = {
    <span title="Int" class="keyword">if</span> (<a href="#719349" title="(x$1: Int)Boolean">v</a> == <span title="Int(65536)">COVARIANT</span>) <span title="Int(131072)">CONTRAVARIANT</span>
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#719349" title="(x$1: Int)Boolean">v</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <span title="Int(65536)">COVARIANT</span>
    <span class="keyword">else</span> <a href="#719349" title="Int">v</a>
  }

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v1: Int,v2: Int)Int" id="40246">compose</a>(<a title="Int" id="719363">v1</a>: <span title="Int">Int</span>, <a title="Int" id="719364">v2</a>: <span title="Int">Int</span>) =
    <span title="Int" class="keyword">if</span> (<a href="#719363" title="(x$1: Int)Boolean">v1</a> == <span title="Int(0)" class="int">0</span>) <span title="Int(0)" class="int">0</span>
    <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#719363" title="(x$1: Int)Boolean">v1</a> == <span title="Int(131072)">CONTRAVARIANT</span>) <a href="#40245" title="(v: Int)Int">flip</a>(<a href="#719364" title="Int">v2</a>)
    <span class="keyword">else</span> <a href="#719364" title="Int">v2</a>;

  /** Map everything below VARIANCES to 0 */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(v: Int)Int" id="40247">cut</a>(<a title="Int" id="719381">v</a>: <span title="Int">Int</span>): <span title="Int">Int</span> =
    <span title="Int" class="keyword">if</span> (<a href="#719381" title="(x$1: Int)Boolean">v</a> == <span title="Int(196608)">VARIANCES</span>) <a href="#719381" title="Int">v</a> <span class="keyword">else</span> <span title="Int(0)" class="int">0</span>

  /** Compute variance of type parameter `tparam' in types of all symbols `sym'. */
  <span class="keyword">def</span> <a title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int" id="40248">varianceInSyms</a>(<a title="List[Variances.this.global.Symbol]" id="719389">syms</a>: <span title="List[Variances.this.global.Symbol]">List</span>[Symbol])(<a title="Variances.this.global.Symbol" id="719390">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> =
    (<span title="Int(196608)">VARIANCES</span> <a href="#719392" title="Int">/:</a> <a href="#719389" title="(z: Int)(op: (Int, Variances.this.global.Symbol) =&gt; Int)Int">syms</a>) ((<a title="Int" id="719404">v</a>, <a title="Variances.this.global.Symbol" id="719405">sym</a>) =&gt; <a href="#719404" title="(x$1: Int)Int">v</a> &amp; <a href="#40249" title="(sym: Variances.this.global.Symbol)(tparam: Variances.this.global.Symbol)Int">varianceInSym</a>(<a href="#719405" title="Variances.this.global.Symbol">sym</a>)(<a href="#719390" title="Variances.this.global.Symbol">tparam</a>))

  /** Compute variance of type parameter `tparam' in type of symbol `sym'. */
  <span class="keyword">def</span> <a title="(sym: Variances.this.global.Symbol)(tparam: Variances.this.global.Symbol)Int" id="40249">varianceInSym</a>(<a title="Variances.this.global.Symbol" id="719417">sym</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>)(<a title="Variances.this.global.Symbol" id="719418">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = 
    <span title="Int" class="keyword">if</span> (<a href="#719417" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27058" title="=&gt; Boolean">isAliasType</a>) <a href="#40247" title="(v: Int)Int">cut</a>(<a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719417" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27163" title="=&gt; Variances.this.global.Type">info</a>)(<a href="#719418" title="Variances.this.global.Symbol">tparam</a>)) 
    <span class="keyword">else</span> <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719417" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27163" title="=&gt; Variances.this.global.Type">info</a>)(<a href="#719418" title="Variances.this.global.Symbol">tparam</a>)

  /** Compute variance of type parameter `tparam' in all types `tps'. */
  <span class="keyword">def</span> <a title="(tps: List[Variances.this.global.Type])(tparam: Variances.this.global.Symbol)Int" id="40250">varianceInTypes</a>(<a title="List[Variances.this.global.Type]" id="719441">tps</a>: <span title="List[Variances.this.global.Type]">List</span>[Type])(<a title="Variances.this.global.Symbol" id="719442">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> =
    (<span title="Int(196608)">VARIANCES</span> <a href="#719444" title="Int">/:</a> <a href="#719441" title="(z: Int)(op: (Int, Variances.this.global.Type) =&gt; Int)Int">tps</a>) ((<a title="Int" id="719456">v</a>, <a title="Variances.this.global.Type" id="719457">tp</a>) =&gt; <a href="#719456" title="(x$1: Int)Int">v</a> &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719457" title="Variances.this.global.Type">tp</a>)(<a href="#719442" title="Variances.this.global.Symbol">tparam</a>))

  /** Compute variance of type parameter `tparam' in all type arguments
   *  &lt;code&gt;tps&lt;/code&gt; which correspond to formal type parameters `tparams1'.
   */
  <span class="keyword">def</span> <a title="(tps: List[Variances.this.global.Type],tparams1: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int" id="40251">varianceInArgs</a>(<a title="List[Variances.this.global.Type]" id="719474">tps</a>: <span title="List[Variances.this.global.Type]">List</span>[Type], <a title="List[Variances.this.global.Symbol]" id="719475">tparams1</a>: <span title="List[Variances.this.global.Symbol]">List</span>[Symbol])(<a title="Variances.this.global.Symbol" id="719476">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    <span class="keyword">var</span> <a title="Int" id="719478">v</a>: <span title="Int">Int</span> = <span title="Int(196608)">VARIANCES</span>;
    <span class="keyword">for</span> ((<a title="Variances.this.global.Type" id="719608">tp</a>, <a title="Variances.this.global.Symbol" id="719609">tparam1</a>) &lt;- <a href="#719474" title="(that: Iterable[Variances.this.global.Symbol])(implicit bf: scala.collection.generic.BuilderFactory[(Variances.this.global.Type, Variances.this.global.Symbol),List[(Variances.this.global.Type, Variances.this.global.Symbol)],List[Variances.this.global.Type]])List[(Variances.this.global.Type, Variances.this.global.Symbol)]" id="25607">tps</a> <a href="#719575" title="(f: ((Variances.this.global.Type, Variances.this.global.Symbol)) =&gt; Unit)Unit" id="7415">zip</a> <a href="#719475" title="List[Variances.this.global.Symbol]">tparams1</a>) {
      <span class="keyword">val</span> <a title="Int" id="719612">v1</a> = <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719608" title="Variances.this.global.Type">tp</a>)(<a href="#719476" title="Variances.this.global.Symbol">tparam</a>)
      <a href="#719478" title="Int">v</a> = <a href="#719478" title="(x$1: Int)Int">v</a> &amp; (<span title="Int" class="keyword">if</span> (<a href="#719609" title="Variances.this.global.Symbol">tparam1</a>.<a href="../symtab/Symbols.scala.html#27139" title="=&gt; Boolean">isCovariant</a>) <a href="#719612" title="Int">v1</a>
	       <span class="keyword">else</span> <span title="Int" class="keyword">if</span> (<a href="#719609" title="Variances.this.global.Symbol">tparam1</a>.<a href="../symtab/Symbols.scala.html#27140" title="=&gt; Boolean">isContravariant</a>) <a href="#40245" title="(v: Int)Int">flip</a>(<a href="#719612" title="Int">v1</a>)
	       <span class="keyword">else</span> <a href="#40247" title="(v: Int)Int">cut</a>(<a href="#719612" title="Int">v1</a>))
    }
    <a href="#719478" title="Int">v</a>
  }

  /** Compute variance of type parameter `tparam' in all type annotations `annots'. */
  <span class="keyword">def</span> <a title="(annots: List[Variances.this.global.AnnotationInfo])(tparam: Variances.this.global.Symbol)Int" id="40252">varianceInAttribs</a>(<a title="List[Variances.this.global.AnnotationInfo]" id="719634">annots</a>: <span title="List[Variances.this.global.AnnotationInfo]">List</span>[AnnotationInfo])(<a title="Variances.this.global.Symbol" id="719635">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    (<span title="Int(196608)">VARIANCES</span> <a href="#719637" title="Int">/:</a> <a href="#719634" title="(z: Int)(op: (Int, Variances.this.global.AnnotationInfo) =&gt; Int)Int">annots</a>) ((<a title="Int" id="719649">v</a>, <a title="Variances.this.global.AnnotationInfo" id="719650">annot</a>) =&gt; <a href="#719649" title="(x$1: Int)Int">v</a> &amp; <a href="#40253" title="(annot: Variances.this.global.AnnotationInfo)(tparam: Variances.this.global.Symbol)Int">varianceInAttrib</a>(<a href="#719650" title="Variances.this.global.AnnotationInfo">annot</a>)(<a href="#719635" title="Variances.this.global.Symbol">tparam</a>))
  }

  /** Compute variance of type parameter `tparam' in type annotation `annot'. */
  <span class="keyword">def</span> <a title="(annot: Variances.this.global.AnnotationInfo)(tparam: Variances.this.global.Symbol)Int" id="40253">varianceInAttrib</a>(<a title="Variances.this.global.AnnotationInfo" id="719659">annot</a>: <a href="../symtab/AnnotationInfos.scala.html#26712" title="Variances.this.global.AnnotationInfo">AnnotationInfo</a>)(<a title="Variances.this.global.Symbol" id="719660">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = {
    <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719659" title="Variances.this.global.AnnotationInfo">annot</a>.<a href="../symtab/AnnotationInfos.scala.html#44970" title="=&gt; Variances.this.global.Type">atp</a>)(<a href="#719660" title="Variances.this.global.Symbol">tparam</a>)
  }

  /** Compute variance of type parameter &lt;code&gt;tparam&lt;/code&gt; in type &lt;code&gt;tp&lt;/code&gt;. */
  <span class="keyword">def</span> <a title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int" id="40254">varianceInType</a>(<a title="Variances.this.global.Type" id="719428">tp</a>: <a href="../symtab/Types.scala.html#26364" title="Variances.this.global.Type">Type</a>)(<a title="Variances.this.global.Symbol" id="719429">tparam</a>: <a href="../symtab/Symbols.scala.html#26286" title="Variances.this.global.Symbol">Symbol</a>): <span title="Int">Int</span> = <a href="#719428" title="Variances.this.global.Type">tp</a> <span title="Int" class="keyword">match</span> {
    <span title="Int(196608)" class="keyword">case</span> <a href="../symtab/Types.scala.html#26376" title="object Variances.this.global.ErrorType">ErrorType</a> | <a href="../symtab/Types.scala.html#26378" title="object Variances.this.global.WildcardType">WildcardType</a> | <a href="../symtab/Types.scala.html#26383" title="object Variances.this.global.NoType">NoType</a> | <a href="../symtab/Types.scala.html#26385" title="object Variances.this.global.NoPrefix">NoPrefix</a> | ThisType(_) | ConstantType(_) =&gt;
      <span title="Int(196608)">VARIANCES</span>
    <span title="Int" class="keyword">case</span> SingleType(<a title="Variances.this.global.Type" id="719682">pre</a>, <a title="Variances.this.global.Symbol" id="719683">sym</a>) =&gt;
      <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719682" title="Variances.this.global.Type">pre</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> TypeRef(<a title="Variances.this.global.Type" id="719693">pre</a>, <a title="Variances.this.global.Symbol" id="719694">sym</a>, <a title="List[Variances.this.global.Type]" id="719695">args</a>) =&gt;
      <span title="Int" class="keyword">if</span> (<a href="#719694" title="(x$1: AnyRef)Boolean" id="3647">sym</a> == <a href="#719429" title="Variances.this.global.Symbol">tparam</a>) <span title="Int(65536)">COVARIANT</span>
      <span class="keyword">else</span> <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719693" title="Variances.this.global.Type">pre</a>)<span title="(x$1: Int)Int">(</span><a href="#719429" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40251" title="(tps: List[Variances.this.global.Type],tparams1: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInArgs</a>(<a href="#719695" title="List[Variances.this.global.Type]">args</a>, <a href="#719694" title="Variances.this.global.Symbol">sym</a>.<a href="../symtab/Symbols.scala.html#27175" title="=&gt; List[Variances.this.global.Symbol]">typeParams</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> TypeBounds(<a title="Variances.this.global.Type" id="719724">lo</a>, <a title="Variances.this.global.Type" id="719725">hi</a>) =&gt;
      <a href="#40245" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719724" title="Variances.this.global.Type">lo</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719725" title="Variances.this.global.Type">hi</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> RefinedType(<a title="List[Variances.this.global.Type]" id="719750">parents</a>, <a title="Variances.this.global.Scope" id="719751">defs</a>) =&gt;
      <a href="#40250" title="(tps: List[Variances.this.global.Type])(tparam: Variances.this.global.Symbol)Int">varianceInTypes</a>(<a href="#719750" title="List[Variances.this.global.Type]">parents</a>)<span title="(x$1: Int)Int">(</span><a href="#719429" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40248" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#719751" title="Variances.this.global.Scope">defs</a>.<a href="../symtab/Scopes.scala.html#27303" title="=&gt; List[Variances.this.global.Symbol]">toList</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> MethodType(<a title="List[Variances.this.global.Symbol]" id="719774">params</a>, <a title="Variances.this.global.Type" id="719775">restpe</a>) =&gt;
      <a href="#40245" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40248" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#719774" title="List[Variances.this.global.Symbol]">params</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719775" title="Variances.this.global.Type">restpe</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> PolyType(<a title="List[Variances.this.global.Symbol]" id="719800">tparams</a>, <a title="Variances.this.global.Type" id="719801">restpe</a>) =&gt;
      <a href="#40245" title="(v: Int)Int">flip</a><span title="(x$1: Int)Int">(</span><a href="#40248" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#719800" title="List[Variances.this.global.Symbol]">tparams</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)) &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719801" title="Variances.this.global.Type">restpe</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> ExistentialType(<a title="List[Variances.this.global.Symbol]" id="719826">tparams</a>, <a title="Variances.this.global.Type" id="719827">restpe</a>) =&gt;
      <a href="#40248" title="(syms: List[Variances.this.global.Symbol])(tparam: Variances.this.global.Symbol)Int">varianceInSyms</a>(<a href="#719826" title="List[Variances.this.global.Symbol]">tparams</a>)<span title="(x$1: Int)Int">(</span><a href="#719429" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719827" title="Variances.this.global.Type">restpe</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
    <span title="Int" class="keyword">case</span> AnnotatedType(<a title="List[Variances.this.global.AnnotationInfo]" id="719851">annots</a>, <a title="Variances.this.global.Type" id="719852">tp</a>, _) =&gt;
      <a href="#40252" title="(annots: List[Variances.this.global.AnnotationInfo])(tparam: Variances.this.global.Symbol)Int">varianceInAttribs</a>(<a href="#719851" title="List[Variances.this.global.AnnotationInfo]">annots</a>)<span title="(x$1: Int)Int">(</span><a href="#719429" title="Variances.this.global.Symbol">tparam</a>) &amp; <a href="#40254" title="(tp: Variances.this.global.Type)(tparam: Variances.this.global.Symbol)Int">varianceInType</a>(<a href="#719852" title="Variances.this.global.Type">tp</a>)(<a href="#719429" title="Variances.this.global.Symbol">tparam</a>)
  }
}

        </pre>
    </body>
</html>