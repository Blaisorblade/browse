<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/tools/ant/ScalaBazaar.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/*                     __                                               *\
**     ________ ___   / /  ___     Scala Ant Tasks                      **
**    / __/ __// _ | / /  / _ |    (c) 2005-2009, LAMP/EPFL             **
**  __\ \/ /__/ __ |/ /__/ __ |    http://scala-lang.org/               **
** /____/\___/_/ |_/____/_/ | |                                         **
**                          |/                                          **
\*                                                                      */

// $Id: ScalaBazaar.scala 17856 2009-05-27 19:35:02Z dubochet $

  
<span class="keyword">package</span> scala.tools.ant {
  
  <span class="keyword">import</span> scala.collection.DefaultMap
  <span class="keyword">import</span> scala.collection.mutable.HashMap
  <span class="keyword">import</span> java.io.{File, FileInputStream, FileOutputStream,
                  FileWriter, StringReader}
  <span class="keyword">import</span> java.net.URL
  <span class="keyword">import</span> java.util.{ArrayList, Vector}
  <span class="keyword">import</span> java.util.zip.{ZipOutputStream, ZipEntry}
  
  <span class="keyword">import</span> org.apache.tools.ant.{AntClassLoader, BuildException,
                               DirectoryScanner, Project}
  <span class="keyword">import</span> org.apache.tools.ant.Task
  <span class="keyword">import</span> org.apache.tools.ant.types.Path
  <span class="keyword">import</span> org.apache.tools.ant.util.{FileUtils, MergingMapper,
                                    SourceFileScanner}
  <span class="keyword">import</span> org.apache.tools.ant.types.{EnumeratedAttribute, Reference, FileSet}
    
  /** A set of files that can be installed at any relative location */
    <span class="keyword">class</span> <a title="class LooseFileSet extends java.lang.Object with ScalaObject" id="11376">LooseFileSet</a> <span title="ScalaObject">{</span>
      <span class="keyword">var</span> <a title="Option[String]" id="133328">destination</a>: <span title="Option[String]">Option</span>[String] = <span title="object None">None</span>
      <span class="keyword">def</span> <a title="(dest: String)Unit" id="133330">setDestination</a>(<a title="String" id="133347">dest</a>: <span title="String">String</span>) = {
        <a href="#133328" title="(x$1: Option[String])Unit">destination</a> = <span title="(x: String)Some[String]">Some</span>(<a href="#133347" title="String">dest</a>)
      }
      
      <span class="keyword">var</span> <a title="Option[org.apache.tools.ant.types.FileSet]" id="133332">fileset</a>: <span title="Option[org.apache.tools.ant.types.FileSet]">Option</span>[FileSet] = <span title="object None">None</span>
      <span class="keyword">def</span> <a title="(fs: org.apache.tools.ant.types.FileSet)Unit" id="133334">addConfiguredFileSet</a>(<a title="org.apache.tools.ant.types.FileSet" id="133462">fs</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) = {
        <a href="#133332" title="(x$1: Option[org.apache.tools.ant.types.FileSet])Unit">fileset</a> = <span title="(x: org.apache.tools.ant.types.FileSet)Some[org.apache.tools.ant.types.FileSet]">Some</span>(<a href="#133462" title="org.apache.tools.ant.types.FileSet">fs</a>)
      }
    }
  /** An Ant task that generates a Scala Bazaars package (sbp file) along
    * with an advertisement of that package.
    *
    * This task can take the following parameters as attributes:&lt;ul&gt;
    *  &lt;li&gt;file (mandatory),&lt;/li&gt;
    *  &lt;li&gt;adfile,&lt;/li&gt;
    *  &lt;li&gt;name (mandatory),&lt;/li&gt;
    *  &lt;li&gt;version (mandatory),&lt;/li&gt;
    *  &lt;li&gt;depends,&lt;/li&gt;
    *  &lt;li&gt;description,&lt;/li&gt;
    *  &lt;li&gt;link.&lt;/li&gt;
    *  &lt;/ul&gt;
    * 
    * @author Gilles Dubochet */
  <span class="keyword">class</span> <a title="class ScalaBazaar extends org.apache.tools.ant.Task with ScalaObject" id="11259">ScalaBazaar</a> <span title="ScalaObject" class="keyword">extends</span> <a title="org.apache.tools.ant.Task" id="33097">Task</a> {
    
    /** The unique Ant file utilities instance to use in this task. */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="org.apache.tools.ant.util.FileUtils" id="133473">fileUtils</a> = <a title="object org.apache.tools.ant.util.FileUtils" id="34392">FileUtils</a>.<a title="()org.apache.tools.ant.util.FileUtils" id="35014">newFileUtils</a>()
    
/******************************************************************************\
**                             Ant user-properties                            **
\******************************************************************************/
    
    /** The path to the archive file. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[java.io.File]" id="133476">file</a>: <span title="Option[java.io.File]">Option</span>[File] = <span title="object None">None</span>
    /** The optional path to the advertisement file. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[java.io.File]" id="133479">adfile</a>: <span title="Option[java.io.File]">Option</span>[File] = <span title="object None">None</span>
    /** The name of the package. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[String]" id="133482">name</a>: <span title="Option[String]">Option</span>[String] = <span title="object None">None</span>
    /** The version number of the package. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[String]" id="133485">version</a>: <span title="Option[String]">Option</span>[String] = <span title="object None">None</span>
    /** An (optional) list of names of the packages it depends of. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="List[String]" id="133488">depends</a>: <a title="List[String]" id="7414">List</a>[String] = <span title="object Nil">Nil</span>
    /** An (optional) description of this package. */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[String]" id="133491">desc</a>: <span title="Option[String]">Option</span>[String] = <span title="object None">None</span>
    /** An (optional) URL link pointing to the location of the package */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[String]" id="133494">link</a>: <span title="Option[String]">Option</span>[String] = <span title="object None">None</span>
    
    /** The sets of files to include in the package */
    <span class="keyword">private</span> <span class="keyword">object</span> <a title="object ScalaBazaar.this.fileSetsMap" id="133496">fileSetsMap</a> <span title="ScalaObject" class="keyword">extends</span> <a title="scala.collection.DefaultMap[String,List[org.apache.tools.ant.types.FileSet]]" id="4357">DefaultMap</a>[String, List[FileSet]] {
      <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]" id="133543">content</a> = <span title="scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]" class="keyword">new</span> <a title="scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]" id="25113">HashMap</a>[String, List[FileSet]]()
      <span class="keyword">def</span> <a title="(key: String)Option[List[org.apache.tools.ant.types.FileSet]]" id="133545">get</a>(<a title="String" id="133556">key</a>: <span title="String">String</span>): <span title="Option[List[org.apache.tools.ant.types.FileSet]]">Option</span>[List[FileSet]] = <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<a title="(key: String)Option[List[org.apache.tools.ant.types.FileSet]]" id="44613">get</a>(<a href="#133556" title="String">key</a>)
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Int" id="133546">size</a>: <a title="Int" id="2198">Int</a> = <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<a title="=&gt; Int" id="44611">size</a>
      <span class="keyword">def</span> <a title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit" id="133547">update</a>(<a title="String" id="133568">key</a>: <span title="String">String</span>, <a title="org.apache.tools.ant.types.FileSet" id="133569">value</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) {
        <span title="Unit" class="keyword">if</span> (<a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<a title="(key: String)Boolean" id="44678">contains</a><span title="(x$1: Boolean)Boolean">(</span><a href="#133568" title="String">key</a>) &amp;&amp; <a href="#133543" title="(key: String)List[org.apache.tools.ant.types.FileSet]">content</a><span title="(x$1: AnyRef)Boolean">(</span><a href="#133568" title="String">key</a>) != <span title="object Nil">Nil</span>)
          <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<span title="(key: String,value: List[org.apache.tools.ant.types.FileSet])Unit">update</span>(<a href="#133568" title="String">key</a>, <a href="#133569" title="org.apache.tools.ant.types.FileSet">value</a> <a href="#133605" title="org.apache.tools.ant.types.FileSet">::</a> <a href="#133543" title="(key: String)List[org.apache.tools.ant.types.FileSet]">content</a><a title="(x: org.apache.tools.ant.types.FileSet)List[org.apache.tools.ant.types.FileSet]" id="24417">(</a><a href="#133568" title="String">key</a>))
        <span class="keyword">else</span> <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<span title="(key: String,value: List[org.apache.tools.ant.types.FileSet])Unit">update</span>(<a href="#133568" title="String">key</a>, <span title="(xs: org.apache.tools.ant.types.FileSet*)List[org.apache.tools.ant.types.FileSet]">List</span>(<a href="#133569" title="org.apache.tools.ant.types.FileSet">value</a>))
      }
      <span class="keyword">def</span> <a title="=&gt; List[(String, List[org.apache.tools.ant.types.FileSet])]" id="133548">fileSets</a> = <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<span title="=&gt; List[(String, List[org.apache.tools.ant.types.FileSet])]">toList</span>
      <span class="keyword">def</span> <a title="=&gt; Iterator[(String, List[org.apache.tools.ant.types.FileSet])]" id="133549">iterator</a> = <a href="#133543" title="=&gt; scala.collection.mutable.HashMap[String,List[org.apache.tools.ant.types.FileSet]]">content</a>.<a title="=&gt; Iterator[(String, List[org.apache.tools.ant.types.FileSet])]" id="44627">iterator</a>
    }
    
    
    
/******************************************************************************\
**                             Internal properties                            **
\******************************************************************************/

      
/******************************************************************************\
**                             Properties setters                             **
\******************************************************************************/
    
    /** Sets the file attribute. Used by Ant.
      * @param input The value of &lt;code&gt;file&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: java.io.File)Unit" id="133498">setFile</a>(<a title="java.io.File" id="133655">input</a>: <span title="java.io.File">File</span>) =
      <a href="#133476" title="(x$1: Option[java.io.File])Unit">file</a> = <span title="(x: java.io.File)Some[java.io.File]">Some</span>(<a href="#133655" title="java.io.File">input</a>)
      
    /** Sets the advertisement file attribute. Used by Ant.
      * @param input The value of &lt;code&gt;adfile&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: java.io.File)Unit" id="133499">setAdfile</a>(<a title="java.io.File" id="133665">input</a>: <span title="java.io.File">File</span>) =
      <a href="#133479" title="(x$1: Option[java.io.File])Unit">adfile</a> = <span title="(x: java.io.File)Some[java.io.File]">Some</span>(<a href="#133665" title="java.io.File">input</a>)
      
    /** Sets the name attribute of this package. Used by Ant.
      * @param input The value of &lt;code&gt;name&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: String)Unit" id="133500">setName</a>(<a title="String" id="133675">input</a>: <span title="String">String</span>) =
      <a href="#133482" title="(x$1: Option[String])Unit">name</a> = <span title="(x: String)Some[String]">Some</span>(<a href="#133675" title="String">input</a>)
      
    /** Sets the version attribute of this package. Used by Ant.
      * @param input The value of &lt;code&gt;version&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: String)Unit" id="133501">setVersion</a>(<a title="String" id="133685">input</a>: <span title="String">String</span>) =
      <a href="#133485" title="(x$1: Option[String])Unit">version</a> = <span title="(x: String)Some[String]">Some</span>(<a href="#133685" title="String">input</a>)
    
    /** Sets the depends attribute. Used by Ant.
      * @param input The value for &lt;code&gt;depends&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: String)Unit" id="133502">setDepends</a>(<a title="String" id="133695">input</a>: <span title="String">String</span>) = {
      <a href="#133488" title="(x$1: List[String])Unit">depends</a> = <a href="#133695" title="String">input</a>.<a title="(x$1: java.lang.String)Array[java.lang.String]" id="7112">split</a>(<span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span>).<span title="=&gt; List[java.lang.String]">toList</span>.<span title="(f: (java.lang.String) =&gt; Traversable[java.lang.String])(implicit bf: scala.collection.generic.BuilderFactory[java.lang.String,List[String],List[java.lang.String]])List[String]">flatMap</span> <a title="scala.collection.generic.BuilderFactory[java.lang.String,List[java.lang.String],List#Coll]" id="24472">{</a> s: <span title="String">String</span> =&gt;
        <span class="keyword">val</span> <a title="java.lang.String" id="133711">st</a> = <a href="#133710" title="String">s</a>.<a title="()java.lang.String" id="7120">trim</a>()
        (<span title="List[java.lang.String]" class="keyword">if</span> (<a href="#133711" title="(x$1: AnyRef)Boolean">st</a> != <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>) <span title="(xs: java.lang.String*)List[java.lang.String]">List</span>(<a href="#133711" title="java.lang.String">st</a>) <span class="keyword">else</span> <span title="object Nil">Nil</span>)
      }
    }
      
    /** Sets the description attribute of this package. Used by Ant.
      * @param input The value of &lt;code&gt;description&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: String)Unit" id="133503">setDesc</a>(<a title="String" id="133759">input</a>: <span title="String">String</span>) =
      <a href="#133491" title="(x$1: Option[String])Unit">desc</a> = <span title="(x: String)Some[String]">Some</span>(<a href="#133759" title="String">input</a>)

    /** Sets the link attribute of this package. Used by Ant.
      * @param input The value of &lt;code&gt;link&lt;/code&gt;. */
    <span class="keyword">def</span> <a title="(input: String)Unit" id="133504">setLink</a>(<a title="String" id="133769">input</a>: <span title="String">String</span>) =
      <a href="#133494" title="(x$1: Option[String])Unit">link</a> = <span title="(x: String)Some[String]">Some</span>(<a href="#133769" title="String">input</a>)

    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133505">addConfiguredLibset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133779">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="java.lang.String(&quot;lib&quot;)" class="string">&quot;lib&quot;</span>, <a href="#133779" title="org.apache.tools.ant.types.FileSet">input</a>)
    
    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133506">addConfiguredBinset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133784">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="java.lang.String(&quot;bin&quot;)" class="string">&quot;bin&quot;</span>, <a href="#133784" title="org.apache.tools.ant.types.FileSet">input</a>)
    
    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133507">addConfiguredSrcset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133789">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="java.lang.String(&quot;src&quot;)" class="string">&quot;src&quot;</span>, <a href="#133789" title="org.apache.tools.ant.types.FileSet">input</a>)
    
    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133508">addConfiguredManset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133794">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="java.lang.String(&quot;man&quot;)" class="string">&quot;man&quot;</span>, <a href="#133794" title="org.apache.tools.ant.types.FileSet">input</a>)
    
    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133509">addConfiguredDocset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133799">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;doc/&quot;</span> + <a href="#133512" title="=&gt; String">getName</a>, <a href="#133799" title="org.apache.tools.ant.types.FileSet">input</a>)
    
    <span class="keyword">def</span> <a title="(input: org.apache.tools.ant.types.FileSet)Unit" id="133510">addConfiguredMiscset</a>(<a title="org.apache.tools.ant.types.FileSet" id="133808">input</a>: <span title="org.apache.tools.ant.types.FileSet">FileSet</span>) =
      <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;misc/&quot;</span> + <a href="#133512" title="=&gt; String">getName</a>, <a href="#133808" title="org.apache.tools.ant.types.FileSet">input</a>)
      
    <span class="keyword">def</span> <a title="(set: scala.tools.ant.LooseFileSet)Unit" id="133511">addConfiguredLooseset</a>(<a title="scala.tools.ant.LooseFileSet" id="133815">set</a>: <a href="#11376" title="scala.tools.ant.LooseFileSet">LooseFileSet</a>) = {
      <a title="(x: Option[String],y: Option[org.apache.tools.ant.types.FileSet])(Option[String], Option[org.apache.tools.ant.types.FileSet])" id="7964">Pair</a>(<a href="#133815" title="scala.tools.ant.LooseFileSet">set</a>.<a href="#133328" title="=&gt; Option[String]">destination</a>, <a href="#133815" title="scala.tools.ant.LooseFileSet">set</a>.<a href="#133332" title="=&gt; Option[org.apache.tools.ant.types.FileSet]">fileset</a>) <span title="Unit" class="keyword">match</span> {
        <span title="Nothing" class="keyword">case</span> <a href="#133826" title="(x: (Option[String], Option[org.apache.tools.ant.types.FileSet]))Option[(Option[String], Option[org.apache.tools.ant.types.FileSet])]">Pair</a>(<span title="object None">None</span>, _) =&gt;
          <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;destination not specified for a loose file set&quot;)" class="string">&quot;destination not specified for a loose file set&quot;</span>)
        
        <span title="Nothing" class="keyword">case</span> <a href="#133841" title="(x: (Option[String], Option[org.apache.tools.ant.types.FileSet]))Option[(Option[String], Option[org.apache.tools.ant.types.FileSet])]">Pair</a>(_, <span title="object None">None</span>) =&gt; 
          <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;no files specified for a loose file set&quot;)" class="string">&quot;no files specified for a loose file set&quot;</span>)
          
        <span title="Unit" class="keyword">case</span> <a href="#133854" title="(x: (Option[String], Option[org.apache.tools.ant.types.FileSet]))Option[(Option[String], Option[org.apache.tools.ant.types.FileSet])]">Pair</a>(Some(<a title="String" id="133865">dest</a>), Some(<a title="org.apache.tools.ant.types.FileSet" id="133869">fileset</a>)) =&gt;
          <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133547" title="(key: String,value: org.apache.tools.ant.types.FileSet)Unit">update</a>(<a href="#133865" title="String">dest</a>, <a href="#133869" title="org.apache.tools.ant.types.FileSet">fileset</a>)
      }
    }

/******************************************************************************\
**                             Properties getters                             **
\******************************************************************************/
    
    /** Gets the value of the file attribute in a Scala-friendly form. 
      * @returns The file as a file. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; String" id="133512">getName</a>: <span title="String">String</span> =
      <span title="String" class="keyword">if</span> (<a href="#133482" title="=&gt; Option[String]">name</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Name attribute must be defined first.&quot;)" class="string">&quot;Name attribute must be defined first.&quot;</span>)
      <span class="keyword">else</span> <a href="#133482" title="=&gt; Option[String]">name</a>.<span title="=&gt; String">get</span>
      
    /** Gets the value of the file attribute in a Scala-friendly form. 
      * @returns The file as a file. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; java.io.File" id="133513">getFile</a>: <span title="java.io.File">File</span> =
      <span title="java.io.File" class="keyword">if</span> (<a href="#133476" title="=&gt; Option[java.io.File]">file</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Member 'file' is empty.&quot;)" class="string">&quot;Member 'file' is empty.&quot;</span>)
      <span class="keyword">else</span> <a href="#11259" title="()org.apache.tools.ant.Project">getProject</a>().<span title="(x$1: java.lang.String)java.io.File">resolveFile</span>(<a href="#133476" title="=&gt; Option[java.io.File]">file</a>.<span title="=&gt; java.io.File">get</span>.<span title="()java.lang.String">toString</span>())
      
    /** Gets the value of the adfile attribute in a Scala-friendly form. 
      * @returns The adfile as a file. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; java.io.File" id="133514">getAdfile</a>: <span title="java.io.File">File</span> =
      <span title="java.io.File" class="keyword">if</span> (<a href="#133479" title="=&gt; Option[java.io.File]">adfile</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Member 'adfile' is empty.&quot;)" class="string">&quot;Member 'adfile' is empty.&quot;</span>)
      <span class="keyword">else</span> <a href="#11259" title="()org.apache.tools.ant.Project">getProject</a>().<span title="(x$1: java.lang.String)java.io.File">resolveFile</span>(<a href="#133479" title="=&gt; Option[java.io.File]">adfile</a>.<span title="=&gt; java.io.File">get</span>.<span title="()java.lang.String">toString</span>())

/******************************************************************************\
**                       Compilation and support methods                      **
\******************************************************************************/
    /** Transforms a string name into a file relative to the provided base
      * directory.
      * @param base A file pointing to the location relative to which the name
      *   will be resolved.
      * @param name A relative or absolute path to the file as a string.
      * @return A file created from the name and the base file. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(base: java.io.File)(name: String)java.io.File" id="133515">nameToFile</a>(<a title="java.io.File" id="133923">base</a>: <span title="java.io.File">File</span>)(<a title="String" id="133924">name</a>: <span title="String">String</span>): <span title="java.io.File">File</span> =
      <a href="#133517" title="(file: java.io.File)java.io.File">existing</a>(<a href="#133473" title="=&gt; org.apache.tools.ant.util.FileUtils">fileUtils</a>.<a title="(x$1: java.io.File,x$2: java.lang.String)java.io.File" id="35110">resolveFile</a>(<a href="#133923" title="java.io.File">base</a>, <a href="#133924" title="String">name</a>))
    
    /** Transforms a string name into a file relative to the build root
      * directory.
      * @param name A relative or absolute path to the file as a string.
      * @return A file created from the name. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(name: String)java.io.File" id="133516">nameToFile</a>(<a title="String" id="133932">name</a>: <span title="String">String</span>): <span title="java.io.File">File</span> =
      <a href="#133517" title="(file: java.io.File)java.io.File">existing</a>(<a href="#11259" title="()org.apache.tools.ant.Project">getProject</a>().<span title="(x$1: java.lang.String)java.io.File">resolveFile</span>(<a href="#133932" title="String">name</a>))
    
    /** Tests if a file exists and prints a warning in case it doesn't. Always
      * returns the file, even if it doesn't exist.
      * @param file A file to test for existance.
      * @return The same file. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(file: java.io.File)java.io.File" id="133517">existing</a>(<a title="java.io.File" id="133926">file</a>: <span title="java.io.File">File</span>): <span title="java.io.File">File</span> = {
      <span title="Unit" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#133926" title="java.io.File">file</a>.<span title="()Boolean">exists</span>())
        <a href="#11259" title="(x$1: java.lang.String,x$2: Int)Unit">log</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;Element '&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#133926" title="java.io.File">file</a>.<span title="()java.lang.String">toString</span>() + <span title="java.lang.String(&quot;' does not exist.&quot;)" class="string">&quot;' does not exist.&quot;</span>,
            Project.<span title="Int(1)">MSG_WARN</span>)
      <a href="#133926" title="java.io.File">file</a>
    }
    
    /** Generates a build error. Error location will be the current task in the  
      * ant file.
      * @param message A message describing the error.
      * @throws BuildException A build error exception thrown in every case. */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(message: String)Nothing" id="133518">error</a>(<a title="String" id="133837">message</a>: <span title="String">String</span>): <a title="Nothing" id="3643">Nothing</a> =
      <span title="Nothing" class="keyword">throw</span> <a title="(x$1: java.lang.String,x$2: org.apache.tools.ant.Location)org.apache.tools.ant.BuildException" id="36814" class="keyword">new</a> <a title="org.apache.tools.ant.BuildException" id="33124">BuildException</a>(<a href="#133837" title="String">message</a>, <a href="#11259" title="()org.apache.tools.ant.Location" id="34673">getLocation</a>())
    
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(file: java.io.File,content: String)Unit" id="133519">writeFile</a>(<a title="java.io.File" id="133980">file</a>: <span title="java.io.File">File</span>, <a title="String" id="133981">content</a>: <span title="String">String</span>) =
      <span title="Unit" class="keyword">if</span> (<a href="#133980" title="java.io.File">file</a>.<span title="()Boolean">exists</span><span title="(x$1: Boolean)Boolean">(</span>) &amp;&amp; <span title="=&gt; Boolean">!</span><a href="#133980" title="java.io.File">file</a>.<a title="()Boolean" id="35380">canWrite</a>())
        <a href="#133518" title="(message: String)Nothing">error</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;File &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#133980" title="java.io.File">file</a> + <span title="java.lang.String(&quot; is not writable&quot;)" class="string">&quot; is not writable&quot;</span>)
      <span class="keyword">else</span> {
        <span class="keyword">val</span> <a title="java.io.FileWriter" id="133996">writer</a> = <a title="(x$1: java.io.File,x$2: Boolean)java.io.FileWriter" id="134004" class="keyword">new</a> <a title="java.io.FileWriter" id="3774">FileWriter</a>(<a href="#133980" title="java.io.File">file</a>, <span title="Boolean(false)" class="keyword">false</span>)
        <a href="#133996" title="java.io.FileWriter">writer</a>.<a title="(x$1: java.lang.String)Unit" id="41489">write</a>(<a href="#133981" title="String">content</a>)
        <a href="#133996" title="java.io.FileWriter">writer</a>.<a title="()Unit" id="134033">close</a>()
      }

/******************************************************************************\
**                           The big execute method                           **
\******************************************************************************/

    /** Performs the compilation. */
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="133520">execute</a>() = {
      // Tests if all mandatory attributes are set and valid.
      <span title="Unit" class="keyword">if</span> (<a href="#133476" title="=&gt; Option[java.io.File]">file</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Attribute 'file' is not set.&quot;)" class="string">&quot;Attribute 'file' is not set.&quot;</span>)
      <span title="Unit" class="keyword">if</span> (<a href="#133482" title="=&gt; Option[String]">name</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Attribute 'name' is not set.&quot;)" class="string">&quot;Attribute 'name' is not set.&quot;</span>)
      <span title="Unit" class="keyword">if</span> (<a href="#133485" title="=&gt; Option[String]">version</a>.<span title="=&gt; Boolean">isEmpty</span>) <a href="#133518" title="(message: String)Nothing">error</a>(<span title="java.lang.String(&quot;Attribute 'version' is not set.&quot;)" class="string">&quot;Attribute 'version' is not set.&quot;</span>)
      
      <span class="keyword">val</span> <a title="scala.xml.Elem" id="134068">pack</a> = {
        &lt;<a title="scala.xml.Elem" id="134384" class="keyword">package</a>&gt;
          &lt;<a title="scala.xml.Elem" id="134515">name</a>&gt;{<a href="#133482" title="=&gt; Option[String]">name</a>.<span title="=&gt; String">get</span>}&lt;/name&gt;
          &lt;<a title="scala.xml.Elem" id="134543">version</a>&gt;{<a href="#133485" title="=&gt; Option[String]">version</a>.<span title="=&gt; String">get</span>}&lt;/version&gt;{
            <span title="Any" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#133488" title="=&gt; List[String]">depends</a>.<span title="=&gt; Boolean">isEmpty</span>)
              &lt;<a title="scala.xml.Elem" id="134561">depends</a>&gt;{
                <span class="keyword">for</span> (<a title="String" id="134572">depend</a> &lt;- <a href="#133488" title="(f: (String) =&gt; scala.xml.Elem)(implicit bf: scala.collection.generic.BuilderFactory[scala.xml.Elem,Any,List[String]])Any">depends</a>) <span class="keyword">yield</span>
                  &lt;<a title="scala.xml.Elem" id="134573">name</a>&gt;{<a href="#134572" title="String">depend</a>}&lt;/name&gt;
              }&lt;/depends&gt;
            <span class="keyword">else</span> <span title="object Nil">Nil</span>
          }{
            <span title="Any" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#133491" title="=&gt; Option[String]">desc</a>.<span title="=&gt; Boolean">isEmpty</span>)
              &lt;<a title="scala.xml.Elem" id="134670">description</a>&gt;{<a href="#133491" title="=&gt; Option[String]">desc</a>.<span title="=&gt; String">get</span>}&lt;/description&gt;
            <span class="keyword">else</span> <span title="object Nil">Nil</span>
          }
        &lt;/<span class="keyword">package</span>&gt;
      }

      <a href="#11259" title="(x$1: java.lang.String)Unit" id="34944">log</a>(<span title="(x$1: Any)java.lang.String" class="string">&quot;Creating package '&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#133482" title="=&gt; Option[String]">name</a>.<span title="=&gt; String">get</span> + <span title="java.lang.String(&quot;'&quot;)" class="string">&quot;'&quot;</span>)
      
      // Creates the advert file
      <span class="keyword">val</span> <a title="scala.xml.Elem" id="134069">advert</a> = {
        &lt;<a title="scala.xml.Elem" id="134710">availablePackage</a>&gt;
          {<a href="#134068" title="scala.xml.Elem">pack</a>}
          {<a href="#133494" title="=&gt; Option[String]">link</a> <span title="Any" class="keyword">match</span> {
            <span title="scala.xml.Elem" class="keyword">case</span> <span title="object None">None</span> =&gt; &lt;<a title="scala.xml.Elem" id="134723">link</a>&gt;<a title="scala.xml.Text" id="40990">INSERT</a> LINK HERE&lt;/link&gt;
            <span title="scala.xml.Elem" class="keyword">case</span> Some(<a title="String" id="134733">str</a>) =&gt; &lt;<a title="scala.xml.Elem" id="134736">link</a>&gt;{<a href="#134733" title="String">str</a>}&lt;/link&gt;
          }}
        &lt;/availablePackage&gt;
      };
      
      <span title="Unit" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#133479" title="=&gt; Option[java.io.File]">adfile</a>.<span title="=&gt; Boolean">isEmpty</span>)
        <a href="#133519" title="(file: java.io.File,content: String)Unit">writeFile</a>(<a href="#133514" title="=&gt; java.io.File">getAdfile</a>, <a href="#134069" title="scala.xml.Elem">advert</a>.<span title="()String">toString</span>())
      
      // Checks for new files and creates the ZIP
      
      <span class="keyword">val</span> <a title="List[(String, java.io.File, java.lang.String)]" id="134070">zipContent</a> =
        <span class="keyword">for</span> {
          <a href="#134760" title="(x: (String, List[org.apache.tools.ant.types.FileSet]))Option[(String, List[org.apache.tools.ant.types.FileSet])]">Pair</a>(<a title="String" id="134796">folder</a>, <a title="List[org.apache.tools.ant.types.FileSet]" id="134797">fileSets</a>) &lt;- <a href="#133496" title="object ScalaBazaar.this.fileSetsMap">fileSetsMap</a>.<a href="#133548" title="(f: ((String, List[org.apache.tools.ant.types.FileSet])) =&gt; Traversable[(String, java.io.File, java.lang.String)])(implicit bf: scala.collection.generic.BuilderFactory[(String, java.io.File, java.lang.String),List[(String, java.io.File, java.lang.String)],List[(String, List[org.apache.tools.ant.types.FileSet])]])List[(String, java.io.File, java.lang.String)]">fileSets</a>
          <a title="org.apache.tools.ant.types.FileSet" id="134807">fileSet</a> &lt;- <a href="#134797" title="(f: (org.apache.tools.ant.types.FileSet) =&gt; Traversable[(String, java.io.File, java.lang.String)])(implicit bf: scala.collection.generic.BuilderFactory[(String, java.io.File, java.lang.String),List[(String, java.io.File, java.lang.String)],List[org.apache.tools.ant.types.FileSet]])List[(String, java.io.File, java.lang.String)]">fileSets</a>
          <a title="java.lang.String" id="134825">file</a> &lt;- <a href="#134807" title="org.apache.tools.ant.types.FileSet">fileSet</a>.<a title="(x$1: org.apache.tools.ant.Project)org.apache.tools.ant.DirectoryScanner" id="133398">getDirectoryScanner</a>(<a href="#11259" title="()org.apache.tools.ant.Project">getProject</a>).<a title="()Array[java.lang.String]" id="36583">getIncludedFiles</a>.<span title="(f: (java.lang.String) =&gt; (String, java.io.File, java.lang.String))(implicit bf: scala.collection.generic.BuilderFactory[(String, java.io.File, java.lang.String),List[(String, java.io.File, java.lang.String)],List[java.lang.String]])List[(String, java.io.File, java.lang.String)]">toList</span>
        } <span class="keyword">yield</span> <a title="(x: String,y: java.io.File,z: java.lang.String)(String, java.io.File, java.lang.String)" id="7980">Triple</a>(<a href="#134796" title="String">folder</a>, <a href="#134807" title="org.apache.tools.ant.types.FileSet">fileSet</a>.<a title="(x$1: org.apache.tools.ant.Project)java.io.File" id="133365">getDir</a>(<a href="#11259" title="()org.apache.tools.ant.Project">getProject</a>), <a href="#134825" title="java.lang.String">file</a>)
      <span class="keyword">val</span> <a title="java.util.zip.ZipOutputStream" id="134071">zip</a> = <span title="java.util.zip.ZipOutputStream" class="keyword">new</span> <a title="java.util.zip.ZipOutputStream" id="40747">ZipOutputStream</a>(<a title="(x$1: java.io.File,x$2: Boolean)java.io.FileOutputStream" id="131654" class="keyword">new</a> <a title="java.io.FileOutputStream" id="3969">FileOutputStream</a>(<a href="#133476" title="=&gt; Option[java.io.File]">file</a>.<span title="=&gt; java.io.File">get</span>, <span title="Boolean(false)" class="keyword">false</span>))
      <span title="Unit" class="keyword">if</span> (<span title="=&gt; Boolean">!</span><a href="#134070" title="List[(String, java.io.File, java.lang.String)]">zipContent</a>.<span title="=&gt; Boolean">isEmpty</span>) {
        <span class="keyword">for</span> (<a href="#135130" title="(x: (String, java.io.File, java.lang.String))Option[(String, java.io.File, java.lang.String)]">Triple</a>(<a title="String" id="135180">destFolder</a>, <a title="java.io.File" id="135181">srcFolder</a>, <a title="java.lang.String" id="135182">file</a>) &lt;- <a href="#134070" title="(f: ((String, java.io.File, java.lang.String)) =&gt; Unit)Unit" id="29118">zipContent</a>) {
          <a href="#11259" title="(x$1: java.lang.String,x$2: Int)Unit">log</a>(<a href="#135182" title="java.lang.String">file</a>, Project.<span title="Int(4)">MSG_DEBUG</span>)
          <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<span title="(x$1: java.util.zip.ZipEntry)Unit">putNextEntry</span>(<span title="java.util.zip.ZipEntry" class="keyword">new</span> <span title="java.util.zip.ZipEntry">ZipEntry</span>(<a href="#135180" title="(x$1: Any)java.lang.String">destFolder</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span> + <a href="#135182" title="java.lang.String">file</a>))
          <span class="keyword">val</span> <a title="java.io.FileInputStream" id="135184">input</a> = <a title="(x$1: java.io.File)java.io.FileInputStream" id="111824" class="keyword">new</a> <a title="java.io.FileInputStream" id="3981">FileInputStream</a>(<a href="#133515" title="(base: java.io.File)(name: String)java.io.File">nameToFile</a>(<a href="#135181" title="java.io.File">srcFolder</a>)(<a href="#135182" title="java.lang.String">file</a>))
          <span class="keyword">val</span> <a title="Array[Byte]" id="135185">buf</a> = <span title="Array[Byte]" class="keyword">new</span> <a title="Array[Byte]" id="905">Array</a>[Byte](<span title="Int(10240)" class="int">10240</span>)
          <span class="keyword">var</span> <a title="Int" id="135186">n</a> = <a href="#135184" title="java.io.FileInputStream">input</a>.<span title="(x$1: Array[Byte],x$2: Int,x$3: Int)Int">read</span>(<a href="#135185" title="Array[Byte]">buf</a>, <span title="Int(0)" class="int">0</span>, <a href="#135185" title="Array[Byte]">buf</a>.<span title="=&gt; Int">length</span>)
          <span title="Unit" class="keyword">while</span> (<a href="#135186" title="(x$1: Int)Boolean" id="2983">n</a> &gt;= <span title="Int(0)" class="int">0</span>) <a href="#135187" title="()Unit">{</a>
            <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<a title="(x$1: Array[Byte],x$2: Int,x$3: Int)Unit" id="131546">write</a> (<a href="#135185" title="Array[Byte]">buf</a>, <span title="Int(0)" class="int">0</span>, <a href="#135186" title="Int">n</a>)
            <a href="#135186" title="Int">n</a> = <a href="#135184" title="java.io.FileInputStream">input</a>.<span title="(x$1: Array[Byte],x$2: Int,x$3: Int)Int">read</span>(<a href="#135185" title="Array[Byte]">buf</a>, <span title="Int(0)" class="int">0</span>, <a href="#135185" title="Array[Byte]">buf</a>.<span title="=&gt; Int">length</span>)
          }
          <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<span title="()Unit">closeEntry</span>()
          <a href="#135184" title="java.io.FileInputStream">input</a>.<a title="()Unit" id="111838">close</a>()
        }
      } <span class="keyword">else</span> <a href="#11259" title="(x$1: java.lang.String,x$2: Int)Unit">log</a>(<span title="java.lang.String(&quot;Archive contains no files.&quot;)" class="string">&quot;Archive contains no files.&quot;</span>, Project.<span title="Int(3)">MSG_VERBOSE</span>)
      <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<span title="(x$1: java.util.zip.ZipEntry)Unit">putNextEntry</span>(<span title="java.util.zip.ZipEntry" class="keyword">new</span> <span title="java.util.zip.ZipEntry">ZipEntry</span>(<span title="java.lang.String(&quot;meta/description&quot;)" class="string">&quot;meta/description&quot;</span>))
      <span class="keyword">val</span> <a title="java.io.StringReader" id="134072">packInput</a> = <span title="java.io.StringReader" class="keyword">new</span> <a title="java.io.StringReader" id="3729">StringReader</a>(<a href="#134068" title="scala.xml.Elem">pack</a>.<span title="()String">toString</span>())
      <span class="keyword">var</span> <a title="Int" id="134073">byte</a> = <a href="#134072" title="java.io.StringReader">packInput</a>.<span title="()Int">read</span>()
      <span title="Unit" class="keyword">while</span> (<a href="#134073" title="(x$1: Int)Boolean" id="2975">byte</a> != <span title="Int(-1)">-</span><span class="int">1</span>) <a href="#134074" title="()Unit">{</a>
        <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<a title="(x$1: Int)Unit" id="131566">write</a> (<a href="#134073" title="Int">byte</a>)
        <a href="#134073" title="Int">byte</a> = <a href="#134072" title="java.io.StringReader">packInput</a>.<span title="()Int">read</span>()
      }
      <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<span title="()Unit">closeEntry</span>()
      <a href="#134072" title="java.io.StringReader">packInput</a>.<a title="()Unit" id="135306">close</a>()
      <a href="#134071" title="java.util.zip.ZipOutputStream">zip</a>.<a title="()Unit" id="131551">close</a>
    }
  
  }
  
}

        </pre>
    </body>
</html>