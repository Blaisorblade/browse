<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/actors/remote/TcpService.scala</title>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/*                     __                                               *\
**     ________ ___   / /  ___     Scala API                            **
**    / __/ __// _ | / /  / _ |    (c) 2005-2009, LAMP/EPFL             **
**  __\ \/ /__/ __ |/ /__/ __ |    http://scala-lang.org/               **
** /____/\___/_/ |_/____/_/ | |                                         **
**                          |/                                          **
\*                                                                      */</span>

<span class="comment">// $Id: TcpService.scala 17017 2009-02-02 21:35:37Z phaller $</span>


<span class="keyword">package</span> scala.actors.remote


<span class="keyword">import</span> java.io.{DataInputStream, DataOutputStream, IOException}
<span class="keyword">import</span> java.lang.{Thread, SecurityException}
<span class="keyword">import</span> java.net.{InetAddress, ServerSocket, Socket, UnknownHostException}

<span class="keyword">import</span> scala.collection.mutable.HashMap
<span class="keyword">import</span> scala.util.Random

<span class="comment">/* Object TcpService.
 *
 * @version 0.9.9
 * @author Philipp Haller
 */</span>
<span class="keyword">object</span> <span class="typed"><span class="type">object scala.actors.remote.TcpService</span><a id="8351">TcpService</a></span> {
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">scala.util.Random</span><span id="40023"><a id="40022">random</a></span></span> = <span class="typed"><span class="type">()scala.util.Random</span><a href="../../util/Random.scala.html#90024" class="keyword">new</a></span> <span class="typed"><span class="type">scala.util.Random</span><a href="../../util/Random.scala.html#6729">Random</a></span>
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">scala.collection.mutable.HashMap[Int,scala.actors.remote.TcpService]</span><span id="40025"><a id="40024">ports</a></span></span> = <span class="typed"><span class="type">scala.collection.mutable.HashMap[Int,scala.actors.remote.TcpService]</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.collection.mutable.HashMap[Int,scala.actors.remote.TcpService]</span><a href="../../collection/mutable/HashMap.scala.html#11326">HashMap</a></span>[Int, TcpService]

  <span class="keyword">def</span> <span class="typed"><span class="type">(Int,java.lang.ClassLoader)scala.actors.remote.TcpService</span><a id="40026">apply</a></span>(<span class="typed"><span class="type">Int</span><a id="40031">port</a></span>: <span class="typed"><span class="type">Int</span><a id="2392">Int</a></span>, <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="40032">cl</a></span>: <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="1724">ClassLoader</a></span>): <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350">TcpService</a></span> =
    <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[Int,scala.actors.remote.TcpService]</span><a href="#40024">ports</a></span>.<span class="typed"><span class="type">(Int)Option[scala.actors.remote.TcpService]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">Int</span><a href="#40031">port</a></span>) <span class="typed"><span class="type">scala.actors.remote.TcpService</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">scala.actors.remote.TcpService</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">scala.actors.remote.TcpService</span><a id="111524">service</a></span>) =&gt;
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111524">service</a></span>
      <span class="typed"><span class="type">scala.actors.remote.TcpService</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a href="../../Option.scala.html#534">None</a></span> =&gt;
        <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a id="111525">service</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpService</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350">TcpService</a></span>(<span class="typed"><span class="type">Int</span><a href="#40031">port</a></span>, <span class="typed"><span class="type">java.lang.ClassLoader</span><a href="#40032">cl</a></span>)
        <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[Int,scala.actors.remote.TcpService]</span><a href="#40024">ports</a></span> <span class="typed"><span class="type">((Int, scala.actors.remote.TcpService))Unit</span><a href="../../collection/mutable/Map.scala.html#21351">+=</a></span> <span class="typed"><span class="type">(Int,scala.actors.remote.TcpService)(Int, scala.actors.remote.TcpService)</span><a href="../../Predef.scala.html#27947">Pair</a></span>(<span class="typed"><span class="type">Int</span><a href="#40031">port</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111525">service</a></span>)
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111525">service</a></span>.<span class="typed"><span class="type">()Unit</span><a id="20759">start</a></span>()
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;created service at &quot;)</span><span class="string">&quot;created service at &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111525">service</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#40042">node</a></span>)
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111525">service</a></span>
    }

  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Int</span><a id="40027">generatePort</a></span>: <span class="typed"><span class="type">Int</span><a id="2392">Int</a></span> = {
    <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><a id="111533">portnum</a></span> = <span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">Int</span><a href="#111533">portnum</a></span> = <span class="typed"><span class="type">Int(8000)</span><span class="int">8000</span></span> <span class="typed"><span class="type">(Int)Int</span><a id="3145">+</a></span> <span class="typed"><span class="type">=&gt; scala.util.Random</span><a href="#40022">random</a></span>.<span class="typed"><span class="type">(Int)Int</span><a href="../../util/Random.scala.html#90030">nextInt</a></span>(<span class="typed"><span class="type">Int(500)</span><span class="int">500</span></span>)
      <span class="keyword">val</span> <span class="typed"><span class="type">java.net.ServerSocket</span><a id="111534">socket</a></span> = <span class="typed"><span class="type">(Int)java.net.ServerSocket</span><a id="111556" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.ServerSocket</span><a id="4524">ServerSocket</a></span>(<span class="typed"><span class="type">Int</span><a href="#111533">portnum</a></span>)
      <span class="typed"><span class="type">java.net.ServerSocket</span><a href="#111534">socket</a></span>.<span class="typed"><span class="type">()Unit</span><a id="111568">close</a></span>()
    }
    <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Int</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="111732">ioe</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3517">IOException</a></span> =&gt;
        <span class="comment">// this happens when trying to open a socket twice</span>
        <span class="comment">// at the same port</span>
        <span class="comment">// try again</span>
        <span class="typed"><span class="type">=&gt; Int</span><a href="#40027">generatePort</a></span>
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="111733">se</a></span>: <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1856">SecurityException</a></span> =&gt;
        <span class="comment">// do nothing</span>
    }
    <span class="typed"><span class="type">Int</span><a href="#111533">portnum</a></span>
  }

  <span class="keyword">var</span> <span class="typed"><span class="type">Int</span><span id="40030"><span id="40028"><span id="40029"><a id="111523">BufSize</a></span></span></span></span>: <span class="typed"><span class="type">Int</span><a id="2392">Int</a></span> = <span class="typed"><span class="type">Int(65536)</span><span class="int">65536</span></span>
}

<span class="comment">/* Class TcpService.
 *
 * @version 0.9.10
 * @author Philipp Haller
 */</span>
<span class="keyword">class</span> <span class="typed"><span class="type">class TcpService extends java.lang.Thread with scala.actors.remote.Service with ScalaObject</span><a id="8350">TcpService</a></span>(<span class="typed"><span class="type">Int</span><span id="40035"><a id="111526">port</a></span></span>: <span class="typed"><span class="type">Int</span><a id="2392">Int</a></span>, <span class="typed"><span class="type">java.lang.ClassLoader</span><span id="40036"><a id="111527">cl</a></span></span>: <span class="typed"><span class="type">java.lang.ClassLoader</span><a id="1724">ClassLoader</a></span>) <span class="keyword">extends</span> <span class="typed"><span class="type">java.lang.Thread</span><a id="2081">Thread</a></span> <span class="keyword">with</span> <span class="typed"><span class="type">scala.actors.remote.Service</span><a href="Service.scala.html#8266">Service</a></span> {
  <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.JavaSerializer</span><span id="40039"><a id="40038">serializer</a></span></span>: <span class="typed"><span class="type">scala.actors.remote.JavaSerializer</span><a href="JavaSerializer.scala.html#8338">JavaSerializer</a></span> = <span class="typed"><span class="type">scala.actors.remote.JavaSerializer</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.actors.remote.JavaSerializer</span><a href="JavaSerializer.scala.html#8338">JavaSerializer</a></span>(<span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350" class="keyword">this</a></span>, <span class="typed"><span class="type">java.lang.ClassLoader</span><a href="#40036">cl</a></span>)

  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.Node</span><span id="40041"><a id="40040">internalNode</a></span></span> = <span class="typed"><span class="type">scala.actors.remote.Node</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>(<span class="typed"><span class="type">object java.net.InetAddress</span><a id="4645">InetAddress</a></span>.<span class="typed"><span class="type">()java.net.InetAddress</span><a id="111627">getLocalHost</a></span>().<span class="typed"><span class="type">()java.lang.String</span><a id="111618">getHostAddress</a></span>(), <span class="typed"><span class="type">Int</span><a href="#40035">port</a></span>)
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a id="40042">node</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span> = <span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#40040">internalNode</a></span>

  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><span id="40044"><a id="40043">pendingSends</a></span></span> = <span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="../../collection/mutable/HashMap.scala.html#11326">HashMap</a></span>[Node, List[Array[Byte]]]

  <span class="comment">/**
   * Sends a byte array to another node on the network.
   * If the node is not yet up, up to &lt;code&gt;TcpService.BufSize&lt;/code&gt;
   * messages are buffered.
   */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node,Array[Byte])Unit</span><a id="40045">send</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111759">node</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>, <span class="typed"><span class="type">Array[Byte]</span><a id="111760">data</a></span>: <span class="typed"><span class="type">Array[Byte]</span><a href="../../Array.scala.html#1070">Array</a></span>[Byte]): <span class="typed"><span class="type">Unit</span><a id="2167">Unit</a></span> = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8350" id="5794">synchronized</a></span> {

    <span class="keyword">def</span> <span class="typed"><span class="type">(Throwable)Unit</span><a id="111762">bufferMsg</a></span>(<span class="typed"><span class="type">Throwable</span><a id="111763">t</a></span>: <span class="typed"><span class="type">Throwable</span><a id="2141">Throwable</a></span>) {
      <span class="comment">// buffer message, so that it can be re-sent</span>
      <span class="comment">// when remote net kernel comes up</span>
      (<span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="#40043">pendingSends</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Option[List[Array[Byte]]]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>): @<span class="typed"><span class="type">Option[List[Array[Byte]]] @unchecked</span><a href="../../Option.scala.html#932">unchecked</a></span>) <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
        <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a href="../../Option.scala.html#534">None</a></span> =&gt;
          <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="#40043">pendingSends</a></span> <span class="typed"><span class="type">((scala.actors.remote.Node, List[Array[Byte]]))Unit</span><a href="../../collection/mutable/Map.scala.html#21351">+=</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node,List[Array[Byte]])(scala.actors.remote.Node, List[Array[Byte]])</span><a href="../../Predef.scala.html#27947">Pair</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>, <span class="typed"><span class="type">(Array[Byte]*)List[Array[Byte]]</span><a href="../../List.scala.html#16977">List</a></span>(<span class="typed"><span class="type">Array[Byte]</span><a href="#111760">data</a></span>))
        <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">List[Array[Byte]]</span><a id="111769">msgs</a></span>) <span class="keyword">if</span> <span class="typed"><span class="type">List[Array[Byte]]</span><a href="#111769">msgs</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="../../List.scala.html#20887">length</a></span> <span class="typed"><span class="type">(Int)Boolean</span><a id="3141">&lt;</a></span> <span class="typed"><span class="type">object scala.actors.remote.TcpService</span><a href="#8351">TcpService</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="#40028">BufSize</a></span> =&gt;
          <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="#40043">pendingSends</a></span> <span class="typed"><span class="type">((scala.actors.remote.Node, List[Array[Byte]]))Unit</span><a href="../../collection/mutable/Map.scala.html#21351">+=</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node,List[Array[Byte]])(scala.actors.remote.Node, List[Array[Byte]])</span><a href="../../Predef.scala.html#27947">Pair</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>, <span class="typed"><span class="type">Array[Byte]</span><a href="#111760">data</a></span> <span class="typed"><span class="type">(Array[Byte])List[Array[Byte]]</span><a href="../../List.scala.html#20872">::</a></span> <span class="typed"><span class="type">List[Array[Byte]]</span><a href="#111769">msgs</a></span>)
      }
    }

    <span class="comment">// retrieve worker thread (if any) that already has connection</span>
    <span class="typed"><span class="type">(scala.actors.remote.Node)Option[scala.actors.remote.TcpServiceWorker]</span><a href="#40054">getConnection</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>) <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a href="../../Option.scala.html#534">None</a></span> =&gt;
        <span class="comment">// we are not connected, yet</span>
        <span class="keyword">try</span> {
          <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111805">newWorker</a></span> = <span class="typed"><span class="type">(scala.actors.remote.Node)scala.actors.remote.TcpServiceWorker</span><a href="#40056">connect</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>)
          <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111805">newWorker</a></span> <span class="typed"><span class="type">(Array[Byte])Unit</span><a href="#111799">transmit</a></span> <span class="typed"><span class="type">Array[Byte]</span><a href="#111760">data</a></span>

          <span class="comment">// any pending sends?</span>
          <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="#40043">pendingSends</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Option[List[Array[Byte]]]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>) <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
            <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a href="../../Option.scala.html#534">None</a></span> =&gt;
              <span class="comment">// do nothing</span>
            <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">List[Array[Byte]]</span><a id="111808">msgs</a></span>) =&gt;
              <span class="typed"><span class="type">List[Array[Byte]]</span><a href="#111808">msgs</a></span> <span class="typed"><span class="type">((Array[Byte]) =&gt; Unit)Unit</span><a href="../../List.scala.html#20910">foreach</a></span> {<span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111805">newWorker</a></span> <span class="typed"><span class="type">(Array[Byte])Unit</span><a href="#111799">transmit</a></span> <span class="typed"><span class="type">Array[Byte]</span><a href="#111810">_</a></span>}
              <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,List[Array[Byte]]]</span><a href="#40043">pendingSends</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="../../collection/mutable/HashMap.scala.html#21381">-=</a></span> <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111759">node</a></span>
          }
        } <span class="keyword">catch</span> {
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.net.UnknownHostException</span><a id="111812">uhe</a></span>: <span class="typed"><span class="type">java.net.UnknownHostException</span><a id="4380">UnknownHostException</a></span> =&gt;
            <span class="typed"><span class="type">(Throwable)Unit</span><a href="#111762">bufferMsg</a></span>(<span class="typed"><span class="type">java.net.UnknownHostException</span><a href="#111812">uhe</a></span>)
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="111815">ioe</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3517">IOException</a></span> =&gt;
            <span class="typed"><span class="type">(Throwable)Unit</span><a href="#111762">bufferMsg</a></span>(<span class="typed"><span class="type">java.io.IOException</span><a href="#111815">ioe</a></span>)
          <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="111816">se</a></span>: <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1856">SecurityException</a></span> =&gt;
            <span class="comment">// do nothing</span>
        }
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111817">worker</a></span>) =&gt;
        <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111817">worker</a></span> <span class="typed"><span class="type">(Array[Byte])Unit</span><a href="#111799">transmit</a></span> <span class="typed"><span class="type">Array[Byte]</span><a href="#111760">data</a></span>
    }
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="40046">terminate</a></span>() {
    <span class="typed"><span class="type">(Boolean)Unit</span><a href="#40048">shouldTerminate</a></span> = <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">(java.lang.String,Int)java.net.Socket</span><a id="111822" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.Socket</span><a id="4401">Socket</a></span>(<span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#40040">internalNode</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="RemoteActor.scala.html#40104">address</a></span>, <span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#40040">internalNode</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="RemoteActor.scala.html#40106">port</a></span>)
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.net.ConnectException</span><a id="111887">ce</a></span>: java.net.<span class="typed"><span class="type">java.net.ConnectException</span><a id="4599">ConnectException</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.net.ConnectException</span><a href="#111887">ce</a></span>)
    }
  }

  <span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">Boolean</span><span id="40049"><span id="40047"><span id="40048"><a id="111745">shouldTerminate</a></span></span></span></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>

  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="40050">run</a></span>() {
    <span class="keyword">try</span> {
      <span class="keyword">val</span> <span class="typed"><span class="type">java.net.ServerSocket</span><a id="111896">socket</a></span> = <span class="typed"><span class="type">(Int)java.net.ServerSocket</span><a id="111556" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.ServerSocket</span><a id="4524">ServerSocket</a></span>(<span class="typed"><span class="type">Int</span><a href="#40035">port</a></span>)
      <span class="typed"><span class="type">Unit</span><a href="#111898" class="keyword">while</a></span> (<span class="typed"><span class="type">=&gt; Boolean</span><a id="2745">!</a></span><span class="typed"><span class="type">=&gt; Boolean</span><a href="#40047">shouldTerminate</a></span>) {
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: waiting for new connection...&quot;)</span><span class="string">&quot;: waiting for new connection...&quot;</span></span>)
        <span class="keyword">val</span> <span class="typed"><span class="type">java.net.Socket</span><a id="111899">nextClient</a></span> = <span class="typed"><span class="type">java.net.ServerSocket</span><a href="#111896">socket</a></span>.<span class="typed"><span class="type">()java.net.Socket</span><a id="111566">accept</a></span>()
        <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; Boolean</span><a id="2745">!</a></span><span class="typed"><span class="type">=&gt; Boolean</span><a href="#40047">shouldTerminate</a></span>) {
          <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111904">worker</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#8323">TcpServiceWorker</a></span>(<span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350" class="keyword">this</a></span>, <span class="typed"><span class="type">java.net.Socket</span><a href="#111899">nextClient</a></span>)
          <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;Started new &quot;)</span><span class="string">&quot;Started new &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111904">worker</a></span>)
          <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111904">worker</a></span>.<span class="typed"><span class="type">=&gt; Unit</span><a href="#111798">readNode</a></span>
          <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111904">worker</a></span>.<span class="typed"><span class="type">()Unit</span><a id="20759">start</a></span>()
        } <span class="keyword">else</span>
          <span class="typed"><span class="type">java.net.Socket</span><a href="#111899">nextClient</a></span>.<span class="typed"><span class="type">()Unit</span><a id="111866">close</a></span>()
      }
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="111919">ioe</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3517">IOException</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.io.IOException</span><a href="#111919">ioe</a></span>)
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="111924">sec</a></span>: <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1856">SecurityException</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.lang.SecurityException</span><a href="#111924">sec</a></span>)
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Exception</span><a id="111929">e</a></span>: <span class="typed"><span class="type">Exception</span><a id="2129">Exception</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">Exception</span><a href="#111929">e</a></span>)
    } <span class="keyword">finally</span> {
      <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: shutting down...&quot;)</span><span class="string">&quot;: shutting down...&quot;</span></span>)

      <span class="keyword">var</span> <span class="typed"><span class="type">List[scala.actors.remote.TcpServiceWorker]</span><a id="111934">workers</a></span>: <span class="typed"><span class="type">List[scala.actors.remote.TcpServiceWorker]</span><a href="../../List.scala.html#524">List</a></span>[TcpServiceWorker] = <span class="typed"><span class="type">object Nil</span><a href="../../List.scala.html#333">List</a></span>()
      <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span>.<span class="typed"><span class="type">=&gt; Iterator[scala.actors.remote.TcpServiceWorker]</span><a href="../../collection/Map.scala.html#21396">values</a></span> <span class="typed"><span class="type">((scala.actors.remote.TcpServiceWorker) =&gt; Unit)Unit</span><a href="../../Iterator.scala.html#20001">foreach</a></span> { <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111941">w</a></span> =&gt; <span class="typed"><span class="type">List[scala.actors.remote.TcpServiceWorker]</span><a href="#111934">workers</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111941">w</a></span> <span class="typed"><span class="type">(scala.actors.remote.TcpServiceWorker)List[scala.actors.remote.TcpServiceWorker]</span><a href="../../List.scala.html#20872">::</a></span> <span class="typed"><span class="type">List[scala.actors.remote.TcpServiceWorker]</span><a href="#111934">workers</a></span> }
      <span class="typed"><span class="type">List[scala.actors.remote.TcpServiceWorker]</span><a href="#111934">workers</a></span> <span class="typed"><span class="type">((scala.actors.remote.TcpServiceWorker) =&gt; Unit)Unit</span><a href="../../List.scala.html#20910">foreach</a></span> { <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111947">w</a></span> =&gt; <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111947">w</a></span>.<span class="typed"><span class="type">=&gt; Unit</span><a href="#111803">halt</a></span> }
    }
  }

  <span class="comment">// connection management</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><span id="40052"><a id="40051">connections</a></span></span> =
    <span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><span class="keyword">new</span></span> scala.collection.mutable.<span class="typed"><span class="type">scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="../../collection/mutable/HashMap.scala.html#11326">HashMap</a></span>[Node, TcpServiceWorker]

  <span class="keyword">private</span>[actors] <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker)Unit</span><a id="40053">addConnection</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111911">node</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111912">worker</a></span>: <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#8323">TcpServiceWorker</a></span>) = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span> <span class="typed"><span class="type">((scala.actors.remote.Node, scala.actors.remote.TcpServiceWorker))Unit</span><a href="../../collection/mutable/Map.scala.html#21351">+=</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker)(scala.actors.remote.Node, scala.actors.remote.TcpServiceWorker)</span><a href="../../Predef.scala.html#27947">Pair</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111911">node</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111912">worker</a></span>)
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Option[scala.actors.remote.TcpServiceWorker]</span><a id="40054">getConnection</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111778">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>) = <span class="typed"><span class="type">(Option[scala.actors.remote.TcpServiceWorker])Option[scala.actors.remote.TcpServiceWorker]</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Option[scala.actors.remote.TcpServiceWorker]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111778">n</a></span>)
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Boolean</span><a id="40055">isConnected</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111951">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2168">Boolean</a></span> = <span class="typed"><span class="type">(Boolean)Boolean</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">=&gt; Boolean</span><a id="2745">!</a></span><span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Option[scala.actors.remote.TcpServiceWorker]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111951">n</a></span>).<span class="typed"><span class="type">=&gt; Boolean</span><a href="../../Option.scala.html#18268">isEmpty</a></span>
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)scala.actors.remote.TcpServiceWorker</span><a id="40056">connect</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111806">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>): <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#8323">TcpServiceWorker</a></span> = <span class="typed"><span class="type">(scala.actors.remote.TcpServiceWorker)scala.actors.remote.TcpServiceWorker</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="keyword">val</span> <span class="typed"><span class="type">java.net.Socket</span><a id="111954">sock</a></span> = <span class="typed"><span class="type">(java.lang.String,Int)java.net.Socket</span><a id="111822" class="keyword">new</a></span> <span class="typed"><span class="type">java.net.Socket</span><a id="4401">Socket</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111806">n</a></span>.<span class="typed"><span class="type">=&gt; String</span><a href="RemoteActor.scala.html#40104">address</a></span>, <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111806">n</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="RemoteActor.scala.html#40106">port</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111955">worker</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><span class="keyword">new</span></span> <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#8323">TcpServiceWorker</a></span>(<span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350" class="keyword">this</a></span>, <span class="typed"><span class="type">java.net.Socket</span><a href="#111954">sock</a></span>)
    <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111955">worker</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="#111797">sendNode</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111806">n</a></span>)
    <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111955">worker</a></span>.<span class="typed"><span class="type">()Unit</span><a id="20759">start</a></span>()
    <span class="typed"><span class="type">(scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker)Unit</span><a href="#40053">addConnection</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111806">n</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111955">worker</a></span>)
    <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111955">worker</a></span>
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a id="40057">disconnectNode</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111967">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>) = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node)Option[scala.actors.remote.TcpServiceWorker]</span><a href="../../collection/mutable/DefaultMapModel.scala.html#21440">get</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111967">n</a></span>) <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">object None</span><a href="../../Option.scala.html#534">None</a></span> =&gt; <span class="typed"><span class="type">Unit</span><span >{</span></span>
        <span class="comment">// do nothing</span>
      }
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <a id="1">Some</a>(<span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a id="111970">worker</a></span>) =&gt; {
        <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="../../collection/mutable/HashMap.scala.html#21381">-=</a></span> <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111967">n</a></span>
        <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#111970">worker</a></span>.<span class="typed"><span class="type">=&gt; Unit</span><a href="#111803">halt</a></span>
      }
    }
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Boolean</span><a id="40058">isReachable</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111972">node</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>): <span class="typed"><span class="type">Boolean</span><a id="2168">Boolean</a></span> =
    <span class="typed"><span class="type">Boolean</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">(scala.actors.remote.Node)Boolean</span><a href="#40055">isConnected</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111972">node</a></span>)) <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
    <span class="keyword">else</span> <span class="keyword">try</span> {
      <span class="typed"><span class="type">(scala.actors.remote.Node)scala.actors.remote.TcpServiceWorker</span><a href="#40056">connect</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111972">node</a></span>)
      <span class="typed"><span class="type">Nothing</span><span class="keyword">return</span></span> <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>
    } <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.net.UnknownHostException</span><a id="111973">uhe</a></span>: <span class="typed"><span class="type">java.net.UnknownHostException</span><a id="4380">UnknownHostException</a></span> =&gt; <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
      <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="111974">ioe</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3517">IOException</a></span> =&gt; <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
      <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.lang.SecurityException</span><a id="111975">se</a></span>: <span class="typed"><span class="type">java.lang.SecurityException</span><a id="1856">SecurityException</a></span> =&gt; <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
    }

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a id="40059">nodeDown</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111976">mnode</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>): <span class="typed"><span class="type">Unit</span><a id="2167">Unit</a></span> = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8350" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">=&gt; scala.collection.mutable.HashMap[scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker]</span><a href="#40051">connections</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="../../collection/mutable/HashMap.scala.html#21381">-=</a></span> <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111976">mnode</a></span>
  }
}


<span class="keyword">class</span> <span class="typed"><span class="type">class TcpServiceWorker extends java.lang.Thread with ScalaObject</span><a id="8323">TcpServiceWorker</a></span>(<span class="typed"><span class="type">scala.actors.remote.TcpService</span><span id="111783"><a id="111905">parent</a></span></span>: <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#8350">TcpService</a></span>, <span class="typed"><span class="type">java.net.Socket</span><span id="111784"><a id="111906">so</a></span></span>: <span class="typed"><span class="type">java.net.Socket</span><a id="4401">Socket</a></span>) <span class="keyword">extends</span> <span class="typed"><span class="type">java.lang.Thread</span><a id="2081">Thread</a></span> {
  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.InputStream</span><span id="111787"><a id="111786">in</a></span></span> = <span class="typed"><span class="type">java.net.Socket</span><a href="#111784">so</a></span>.<span class="typed"><span class="type">()java.io.InputStream</span><a id="111845">getInputStream</a></span>()
  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.OutputStream</span><span id="111789"><a id="111788">out</a></span></span> = <span class="typed"><span class="type">java.net.Socket</span><a href="#111784">so</a></span>.<span class="typed"><span class="type">()java.io.OutputStream</span><a id="111846">getOutputStream</a></span>()

  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.DataInputStream</span><span id="111791"><a id="111790">datain</a></span></span> = <span class="typed"><span class="type">java.io.DataInputStream</span><span class="keyword">new</span></span> <span class="typed"><span class="type">java.io.DataInputStream</span><a id="3565">DataInputStream</a></span>(<span class="typed"><span class="type">=&gt; java.io.InputStream</span><a href="#111786">in</a></span>)
  <span class="keyword">val</span> <span class="typed"><span class="type">java.io.DataOutputStream</span><span id="111793"><a id="111792">dataout</a></span></span> = <span class="typed"><span class="type">java.io.DataOutputStream</span><span class="keyword">new</span></span> <span class="typed"><span class="type">java.io.DataOutputStream</span><a id="3526">DataOutputStream</a></span>(<span class="typed"><span class="type">=&gt; java.io.OutputStream</span><a href="#111788">out</a></span>)

  <span class="keyword">var</span> <span class="typed"><span class="type">scala.actors.remote.Node</span><span id="111796"><span id="111794"><span id="111795"><a id="111982">connectedNode</a></span></span></span></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span> = _

  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a id="111797">sendNode</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111965">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span>) = {
    <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="#111795">connectedNode</a></span> = <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111965">n</a></span>
    <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.JavaSerializer</span><a href="#40038">serializer</a></span>.<span class="typed"><span class="type">(java.io.DataOutputStream,AnyRef)Unit</span><a href="Serializer.scala.html#23253">writeObject</a></span>(<span class="typed"><span class="type">=&gt; java.io.DataOutputStream</span><a href="#111792">dataout</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#40042">node</a></span>)
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="111798">readNode</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">AnyRef</span><a id="111909">node</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.JavaSerializer</span><a href="#40038">serializer</a></span>.<span class="typed"><span class="type">(java.io.DataInputStream)AnyRef</span><a href="Serializer.scala.html#23251">readObject</a></span>(<span class="typed"><span class="type">=&gt; java.io.DataInputStream</span><a href="#111790">datain</a></span>)
    <span class="typed"><span class="type">AnyRef</span><a href="#111909">node</a></span> <span class="typed"><span class="type">Unit</span><span class="keyword">match</span></span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">scala.actors.remote.Node</span><a id="111910">n</a></span>: <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="RemoteActor.scala.html#8287">Node</a></span> =&gt; {
        <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="#111795">connectedNode</a></span> = <span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111910">n</a></span>
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node,scala.actors.remote.TcpServiceWorker)Unit</span><a href="#40053">addConnection</a></span>(<span class="typed"><span class="type">scala.actors.remote.Node</span><a href="#111910">n</a></span>, <span class="typed"><span class="type">scala.actors.remote.TcpServiceWorker</span><a href="#8323" class="keyword">this</a></span>)
      }
    }
  }

  <span class="keyword">def</span> <span class="typed"><span class="type">(Array[Byte])Unit</span><a id="111799">transmit</a></span>(<span class="typed"><span class="type">Array[Byte]</span><a id="111807">data</a></span>: <span class="typed"><span class="type">Array[Byte]</span><a href="../../Array.scala.html#1070">Array</a></span>[Byte]): <span class="typed"><span class="type">Unit</span><a id="2167">Unit</a></span> = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8323" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: transmitting data...&quot;)</span><span class="string">&quot;: transmitting data...&quot;</span></span>)
    <span class="typed"><span class="type">=&gt; java.io.DataOutputStream</span><a href="#111792">dataout</a></span>.<span class="typed"><span class="type">(Int)Unit</span><a id="23357">writeInt</a></span>(<span class="typed"><span class="type">Array[Byte]</span><a href="#111807">data</a></span>.<span class="typed"><span class="type">=&gt; Int</span><a href="../../Array.scala.html#17252">length</a></span>)
    <span class="typed"><span class="type">=&gt; java.io.DataOutputStream</span><a href="#111792">dataout</a></span>.<span class="typed"><span class="type">(Array[Byte])Unit</span><a id="23370">write</a></span>(<span class="typed"><span class="type">Array[Byte]</span><a href="#111807">data</a></span>)
    <span class="typed"><span class="type">=&gt; java.io.DataOutputStream</span><a href="#111792">dataout</a></span>.<span class="typed"><span class="type">()Unit</span><a id="23352">flush</a></span>()
  }

  <span class="keyword">var</span> <span class="typed"><span class="type">Boolean</span><span id="111802"><span id="111800"><span id="111801"><a id="111983">running</a></span></span></span></span> = <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>

  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="111803">halt</a></span> = <span class="typed"><span class="type">(Unit)Unit</span><a href="#8323" id="5794">synchronized</a></span> {
    <span class="typed"><span class="type">java.net.Socket</span><a href="#111784">so</a></span>.<span class="typed"><span class="type">()Unit</span><a id="111866">close</a></span>()
    <span class="typed"><span class="type">(Boolean)Unit</span><a href="#111801">running</a></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
  }

  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="111804">run</a></span>() {
    <span class="keyword">try</span> {
      <span class="typed"><span class="type">Unit</span><a href="#111995" class="keyword">while</a></span> (<span class="typed"><span class="type">=&gt; Boolean</span><a href="#111800">running</a></span>) {
        <span class="keyword">val</span> <span class="typed"><span class="type">AnyRef</span><a id="111996">msg</a></span> = <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.JavaSerializer</span><a href="#40038">serializer</a></span>.<span class="typed"><span class="type">(java.io.DataInputStream)AnyRef</span><a href="Serializer.scala.html#23251">readObject</a></span>(<span class="typed"><span class="type">=&gt; java.io.DataInputStream</span><a href="#111790">datain</a></span>);
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span>.<span class="typed"><span class="type">=&gt; scala.actors.remote.NetKernel</span><a href="Service.scala.html#23257">kernel</a></span>.<span class="typed"><span class="type">(scala.actors.remote.Node,AnyRef)Unit</span><a href="NetKernel.scala.html#40016">processMsg</a></span>(<span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#111794">connectedNode</a></span>, <span class="typed"><span class="type">AnyRef</span><a href="#111996">msg</a></span>)
      }
    }
    <span class="keyword">catch</span> {
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">java.io.IOException</span><a id="111997">ioe</a></span>: <span class="typed"><span class="type">java.io.IOException</span><a id="3517">IOException</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.io.IOException</span><a href="#111997">ioe</a></span>)
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="#40059">nodeDown</a></span> <span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#111794">connectedNode</a></span>
      <span class="typed"><span class="type">Unit</span><span class="keyword">case</span></span> <span class="typed"><span class="type">Exception</span><a id="112002">e</a></span>: <span class="typed"><span class="type">Exception</span><a id="2129">Exception</a></span> =&gt;
        <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: caught &quot;)</span><span class="string">&quot;: caught &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">Exception</span><a href="#112002">e</a></span>)
        <span class="typed"><span class="type">scala.actors.remote.TcpService</span><a href="#111783">parent</a></span> <span class="typed"><span class="type">(scala.actors.remote.Node)Unit</span><a href="#40059">nodeDown</a></span> <span class="typed"><span class="type">=&gt; scala.actors.remote.Node</span><a href="#111794">connectedNode</a></span>
    }
    <span class="typed"><span class="type">object scala.actors.Debug</span><a href="../Debug.scala.html#8211">Debug</a></span>.<span class="typed"><span class="type">(String)Unit</span><a href="../Debug.scala.html#40072">info</a></span>(<span class="typed"><span class="type">implicit scala.Predef.any2stringadd : (Any)scala.runtime.StringAdd</span><a href="../../Predef.scala.html#13520" class="keyword">this</a></span><span class="typed"><span class="type">(String)java.lang.String</span><a href="../../runtime/StringAdd.scala.html#19198">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;: terminated&quot;)</span><span class="string">&quot;: terminated&quot;</span></span>)
  }
}

        </pre>
    </body>
</html>