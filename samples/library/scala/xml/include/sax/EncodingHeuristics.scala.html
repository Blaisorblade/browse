<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/xml/include/sax/EncodingHeuristics.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style">
    </head>
    <body>
        <pre>
/*                     __                                               *\
**     ________ ___   / /  ___     Scala API                            **
**    / __/ __// _ | / /  / _ |    (c) 2002-2009, LAMP/EPFL             **
**  __\ \/ /__/ __ |/ /__/ __ |    http://scala-lang.org/               **
** /____/\___/_/ |_/____/_/ | |                                         **
**                          |/                                          **
\*                                                                      */

// $Id: EncodingHeuristics.scala 18387 2009-07-24 15:28:37Z odersky $

<span class="keyword">package</span> scala.xml
<span class="keyword">package</span> include.sax
<span class="keyword">import</span> scala.xml.include._

<span class="keyword">import</span> java.io.InputStream
<span class="keyword">import</span> scala.util.matching.Regex

/**
 * &lt;p&gt;
 * &lt;code&gt;EncodingHeuristics&lt;/code&gt; reads from a stream
 * (which should be buffered) and attempts to guess
 * what the encoding of the text in the stream is.
 * If it fails to determine the type of the encoding,
 * it returns the default UTF-8. 
 * &lt;/p&gt;
 *
 * @author Burak Emir
 * @author Paul Phillips
 */
<span class="keyword">object</span> <a title="object scala.xml.include.sax.EncodingHeuristics" id="9978">EncodingHeuristics</a>
<a href="../../../ScalaObject.scala.html#969" title="ScalaObject">{</a>
  <span class="keyword">object</span> <a title="object scala.xml.include.sax.EncodingHeuristics.EncodingNames" id="218586">EncodingNames</a> <a href="../../../ScalaObject.scala.html#969" title="ScalaObject">{</a>
    // UCS-4 isn't yet implemented in java releases anyway...
    <span class="keyword">val</span> <a title="java.lang.String" id="218592">bigUCS4</a>       = <span title="java.lang.String(&quot;UCS-4&quot;)" class="string">&quot;UCS-4&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218594">littleUCS4</a>    = <span title="java.lang.String(&quot;UCS-4&quot;)" class="string">&quot;UCS-4&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218596">unusualUCS4</a>   = <span title="java.lang.String(&quot;UCS-4&quot;)" class="string">&quot;UCS-4&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218598">bigUTF16</a>      = <span title="java.lang.String(&quot;UTF-16BE&quot;)" class="string">&quot;UTF-16BE&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218600">littleUTF16</a>   = <span title="java.lang.String(&quot;UTF-16LE&quot;)" class="string">&quot;UTF-16LE&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218602">utf8</a>          = <span title="java.lang.String(&quot;UTF-8&quot;)" class="string">&quot;UTF-8&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="218604">default</a>       = <a href="#218602" title="=&gt; java.lang.String">utf8</a>
  }
  <span class="keyword">import</span> EncodingNames._

  /**
    * &lt;p&gt;
    * This utility method attempts to determine the XML character encoding
    * by examining the input stream, as specified here:
    *    http://www.w3.org/TR/xml/#sec-guessing
    * &lt;/p&gt;
    *
    * @param in   &lt;code&gt;InputStream&lt;/code&gt; to read from. 
    * @return String  The name of the encoding.
    * @throws IOException if the stream cannot be reset
    */    
  <span class="keyword">def</span> <a title="(in: java.io.InputStream)String" id="218589">readEncodingFromStream</a>(<a title="java.io.InputStream" id="218590">in</a>: <a title="java.io.InputStream" id="3907">InputStream</a>): <span title="String">String</span> = {
    <span class="keyword">var</span> <a title="String" id="249258">ret</a>: <span title="String">String</span> = <span title="Null(null)" class="keyword">null</span>    
    <span class="keyword">val</span> <a title="Int" id="249259">bytesToRead</a> = <span title="Int(1024)" class="int">1024</span> // enough to read most XML encoding declarations
    <span class="keyword">def</span> <a title="=&gt; String" id="249260">resetAndRet</a> = { <a href="#218590" title="java.io.InputStream">in</a>.<a title="()Unit" id="47008">reset</a> ; <a href="#249258" title="String">ret</a> }
    
    // This may fail if there are a lot of space characters before the end
    // of the encoding declaration
    <a href="#218590" title="(x$1: Int)Unit" id="47006">in</a> mark <a href="#249259" title="Int">bytesToRead</a>
    <span class="keyword">val</span> <a title="(Int, Int, Int, Int)" id="249261">bytes</a> = <a href="../../../Tuple4.scala.html#32062" title="(_1: Int,_2: Int,_3: Int,_4: Int)(Int, Int, Int, Int)">(</a><a href="#218590" title="java.io.InputStream">in</a>.<span title="()Int">read</span>, <a href="#218590" title="java.io.InputStream">in</a>.<span title="()Int">read</span>, <a href="#218590" title="java.io.InputStream">in</a>.<span title="()Int">read</span>, <a href="#218590" title="java.io.InputStream">in</a>.<span title="()Int">read</span>)
    
    // first look for byte order mark
    <a href="#249258" title="String">ret</a> = <a href="#249261" title="(Int, Int, Int, Int)">bytes</a> <span title="String" class="keyword">match</span> {
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(254)" class="int">0xFE</span>, <span title="Int(255)" class="int">0xFF</span>) =&gt; <a href="#218592" title="=&gt; java.lang.String">bigUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(255)" class="int">0xFF</span>, <span title="Int(254)" class="int">0xFE</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218594" title="=&gt; java.lang.String">littleUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(255)" class="int">0xFF</span>, <span title="Int(254)" class="int">0xFE</span>) =&gt; <a href="#218596" title="=&gt; java.lang.String">unusualUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(254)" class="int">0xFE</span>, <span title="Int(255)" class="int">0xFF</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218596" title="=&gt; java.lang.String">unusualUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(254)" class="int">0xFE</span>, <span title="Int(255)" class="int">0xFF</span>, _   , _   ) =&gt; <a href="#218598" title="=&gt; java.lang.String">bigUTF16</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(255)" class="int">0xFF</span>, <span title="Int(254)" class="int">0xFE</span>, _   , _   ) =&gt; <a href="#218600" title="=&gt; java.lang.String">littleUTF16</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(239)" class="int">0xEF</span>, <span title="Int(187)" class="int">0xBB</span>, <span title="Int(191)" class="int">0xBF</span>, _   ) =&gt; <a href="#218602" title="=&gt; java.lang.String">utf8</a>
      <span title="Null(null)" class="keyword">case</span> _                        =&gt; <span title="Null(null)" class="keyword">null</span>
    }
    <span title="Unit" class="keyword">if</span> (<a href="#249258" title="(x$1: AnyRef)Boolean" id="6592">ret</a> != <span title="Null(null)" class="keyword">null</span>)
      <span title="Nothing" class="keyword">return</span> <a href="#249260" title="=&gt; String">resetAndRet</a>
    
    <span class="keyword">def</span> <a title="=&gt; String" id="249262">readASCIIEncoding</a>: <span title="String">String</span> = {
      <span class="keyword">val</span> <a title="Array[Byte]" id="249346">data</a> = <span title="Array[Byte]" class="keyword">new</span> <a href="../../../Array.scala.html#897" title="Array[Byte]">Array</a>[Byte](<a href="#249259" title="(x$1: Int)Int">bytesToRead</a> - <span title="Int(4)" class="int">4</span>)
      <span class="keyword">val</span> <a title="Int" id="249347">length</a> = <a href="#218590" title="java.io.InputStream">in</a>.<a title="(x$1: Array[Byte],x$2: Int,x$3: Int)Int" id="46998">read</a>(<a href="#249346" title="Array[Byte]">data</a>, <span title="Int(0)" class="int">0</span>, <a href="#249259" title="(x$1: Int)Int">bytesToRead</a> - <span title="Int(4)" class="int">4</span>)

      // Use Latin-1 (ISO-8859-1) because all byte sequences are legal.
      <span class="keyword">val</span> <a title="java.lang.String" id="249348">declaration</a> = <a title="(x$1: Array[Byte],x$2: Int,x$3: Int,x$4: java.lang.String)java.lang.String" id="6631" class="keyword">new</a> <a href="../../../Predef.scala.html#16261" title="java.lang.String">String</a>(<a href="#249346" title="Array[Byte]">data</a>, <span title="Int(0)" class="int">0</span>, <a href="#249347" title="Int">length</a>, <span title="java.lang.String(&quot;ISO-8859-1&quot;)" class="string">&quot;ISO-8859-1&quot;</span>)
      <span class="keyword">val</span> <a title="scala.util.matching.Regex" id="249349">regexp</a> = <a href="../../../Predef.scala.html#16471" title="implicit scala.Predef.stringWrapper : (x: String)scala.runtime.RichString" class="string">&quot;&quot;&quot;(?m).*?encoding\s*=\s*[&quot;'](.+?)['&quot;]&quot;&quot;&quot;</a>.<a href="../../../runtime/RichString.scala.html#18158" title="=&gt; scala.util.matching.Regex">r</a>
      (<a href="../../../util/matching/Regex.scala.html#59902" title="(source: java.lang.CharSequence)Option[scala.util.matching.Regex.Match]">regexp</a> findFirstMatchIn <a href="#249348" title="java.lang.String">declaration</a>) <span title="String" class="keyword">match</span> {
        <span title="java.lang.String" class="keyword">case</span> <a href="../../../Option.scala.html#472" title="object None">None</a>     =&gt; <a href="#218604" title="=&gt; java.lang.String">default</a>
        <span title="String" class="keyword">case</span> Some(<a title="scala.util.matching.Regex.Match" id="249519">md</a>) =&gt; <a href="#249519" title="scala.util.matching.Regex.Match">md</a>.<a href="../../../collection/generic/LinearSequenceTemplate.scala.html#19507" title="(n: Int)String">subgroups</a>(<span title="Int(0)" class="int">0</span>)
      }
    }
          
    // no byte order mark present; first character must be '&lt;' or whitespace        
    <a href="#249258" title="String">ret</a> = <a href="#249261" title="(Int, Int, Int, Int)">bytes</a> <span title="String" class="keyword">match</span> {    
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Char('&lt;')" class="char">'&lt;'</span> ) =&gt; <a href="#218592" title="=&gt; java.lang.String">bigUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218594" title="=&gt; java.lang.String">littleUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>, <span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218596" title="=&gt; java.lang.String">unusualUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Int(0)" class="int">0x00</span>, <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218596" title="=&gt; java.lang.String">unusualUCS4</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(0)" class="int">0x00</span>, <span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Int(0)" class="int">0x00</span>, <span title="Char('?')" class="char">'?'</span> ) =&gt; <a href="#218598" title="=&gt; java.lang.String">bigUTF16</a>     // XXX must read encoding
      <span title="java.lang.String" class="keyword">case</span> (<span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Int(0)" class="int">0x00</span>, <span title="Char('?')" class="char">'?'</span> , <span title="Int(0)" class="int">0x00</span>) =&gt; <a href="#218600" title="=&gt; java.lang.String">littleUTF16</a>  // XXX must read encoding
      <span title="String" class="keyword">case</span> (<span title="Char('&lt;')" class="char">'&lt;'</span> , <span title="Char('?')" class="char">'?'</span> , <span title="Char('x')" class="char">'x'</span> , <span title="Char('m')" class="char">'m'</span> ) =&gt; <a href="#249262" title="=&gt; String">readASCIIEncoding</a>
      <span title="java.lang.String" class="keyword">case</span> (<span title="Int(76)" class="int">0x4C</span>, <span title="Int(111)" class="int">0x6F</span>, <span title="Int(167)" class="int">0xA7</span>, <span title="Int(148)" class="int">0x94</span>) =&gt; <a href="#218602" title="=&gt; java.lang.String">utf8</a>         // XXX EBCDIC
      <span title="java.lang.String" class="keyword">case</span> _                        =&gt; <a href="#218602" title="=&gt; java.lang.String">utf8</a>         // no XML or text declaration present
    }
    <a href="#249260" title="=&gt; String">resetAndRet</a>
  }
}

        </pre>
    </body>
</html>