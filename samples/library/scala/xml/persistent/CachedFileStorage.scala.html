<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/xml/persistent/CachedFileStorage.scala</title>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/*                     __                                               *\
**     ________ ___   / /  ___     Scala API                            **
**    / __/ __// _ | / /  / _ |    (c) 2002-2009, LAMP/EPFL             **
**  __\ \/ /__/ __ |/ /__/ __ |    http://scala-lang.org/               **
** /____/\___/_/ |_/____/_/ | |                                         **
**                          |/                                          **
\*                                                                      */</span>

<span class="comment">// $Id: CachedFileStorage.scala 16893 2009-01-13 13:09:22Z cunei $</span>

<span class="keyword">package</span> scala.xml.persistent

<span class="keyword">import</span> java.io.{File, FileOutputStream} 
<span class="keyword">import</span> java.nio.ByteBuffer
<span class="keyword">import</span> java.nio.channels.Channels 

<span class="comment">/** &lt;p&gt;
 *    Mutable storage of immutable xml trees. Everything is kept in memory,
 *    with a thread periodically checking for changes and writing to file.
 *    To ensure atomicity, two files are used, filename1 and '$'+filename1.
 *    The implementation switches between the two, deleting the older one
 *    after a complete dump of the database has been written.
 *  &lt;/p&gt;
 *
 *  @author Burak Emir
 */</span>
<span class="keyword">abstract</span> <span class="keyword">class</span> <span class="typed"><span class="type">class CachedFileStorage extends java.lang.Thread with scala.util.logging.Logged with ScalaObject</span><a id="13183">CachedFileStorage</a></span>(<span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><span id="54334"><span id="54333"><a id="54374">file1</a></span></span></span>: <span class="typed"><span class="type">java.io.File</span><a id="3667">File</a></span>)
<span class="keyword">extends</span> java.lang.<span class="typed"><span class="type">java.lang.Thread</span><a id="2081">Thread</a></span> <span class="keyword">with</span> scala.util.logging.<span class="typed"><span class="type">scala.util.logging.Logged</span><a href="../../util/logging/Logged.scala.html#15539">Logged</a></span> {

  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">java.io.File</span><span id="54337"><a id="54336">file2</a></span></span> = <span class="typed"><span class="type">(java.lang.String,java.lang.String)java.io.File</span><a id="25987" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.File</span><a id="3667">File</a></span>(<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="25991">getParent</a></span>, <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>.<span class="typed"><span class="type">()java.lang.String</span><a id="25990">getName</a></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;$&quot;)</span><span class="string">&quot;$&quot;</span></span>)
    
  <span class="comment">/**  either equals file1 or file2, references the next file in which updates will be stored
   */</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <span class="typed"><span class="type">java.io.File</span><span id="54340"><span id="54338"><span id="54339"><a id="107901">theFile</a></span></span></span></span>: <span class="typed"><span class="type">java.io.File</span><a id="3667">File</a></span> = <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>

  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="54341">switch</a></span> = { <span class="typed"><span class="type">(java.io.File)Unit</span><a href="#54339">theFile</a></span> = <span class="typed"><span class="type">java.io.File</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span> <span class="typed"><span class="type">(AnyRef)Boolean</span><a id="3507">==</a></span> <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>) <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54336">file2</a></span> <span class="keyword">else</span> <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>; }

  <span class="comment">/** this storage modified since last modification check */</span>
  <span class="keyword">protected</span> <span class="keyword">var</span> <span class="typed"><span class="type">Boolean</span><span id="54344"><span id="54342"><span id="54343"><a id="107902">dirty</a></span></span></span></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>

  <span class="comment">/** period between modification checks, in milliseconds */</span>
  <span class="keyword">protected</span> <span class="keyword">val</span> <span class="typed"><span class="type">Int</span><span id="54346"><a id="54345">interval</a></span></span> = <span class="typed"><span class="type">Int(1000)</span><span class="int">1000</span></span>

  <span class="comment">/** finds and loads the storage file. subclasses should call this method 
   *  prior to any other, but only once, to obtain the initial sequence of nodes.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a id="54347">initialNodes</a></span>: <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><a href="../../Iterator.scala.html#1337">Iterator</a></span>[Node] = <span class="typed"><span class="type">(Boolean,Boolean)(Boolean, Boolean)</span><a href="../../Tuple2.scala.html#20366">(</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="26003">exists</a></span>, <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54336">file2</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="26003">exists</a></span>) <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><span class="keyword">match</span></span> {
    <span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.Object with Iterator[Nothing]</span><span class="keyword">case</span></span> <a id="1">(</a><span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>,<span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>) =&gt; 
      <span class="typed"><span class="type">(java.io.File)Unit</span><a href="#54339">theFile</a></span> = <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>
      <span class="typed"><span class="type">object Iterator</span><a href="../../Iterator.scala.html#1338">Iterator</a></span>.<span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.Object with Iterator[Nothing]</span><a href="../../Iterator.scala.html#22746">empty</a></span>
    <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><span class="keyword">case</span></span> <a id="1">(</a><span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>, <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span> ) <span class="keyword">if</span> (<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>.<span class="typed"><span class="type">()Long</span><a id="26007">lastModified</a></span> <span class="typed"><span class="type">(Long)Boolean</span><a id="3264">&lt;</a></span> <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54336">file2</a></span>.<span class="typed"><span class="type">()Long</span><a id="26007">lastModified</a></span>) =&gt; 
      <span class="typed"><span class="type">(java.io.File)Unit</span><a href="#54339">theFile</a></span> = <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54336">file2</a></span>
      <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a href="#54351">load</a></span>
    <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><span class="keyword">case</span></span> <a id="1">(</a><span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>, _ ) =&gt;
      <span class="typed"><span class="type">(java.io.File)Unit</span><a href="#54339">theFile</a></span> = <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54333">file1</a></span>
      <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a href="#54351">load</a></span>
    <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><span class="keyword">case</span></span> _ =&gt;
      <span class="typed"><span class="type">(java.io.File)Unit</span><a href="#54339">theFile</a></span> = <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54336">file2</a></span>
      <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a href="#54351">load</a></span>
  }

  <span class="comment">/** returns an iterator over the nodes in this storage */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a id="54348">nodes</a></span>: <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><a href="../../Iterator.scala.html#1337">Iterator</a></span>[Node]  

  <span class="comment">/** adds a node, setting this.dirty to true as a side effect */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.xml.Node)Unit</span><a id="54349">+=</a></span> (<span class="typed"><span class="type">scala.xml.Node</span><a id="54380">e</a></span>: <span class="typed"><span class="type">scala.xml.Node</span><a href="../Node.scala.html#7174">Node</a></span>): <span class="typed"><span class="type">Unit</span><a id="2167">Unit</a></span> 

  <span class="comment">/** removes a tree, setting this.dirty to true as a side effect */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(scala.xml.Node)Unit</span><a id="54350">-=</a></span> (<span class="typed"><span class="type">scala.xml.Node</span><a id="107916">e</a></span>: <span class="typed"><span class="type">scala.xml.Node</span><a href="../Node.scala.html#7174">Node</a></span>): <span class="typed"><span class="type">Unit</span><a id="2167">Unit</a></span> 

  <span class="comment">/* loads and parses XML from file */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a id="54351">load</a></span>: <span class="typed"><span class="type">Iterator[scala.xml.Node]</span><a href="../../Iterator.scala.html#1337">Iterator</a></span>[Node] = {
    <span class="keyword">import</span> scala.io.Source
    <span class="keyword">import</span> scala.xml.parsing.ConstructingParser
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[load]\012loading &quot;)</span><span class="string">&quot;[load]\nloading &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">scala.io.Source</span><a id="107919">src</a></span> = <span class="typed"><span class="type">object scala.io.Source</span><a href="../../io/Source.scala.html#9108">Source</a></span>.<span class="typed"><span class="type">(java.io.File)scala.io.Source</span><a href="../../io/Source.scala.html#30265">fromFile</a></span>( <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span> )
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;parsing &quot;)</span><span class="string">&quot;parsing &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">scala.xml.Node</span><a id="107920">res</a></span> = <span class="typed"><span class="type">object scala.xml.parsing.ConstructingParser</span><a href="../parsing/ConstructingParser.scala.html#12544">ConstructingParser</a></span>.<span class="typed"><span class="type">(scala.io.Source,Boolean)scala.xml.parsing.ConstructingParser</span><a href="../parsing/ConstructingParser.scala.html#74898">fromSource</a></span>(<span class="typed"><span class="type">scala.io.Source</span><a href="#107919">src</a></span>,<span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>).<span class="typed"><span class="type">()scala.xml.Document</span><a href="../parsing/MarkupParser.scala.html#44336">document</a></span>.<span class="typed"><span class="type">(Int)scala.xml.Node</span><a href="../NodeSeq.scala.html#19935">docElem</a></span>(<span class="typed"><span class="type">Int(0)</span><span class="int">0</span></span>)
    <span class="typed"><span class="type">=&gt; Unit</span><a href="#54341">switch</a></span>
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[load done]&quot;)</span><span class="string">&quot;[load done]&quot;</span></span>)
    <span class="typed"><span class="type">scala.xml.Node</span><a href="#107920">res</a></span>.<span class="typed"><span class="type">=&gt; Seq[scala.xml.Node]</span><a href="../Node.scala.html#19952">child</a></span>.<span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a href="../../Iterable.scala.html#17309">elements</a></span>
  }
  
  <span class="comment">/** saves the XML to file */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="54352">save</a></span> = <span class="typed"><span class="type">Unit</span><span class="keyword">if</span></span> (<span class="typed"><span class="type">CachedFileStorage.this.type</span><a href="#13183" class="keyword">this</a></span>.<span class="typed"><span class="type">=&gt; Boolean</span><a href="#54342">dirty</a></span>) {
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[save]\012deleting &quot;)</span><span class="string">&quot;[save]\ndeleting &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>);
    <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="26010">delete</a></span>();
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;creating new &quot;)</span><span class="string">&quot;creating new &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>);
    <span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>.<span class="typed"><span class="type">()Boolean</span><a id="26009">createNewFile</a></span>();
    <span class="keyword">val</span> <span class="typed"><span class="type">java.io.FileOutputStream</span><a id="107933">fos</a></span> = <span class="typed"><span class="type">(java.io.File)java.io.FileOutputStream</span><a id="26403" class="keyword">new</a></span> <span class="typed"><span class="type">java.io.FileOutputStream</span><a id="3796">FileOutputStream</a></span>(<span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>)
    <span class="keyword">val</span> <span class="typed"><span class="type">java.nio.channels.FileChannel</span><a id="107934">c</a></span>   = <span class="typed"><span class="type">java.io.FileOutputStream</span><a href="#107933">fos</a></span>.<span class="typed"><span class="type">()java.nio.channels.FileChannel</span><a id="26411">getChannel</a></span>()
    
    <span class="comment">// @todo: optimize</span>
    <span class="keyword">val</span> <span class="typed"><span class="type">scala.xml.Elem</span><a id="107935">storageNode</a></span> = &lt;nodes&gt;{ <span class="typed"><span class="type">=&gt; Iterator[scala.xml.Node]</span><a href="#54348">nodes</a></span>.<span class="typed"><span class="type">=&gt; List[scala.xml.Node]</span><a href="../../Iterator.scala.html#20046">toList</a></span> }&lt;/nodes&gt;
    <span class="keyword">val</span> <span class="typed"><span class="type">java.io.Writer</span><a id="107936">w</a></span> = <span class="typed"><span class="type">object java.nio.channels.Channels</span><a id="21964">Channels</a></span>.<span class="typed"><span class="type">(java.nio.channels.WritableByteChannel,java.lang.String)java.io.Writer</span><a id="22280">newWriter</a></span>(<span class="typed"><span class="type">java.nio.channels.FileChannel</span><a href="#107934">c</a></span>, <span class="typed"><span class="type">java.lang.String(&quot;utf-8&quot;)</span><span class="string">&quot;utf-8&quot;</span></span>)
    <span class="typed"><span class="type">object scala.xml.XML</span><a href="../XML.scala.html#7322">XML</a></span>.<span class="typed"><span class="type">(java.io.Writer,scala.xml.Node,String,Boolean,scala.xml.dtd.DocType)Unit</span><a href="../XML.scala.html#25977">write</a></span>(<span class="typed"><span class="type">java.io.Writer</span><a href="#107936">w</a></span>, <span class="typed"><span class="type">scala.xml.Elem</span><a href="#107935">storageNode</a></span>, <span class="typed"><span class="type">java.lang.String(&quot;utf-8&quot;)</span><span class="string">&quot;utf-8&quot;</span></span>, <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>, <span class="typed"><span class="type">Null(null)</span><span class="keyword">null</span></span>)
    
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;writing to &quot;)</span><span class="string">&quot;writing to &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; java.io.File</span><a href="#54338">theFile</a></span>);
    
    <span class="typed"><span class="type">java.io.Writer</span><a href="#107936">w</a></span>.<span class="typed"><span class="type">()Unit</span><a id="26426">close</a></span>
    <span class="typed"><span class="type">java.nio.channels.FileChannel</span><a href="#107934">c</a></span>.<span class="typed"><span class="type">()Unit</span><a id="26510">close</a></span>
    <span class="typed"><span class="type">java.io.FileOutputStream</span><a href="#107933">fos</a></span>.<span class="typed"><span class="type">()Unit</span><a id="26409">close</a></span>
    <span class="typed"><span class="type">(Boolean)Unit</span><a href="#54343">dirty</a></span> = <span class="typed"><span class="type">Boolean(false)</span><span class="keyword">false</span></span>
    <span class="typed"><span class="type">=&gt; Unit</span><a href="#54341">switch</a></span>
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[save done]&quot;)</span><span class="string">&quot;[save done]&quot;</span></span>)
  }
  
  <span class="comment">/** run method of the thread. remember to use start() to start a thread, not run. */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()Unit</span><a id="54353">run</a></span> = {
    <span class="typed"><span class="type">(String)Unit</span><a href="../../util/logging/Logged.scala.html#44411">log</a></span>(<span class="typed"><span class="type">java.lang.String(&quot;[run]\012starting storage thread, checking every &quot;)</span><span class="string">&quot;[run]\nstarting storage thread, checking every &quot;</span></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">=&gt; Int</span><a href="#54345">interval</a></span><span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.lang.String(&quot; ms&quot;)</span><span class="string">&quot; ms&quot;</span></span>);
    <span class="typed"><span class="type">Unit</span><a href="#107943" class="keyword">while</a></span>(<span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>) { 
      <span class="typed"><span class="type">object java.lang.Thread</span><a id="2082">Thread</a></span>.<span class="typed"><span class="type">(Long)Unit</span><a id="20749">sleep</a></span>( <span class="typed"><span class="type">CachedFileStorage.this.type</span><a href="#13183" class="keyword">this</a></span>.<span class="typed"><span class="type">implicit scala.Predef.int2long : (Int)Long</span><a href="../../Predef.scala.html#13635">interval</a></span> ); 
      <span class="typed"><span class="type">=&gt; Unit</span><a href="#54352">save</a></span> 
    }
  }
  
  <span class="comment">/** forces writing of contents to the file, even if there has not been any update. */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; Unit</span><a id="54354">flush</a></span> = { 
    <span class="typed"><span class="type">CachedFileStorage.this.type</span><a href="#13183" class="keyword">this</a></span>.<span class="typed"><span class="type">(Boolean)Unit</span><a href="#54343">dirty</a></span> = <span class="typed"><span class="type">Boolean(true)</span><span class="keyword">true</span></span>; 
    <span class="typed"><span class="type">=&gt; Unit</span><a href="#54352">save</a></span>
  }
}


        </pre>
    </body>
</html>