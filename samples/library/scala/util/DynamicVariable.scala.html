<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>scala/util/DynamicVariable.scala</title>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style">
    </head>
    <body onload="initializeLinked()">
        <pre>
<span class="comment">/*                     __                                               *\
**     ________ ___   / /  ___     Scala API                            **
**    / __/ __// _ | / /  / _ |    (c) 2006-2009, LAMP/EPFL             **
**  __\ \/ /__/ __ |/ /__/ __ |    http://scala-lang.org/               **
** /____/\___/_/ |_/____/_/ | |                                         **
**                          |/                                          **
\*                                                                      */</span>

<span class="comment">// $Id: DynamicVariable.scala 16884 2009-01-09 16:52:09Z cunei $</span>


<span class="keyword">package</span> scala.util


<span class="keyword">import</span> Predef._
<span class="keyword">import</span> java.lang.InheritableThreadLocal

<span class="comment">/** &lt;p&gt;
 *    DynamicVariables provide a binding mechanism where the current
 *    value is found through &lt;em&gt;dynamic scope&lt;/em&gt;, but where
 *    access to the variable itself is resolved through &lt;em&gt;static
 *    scope&lt;/em&gt;.
 *  &lt;/p&gt;
 *  &lt;p&gt;
 *    The current value can be retrieved with the
 *    &lt;code&gt;value&lt;/code&gt; method.  New values should be
 *    pushed using the &lt;code&gt;withValue&lt;/code&gt; method.
 *    Values pushed via &lt;code&gt;withValue&lt;/code&gt; only
 *    stay valid while the &lt;code&gt;withValue&lt;/code&gt;'s
 *    &lt;em&gt;second&lt;/em&gt; argument, a parameterless closure,
 *    executes.  When the second argument finishes,
 *    the variable reverts to the previous value.
 *  &lt;/p&gt;
 *  &lt;p&gt;
 *    Usage of &lt;code&gt;withValue&lt;/code&gt; looks like this:
 *  &lt;/p&gt;
 *  &lt;blockquote&gt;&lt;pre&gt;
 *  someDynamicVariable.withValue(newValue) {
 *    // ... code called in here that calls value ...
 *    // ... will be given back the newValue ...
 *  }
 *  &lt;/pre&gt;&lt;/blockquote&gt;
 *  &lt;p&gt;
 *    Each thread gets its own stack of bindings.  When a 
 *    new thread is created, the fluid gets a copy of
 *    the stack of bindings from the parent thread, and 
 *    from then on the bindings for the new thread
 *    are independent of those for the original thread.
 *  &lt;/p&gt;
 *
 *  @author  Lex Spoon
 *  @version 1.1, 2007-5-21
 */</span>
<span class="keyword">class</span> <span class="typed"><span class="type">class DynamicVariable[T] extends java.lang.Object with ScalaObject</span><a id="6723">DynamicVariable</a></span>[<span class="typed"><span class="type">&gt;: Nothing &lt;: Any</span><a id="12493">T</a></span>](<span class="typed"><span class="type">T</span><span id="31487"><a id="31497">init</a></span></span>: <span class="typed"><span class="type">T</span><a href="#12493">T</a></span>) {
  <span class="keyword">private</span> <span class="keyword">val</span> <span class="typed"><span class="type">&lt;refinement&gt; extends java.lang.InheritableThreadLocal[T]</span><span id="31490"><a id="31489">tl</a></span></span> = <span class="typed"><span class="type">template $anon extends java.lang.InheritableThreadLocal[T]</span><a id="42027" class="keyword">new</a></span> <span class="typed"><span class="type">java.lang.InheritableThreadLocal[T]</span><a id="1964">InheritableThreadLocal</a></span>[T] {
    <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()T with AnyRef</span><a id="42034">initialValue</a></span> = <span class="typed"><span class="type">T</span><a href="#31487">init</a></span>.<span class="typed"><span class="type">&lt;refinement&gt; extends T with AnyRef</span><a id="3501">asInstanceOf</a></span>[<span class="typed"><span class="type">&lt;refinement&gt; extends T with AnyRef</span><a href="#42036">T</a></span> <span class="keyword">with</span> AnyRef]
  }

  <span class="comment">/** Retrieve the current value */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">=&gt; T</span><a id="31491">value</a></span>: <span class="typed"><span class="type">T</span><a href="#12493">T</a></span> = <span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.InheritableThreadLocal[T]</span><a href="#31489">tl</a></span>.<span class="typed"><span class="type">()T</span><a id="20499">get</a></span>.<span class="typed"><span class="type">T</span><a id="3501">asInstanceOf</a></span>[<span class="typed"><span class="type">T</span><a href="#12493">T</a></span>]
  
   
  <span class="comment">/** Set the value of the variable while executing the specified
    * thunk.
    *
    * @param newval The value to which to set the fluid
    * @param thunk The code to evaluate under the new setting
    */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">[S](T)(=&gt; S)S</span><a id="31492">withValue</a></span>[<span class="typed"><span class="type">&gt;: Nothing &lt;: Any</span><a id="31494">S</a></span>](<span class="typed"><span class="type">T</span><a id="42042">newval</a></span>: <span class="typed"><span class="type">T</span><a href="#12493">T</a></span>)(<span class="typed"><span class="type">=&gt; S</span><a id="42043">thunk</a></span>: =&gt;S): <span class="typed"><span class="type">S</span><a href="#31494">S</a></span> = {
    <span class="keyword">val</span> <span class="typed"><span class="type">T</span><a id="42044">oldval</a></span> = <span class="typed"><span class="type">=&gt; T</span><a href="#31491">value</a></span>
    <span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.InheritableThreadLocal[T]</span><a href="#31489">tl</a></span>.<span class="typed"><span class="type">(T)Unit</span><a id="20500">set</a></span>(<span class="typed"><span class="type">T</span><a href="#42042">newval</a></span>)
  
    <span class="keyword">try</span> { <span class="typed"><span class="type">=&gt; S</span><a href="#42043">thunk</a></span> } <span class="keyword">finally</span> {
      <span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.InheritableThreadLocal[T]</span><a href="#31489">tl</a></span>.<span class="typed"><span class="type">(T)Unit</span><a id="20500">set</a></span>(<span class="typed"><span class="type">T</span><a href="#42044">oldval</a></span>)
    }
  }

  <span class="comment">/** Change the currently bound value, discarding the old value.
    * Usually &lt;code&gt;withValue()&lt;/code&gt; gives better semantics.
    */</span>
  <span class="keyword">def</span> <span class="typed"><span class="type">(T)Unit</span><a id="31495">value_=</a></span>(<span class="typed"><span class="type">T</span><a id="42045">newval</a></span>: <span class="typed"><span class="type">T</span><a href="#12493">T</a></span>) = { <span class="typed"><span class="type">=&gt; &lt;refinement&gt; extends java.lang.InheritableThreadLocal[T]</span><a href="#31489">tl</a></span>.<span class="typed"><span class="type">(T)Unit</span><a id="20500">set</a></span>(<span class="typed"><span class="type">T</span><a href="#42045">newval</a></span>) }
  
  <span class="keyword">override</span> <span class="keyword">def</span> <span class="typed"><span class="type">()String</span><a id="31496">toString</a></span>: <span class="typed"><span class="type">String</span><a id="1859">String</a></span> = <span class="typed"><span class="type">java.lang.String(&quot;DynamicVariable(&quot;)</span><span class="string">&quot;DynamicVariable(&quot;</span></span> <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span> <span class="typed"><span class="type">=&gt; T</span><a href="#31491">value</a></span>  <span class="typed"><span class="type">(Any)java.lang.String</span><a id="5800">+</a></span><span class="typed"><span class="type">java.lang.String(&quot;)&quot;)</span><span class="string">&quot;)&quot;</span></span>
}

        </pre>
    </body>
</html>